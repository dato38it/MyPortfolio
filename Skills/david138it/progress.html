<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Progress</title>
</head>
<body>
    <!--HEADER-->
    <header class="header fixed" id="header">
        <div class="container">
            <div class="header__nav">
                <p>mail - david138it@gmail.com</p>
                <p><a href="https://github.com/David138it">github</a></p>
                <p><a href="http://www.linkedin.com/in/david-gabuniya-3bb954237">linkedin</a></p>
                <p>telegram - @david138it</p>
             </div>
        </div>
    </header>
    <!--SECTIONS-->
    <!--CARDS-->
    <section>
        <div class="container">
            <div class="cards">
                <div class="card__content" id="page__fixed">
                    <h2 class="card_hidden" onclick="card__hidden(this)"></h2>
                    <div style="display:none; text-align: left;" style=&{head};>

                    </div>
                </div> 
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Виртуализация в Yandex Cloud</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты практической работы по теме "Виртуализация в Yandex Cloud" настроил в Yandex Cloud больше десятка виртуальных машин на базе OC Linux<br /><strong>Task:</strong><br />Создание аккаунта. Для того, чтобы работать в облаке, нужен платёжный аккаунт. Если это ваш первый аккаунт в Yandex Cloud, то после его создания вы сможете активировать 60-дневный пробный период и получить стартовый грант. Это позволит вам выполнять практические работы, не тратя собственных средств.<br /><strong>Decision:</strong><br />Если у вас нет личного платёжного аккаунта: Откройте в браузере сайт cloud.yandex.ru. Если вы не авторизованы, в правом верхнем углу или на баннере нажмите кнопку Подключиться. - Войдите в свой аккаунт на Яндексе. - Если у вас его нет, то вам будет предложено создать новый Яндекс ID. При регистрации в Яндекс ID заполните все поля, в том числе номер телефона: он потребуется, чтобы создать платёжный аккаунт в Yandex Cloud. - Примите условия использования Yandex Cloud. - После аутентификации при первом входе в консоль управления вам будет предложено создать облако. Укажите название облака и нажмите кнопку Создать. - Вам будет назначена роль владельца &mdash; owner. - На этом этапе у вас есть облако, но нет платёжного аккаунта. Если вы перейдете в раздел Биллинг (в левом верхнем углу выберите меню Все сервисы -&gt; Биллинг), то увидите, что в списке аккаунтов пока пусто. - Чтобы создать платёжный аккаунт, нажмите кнопку Создать аккаунт в разделе Биллинг или на стартовой странице. При создании аккаунта заполните все данные (выберите тип плательщика &mdash; Физическое лицо) и добавьте банковскую карту. Для проверки система спишет с неё небольшую сумму денег, а затем сразу вернёт на счёт. - Важно! Обязательно выберите опцию Включить пробный период. Если этого не сделать, то ваш платежный аккаунт будет сразу переведен в режим платного потребления. - Пробный период позволяет использовать ресурсы Yandex Cloud в ограниченном режиме в течение 60 дней. Потреблённые ресурсы оплачиваются из стартового гранта. После завершения пробного периода ваши ресурсы в облаке будут остановлены, а чтобы возобновить работу в полном объёме потребуется перейти на платную версию. - Важно! Не отвязывайте банковскую карту во время пробного периода: в этом случае облако заблокируется. Если вы не перейдёте на платную версию, средства с карты списываться не будут.<br />$ google-chrome https://cloud.yandex.ru/ &amp;<br />После аутентификации при первом входе в консоль управления вам будет предложено создать облако. Укажите название облака и нажмите кнопку Создать. Вам будет назначена роль владельца &mdash; owner.<br />Чтобы создать платёжный аккаунт, нажмите кнопку Создать аккаунт в разделе Биллинг или на стартовой странице. При создании аккаунта заполните все данные (выберите тип плательщика &mdash; Физическое лицо) и добавьте банковскую карту. Для проверки система спишет с неё небольшую сумму денег, а затем сразу вернёт на счёт.<br /><strong>Task:</strong><br />Создать ВМ на базе OC Linux из консоли управления.<br /><strong>Decision:</strong><br />Откройте консоль управления облаком. Если это новое облако, которое вы создали в предыдущей практической работе, то вы окажетесь на странице дашборда каталога с именем default. Этот каталог и облачная сеть в нём с таким же именем создаются вместе с облаком автоматически.<br />Выберите сервис Compute Cloud из списка (Дашборд каталога &rarr; Все сервисы &rarr; Compute Cloud) и нажмите кнопку Создать ВМ.<br />В открывшемся окне понадобится указать параметры создаваемой ВМ. В блоке Базовые параметры укажите Имя ВМ, оно может содержать строчные латинские буквы, цифры и дефисы. Поле Описание необязательное &mdash; его обычно заполняют, чтобы не запутаться, если ВМ несколько. Выберите из списка Зону доступности ru-central1-a.<br />На вкладке Операционные системы В блоке Выбор образа/загрузочного диска выберите ОС, которая будет установлена на ВМ, &mdash; Ubuntu 22.04.<br />В блоке Диски оставьте значения по умолчанию: тип &mdash; HDD, размер &mdash; 18 ГБ.<br />В блоке Вычислительные ресурсы оставьте значения по умолчанию: платформа Intel Ice Lake, 2 ядра виртуального процессора (vCPU), гарантированная доля vCPU 100% и объём оперативной памяти (RAM) 2 ГБ.<br />В блоке Сетевые настройки оставьте используемую по умолчанию подсеть, а для Публичного адреса и Внутреннего адреса &mdash; опцию Автоматически.<br />В блоке Доступ заполните поле Логин&nbsp; (имя пользователя создаваемой ВМ).<br />Не указывайте идентификатор root или другие имена, зарезервированные операционной системой. Для операций, требующих прав суперпользователя, нужно будет использовать команду sudo.<br />Чтобы подключиться к создаваемой ВМ по протоколу SSH, понадобится пара SSH-ключей. Открытый ключ хранится на ВМ, а закрытый &mdash; у пользователя. В публичных образах Linux, предоставляемых Yandex Cloud, возможность подключения по SSH с использованием логина и пароля по умолчанию отключена.<br />создать SSH-ключи<br />После выполнения команды укажите имена файлов, куда сохранятся ключи, и введите пароль для закрытого ключа. По умолчанию используется имя id_rsa, ключи создаются в папке ~/.ssh текущего пользователя.<br />Открытый ключ сохранится в файле &lt;имя_ключа&gt;.pub. Содержимое этого файла вставляется в поле SSH-ключ виртуальной машины.<br />В поле SSH-ключ вставьте содержимое созданного открытого ключа. Убедитесь, что вставляете ключ без переносов строки. Например: ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAoIT+oFLFEHwNlGO71wZiamqHkzduK7V/B8ITxgLnddm725QZJbaO1JAUfaOryGckWqEHr0NQxZ+CfozLjtYwcYhnPfNs1vw7Ii5gnL4ne+Vu5Kl4f8rb+tOXAv6GAZIO1+05kB8K3nINfBkKFD1J0VmOr5P2MWy7aqdbyIqVJCH+YeU4SW5RGFPJbl5zGhlwSavVU0bgTYQmqWAOnR95bQVx1vRf4SyB003C8MYl8ccZ+emixM12eQPJ74fJyy1kKLRmU/IAlxyEiYESQglAaNQKN2ivnbfMaSVBnxMlYipxyeMDyCs8RD7zVUndTOJQg8PV7QVWqfAQjlY4uYlk8Q== rsa-key-20210429 <br />Изменяя параметры ВМ, в блоке Тарифы и цены (справа) вы увидите, как меняется её месячная стоимость.<br />Нажмите кнопку Создать ВМ.<br />Развёртывание ВМ занимает несколько минут. Вы можете отслеживать этот процесс по смене статуса.<br />Статус ВМ влияет на то, какие операции вы можете с ней выполнять. Например, статус Stopped означает, что машина остановлена и к ней невозможно подключиться. При запуске статус меняется на Provisioning (Yandex Cloud выделяет ВМ ресурсы), а после загрузки операционной системы &mdash; на Running.<br />Теперь, когда ВМ создана и запущена, к ней можно подключиться. Для этого понадобятся логин пользователя и публичный IP-адрес ВМ, который можно скопировать из строки с информацией о ней на странице Виртуальные машины.<br />Чтобы подключиться к запущенной ВМ (статус RUNNING) по протоколу SSH, используют утилиту ssh в Linux/macOS или Windows 10/11, программу PuTTY в Windows 7/8 или любой другой клиент SSH.<br />Если у вас несколько закрытых ключей, укажите нужный: ssh -i &lt;путь_к_ключу/имя_файла_ключа&gt; &lt;имя_пользователя&gt;@&lt;публичный_IP-адрес_ВМ&gt; <br />Установите обновления.<br />ВМ готова к работе<br /><strong>Decision:</strong><br />$ ssh-keygen -t rsa -b 2048<br />$ cat davidk.pub<br />$ ssh -i davidk david@178.154.223.142<br />$ sudo apt-get update<br />$ sudo apt-get upgrade<br /><strong>Task:</strong><br />Работа серийной консоли зависит от настроек операционной системы. Yandex Compute Cloud обеспечивает канал связи между пользователем и COM-портом ВМ, но не гарантирует стабильность работы консоли со стороны операционной системы ВМ.<br />Доступ к серийной консоли ВМ с ОС на базе Linux возможен следующими способами: по протоколу SSH с другого компьютера; через консоль управления Yandex Cloud; с помощью интерфейса командной строки Yandex Cloud CLI. <br /><strong>Task:</strong><br />Вход по протоколу SSH. Подключитесь к ВМ по протоколу SSH. Установите пароль текущему пользователю с помощью утилиты passwd в привилегированном режиме: sudo passwd &lt;имя_пользователя&gt; <br />После ввода команды дважды наберите одинаковый пароль.<br />Для доступа к серийной консоли ВМ необходимо знать её идентификатор (ID). В консоли управления перейдите в раздел Compute Cloud. По умолчанию откроется страница со списком ВМ. В столбце справа указан идентификатор каждой ВМ.<br />Используйте для входа идентификатор ВМ и имя (логин) созданного в ней пользователя. Вот шаблон команды подключения для Linux: ssh -t -p 9600 -o IdentitiesOnly=yes -i ~/.ssh/&lt;имя закрытого ключа&gt; &lt;ID виртуальной машины&gt;.&lt;имя пользователя&gt;@serialssh.cloud.yandex.net <br />Вот так вы подключитесь к консоли, если в ВМ с ID fhm0b28lgfp4tkoa3jl6 есть пользователь yc-user: ssh -t -p 9600 -o IdentitiesOnly=yes -i ~/.ssh/id_rsa fhm0b28lgfp4tkoa3jl6.yc-user@serialssh.cloud.yandex.net <br />Чтобы отключиться от серийной консоли, нажмите клавишу Enter, а затем введите символы ~. (тильда и точка). В терминалах Linux для отключения также можно использовать комбинацию клавиш Ctrl + D.<br /><strong>Task:</strong><br />Вход через консоль управления<br /><strong>Decision:</strong><br />В консоли управления откройте страницу ВМ и через меню слева перейдите на страницу Серийная консоль. При авторизации используйте логин, указанный при создании ВМ, и пароль, который вы установили после подключения к ней.<br /><strong>Decision:</strong><br />$ sudo passwd david<br />$ exit<br />$ ssh -t -p 9600 -o IdentitiesOnly=yes -i davidk fhmm3t1r6n0e6s5q2u3h.david@serialssh.cloud.yandex.net<br /><strong>Task:</strong><br />Создаем ВМ с 5% vCPU и учимся использовать мониторинг<br />Давайте создадим ВМ с гарантированной долей vCPU, равной 5%, и проверим её производительность.<br /><strong>Decision:</strong><br />В консоли управления перейдите в раздел Compute Cloud и нажмите кнопку Создать ВМ. Заполните имя и описание, выберите операционную систему CentOS 7.<br />В блоке Вычислительные ресурсы выберите платформу Intel Cascade Lake и укажите гарантированную долю vCPU 5%. Другие параметры оставьте по умолчанию.<br />После создания и запуска ВМ в списке машин нажмите её название. Вы перейдёте на страницу ВМ. Затем на левой боковой панели выберите Мониторинг. Откроется страница, где в динамике показывается информация о загрузке процессора, операциях с диском и сетевой активности. По умолчанию видны данные за одни сутки (1d &mdash; 1 day).<br />Переключитесь на один час: вверху слева нажмите 1h (1 hour).<br />На графике видно, что при запуске использование процессорных ресурсов было высоким, а позже снизилось до приемлемого. Чтобы посмотреть точные значения в определённый момент, поместите указатель над линией графика. Вы увидите всплывающее окно с показателями для этой точки времени.<br />Теперь удалите ВМ. Для этого сначала остановите её &mdash; вернитесь в список ВМ, отметьте нужную ВМ и на появившейся внизу контекстной панели нажмите Остановить.<br />Во всплывающем окне подтвердите действие и нажмите кнопку Остановить. Дождитесь смены статуса на Stopped.<br />Чтобы удалить ВМ, в списке ВМ справа напротив машины нажмите ... и в раскрывшемся меню выберите Удалить. Подтвердите действие. Через некоторое время ВМ будет удалена.<br /><strong>Task:</strong><br />Создаем снимок диска ВМ<br />Допустим, вы планируете обновить ПО на виртуальной машине ВМ. Вы знаете, что взаимодействие приложений и системных сервисов после обновления может нарушиться, а данные могут быть повреждены. Поэтому хотите иметь резервную копию полностью работоспособной системы на случай неудачи.<br />Давайте на практике разберём, как сделать снимок и восстановить из него ВМ при повреждении системы. Для этого используем ВМ, на которой развернута система на основе Ubuntu или CentOS.<br /><strong>Decision:</strong><br />В первую очередь обеспечьте целостность данных. Для этого подключитесь к ВМ по SSH. Чтобы записать кеш операционной системы на диск, выполните команду sync (иначе изменения файлов, хранящиеся в оперативной памяти, будут потеряны). Диски в Linux монтируются в ОС в виде файлов. Чтобы узнать нужный файл устройства диска, выполните команду df -h для вывода полного списка устройств и соответствующих точек монтирования. Затем, чтобы заморозить файловую систему, выполните команду fsfreeze -f &lt;точка монтирования&gt;.<br />В консоли управления откройте раздел Compute Cloud и перейдите на вкладку Диски. Справа от диска нажмите ... и выберите Создать снимок.<br />В открывшемся окне вы увидите автоматически сформированное имя снимка диска. Оно состоит из идентификатора диска и идентификатора снимка. Вы можете переименовать снимок и заполнить его описание. После этого нажмите кнопку Создать.<br />Откройте Снимки дисков. Как только снимок будет создан, статус операции сменится с Creating на Ready.<br />Разморозьте файловую систему. Для этого в командной строке с интерфейсом подключения к ВМ по SSH выполните команду fsfreeze --unfreeze &lt;точка монтирования&gt;.<br />Теперь протестируйте обновление системы: в командной строке с интерфейсом подключения к ВМ по SSH последовательно выполните команды apt-get update и apt-get dist-upgrade. Дождитесь, пока обновление завершится. Важно! Перед выполнением следующей команды убедитесь в том, что находитесь в консоли именно тестовой ВМ.<br />Сымитируйте повреждение системы: выполните команду sudo rm -rf --no-preserve-root /. Вы увидите предупреждение, что все данные на диске будут удалены. Подтвердите своё намерение.<br />Поскольку снимок создан с загрузочного диска, который всегда подключён к ВМ, для восстановления создайте новую ВМ вместо старой. При создании загрузочного диска машины выберите готовый снимок диска. Для этого в блоке Выбор образа/загрузочного диска перейдите на вкладку Пользовательские и нажмите кнопку Выбрать. В открывшемся окне перейдите на вкладку Снимок, выберите нужный снимок и нажмите кнопку Применить.<br />Дождитесь завершения создания и запуска новой ВМ. Теперь старую ВМ можно остановить и удалить.<br /><strong>Decision:</strong><br />$ ssh -i ubcloud test138@51.250.93.58<br />$ sudo fsfreeze -f /mnt<br />$ sudo fsfreeze --unfreeze /mnt<br />$ sudo apt-get update<br />$ sudo apt-get dist-upgrade<br />$ sudo rm -rf --no-preserve-root /<br /><strong>Task:</strong><br />Создание новой сети с подсетями и ВМ. <br />Облачные сети (сервис Virtual Private Cloud или VPC) являются частью публичного облака, которая связывает пользовательские, инфраструктурные, платформенные и прочие ресурсы воедино, где бы они ни находились &mdash; в нашем облаке или за его пределами. При этом VPC позволяет не публиковать эти ресурсы в интернете без необходимости, они остаются в пределах вашей изолированной сети.<br />Когда вы создаёте облако, в нём автоматически создаются сеть default и подсети в каждой зоне доступности. Но иногда их бывает недостаточно. В этой практической работе вы научитесь создавать облачную сеть и добавлять подсети самостоятельно.<br />Рассмотрим пример, как настроить облачную сеть, чтобы организовать работу сервера с доступом из интернета. <br />Сначала создадим единую для всех ресурсов облака изолированную сеть с подсетями и виртуальной машиной.<br /><strong>Decision:</strong><br />В консоли управления перейдите на страницу сервиса Virtual Private Cloud (Дашборд каталога &rarr; Virtual Private Cloud) и нажмите кнопку Создать сеть вверху справа. Введите имя сети (пусть она называется yc), поле Описание заполнять необязательно. Оставьте выбранной опцию Создать подсети и нажмите кнопку Создать сеть. В результате будут созданы сеть yc и три подсети: yc-ru-central1-a, yc-ru-central1-b и yc-ru-central1-c.<br />Для сервера создадим ещё одну подсеть с маской /28. Перейдите на страницу сети yc (Дашборд каталога &rarr; Virtual Private Cloud &rarr; сеть yc) и нажмите кнопку Добавить подсеть. Введите параметры подсети: Имя &mdash; yc-public, Зона &mdash; ru-central1-a, CIDR &mdash; 192.168.0.0/28. Нажмите кнопку Создать подсеть.<br />Доступом пользователей облака к сетевым ресурсам управляют с помощью назначения ролей.<br />Теперь создайте ВМ с именем web-server и ОС Ubuntu 22.04. Убедитесь, что в блоке Базовые параметры выбрана зона доступности ru-central1-a. В блоке Сетевые настройки выберите Подсеть yc-public. В блоке Доступ введите логин пользователя (например user) и вставьте открытый SSH-ключ в соответствующее поле. Чтобы ВМ полноценно заработала, для неё нужно организовать доступ в интернет. Есть три способа:<br />- Назначить ВМ публичный IP-адрес. Для этого выберите автоматический способ назначения IP-адреса, когда создаёте ВМ, или привяжите его к уже созданной.<br />- Использовать NAT-шлюз, который позволяет дать ВМ доступ в интернет без назначения ей публичного IP-адреса. Самому шлюзу адрес выделяется из отдельного диапазона публичных IP-адресов.<br />- Использовать NAT-инстанс &mdash; отдельную ВМ со статическим публичным IP-адресом и настроенными правилами маршрутизации трафика.<br />С точки зрения безопасности лучше выбирать второй или третий способ. В этом примере для упрощения присвойте ВМ публичный IP-адрес &mdash; в поле Публичный адрес выберите опцию Автоматически.<br />После создания ВМ проверьте её доступность, чтобы убедиться в том, что сетевая конфигурация настроена правильно. Для этого перейдите на страницу Обзор созданной ВМ (Дашборд каталога &rarr; Compute Cloud &rarr; ВМ web-server) и в блоке Сеть найдите её публичный IP-адрес. Откройте интерфейс командной строки на своём компьютере и введите команду:<br />$ ping 51.250.78.143 <br /><strong>Task:</strong><br />Давайте попробуем создать группу безопасности и сделать доступными страницы, предоставляемые веб-сервером NGINX.<br /><strong>Decision:</strong><br />Перейдите по ссылке https://console.cloud.yandex.ru/link/vpc/security-groups и нажмите кнопку Создать группу.<br />Введите имя группы yc-security и выберите сеть yc.<br />В блоке Правила добавьте правила для исходящего трафика. Опишите правило, укажите диапазон портов 80 (HTTP) и протокол TCP, выберите назначение "CIDR" 0.0.0.0/0 . Создайте аналогичные исходящие правила для портов 443 (HTTPS) и 22 (SSH). Для входящего трафика добавьте правила для 80 и 22 портов, чтобы подключаться к веб-серверу и управлять ВМ извне. Вы увидите созданную группу в списке групп безопасности. Если инициировано соединение по определенному порту и протоколу с ВМ и есть исходящее правило, то значит и на входящий трафик будет разрешена передача данных в эту же сеть, на этот же протокол и порт. Если назначить сетевому интерфейсу ВМ группу безопасности без правил, ВМ не сможет передавать и принимать трафик.<br />Создайте виртуальную машину на базе Ubuntu 20.04, выберите сеть yc и вновь созданную группу безопасности yc-security в сетевых настройках создаваемой ВМ, дождитесь запуска машины, подключитесь к ВМ по SSH и установите веб-сервер NGINX (по умолчанию он отсутствует). Для этого выполните команду:<br />Установка возможна, поскольку вы открыли порт 80: команда apt-get использует его для получения пакетов с ПО.<br />После установки сервер автоматически запустится и будет доступен извне благодаря открытому порту 80. Проверьте это, зайдя через браузер на публичный IP-адрес ВМ, который найдёте на странице параметров машины в консоли управления.<br /><strong>Decision:</strong><br />$ sudo apt-get install nginx<br /><strong>Task:</strong><br />Знакомство с Yandex Cloud CLI.<br /><strong>Decision:</strong><br />Развернём две ВМ, запустим на них веб-серверы NGINX и поместим их за балансировщик. Создавать ВМ через консоль управления облаком вы уже умеете. Вот только для реальных проектов часто приходится разворачивать далеко не одну-две ВМ. В этом случае работать через консоль управления долго и неудобно, да и вероятность ошибиться, выполняя много однотипных операций вручную, растёт. Решить эту проблему можно с помощью автоматизации, а один из самых простых способов это сделать &mdash; использовать интерфейс командной строки (CLI, Command Line Interface).<br />Установите на свой компьютер утилиту yc, которая представляет собой интерфейс командной строки Yandex Cloud CLI, и настройте её (создайте профиль) по инструкции в документации.<br />Создайте файл startup.sh Скрипт, который получает список актуальных пакетов с софтом, устанавливает и запускает NGINX, а затем меняет информационную страницу работающего сервера.<br />Создайте первую ВМ с помощью команды yc compute instance create. Чтобы указать, какую именно ВМ мы хотим создать, в команде используются параметры. В данном случае &mdash; имя ВМ (--name demo-1), откуда взять метаданные (из файла скрипта startup.sh, созданного ранее), из какого образа создать загрузочный диск (ubuntu-2004-lts), в какой зоне создать машину (--zone ru-central1-a) и в какую подсеть подключить сетевой интерфейс с IPv4-адресом (--network-interface ...).<br />Самостоятельно измените и запустите еще раз эту команду, чтобы создать такую же ВМ с именем demo-2.<br />Теперь проверим, что обе ВМ успешно созданы. Это можно сделать, заглянув в консоль управления. А можно и из командной строки с помощью команды yc compute instance list. Попробуйте этот способ. <br />Убедитесь, что статус машин сменился на Running, а скрипт выполнился (иногда нужно подождать до одной минуты, пока обновится список пакетов и установится NGINX).<br />Введите публичные IP-адреса ВМ в браузере и проверьте, что главные страницы веб-серверов доступны<br /><strong>Decision:</strong><br />$ curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash<br />$ sudo reboot<br />$ yc init<br />$ yc config list<br />$ yc resource-manager folder add-access-binding default \<br />--role compute.images.user \<br />--subject system:allAuthenticatedUsers<br />$ yc compute image list --folder-id standard-images<br />$ vim startup.sh<br />$ cat startup.sh<br />#!/bin/bash<br />apt-get update<br />apt-get install -y nginx<br />service nginx start<br />sed -i -- "s/nginx/Yandex Cloud - ${HOSTNAME}/" /var/www/html/index.nginx-debian.html<br />EOF<br />$ chmod +x startup.sh<br />$ yc compute instance create \<br />--name tcloud-ubuntu3 \<br />--hostname tcloud-ubuntu3 \<br />--metadata-from-file user-data=startup.sh \<br />--create-boot-disk image-folder-id=standard-images,image-family=ubuntu-2004-lts \<br />--zone ru-central1-a \<br />--network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4<br />$ yc compute instance create \<br />--name tcloud-ubuntu4 \<br />--hostname tcloud-ubuntu4 \<br />--metadata-from-file user-data=startup.sh \<br />--create-boot-disk image-folder-id=standard-images,image-family=ubuntu-2004-lts \<br />--zone ru-central1-a \<br />--network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4<br />$ yc compute instance list<br /><strong>Task:</strong><br />Создание балансировщика<br />Итак, у вас есть виртуальные машины. Можно сразу создать и балансировщик, и целевую группу, но мы поступим иначе: сначала создадим целевую группу, затем подключим её к балансировщику.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Network Load Balancer, на вкладке Целевые группы нажмите кнопку Создать целевую группу. На открывшейся странице введите имя целевой группы (например demo-web), выберите обе ВМ, созданные на предыдущем уроке, и нажмите кнопку Создать.<br />Остаётся создать балансировщик. Для этого сначала создайте обработчик и настройте проверку состояния ресурсов в целевой группе:<br />На вкладке Балансировщики нажмите кнопку Создать сетевой балансировщик.<br />Заполните имя балансировщика (например lb-demo-web) и нажмите кнопку Добавить обработчик.<br />В открывшемся окне введите имя обработчика (например demo-web-listener). В качестве портов укажите 80и нажмите кнопку Добавить.<br />После создания обработчика нажмите кнопку Добавить целевую группу. Укажите имя проверки состояния (например hc-demo-web), тип проверки (HTTP), порт (80), интервал отправки проверок состояния в секундах, порог работоспособности и порог неработоспособности. Оставьте указанный по умолчанию путь для проверок, используйте значения по умолчанию и для других параметров. Нажмите кнопку Применить, а затем кнопку Создать.<br />После создания балансировщика проверьте состояние ресурсов: в консоли управления откройте страницу балансировщика и убедитесь, что его статус &mdash; Active. Значит, балансировщик готов передавать трафик целевым ресурсам.<br />Перейдите на страницу балансировщика и посмотрите на блок Целевые группы. У запущенных ВМ, готовых принимать трафик, будет статус Healthy.<br />Введите внешний IP-адрес балансировщика в адресную строку браузера &mdash; и балансировщик перенаправит вас на одну из машин целевой группы. Обратите внимание на имя ВМ, указанное во второй строке веб-страницы.<br />Чтобы протестировать отказоустойчивость, в консоли управления перейдите в раздел Compute Cloud и остановите одну из ВМ целевой группы.<br />Вернитесь на страницу балансировщика и убедитесь, что статус остановленной ВМ изменился на Unhealthy. Это означает, что целевой ресурс группы не прошёл проверку состояния и не готов принимать трафик.<br />Обновите страницу с IP-адресом балансировщика, и вы увидите, что трафик перенаправлен на другую ВМ (изменилось имя ВМ, указанное во второй строке веб-страницы).<br />После завершения работы не забудьте удалить использованные ресурсы: две ВМ и балансировщик.<br /><strong>Task:</strong><br />Создание группы виртуальных машин<br />Иногда вам требуется не автоматическое масштабирование, а автоматическое восстановление ВМ. <br />Например, если вы отлаживаете работу веб-сервиса, который периодически падает. <br />Для этого подойдут группы ВМ фиксированного размера. Давайте создадим и настроим такую группу.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Compute Cloud, перейдите на вкладку Группы виртуальных машин и нажмите кнопку Создать группу.<br />Откроется страница Создание группы виртуальных машин.<br />В блоке Базовые параметры введите имя и описание группы ВМ. Создайте новый сервисный аккаунт. Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, назначьте сервисному аккаунту роль editor. По умолчанию все операции в группе ВМ выполняются от имени сервисного аккаунта.<br />ВМ группы могут находиться в разных зонах и регионах. В блоке Распределение выберите две зоны доступности, чтобы обеспечить доступность сервиса, если в одной из них случится сбой.<br />В блоке Шаблон виртуальной машины нажмите кнопку Задать.<br />Шаблон создается так же, как и сама ВМ. В блоке Базовые параметры введите описание шаблона конфигурации, затем в блоке Выбор образа/загрузочного диска на вкладке Операционные системы выберите Ubuntu.<br />В блоках Диски и Вычислительные ресурсы для загрузочного диска оставьте значения по умолчанию. В блоке Сетевые настройки выберите существующую сеть и подсеть или создайте новые. В блоке Доступ выберите существующий или создайте новый сервисный аккаунт, укажите логин, вставьте в поле SSH-ключ содержимое файла с публичным ключом, доступ к серийной консоли не разрешайте.<br />Сохраните параметры и вы вернётесь на страницу Создание группы виртуальных машин.<br />В блоке В процессе создания и обновления разрешено установите политику развертывания: Добавлять выше целевого значения (на сколько ВМ можно превышать размер группы) &mdash; 2. Уменьшать относительно целевого значения (на сколько ВМ можно уменьшать размер группы) &mdash; 1. Одновременно создавать (сколько ВМ можно сразу создавать в группе) &mdash; 2. Время запуска (сколько времени должно пройти, прежде чем будут пройдены все проверки состояния и ВМ начнет получать нагрузку) &mdash; 2 минуты. Одновременно останавливать (сколько ВМ можно сразу удалять) &mdash; 1. Останавливать машины по стратегии &mdash; Принудительная. При принудительной стратегии Instance Groups самостоятельно выбирает, какие ВМ остановить.<br />В блоке Масштабирование выберите фиксированный тип, Размер (количество ВМ) &mdash; 3.<br />В блоке Интеграция с Load Balancer оставьте опцию Создать целевую группу выключенной. Не включайте пока проверку состояний, которая позволяет Instance Groups получать сведения о состоянии ВМ.<br />Нажмите кнопку Создать и вернитесь на страницу Группы виртуальных машин. В правом нижнем углу появится сообщение &laquo;Группа виртуальных машин создаётся&raquo;. Одновременно можно создавать не более двух ВМ. Поэтому сначала будут созданы две ВМ, потом &mdash; третья.<br />После того как вы создали группу, протестируйте включение и выключение всех машин сразу. Обратите внимание: в соответствии с настройками сервис инициирует запуск не более двух машин одновременно. Третья ВМ будет оставаться остановленной. Как только первая будет запущена, один слот на запуск освободится, поэтому сразу будет инициирован запуск третьей и последней ВМ.<br /><strong>Task:</strong><br />Автоматическое масштабирование под нагрузкой<br />Давайте разберёмся, как обеспечить доступность сервиса под высокой нагрузкой. Вы уже научились создавать группы ВМ. Теперь создадим автоматически масштабируемую группу ВМ.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Compute Cloud. Перейдите на вкладку Группы виртуальных машин и нажмите кнопку Создать группу. Задайте имя группе ВМ.<br />Создайте сервисный аккаунт. Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, назначьте сервисному аккаунту роль editor. По умолчанию все операции в группе ВМ выполняются от имени сервисного аккаунта.<br />В блоке Распределение выберите только одну зону доступности.<br />В блоке Шаблон виртуальной машины нажмите кнопку Задать. В открывшемся окне выберите: ОС: Ubuntu 20.04. Размер загрузочного диска: 50 ГБ. Тип загрузочного диска: SSD.<br />Остальные параметры &mdash; по умолчанию. Не забудьте добавить публичный SSH-ключ. Он понадобится нам на следующем практическом занятии.<br />В блоке В процессе создания и обновления разрешено оставьте параметры по умолчанию.<br />Перейдите к блоку Масштабирование и выберите тип Автоматический.<br />Задайте параметры масштабирования: Тип автомасштабирования &mdash; зональное. При зональном автомасштабировании количество ВМ регулируется отдельно в каждой зоне доступности, указанной в настройках группы. Минимальное количество ВМ в зоне &mdash; 2. Сервис Instance Groups не будет удалять ВМ в зоне доступности, если их там всего две. Максимальный размер группы &mdash; 4. Instance Groups не будет создавать ВМ, если их уже четыре. В этот раз размер загрузочного диска ВМ &mdash; 50 ГБ, поэтому с учётом квот на суммарный объём SSD-дисков в одном облаке смогут запуститься четыре ВМ. Промежуток измерения загрузки (это период усреднения: время, за которое следует усреднять замеры нагрузки для каждой ВМ в группе) &mdash; 60 секунд. Время на разогрев ВМ &mdash; 3 минуты. В течение этого времени ВМ не учитывается в измерении средней нагрузки на группу. Фактически данное время мы можем определить, измерив, как быстро запускается ВМ. Период стабилизации &mdash; 5 минут. Отсчитывается с момента, когда Compute Cloud принял последнее решение о том, что количество ВМ в группе нужно увеличить. Начальный размер группы &mdash; 4. Это количество ВМ, которое следует создать вместе с группой.<br />В блоке Метрики укажите: Тип &mdash; CPU. Целевой уровень загрузки CPU, % &mdash; 80. Instance Groups будет управлять размером группы так, чтобы поддерживать указанную нагрузку CPU.<br />Нажмите кнопку Создать. Сервис начнет создавать ВМ. После создания статус группы изменится на Active. Обратите внимание, как меняются Состояния ВМ.<br />Creating instance &mdash; ВМ создаётся и запускается. Awaiting warmup duration &mdash; ВМ начинает принимать сетевой трафик. В этом статусе ВМ находится в течение периода прогрева, указанного в настройках автоматического масштабирования. Значения метрик ВМ в этом статусе заменяются средними значениями ВМ из той же зоны доступности. Running actual &mdash; ВМ запущена, на неё подается сетевой трафик, пользовательские приложения работают.<br />Группа ВМ готова принимать рабочую нагрузку.<br /><strong>Task:</strong><br />Воссоздание виртуальных машин в группе.<br />Давайте сымитируем рост нагрузки на ВМ и посмотрим, как сервис на это отреагирует.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Compute Cloud и перейдите на страницу группы ВМ, которую вы создали на прошлом практическом занятии. Откройте в двух вкладках браузера страницы Группы виртуальных машин и Мониторинг (открывается из раздела Группы виртуальных машин).<br />После запуска группы зайдите по SSH на каждую из двух ВМ и установите приложение для стресс-тестирования Linux-систем. Для этого выполните команду: sudo apt-get install stress <br />После этого для каждой ВМ запустите установленное приложение: stress -c 2 <br />Аргумент -c означает, что при тестировании будет нагружаться процессор, а число после аргумента задаёт количество ядер процессора, которые будут нагружаться. Чтобы эксперимент удался &mdash; укажите количество ядер, которое вы выбрали в шаблоне ВМ. На вкладке со страницей мониторинга на графике Average CPU utilization in ru-central1-a следите за тем, как усреднённое значение нагрузки будет постепенно расти.<br />Как только усреднённое значение нагрузки превысит порог, сервис Instance Groups начнёт прогревать две дополнительные ВМ и вводить их в строй. Это будет видно на странице Группы виртуальных машин.<br />Поскольку стресс-тест не остановлен, сервис завершает запуск двух ВМ.<br />Через некоторое время усреднённое значение нагрузки процессоров в группе упадёт до 50%, поскольку первая половина ВМ загружена полностью, а вторая не загружена вовсе. Остановите работу стресс-теста на первой ВМ. В командной строке используйте сочетание клавиш Ctrl + C.<br />Через некоторое время усреднённое значение достигнет 25%, тогда Instance Groups удалит лишнюю ВМ. Остановите второй стресс-тест. Через некоторое время после того, как усредненное значение достигнет нуля, Instance Groups удалит вторую дополнительную ВМ. При минимальной нагрузке остаются работать две машины.<br />Вот так при растущей нагрузке группа ВМ автоматически масштабируется, чтобы обеспечить доступность ресурса.<br /><strong>Decision:</strong><br />$ ssh -i YOUR-KEY YOUR-USERNAME1@YOUR-IP1<br />$ sudo apt-get install stress <br />$ stress -c 2<br />$ ssh -i YOUR-KEY YOUR-USERNAME2@YOUR-IP2<br />$ sudo apt-get install stress <br />$ stress -c 2</p>
                    </div>
                </div> 
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Хранение и анализ данных в Yandex Cloud</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты практической работы по теме "Хранение и анализ данных в Yandex Cloud" развернул пять кластеров баз данных MySQL, PostgreSQL, MongoDB, ClickHouse и Ydb, добавил данные из файлов в БД ClickHouse для анализа прогноза за всю историю наблюдений за последние несколько лет с помощью SQL-запросов, добавил данные из тестового приложения для подключения к БД YDB, запуска тестового приложения, чтобы создать в ней несколько таблиц с данными о популярных сериалах, реализовал систему хранения рентгеновских снимков для клиники, развернул кластер Hadoop с помощью сервиса Yandex Data Proc<br /><strong>Task:</strong><br />Создание бакетов и загрузка объектов<br />Потренируемся работать с объектным хранилищем на практике. Представьте, что вы создаёте облачную систему хранения рентгеновских снимков для крупной клиники.<br />Рентгеновские снимки &mdash; это неструктурированные данные, которые нельзя изменять, нужно надежно хранить и легко находить. <br />Загруженные файлы будут скачивать нечасто. Также важно предоставлять доступ к файлам другим клиникам (это пригодится, если пациента переводят или врачу надо посоветоваться с коллегами). Объектное хранилище &mdash; подходящее решение задачи.<br /><strong>Decision:</strong><br />Выберите на стартовой странице консоли управления сервис Object Storage.<br />Давайте создадим бакет для рентгеновских снимков.<br />Нажмите кнопку Создать бакет. Откроется окно с основными параметрами: <br />Имя. Придумайте его с учетом правил. Обратите внимание, что дать бакету имя hospital не получится. Имена бакетов во всем Yandex Object Storage уникальны &mdash; назвать два бакета одинаково нельзя даже в разных облаках. Помните об этом, если будете создавать бакеты автоматически.<br />Макс. размер. У вас есть два варианта: Выбрать опцию Без ограничения. Размер бакета будет увеличиваться, сколько бы объектов в него ни помещали. Указать максимальный размер. Это убережёт вас от финансовых потерь, если что-то пойдёт не так и в бакет загрузится слишком много объектов.<br />Другие опции. Далее для всех типов операций оставьте ограниченный доступ (публичный позволяет выполнять операции всем пользователям интернета), выберите стандартный класс хранилища и нажмите кнопку Создать бакет.<br />На странице объектного хранилища появился пустой бакет. Мы приготовили два рентгеновских снимка: image01.dat и image02.dat. Файлы можно загрузить в бакет с помощью: консоли управления; приложений; S3-совместимого HTTP API; HTML-форм на сайте.<br />Разберём два способа: ручную загрузку через консоль управления и автоматическую с помощью утилиты S3cmd.<br />Для загрузки файла через консоль управления выберите созданный бакет и в открывшемся окне нажмите кнопку Загрузить объекты.<br />Выберем файл image01.dat. В появившейся форме нажмите кнопку Загрузить &mdash; и вы увидите, что файл оказался в хранилище.<br />Загрузите второй файл с помощью утилиты S3cmd &mdash; консольного клиента для Linux и MacOS, предназначенного для работы с S3-совместимым HTTP API. Для работы в Windows используйте один из вариантов:&nbsp; установите другой консольный клиент для объектных хранилищ, например AWS CLI;&nbsp; установите подсистему Linux на Windows с помощью утилиты WSL (Windows Subsystem for Linux) и работайте с S3cmd в ней; создайте в облаке виртуальную машину с Ubuntu и работайте с S3cmd в ней. Для загрузки файла-примера в виртуальную машину воспользуйтесь командой:<br />$ wget "https://disk.yandex.ru/i/2UlugGkurhcxWw" -O image02.dat <br />Установите S3cmd (в Ubuntu, например, это делается с помощью команды sudo apt-get install s3cmd). Теперь настройте S3cmd для работы с Yandex Object Storage:<br />$ s3cmd --configure<br />Инструкции о настройке клиента вы найдете в документации.<br />После ввода параметров утилита попытается установить соединение с объектным хранилищем и в случае успеха покажет такое сообщение: Success. Your access key and secret key worked fine :-)<br />Загрузим в бакет второй файл (image02.dat) и затем получим список хранящихся в бакете объектов:<br />s3cmd put &lt;путь к второму файлу&gt;/image02.dat s3://&lt;имя бакета&gt;<br />s3cmd ls s3://&lt;имя бакета&gt;<br />Вернемся в консоль управления.<br />Мы видим, что класс хранилища у обоих объектов &mdash; стандартное. Напомним: стандартное хранилище подходит для данных, к которым обращаются часто, а тариф за размещение данных в нем примерно в два раза выше, чем в холодном хранилище.<br />Спустя несколько недель после того, как рентгеновский снимок сделан, к нему будут редко обращаться (если вообще будут), потому что пациент, скорее всего, выздоровеет.<br />Чтобы оптимизировать затраты на хранение данных, настроим жизненный цикл объектов в бакете. Создадим правило, согласно которому через 30 дней после загрузки объектов в бакет класс их хранилища будет автоматически меняться со стандартного на холодное.<br />Перейдите на вкладку Жизненный цикл и нажмите кнопку Настроить. Задайте произвольное описание. В поле Префикс укажите Все объекты. Выберите тип операции Transition. В качестве Условия срабатывания правила задайте Точную дату или Количество дней. В первом случае правило сработает в 00:00 установленной даты. Во втором &mdash; через указанное количество дней после загрузки объекта в бакет.<br />Если понадобится настроить автоматическое удаление объектов, выберите тип операции Expiration. Нажмите кнопку Сохранить.<br />Представим теперь, что объекты в хранилище &mdash; это оцифрованные рентгеновские снимки пациента Петрова. Первый из них (image01.dat) сделали несколько месяцев назад в ходе профосмотра, а второй (image02.dat) &mdash; вчера, после того как Петров обратился к врачу с жалобой на недомогание. В обоих случаях на снимках не увидели патологий.<br />Опишите с помощью пользовательских метаданных эти снимки, и позже вы быстро найдете их среди множества объектов в бакете.<br />С помощью утилиты S3cmd задайте для загруженных объектов метаданные с фамилией пациента (x-amz-meta-patient:petrov) и с результатами обследования (x-amz-meta-status:ok):<br />&nbsp;s3cmd modify --add-header=x-amz-meta-patient:petrov --add-header=x-amz-meta-status:ok s3://hospital/image01.dat s3://hospital/image02.dat<br />Выведите на экран информацию об этих объектах, чтобы проверить, что получилось:<br />&nbsp;s3cmd info s3://hospital/image01.dat s3://hospital/image02.dat<br />В результате вы должны увидеть информацию об объектах в бакете.<br />s3://hospital/image01.dat (object):<br />&nbsp;&nbsp; File size: 33<br />&nbsp;&nbsp; Last mod:&nbsp; Thu, 04 Mar 2021 22:05:31 GMT<br />&nbsp;&nbsp; MIME type: application/x-www-form-urlencoded<br />&nbsp;&nbsp; Storage:&nbsp;&nbsp; STANDARD<br />&nbsp;&nbsp; MD5 sum:&nbsp;&nbsp; 6f6d5a1cb79839e523582ed8810a42fd<br />&nbsp;&nbsp; SSE:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; none<br />&nbsp;&nbsp; Policy:&nbsp;&nbsp;&nbsp; none<br />&nbsp;&nbsp; CORS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; none<br />&nbsp;&nbsp; x-amz-meta-patient: petrov<br />&nbsp;&nbsp; x-amz-meta-status: ok<br />s3://hospital/image02.dat (object):<br />&nbsp;&nbsp; File size: 16<br />&nbsp;&nbsp; Last mod:&nbsp; Thu, 04 Mar 2021 23:11:27 GMT<br />&nbsp;&nbsp; MIME type: text/plain<br />&nbsp;&nbsp; Storage:&nbsp;&nbsp; STANDARD<br />&nbsp;&nbsp; MD5 sum:&nbsp;&nbsp; 0366a1d19e584ce79d5c05ddedc69310<br />&nbsp;&nbsp; SSE:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; none<br />&nbsp;&nbsp; Policy:&nbsp;&nbsp;&nbsp; none<br />&nbsp;&nbsp; CORS:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; none<br />&nbsp;&nbsp; x-amz-meta-patient: petrov<br />&nbsp;&nbsp; x-amz-meta-status: ok <br />Предположим, Петров чувствует себя хуже. Судя по анализам, он действительно болен. Лечащий врач решает проконсультироваться с более опытной коллегой Ивановой из профильной клиники. Объекты в бакете недоступны для внешних пользователей, поскольку при его создании мы ограничили доступ. Чтобы Иванова увидела рентгеновский снимок Петрова, отправим ей временную ссылку на объект image02.dat.<br />Для этого в консоли управления кликните на объект и в открывшемся окне информации об объекте нажмите кнопку Получить ссылку. Укажите время жизни ссылки в часах или днях.<br />Можно поделиться ссылкой или использовать ее в любом сервисе для доступа к файлу.<br />После консультации Иванова поставила Петрову правильный диагноз: вирусная пневмония (код J12 по Международной классификации болезней). Вам осталось исправить метаданные объекта image02.dat. Замените значение метаданных с результатами обследования с ok на J12 самостоятельно.<br /><strong>Decision:</strong><br />$ wget "https://disk.yandex.ru/i/2UlugGkurhcxWw" -O image02.dat <br />$ wget "https://disk.yandex.ru/i/qpl0T4u-nWPgiw" -O image01.dat <br />$ ls *.dat<br />image01.dat&nbsp; image02.dat<br />$ sudo apt-get install s3cmd<br />$ s3cmd --configure<br />$ s3cmd ls<br />2023-12-06 02:37&nbsp; s3://klinika138<br />$ s3cmd put /YOUR-DIR/image02.dat s3://klinika138<br />$ s3cmd modify \<br />--add-header=x-amz-meta-patient:petrov \<br />--add-header=x-amz-meta-status:ok \<br />s3://klinika138/image01.dat \<br />s3://klinika138/image02.dat<br />$ s3cmd info \<br />s3://klinika138/image01.dat \<br />s3://klinika138/image02.dat <br /><strong>Task:</strong><br />Хранение статических веб-сайтов в Object Storage<br />Представьте, что вам нужно выбрать оптимальный хостинг для сайта клиники. Главные критерии: отказоустойчивый, недорогой и простой в обслуживании. <br />Один из вариантов решения такой задачи &mdash; использовать объектное хранилище. Вы можете, не настраивая никаких серверов, просто загрузить HTML-файлы, скрипты, стили и другие файлы в хранилище. Пользователи будут открывать в браузере ваш сайт, а по сути &mdash; скачивать файлы прямо из бакета.<br />Важно понимать, что этот вариант подойдет только для полностью статических сайтов. Иными словами, сайт должен быть сделан с помощью клиентских технологий (HTML, CSS и JavaScript) и не требовать запуска чего-либо на стороне веб-сервера.<br />Предположим, что сайт нашей клиники как раз такой &mdash; полностью статический. Опубликуйте его с помощью объектного хранилища. Прежде всего для него нужно создать бакет:<br />Decision<br />Обратите внимание на несколько особенностей: Если вы планируете использовать собственный домен (например www.example.com), то присвойте бакету точно такое же имя. Откройте публичный доступ на чтение объектов. Это позволит пользователям интернета скачивать объекты из бакета и просматривать сайт в браузере.<br />Задайте необходимые настройки и нажмите кнопку Создать бакет.<br />Теперь загрузите в бакет файлы сайта (например, этот и этот) любым удобным способом.<br />Чтобы настроить хостинг, перейдите на страницу бакета в консоли управления. Выберите вкладку Веб-сайт на левой панели и включите опцию Хостинг.<br />Укажите файл с главной страницей сайта (как правило, это index.html), а поле со страницей ошибки можно не заполнять.<br />Сохраните настройки, и сайт станет доступен по адресам: <br />http(s)://&lt;имя_бакета&gt;.website.yandexcloud.net<br />http(s)://website.yandexcloud.net/&lt;имя_бакета&gt;<br />По умолчанию сайт будет доступен только по протоколу HTTP. Для поддержки HTTPS нужно загрузить в объектное хранилище TLS-сертификат. Вам предстоит это сделать в одной из практических работ курса &laquo;Безопасность&raquo;.<br />Если у вас есть собственный домен и вы хотите опубликовать сайт на нём, то настройте CNAME-запись у DNS-провайдера или на своем DNS-сервере. Например, для домена www.example.com CNAME-запись выглядела бы так: www.example.com CNAME www.example.com.website.yandexcloud.net <br />В этом случае можно использовать домены не ниже третьего уровня (то есть использовать домен example.com не получится, только www.example.com). Это связано с особенностями обработки CNAME-записей на DNS-хостингах.<br /><strong>Decision:</strong><br />$ wget "https://disk.yandex.ru/d/KcpMuYBwKjIa6Q" -O index.html<br />$ wget "https://disk.yandex.ru/i/uTai62_esPSaEw" -O doctor.png<br />$ s3cmd put /YOUR-DIR/doctor.png s3://www.aibloit.healthcare138<br />$ s3cmd put /YOUR-DIR/index.html s3://www.aibloit.healthcare138<br /><strong>Task:</strong><br />Создание кластера базы данных MySQL. Object Storage &mdash; удобный и полезный инструмент для хранения данных в облаке. Но для решения практических задач важно не просто хранить данные, но и иметь возможность их изменять и выполнять с ними различные операции (сортировать, группировать, делать выборки и так далее). Для этого используются базы данных. В этой и следующих темах вы научитесь работать с несколькими управляемыми БД. И начнем мы с одной из самых популярных &mdash; MySQL.<br />На этом уроке вы создадите и настроите кластер управляемой БД MySQL, подключитесь к нему, перенесёте данные в облако, познакомитесь с возможностями резервного копирования и мониторинга. Эти навыки пригодятся вам и в других сервисах управляемых БД, поскольку принципы работы в них очень похожи.<br />Предположим, вы решили добавить в разрабатываемый вами мессенджер новую функциональность. Вы написали микросервис, который позволяет оценивать сообщения в групповых чатах и хранит оценки в БД MySQL. Давайте поместим эту БД в Yandex Cloud.<br /><strong>Decision:</strong><br />Прежде всего понадобится создать кластер: набор виртуальных машин (ВМ, или хостов), на которых будет развёрнута БД. Это обязательный первый шаг при использовании любого сервиса управляемых БД.<br />Войдите в консоль управления Yandex Cloud и выберите каталог для кластера. Вверху справа нажмите кнопку Создать ресурс и выберите из выпадающего списка Кластер MySQL.<br />Откроется страница с основными настройками кластера. Рассмотрим их подробнее.<br />Базовые параметры. Имя кластера может включать только цифры, прописные и строчные латинские буквы, дефисы.<br />Поле Описание заполнять необязательно. Оно полезно, если вам нужно создать несколько кластеров для разных целей, чтобы в них было проще ориентироваться.<br />О том, какое бывает Окружение кластера и чем различаются PRESTABLE и PRODUCTION, мы говорили на одном из предыдущих уроков. Поскольку микросервис только разрабатывается, выберите окружение PRESTABLE.<br />Версия. В качестве сервера MySQL в Yandex Cloud используется Percona Server версии 5.7 или 8.0. У этих реализаций сервера улучшенная производительность на многоядерных машинах. Если для вас критична стабильность работы микросервиса, выбирайте проверенную временем 5.7. Для нашей задачи подойдёт 8.0: в ней много новых функций, но она ещё не полностью обкатана.<br />Класс хостов. Следующий шаг &mdash; выбор класса хостов, или шаблона ВМ. Хосты кластера будут развёрнуты на базе ВМ Compute Cloud с использованием этого шаблона.<br />Платформа определяет тип физического процессора (Intel Broadwell или Intel Cascade Lake), а также конфигурации числа ядер виртуального процессора (vCPU) и размера оперативной памяти.<br />Если тип процессора для вас неважен, выбирайте более современную платформу Intel Cascade Lake. Она предоставляет широкий выбор конфигураций вычислительных ресурсов.<br />Также на конфигурации влияет тип ВМ, на которой будет развёрнута БД.<br />Standard &mdash; это обычные ВМ с 4 ГБ RAM на ядро vCPU. Это оптимальный баланс между количеством запущенных процессов, быстродействием и потребляемой оперативной памятью.<br />Memory-optimized &mdash; машины с вдвое увеличенным объёмом RAM на каждое ядро. Выбирайте их для высоконагруженных сервисов с повышенными требованиями к кешу.<br />Burstable &mdash; машины, для которых гарантируется использование лишь доли ядра vCPU (5, 20 или 50%) с вероятностью временного повышения вплоть до 100%. Они стоят дешевле и подходят для задач, где не нужен постоянный уровень производительности, т. е. для тестирования или разработки.<br />Выберем для микросервиса следующий класс хоста: платформа &mdash; Intel Cascade Lake; тип &mdash; standard; конфигурация вычислительных ресурсов &mdash; s2.micro (два ядра vCPU, 8 ГБ RAM).<br />Хранилище данных. Хранилище БД может быть сетевым или локальным. В первом случае данные находятся на виртуальных дисках в инфраструктуре Yandex Cloud. Локальное хранилище &mdash; это диски, которые физически размещаются в серверах хостов БД.<br />При создании кластера можно выбирать между следующими типами хранилища:<br />- Стандартное сетевое (network-hdd) &mdash; это наиболее экономичный вариант. Выбирайте его, если к скорости записи и чтения нет особых требований.<br />- Быстрое сетевое (network-ssd) стоит примерно в четыре раза дороже, но при размере хранилища от 100 ГБ работает быстрее стандартного в десять и более раз (чем больше размер, тем заметнее разница в скорости).<br />- Сетевое на нереплицируемых SSD-дисках (network-ssd-nonreplicated) &mdash; использует сетевые SSD-диски с повышенной производительностью, реализованной за счет устранения избыточности. Объём такого хранилища можно увеличивать только с шагом 93 ГБ.<br />- Быстрое локальное (local-ssd) &mdash; самое быстрое и дорогое. Если локальный диск откажет, все сохранённые на нём данные будут потеряны. Чтобы этого избежать, при выборе локального хранилища сервис автоматически создаст отказоустойчивый кластер минимум из трёх хостов.<br />При создании кластера внимательно выбирайте тип хранилища. Размер хранилища можно будет позже изменить, а тип &mdash; нет.<br />Выберите для кластера стандартное сетевое хранилище network-hdd размером 50 ГБ.<br />База данных. В этом разделе настроек задаются атрибуты базы: Имя БД, уникальное в рамках кластера, Имя пользователя (владельца БД) и Пароль пользователя.<br />Сеть. Здесь можно выбрать облачную сеть для кластера и группы безопасности для его сетевого трафика.<br />Оставьте сеть по умолчанию (default) или выберите сеть, которую создали на предыдущем курсе. Кластер будет доступен для всех ВМ, которые подключены к вашей облачной сети.<br />Параметры хостов. В этом блоке можно добавить количество хостов, которые будут созданы вместе с кластером, и изменить их параметры. Дополнительные хосты могут понадобиться, например, для репликации БД или снижения нагрузки на хост-мастер.<br />Для наших целей достаточно кластера из одного хоста. Нажмите значок редактирования параметров хоста и в открывшемся окне выберите опцию Публичный доступ. Это означает, что к хосту можно будет подключиться из интернета, а не только из облачной сети. Остальные параметры оставьте без изменений.<br />Дополнительные настройки.Здесь можно: указать время Начала резервного копирования и Окна обслуживания. Это пригодится, если вы хотите, чтобы резервное копирование и техобслуживание хостов кластера не совпадали с периодами пиковых нагрузок на БД; разрешить Доступ из DataLens, если вы планируете анализировать в DataLens данные из базы. Подробнее о DataLens вы узнаете на одном из следующих занятий; разрешить Доступ из консоли управления, чтобы выполнять SQL-запросы к БД из консоли управления Yandex Cloud. Отметьте этот пункт: доступ из консоли понадобится нам на следующих практических работах; разрешить Доступ из Data Transfer, чтобы разрешить доступ к кластеру из сервиса Yandex Data Transfer в Serverless-режиме; разрешить Сбор статистики, чтобы воспользоваться инструментом Диагностика производительности в кластере; установить Защиту от удаления, чтобы защитить кластер от непреднамеренного удаления пользователем.<br />В этом блоке также можно задать настройки БД (например используемую сервером MySQL кодировку при работе с данными и обмене информацией с клиентами). По умолчанию при создании кластера сервис выбирает оптимальные настройки. Изменяйте их, если уверены, что это необходимо.<br />Настройка завершена. Осталось только нажать кнопку Создать кластер.<br />Создание кластера займёт несколько минут. Когда он будет готов к работе, его статус на панели Managed Service for MySQL сменится с Creating на Running, а состояние &mdash; на Alive.<br />Статус показывает, что происходит с кластером: Creating &mdash; создаётся; Running &mdash; работает; Error &mdash; не отвечает, возникла проблема; Updating &mdash; обновляется; Stopped &mdash; остановлен; Unknown &mdash; статус неизвестен (так может быть, например, когда кластер не виден из интернета).<br />Состояние &mdash; это показатель доступности кластера: Alive &mdash; все хосты кластера работают; Degraded &mdash; часть хостов (один или больше) не работает; Dead &mdash; все хосты не работают.<br /><strong>Task:</strong><br />Подключение к БД и добавление данных<br />Доступ из консоли управления. В кластере, который вы создали, уже есть БД. Она пока пустая. Поскольку при создании кластера вы выбрали в настройках пункт Доступ из консоли управления, в консоли управления Yandex Cloud появилась вкладка с интерфейсом для выполнения SQL-запросов к БД.<br />Давайте зайдём туда и создадим в БД таблицу для нашего микросервиса.<br /><strong>Decision:</strong><br />На странице Managed Service for MySQL выберите строку с созданным вами кластером. В панели консоли управления перейдите на вкладку SQL. Вам будет предложено выбрать БД для SQL-запросов и имя пользователя, а также ввести пароль. Все эти атрибуты вы задавали при создании&nbsp; кластера.<br />Нажмите кнопку Подключиться. Откроется структура БД (сейчас там написано, что данных нет) и окно ввода для SQL-запросов.<br />Теперь создадим таблицу. Введите в окне ввода следующий запрос и нажмите кнопку Выполнить.<br />CREATE TABLE IF NOT EXISTS ratings (<br />&nbsp;&nbsp;&nbsp; rating_id INT AUTO_INCREMENT PRIMARY KEY,<br />&nbsp;&nbsp;&nbsp; user_id INT NOT NULL,<br />&nbsp;&nbsp;&nbsp; message_id INT NOT NULL,<br />&nbsp;&nbsp;&nbsp; rating INT NOT NULL<br />) ENGINE=INNODB; <br />Обратите внимание, что в качестве движка в сервисе управляемых БД MySQL используется только InnoDB.<br />В таблицу можно добавить данные с помощью команды INSERT.<br />INSERT INTO ratings (user_id,message_id,rating) VALUES (44,368,4); <br />Чтобы отобразить обновлённую структуру БД, нажмите на имя БД и выберите таблицу ratings.<br />Наведите указатель на заголовок столбца, чтобы увидеть тип данных в нём.<br />SQL-запросы через консоль управления Yandex Cloud &mdash; нетипичный способ работы с БД. Используйте его для небольших, разовых задач, когда быстрее и проще открыть подключение в браузере. Этот способ не очень удобен: текст запроса и результат его выполнения доступны, только пока вы не закрыли или не перезагрузили страницу в браузере. Конечно, если запрос успешно запущен, то сервис обработает его независимо от состояния консоли управления.<br />В консоли выводятся только первые 1000 строк результата запроса, даже если данных больше. Чтобы увидеть строку, введите её номер в поле Номер первой строки.<br />Подключение к кластеру<br />В основном вы будете работать с БД из приложений или из командной строки. Однако для этого нужно подключиться к хосту, на котором развёрнута БД.<br />Есть два варианта подключения. Если публичный доступ к хосту открыт, подключитесь к нему через интернет с помощью защищённого SSL-соединения. Если публичного доступа нет, подключитесь к хосту с виртуальной машины, созданной в той же виртуальной сети. SSL-соединение можно не использовать, но тогда трафик между виртуальной машиной и БД шифроваться не будет.<br />Давайте подключимся к БД через интернет и создадим в ней ещё одну таблицу. Для выполнения этого задания вы можете использовать виртуальную машину с Ubuntu.<br />Для создания таблицы сделаем в текстовом редакторе файл createTables.sql с командами. Например, такой:<br />CREATE TABLE IF NOT EXISTS users (<br />&nbsp;&nbsp;&nbsp; user_id INT AUTO_INCREMENT,<br />&nbsp;&nbsp;&nbsp; nickname VARCHAR(128) NOT NULL,<br />&nbsp;&nbsp;&nbsp; avatar VARCHAR(255),<br />&nbsp;&nbsp;&nbsp; mail VARCHAR(255),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRIMARY KEY (user_id)<br />) ENGINE=INNODB; <br />Чтобы выполнить этот запрос в БД, подключимся к хосту. Для этого понадобится SSL-сертификат. Команды для его получения в Ubuntu:<br />mkdir ~/.mysql<br />wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O ~/.mysql/root.crt<br />chmod 0600 ~/.mysql/root.crt <br />Чтобы получить команды для подключения к БД, в консоли управления перейдите на страницу кластера, на вкладке Обзор нажмите кнопку Подключиться. В результате их выполнения в директории /home/&lt;домашняя_директория&gt;/.mysql/ сохранится SSL-сертификат root.crt.<br />Установите утилиту mysql-client, если на вашем компьютере или виртуальной машине её нет.<br />sudo apt update<br />sudo apt install -y mysql-client <br />Чтобы подключиться к БД, введите команду mysql. Для запуска нашего скрипта она выглядит следующим образом:<br />mysql --host=&lt;адрес хоста&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --port=3306 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-ca=~/.mysql/root.crt \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-mode=VERIFY_IDENTITY \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --user=&lt;имя пользователя&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --password \<br />&nbsp;&nbsp;&nbsp; &lt;имя_базы_данных&gt; &lt; createTables.sql <br />Сервис помогает заполнить параметры в команде. Чтобы посмотреть пример команды с адресом хоста, именами пользователя и БД, в консоли управления перейдите на страницу кластера, на вкладке Обзор нажмите кнопку Подключиться.<br />После запуска команды введите пароль к БД, после чего в ней будет создана таблица users.<br />Если при создании кластера вы не включили публичный доступ, то к БД можно подключиться с виртуальной машины из той же облачной сети без использования шифрования. \\Следовательно, в этом случае в команде для подключения опускается параметр --ssl-ca, а --ssl-mode передаётся со значением DISABLED:<br />mysql --host=адрес_хоста \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --port=3306 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-mode=DISABLED \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --user=&lt;имя пользователя&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --password \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;имя_базы_данных&gt; &lt; createTables.sql <br />Естественно, подключаться к БД можно не только из командной оболочки, но и из приложений. Нажмите уже знакомую вам кнопку Подключиться и посмотрите примеры кода для Python, PHP, Java, Node.js, Go, Ruby или настроек для драйвера ODBC.<br />Если вы хотите перенести БД в облако, то понадобится создать дамп и восстановить его в нужном кластере. Дамп &mdash; это копия БД или её части, представляющая собой текстовый файл с командами SQL (например, CREATE TABLE или INSERT). Его создают с помощью утилиты mysqldump.<br />Давайте попробуем перенести данные в кластер с помощью дампа. Для этого воспользуемся тестовой БД с данными о сотрудниках компании (имя, дата рождения, дата найма, место работы, зарплата и т. д.). Размер БД &mdash; около 167 Мб.<br />Скачайте из репозитория и сохраните на компьютере файлы с расширениями .sql и .dump. В файле employees.sql содержатся SQL команды, необходимые для создания таблиц и добавления в них данных из dump-файлов. Для переноса тестовой БД в облако понадобится запустить этот файл. Но, прежде чем приступить к переносу БД, откройте этот файл и удалите или закомментируйте (допишите в начало строки --) в нём строку 110. В этой строке расположена команда FLUSH LOGS, которая закрывает и снова открывает файлы журналов, а они в этой тестовой БД отсутствуют.<br />Создайте базу данных employees через консоль управления. Для этого на странице кластера перейдите на вкладку Базы данных и нажмите кнопку Добавить.<br />Добавьте пользователю, например user1, разрешение на доступ к БД employees. Для этого на странице кластера перейдите на вкладку Пользователи, напротив пользователя user1 нажмите кнопку &middot;&middot;&middot; и выберите Настроить. Во всплывающем окне нажмите Добавить базу данных, выберите employees, добавьте роль ALL_PRIVILEGES и нажмите Сохранить.<br />Затем в командной строке перейдите в папку сохраненными файлами .sql и .dump и восстановите данные из дампа с помощью команды:<br />mysql --host=&lt;адрес хоста&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --port=3306 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-ca=~/.mysql/root.crt \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-mode=VERIFY_IDENTITY \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --user=&lt;имя_пользователя&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --password \<br />&nbsp;&nbsp;&nbsp; employees &lt; ~/employees.sql <br />После того как данные скопируются, ваш кластер и БД будут готовы к работе. Подключитесь к БД в консоли управления и убедитесь, что данные перенесены.<br /><strong>Decision:</strong><br />$ mkdir ~/.mysql<br />$ wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O ~/.mysql/root.crt<br />$ chmod 0600 ~/.mysql/root.crt <br />$ sudo apt update<br />$ sudo apt install mysql-client <br />$ vim createTables.sql<br />$ cat createTables.sql<br />CREATE TABLE IF NOT EXISTS users (<br />&nbsp;&nbsp;&nbsp; user_id INT AUTO_INCREMENT,<br />&nbsp;&nbsp;&nbsp; nickname VARCHAR(128) NOT NULL,<br />&nbsp;&nbsp;&nbsp; avatar VARCHAR(255),<br />&nbsp;&nbsp;&nbsp; mail VARCHAR(255),<br />&nbsp;&nbsp;&nbsp; PRIMARY KEY (user_id)<br />) ENGINE=INNODB;<br />$ mysql --host=rc1a-642tdtv6ope6gk7u.mdb.yandexcloud.net \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --port=3306 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-ca=~/.mysql/root.crt \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-mode=VERIFY_IDENTITY \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --user=tuser \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --password \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbase &lt; createTables.sql <br />$ wget https://github.com/datacharmer/test_db/archive/refs/heads/master.zip<br />$ unzip master.zip<br />$ ls test_db-master/<br />Changelog&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; employees.sql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; load_dept_emp.dump&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; load_salaries1.dump&nbsp; load_titles.dump&nbsp; sakila&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test_employees_md5.sql<br />employees_partitioned_5.1.sql&nbsp; images&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; load_dept_manager.dump&nbsp; load_salaries2.dump&nbsp; objects.sql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; show_elapsed.sql&nbsp; test_employees_sha.sql<br />employees_partitioned.sql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; load_departments.dump&nbsp; load_employees.dump&nbsp;&nbsp;&nbsp;&nbsp; load_salaries3.dump&nbsp; README.md&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sql_test.sh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; test_versions.sh<br />$ cat test_db-master/employees.sql | grep flush<br />flush /*!50503 binary */ logs;<br />$ vim test_db-master/employees.sql<br />$ cat test_db-master/employees.sql | grep flush<br />$ cd test_db-master/<br />$ mysql --host=rc1a-642tdtv6ope6gk7u.mdb.yandexcloud.net \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --port=3306 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-ca=~/.mysql/root.crt \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-mode=VERIFY_IDENTITY \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --user=tuser1 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --password \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; employees &lt; employees.sql <br />$ mysql --host=rc1a-642tdtv6ope6gk7u.mdb.yandexcloud.net \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --port=3306 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-ca=~/.mysql/root.crt \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl-mode=VERIFY_IDENTITY \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --user=tuser1 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --password \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; employees<br />mysql&gt; show tables;<br /><strong>Task:</strong><br />Создание кластера базы данных PostgreSQL. <br />В этой практической работе вы создадите кластер еще одной управляемой БД, на этот раз PostgreSQL, подключитесь к ней и загрузите в нее данные. <br /><strong>Decision:</strong><br />Создание кластера управляемой базы данных PostgreSQL аналогично созданию кластера базы данных MySQL.<br />Перейдите в сервис управляемых баз данных PostgreSQL и нажмите кнопку Создать кластер.<br />В появившемся окне настроек задайте необходимые параметры.<br />- Имя кластера и его описание. Выберите уникальное в облаке имя кластера. Описание опционально, поэтому можно оставить это поле пустым.<br />- В поле Окружение выберите PRODUCTION.<br />- Выберите версию PostgreSQL и класс хоста.<br />- Выберите размер и тип сетевого хранилища.<br />- Задайте атрибуты базы данных.<br />- Выберите из списка сеть, в которой будут находиться хосты кластера (для подключения потребуются публичные хосты).<br />- В блоке Хосты добавьте ещё два хоста в других зонах доступности для обеспечения отказоустойчивости кластера. База автоматически реплицируется.<br />- В блоке Дополнительные настройки задайте время начала резервного копирования и включите доступ из консоли управления.<br />- Нажмите кнопку Создать кластер.<br />Как и в случае с MySQL, к хостам кластера Managed Service for PostgreSQL можно подключиться двумя способами.<br />Через интернет. Если вы настроили публичный доступ для нужного хоста, то подключиться к нему можно с помощью SSL-соединения.<br />С виртуальных машин Yandex Cloud. Они должны быть расположены в той же облачной сети. Если к хосту нет публичного доступа, для подключения с таких виртуальных машин SSL-соединение использовать необязательно. Обратите внимание, что если публичный доступ в вашем кластере настроен только для некоторых хостов, автоматическая смена мастера может привести к тому, что вы не сможете подключиться к мастеру из интернета.<br />Установите клиент для подключения к БД PostgreSQL. Команда установки в Ubuntu: sudo apt update &amp;&amp; sudo apt install -y postgresql-client <br />Скачайте сертификат для подключения к БД PostgreSQL:<br />mkdir -p ~/.postgresql<br />wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O ~/.postgresql/root.crt <br />chmod 0600 ~/.postgresql/root.crt <br />Пример команды для подключения можно посмотреть в консоли управления, нажав на кнопку Подключиться на странице кластера. Подключение с SSL происходит при помощи следующей команды:<br />psql "host=&lt;FQDN_хоста&gt; \ <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode=verify-full \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dbname=&lt;имя базы данных&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=&lt;имя пользователя базы данных&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; target_session_attrs=read-write"<br />Загрузка данных в базу данных из CSV. Одним из способов добавления данных в базу является их загрузка из csv-файла.<br />Предположим, вы используете БД для организации работы транспортной службы интернет-магазина. Вам нужно добавить в базу таблицу, содержащую данные о расстояниях между складом и пунктами самовывоза, а также о стандартном времени доставки товаров со склада в эти пункты. Создадим csv-файл, например DTM.csv, который содержит такие данные (100 - код склада, 101-109 - коды пунктов, Time - стандартное время доставки в минутах, Distance - расстояние в километрах):<br />"depot","store","time","distance"<br />"100","101",31,12<br />"100","102",38,17<br />"100","103",56,33<br />"100","104",70,60<br />"100","105",41,25<br />"100","106",21,8<br />"100","107",33,14<br />"100","108",62,42<br />"100","109",45,29 <br />Важные моменты при миграции из CSV:<br />- Названия колонок в файле и в таблице необязательно совпадают.<br />- Файл содержит заголовок, который не нужно импортировать.<br />- Первые 2 колонки конвертируем из строк (string) в целые числа (int).<br />PostgreSQL позволяет импортировать данные из файла несколькими способами:<br />- Командой copy.<br />- Через функции pl/pgsql.<br />- Средствами другого языка, например Python.<br />Воспользуемся первым способом. Сначала нам понадобится создать таблицу, в которую будет осуществлена миграция данных. Подключитесь к БД согласно инструкциям выше. Выполните следующую команду:<br />CREATE TABLE dtm (<br />&nbsp;&nbsp;&nbsp; id serial PRIMARY KEY,<br />&nbsp;&nbsp;&nbsp; depot int NOT NULL,<br />&nbsp;&nbsp;&nbsp; store int&nbsp; NOT NULL,<br />&nbsp;&nbsp;&nbsp; time int NOT NULL,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; distance int&nbsp; NOT NULL<br />);<br />Загрузите данные: \copy dtm(depot,store,time,distance) from '/&lt;путь к файлу&gt;/DTM.csv' DELIMITERS ',' CSV HEADER;<br />В этой команде мы учли те моменты, о которых говорили вначале:<br />- dtm (depot, store, time, distance) маппинг колонок связывает колонки в файле с колонками в таблице, их имена могут не совпадать<br />- CSV HEADER показывает, что заголовок импортировать не нужно<br />- Колонки в таблице уже имеют правильные типы данных, конвертация будет выполнена автоматически.<br />В консоли управления на странице кластера перейдите на вкладку SQL. Введите пароль пользователя БД и нажмите кнопку Подключиться. Выберите таблицу dtm, чтобы убедиться, что добавление данных выполнено правильно.<br /><strong>Decision:</strong><br />$ sudo apt update &amp;&amp; sudo apt install postgresql-client<br />$ mkdir -p ~/.postgresql<br />$ wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O ~/.postgresql/root.crt<br />$ chmod 0600 ~/.postgresql/root.crt<br />$ vim DTM.csv<br />$ cat DTM.csv<br />"deport","store","time","distance"<br />"100","101",31,12<br />"100","102",38,17<br />"100","103",56,33<br />"100","104",70,60<br />"100","105",41,25<br />"100","106",21,8<br />"100","107",33,14<br />"100","108",62,42<br />"100","109",45,29<br />$ psql "host=rc1a-w3usdays081v0itf.mdb.yandexcloud.net,rc1c-qga7rd1sqe5jm8io.mdb.yandexcloud.net,rc1d-l1vzj1210qj68s8n.mdb.yandexcloud.net \<br />&nbsp;&nbsp;&nbsp; port=6432 \<br />&nbsp;&nbsp;&nbsp; sslmode=verify-full \<br />&nbsp;&nbsp;&nbsp; dbname=YOUR-DB \<br />&nbsp;&nbsp;&nbsp; user=YOUR-USERNAME \<br />&nbsp;&nbsp;&nbsp; target_session_attrs=read-write"<br />YOUR-DB=&gt; CREATE TABLE dtm (<br />YOUR-DB(&gt;&nbsp;&nbsp;&nbsp;&nbsp; id serial PRIMARY KEY,<br />YOUR-DB(&gt;&nbsp;&nbsp;&nbsp;&nbsp; depot int NOT NULL,<br />YOUR-DB(&gt;&nbsp;&nbsp;&nbsp;&nbsp; store int&nbsp; NOT NULL,<br />YOUR-DB(&gt;&nbsp;&nbsp;&nbsp;&nbsp; time int NOT NULL,<br />YOUR-DB(&gt;&nbsp;&nbsp;&nbsp;&nbsp; distance int&nbsp; NOT NULL<br />YOUR-DB(&gt; );<br />YOUR-DB=&gt; \copy dtm(depot,store,time,distance) from '/home/test/DTM.csv' DELIMITERS ',' CSV HEADER;<br />YOUR-DB=&gt; exit<br /><strong>Task:</strong><br />Создание кластера MongoDB. <br />На этом уроке вы создадите кластер MongoDB, подключитесь к нему и загрузите в него данные. <br />Раньше вы работали только с реляционными БД, но использование кластера MongoDB принципиально не отличается от работы с кластером MySQL или PostgreSQL, так что многое будет вам знакомо.<br /><strong>Decision:</strong><br />Выберите в консоли управления Yandex Cloud каталог для кластера БД. На дашборде каталога откройте раздел Managed Service for MongoDB. В открывшемся окне нажмите кнопку Создать кластер.<br />Установите основные настройки кластера. Для этого урока создайте кластер с минимальной конфигурацией: тип хоста burstable, класс b2.nano, стандартное сетевое хранилище размером 10 ГБ. Откройте публичный доступ к хосту и задайте пароль пользователя БД. Остальные значения оставьте по умолчанию.<br />В сервисе управляемых БД MongoDB к хостам можно подключаться через интернет или с виртуальных машин в той же сети. Порт для подключения &mdash; 27018.<br />Для подключения через интернет хосты кластера должны находиться в публичном доступе. Подключаться можно только через зашифрованное соединение.<br />Обратите внимание: если публичный доступ настроен только для некоторых хостов в кластере, то при автоматической смене основной реплики она может оказаться недоступной из интернета.<br />Если к хосту нет публичного доступа и вы подключаетесь к нему с виртуальных машин Yandex Cloud, то зашифрованное соединение необязательно.<br />Подключитесь к созданной БД из интернета. Используйте SSL-сертификат, который вы подготовили на одной из предыдущих практических работ, или команду (для Ubuntu):<br />sudo mkdir -p /usr/local/share/ca-certificates/Yandex &amp;&amp; \<br />sudo wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt <br />Если всё пройдет успешно &mdash; вы получите сообщение операционной системы о том, что сертификат сохранён.<br />Установите утилиту Mongo Shell:<br />sudo apt install mongodb-clients <br />Подключитесь к БД с помощью команды mongo. Чтобы получить строку подключения, на основной странице сервиса в консоли управления выберите кластер, на вкладке Обзор нажмите кнопку Подключиться.<br />Сервис сформирует пример строки подключения для кластера. Там же вы можете посмотреть примеры кода на Python, PHP, Java, Node.js, Go для подключения из приложений.<br />Подключитесь к кластеру из командной строки.<br />mongo --norc \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --sslCAFile /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --host '&lt;FQDN хоста MongoDB&gt;:27018' \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -u &lt;имя пользователя БД&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -p &lt;пароль пользователя БД&gt; \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;имя БД&gt; <br />Создадим в БД коллекцию users. Предположим, в ней содержится информация о пользователях вашего приложения.<br />db.createCollection("users") <br />Загрузим в коллекцию тестовые данные с помощью методов добавления одного документа db.insertOne(...) и сразу нескольких db.insertMany(...).<br />Сначала добавим один документ (данные одного пользователя).<br />db.users.insertOne({firstName: "Adam", lastName: "Smith", age: 37, email: "adam.smith@test.com"}); <br />Дополним коллекцию данными еще двух пользователей.<br />db.users.insertMany( [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {firstName: "Viktoria", lastName: "Holmes", age: 73, email: "viktoria.holmes@test.com", phone: "737772727"},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {firstName: "Tina", lastName: "Anders", age: 29, email: "tina.anders@test.com", children: [{firstName: "Sam", lastName: "Anders"},{firstName: "Anna", lastName: "Anders"}]}<br />&nbsp;&nbsp; ] ); <br />Обратите внимание, что документы в коллекции users содержат разный набор данных. С помощью MongoDB мы можем работать с данными, структура которых частично не совпадает.<br />Теперь посмотрим на содержимое коллекции с помощью команды db.users.find(). Результат показывает, что все данные успешно добавлены:<br />Проверим, есть ли среди пользователей те, кому больше 37 лет. Сделаем запрос к БД с помощью метода find.<br />db.users.find({age: {$gt: 37}}); <br /><strong>Decision:</strong><br />$ sudo mkdir -p /usr/local/share/ca-certificates/Yandex &amp;&amp; \<br />sudo wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" -O /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt<br />$ wget https://downloads.mongodb.com/linux/mongodb-linux-x86_64-enterprise-ubuntu2004-6.0.2.tgz<br />$ tar -zxvf mongodb-linux-x86_64-enterprise-ubuntu2004-6.0.2.tgz<br />$ sudo ln -s /path/to/the/mongodb-directory/bin/* /usr/local/bin/<br />$ sudo apt install mongodb-clients<br />$ mongo --norc \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ssl \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --sslCAFile /usr/local/share/ca-certificates/Yandex/YandexInternalRootCA.crt \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --host 'rs01/rc1b-b7xwau9lvu3hdt0w.mdb.yandexcloud.net:27018' \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -u YOUR-USERNAME \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -p YOUR-PASSWORD \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; YOUR-DB<br />rs01:PRIMARY&gt; db.createCollection("users")<br />rs01:PRIMARY&gt; db.users.insertOne({firstName: "Adam", lastName: "Smith", age: 37, email: "adam.smith@test.com"});<br />rs01:PRIMARY&gt; db.users.insertMany( [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {firstName: "Viktoria", lastName: "Holmes", age: 73, email: "viktoria.holmes@test.com", phone: "737772727"},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {firstName: "Tina", lastName: "Anders", age: 29, email: "tina.anders@test.com", children: [{firstName: "Sam", lastName: "Anders"},{firstName: "Anna", lastName: "Anders"}]}<br />&nbsp;&nbsp; ] );<br />rs01:PRIMARY&gt; db.users.find({age: {$gt: 37}});<br /><strong>Task:</strong><br />Создание кластера ClickHouse и подключение к нему.<br />В этой практической работе вы создадите кластер ClickHouse. Вы уже знаете, как создавать кластеры и выставлять их основные настройки в сервисах платформы данных. Но у БД ClickHouse есть свои особенности.<br />Когда вы создадите кластер из двух или более хостов, сервис дополнительно создаст ещё один кластер из трёх хостов, где развернёт Apache ZooKeeper. Это служба для распределенных систем, которая управляет конфигурацией, репликацией и распределением запросов по хостам БД. Без неё кластер ClickHouse работать не будет. К ZooKeeper у пользователей доступа нет, однако его хосты учитываются при расчёте квоты ресурсов облака и стоимости сервиса.<br />ZooKeeper синхронизирует шарды (т. е. хосты) ClickHouse. В отличие от классических реляционных БД, у ClickHouse нет главного узла (мастера), через который добавляются данные. В ClickHouse данные можно и записывать, и читать с любого узла.<br /><strong>Decision:</strong><br />Перейдите в каталог, где нужно создать кластер БД, выберите Managed Service for ClickHouse и нажмите кнопку Создать кластер.<br />Для практической работы нам понадобится кластер с минимальной конфигурацией: тип хоста burstable, класс b2.nano и стандартное сетевое хранилище размером 10 ГБ.<br />Задайте настройки: введите имена для кластера и БД, а также имя и пароль пользователя. Откройте публичный доступ к хосту.<br />Обратите внимание: в отличие от сервисов, которые мы уже рассматривали, здесь в разделе База данных можно включить опции управления пользователями и БД с помощью SQL-запросов.<br />Кроме того, в дополнительных настройках можно включить доступ к БД из консоли управления, сервисов DataLens, Яндекс Метрики и AppMetrica, а также возможность использовать бессерверные вычисления (подробно о них мы расскажем на курсе &laquo;Serverless&raquo;). С помощью DataLens, например, вы визуализируете результаты поисковых запросов в виде графиков, диаграмм и дашбордов, а подключение AppMetrica позволит импортировать данные из этого сервиса в кластер.<br />Отметьте пункт Доступ из DataLens: он понадобится вам на одном из следующих уроков. Нажмите кнопку Создать кластер.<br />К хостам кластера ClickHouse можно подключаться через интернет или с виртуальных машин в той же виртуальной сети. Если к хостам БД открыт публичный доступ, то для подключения к ним используется шифрованное соединение.<br />Подключайтесь к кластеру с помощью HTTP-протокола или более низкоуровневого Native TCP-протокола. В большинстве случаев рекомендуется взаимодействовать с ClickHouse не напрямую, а с помощью инструмента или библиотеки. Официально поддерживаются консольный клиент, драйверы JDBC и ODBC, клиентская библиотека для C++. Также можно использовать библиотеки сторонних разработчиков для Python, PHP, Go, Ruby и т. д.<br />Примеры строк подключения приводятся в документации и консоли управления на вкладке Обзор страницы кластера.<br />С БД удобно работать в приложении с графическим интерфейсом. Один из вариантов &mdash; универсальный клиент DBeaver. Другие варианты вы найдёте в полном списке клиентов.<br />Подробная информация о настройке подключения приведена в документации. Чтобы создать подключение к ClickHouse в DBeaver, помимо обычных параметров (адреса хоста, порта, имени БД, логина и пароля) задайте на вкладке Свойства драйвера настройки свойств драйвера JDBC. Укажите следующие параметры: ssl = true; sslmode = strict; sslrootcert = &lt;путь к SSL-сертификату&gt;. Как получить SSL-сертификат, вы уже узнали на предыдущих уроках.<br />При подключении DBeaver покажет номер версии ClickHouse и пинг до хоста.<br />В двух следующих практических работах мы используем кластер для аналитической работы с датасетами и для создания БД ClickHouse.<br /><strong>Decision:</strong><br />$ wget https://dbeaver.io/files/dbeaver-ce_latest_amd64.deb<br />$ sudo dpkg -i dbeaver-ce_latest_amd64.deb<br />$ dbeaver-ce &amp;<br />$ mkdir -p ~/.clickhouse-client<br />$ sudo wget "https://storage.yandexcloud.net/mdb/clickhouse-client.conf.example" -O ~/.clickhouse-client/config.xml<br />$ sudo apt-get install -y apt-transport-https ca-certificates dirmngr<br />$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754<br />$ echo "deb https://packages.clickhouse.com/deb stable main" | sudo tee \<br />&nbsp;&nbsp;&nbsp; /etc/apt/sources.list.d/clickhouse.list<br />$ sudo apt-get update<br />$ sudo apt-get install -y clickhouse-server clickhouse-client<br />$ clickhouse-client --host rc1a-mg8yquor7pspcwkc.mdb.yandexcloud.net \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --secure \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --user YOUR-USERNAME \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --database YOUR-DB \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --port 9440 \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --ask-password<br /><strong>Task:</strong><br />Работа с данными из объектного хранилища.<br />В интернете выложено множество датасетов &mdash;&nbsp; структурированных наборов данных, связанных общей темой. Например в репозитории проекта Our World in Data находится около тысячи разнообразных датасетов: от численности населения государств до сведений об употреблении алкоголя в США с 1850 года.<br />Датасеты часто выкладывают в виде CSV- или TSV-файлов. В них значения разделены запятой (comma separated values, CSV) или табуляцией (tab separated values, TSV).<br />Сохраняйте датасеты в объектное хранилище и анализируйте данные с помощью ClickHouse. При этом не требуется создавать БД и копировать в неё данные из датасета. Отправляйте запросы к ClickHouse &mdash; а ClickHouse сходит за данными напрямую в объектное хранилище.<br /><strong>Decision:</strong><br />В качестве примера возьмем датасет с историей метеонаблюдений за 10 лет и попробуем развеять мифы о разнице погоды в Москве и Санкт-Петербурге. Датасет содержит примерно 50 тысяч записей, он выложен в объектном хранилище Yandex Cloud и доступен всем.<br />Воспользуемся кластером БД, который мы создали на предыдущем уроке. Откройте его в консоли управления. Запросы к датасету будем делать через SQL-консоль. На панели слева выберите вкладку SQL и введите пароль пользователя. В правом поле открывшейся консоли мы и станем вводить SQL-запросы.<br />Как вы думаете, где зарегистрирована самая низкая температура? Наверняка в Санкт-Петербурге! Давайте проверим.<br />Выполните запрос:<br />SELECT<br />&nbsp;&nbsp;&nbsp; City,<br />&nbsp;&nbsp;&nbsp; LocalDate,<br />&nbsp;&nbsp;&nbsp; TempC<br />FROM s3(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'https://storage.yandexcloud.net/arhipov/weather_data.tsv',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'TSV',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'LocalDateTime DateTime, LocalDate Date, Month Int8, Day Int8, TempC Float32,Pressure Float32, RelHumidity Int32, WindSpeed10MinAvg Int32, VisibilityKm Float32, City String')<br />ORDER BY TempC ASC<br />LIMIT 1 <br />Всё-таки наши интуитивные представления не всегда верны и могут опровергаться данными.<br />А что насчет самой высокой температуры, скорости ветра и влажности? Проверьте сами, изменив поля в запросе (средняя скорость ветра за 10 минут &mdash; WindSpeed10MinAvg, относительная влажность &mdash; RelHumidity; сортировка по возрастанию &mdash; ASC, по убыванию &mdash; DESC). Увеличив количество выводимых данных, вы получите более точное представление (измените параметр LIMIT c 1 до 10).<br />Но это были крайние значения. Давайте проверим, насколько в этих городах отличается климат в целом. Узнаем, например, разницу среднегодовых температур.<br />SELECT<br />&nbsp;&nbsp;&nbsp; Year,<br />&nbsp;&nbsp;&nbsp; msk.t - spb.t<br />FROM<br />(<br />&nbsp;&nbsp;&nbsp; SELECT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toYear(LocalDate) AS Year,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; avg(TempC) AS t<br />&nbsp;&nbsp;&nbsp; FROM s3(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'https://storage.yandexcloud.net/arhipov/weather_data.tsv',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'TSV',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'LocalDateTime DateTime, LocalDate Date, Month Int8, Day Int8, TempC Float32,Pressure Float32, RelHumidity Int32, WindSpeed10MinAvg Int32, VisibilityKm Float32, City String')<br />&nbsp;&nbsp;&nbsp; WHERE City = 'Moscow'<br />&nbsp;&nbsp;&nbsp; GROUP BY Year<br />&nbsp;&nbsp;&nbsp; ORDER BY Year ASC<br />) AS msk<br />INNER JOIN<br />(<br />&nbsp;&nbsp;&nbsp; SELECT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; toYear(LocalDate) AS Year,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; avg(TempC) AS t<br />&nbsp;&nbsp;&nbsp; FROM s3(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'https://storage.yandexcloud.net/arhipov/weather_data.tsv',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'TSV',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'LocalDateTime DateTime, LocalDate Date, Month Int8, Day Int8, TempC Float32,Pressure Float32, RelHumidity Int32, WindSpeed10MinAvg Int32, VisibilityKm Float32, City String')<br />&nbsp;&nbsp;&nbsp; WHERE City = 'Saint-Petersburg'<br />&nbsp;&nbsp;&nbsp; GROUP BY Year<br />&nbsp;&nbsp;&nbsp; ORDER BY Year ASC<br />) AS spb ON msk.Year = spb.Year <br />Измените поля в запросе, чтобы проверить разницу относительной влажности.<br />Давайте теперь рассчитаем, где раньше начинается лето. Будем считать началом лета день, начиная с которого температура поднималась выше +15 &deg;С хотя бы пять раз в течение 10-дневного периода (864 тысячи секунд).<br />SELECT<br />&nbsp;&nbsp;&nbsp; City,<br />&nbsp;&nbsp;&nbsp; toYear(LocalDate) AS year,<br />&nbsp;&nbsp;&nbsp; MIN(LocalDate)<br />FROM<br />(<br />&nbsp;&nbsp;&nbsp; SELECT<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; City,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalDate,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; windowFunnel(864000)(LocalDateTime, TempC &gt;= 15, TempC &gt;= 15, TempC &gt;= 15, TempC &gt;= 15, TempC &gt;= 15) AS warmdays<br />&nbsp;&nbsp;&nbsp; FROM s3(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'https://storage.yandexcloud.net/arhipov/weather_data.tsv',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'TSV',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'LocalDateTime DateTime, LocalDate Date, Month Int8, Day Int8, TempC Float32,Pressure Float32, RelHumidity Int32, WindSpeed10MinAvg Int32, VisibilityKm Float32, City String')<br />&nbsp;&nbsp;&nbsp; GROUP BY<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; City,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LocalDate<br />)<br />WHERE warmdays = 5<br />GROUP BY<br />&nbsp;&nbsp;&nbsp; year,<br />&nbsp;&nbsp;&nbsp; City<br />ORDER BY<br />&nbsp;&nbsp;&nbsp; year ASC,<br />&nbsp;&nbsp;&nbsp; City ASC <br /><strong>Task:</strong><br />Добавление данных. <br />Предположим, вы работаете в метеорологической службе и постоянно изучаете датасеты с погодными данными. <br />Сбор данных о погоде автоматизирован: на территории области расположены несколько десятков пунктов наблюдения с датчиками. <br />Информация о температуре, давлении, влажности и скорости ветра раз в полчаса передаётся с датчиков на центральный сервер. <br />Приложение на сервере обрабатывает данные, переводит их в нужный формат и записывает в файл. Каждый файл содержит данные за три часа наблюдений. <br />Для прогноза нужно учитывать всю историю наблюдений за последние несколько лет, то есть все файлы потребуется собрать в одну БД.<br />Давайте потренируемся добавлять данные из файлов в БД ClickHouse.<br />На предыдущих уроках мы создали кластер, на котором развёрнута БД, и научились подключаться к нему. <br />Продолжим работать с этой БД, а в качестве добавляемого файла возьмем уже известный вам датасет с данными о погоде в Москве и Санкт-Петербурге.<br /><strong>Decision:</strong><br />Сохраните файл на компьютере.<br />Прежде чем добавлять файл в БД, создадим в ней таблицу, куда будут вставляться данные. Перейдите в SQL-консоль кластера и выполните команду:<br />CREATE TABLE &lt;имя вашей БД&gt;.Weather<br />(&nbsp; LocalDateTime DateTime,<br />&nbsp;&nbsp; LocalDate Date,<br />&nbsp;&nbsp; Month Int8,<br />&nbsp;&nbsp; Day Int8,<br />&nbsp;&nbsp; TempC Float32,<br />&nbsp;&nbsp; Pressure Float32,<br />&nbsp;&nbsp; RelHumidity Int32,<br />&nbsp;&nbsp; WindSpeed10MinAvg Int32,<br />&nbsp;&nbsp; VisibilityKm Float32,<br />&nbsp;&nbsp; City String<br />) ENGINE=MergeTree<br />ORDER BY LocalDateTime; <br />В результате будет создана пустая таблица с полями и типами данных, соответствующими полям и типам данных в нашем файле (датасете).<br />Вставим данные в таблицу с помощью клиента командной строки clickhouse-client. Команды для его установки (для Ubuntu):<br />sudo apt update &amp;&amp; sudo apt install --yes apt-transport-https ca-certificates dirmngr &amp;&amp; \<br />sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv E0C56BD4 &amp;&amp; \<br />echo "deb https://repo.clickhouse.com/deb/stable/ main/" | sudo tee \<br />/etc/apt/sources.list.d/clickhouse.list<br />sudo apt update &amp;&amp; sudo apt install --yes clickhouse-client<br />mkdir --parents ~/.clickhouse-client &amp;&amp; \<br />wget "https://storage.yandexcloud.net/mdb/clickhouse-client.conf.example" \<br />--output-document ~/.clickhouse-client/config.xml <br />Подробности о том, как установить клиент и работать с ним, вы найдёте в документации ClickHouse.<br />Подключитесь к кластеру. Пример строки подключения посмотрите в консоли управления.<br />Добавим файл с данными в БД с помощью команды:<br />cat weather_data.tsv | clickhouse-client \<br />--host &lt;адрес вашей БД&gt; \<br />--secure \<br />--user user1 \<br />--database db1 \<br />--port 9440 \<br />-q "INSERT INTO db1.Weather FORMAT TabSeparated" \<br />--ask-password <br />Переключившись в SQL-консоль, вы увидите, что данные появились в таблице.<br />Данные в БД можно загружать и другими способами: из приложений или клиентов с графическим интерфейсом (например DBeaver). В этом случае подключение к БД и передача данных будут идти по HTTP-протоколу через порт 8443.<br />Теперь вы можете анализировать 10-летний срез данных о погоде в Москве и Санкт-Петербурге непосредственно в ClickHouse, без обращений к внешним источникам. Попробуйте, например, выяснить, какой день был самым ветреным в этих городах.<br />После практической работы остановите кластер, но не удаляйте его. Кластер ещё понадобится, когда мы будем рассматривать сервис визуализации и анализа данных Yandex DataLens.<br /><strong>Decision:</strong><br />$ wget https://storage.yandexcloud.net/arhipov/weather_data.tsv<br />$ cat weather_data.tsv | clickhouse-client \<br />--host YOUR-IP \<br />--secure \<br />--user YOUR-USERNAME \<br />--database YOUR-DB \<br />--port 9440 \<br />-q "INSERT INTO YOUR-DB.Weather FORMAT TabSeparated" \<br />--ask-password<br /><strong>Task:</strong><br />Создание базы данных. <br />В этой практической работе вы создадите БД YDB в dedicated режиме, научитесь подключаться к ней и добавлять данные из тестового приложения.<br />Также вы подключитесь к БД и запустите тестовое приложение, чтобы создать в ней несколько таблиц с данными о популярных сериалах.<br /><strong>Decision:</strong><br />На стартовой странице консоли управления перейдите в каталог, в котором будете создавать БД, выберите в списке сервисов База данных YDB и нажмите кнопку Создать ресурс.<br />В открывшемся окне выберите тип БД dedicated. Появившийся интерфейс создания новой БД практически идентичен уже знакомым вам интерфейсам создания кластеров управляемых БД.<br />Выберите для вашей БД имя, назначьте необходимые вычислительные ресурсы (для этой и следующих практических работ достаточно одного хоста конфигурации medium), тип и количество групп хранения (достаточно одной группы).<br />Группа хранения &ndash; это массив независимых дисковых накопителей, объединённых по сети в единый логический элемент. В YDB такой массив состоит из 9 дисков, расположенных по три в каждой из трёх зон доступности. Такая конфигурация обеспечивает устойчивость при одновременном отказе одной из зон и отказе диска в другой зоне. Стандартный размер группы хранения &mdash; 100 ГБ.<br />Выберите облачную сеть и подсети для работы с БД. Вы можете оставить сеть по умолчанию или выбрать ту, которую создали на предыдущем курсе. БД будет доступна для всех виртуальных машин, которые подключены к той же облачной сети.<br />Также выберите опцию присвоения публичного IP-адреса, чтобы иметь возможность подключаться к БД из интернета.Нажмите кнопку Создать базу данных. Создание БД занимает несколько минут. Когда статус БД изменится с Provisioning на Running, она готова к работе. Кликнув на созданную БД в консоли управления, вы перейдёте на вкладку Обзор.<br />В разделе Соединение на этой странице приведена информация, которая вам понадобится для подключения к БД:<br />- Эндпоинт &mdash; точка подключения с указанием протокола, представляющая собой в данном случае адрес, на который посылаются сообщения;<br />- Размещение базы данных &mdash; полный путь к БД.<br />- Примеры подключений из командной строки и приложений вы можете посмотреть, нажав на кнопку Подключиться.<br />Подключение к базе данных и запуск тестового приложения. <br />Для того, чтобы выполнить эту задачу, вам понадобится сервисный аккаунт с ролями viewer и editor. Перейдите в дашборд каталога и выберите вкладку Сервисные аккаунты. Создайте сервисный аккаунт, назначив для него указанные роли. Сохраните идентификатор этого аккаунта.<br />Вы можете запускать тестовое приложение со своего компьютера или с виртуальной машины в Yandex Cloud. В данном примере используется OC Ubuntu и приложение на Python.<br />Если при создании БД вы не присвоили ей публичный IP-адрес, то подключиться к ней вы сможете только с виртуальной машины, расположенной в той же облачной сети.<br />Для запуска приложения нужно склонировать на свою машину репозиторий YDB Python SDK, из которого оно будет вызываться, а также установить библиотеки ydb, iso8601 и yandexcloud. Воспользуйтесь для этого следующими командами:<br />git clone https://github.com/yandex-cloud/ydb-python-sdk.git<br />sudo pip3 install iso8601 ydb yandexcloud <br />Создайте авторизованный ключ для вашего сервисного аккаунта и сохраните его в файл с помощью интерфейса командной строки Yandex Cloud.<br />mkdir ~/.ydb<br />yc iam key create \<br />&nbsp; --folder-id &lt;идентификатор каталога&gt; \<br />&nbsp; --service-account-name &lt;имя сервисного аккаунта&gt; \<br />&nbsp; --output ~/.ydb/sa_name.json <br />&nbsp;&nbsp;&nbsp; Получите SSL-сертификат:<br />wget "https://storage.yandexcloud.net/cloud-certs/CA.pem" \<br />&nbsp; -O ~/.ydb/CA.pem <br />Установите переменную окружения YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS и переменную окружения с SSL-сертификатом.<br />export YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS=~/.ydb/sa_name.json<br />export YDB_SSL_ROOT_CERTIFICATES_FILE=~/.ydb/CA.pem <br />&nbsp;&nbsp;&nbsp; Запустите тестовое приложение basic_example_v1 из репозитория ydb-python-sdk, указав в качестве параметров подключения значения протокола, эндпоинта и полного пути к БД.<br />cd ./ydb-python-sdk/examples/basic_example_v1<br />python3 __main__.py \<br />-e &lt;Эндпоинт&gt; \<br />-d &lt;Размещение базы данных&gt; <br />Результат выполнения приложения должен выглядеть так:<br />&gt; describe table: series<br />column, name: series_id , Uint64<br />column, name: title , Utf8<br />column, name: series_info , Utf8<br />column, name: release_date , Uint64<br />&gt; select_simple_transaction:<br />series, id:&nbsp; 1 , title:&nbsp; IT Crowd , release date:&nbsp; b'2006-02-03'<br />&gt; bulk upsert: episodes<br />&gt; select_prepared_transaction:<br />episode title: To Build a Better Beta , air date: b'2016-06-05'<br />&gt; select_prepared_transaction:<br />episode title: Bachman's Earnings Over-Ride , air date: b'2016-06-12'<br />&gt; explicit TCL call<br />&gt; select_prepared_transaction:<br />episode title: TBD , air date: b'2022-08-24' <br />Вернитесь в консоль управления Yandex Cloud, чтобы посмотреть на результаты работы приложения. Переключитесь на вкладку Навигация.<br />В вашей БД созданы три таблицы: episodes, seasons и series с информацией о двух популярных сериалах IT Crowd и Silicon Valley. Кликнув по названию таблицы, вы увидите содержащиеся в ней данные. А если подвести к названию таблицы курсор и кликнуть на значок &laquo;информация&raquo; справа, то внизу появится дополнительное окно с вкладками Обзор, Схема и Партиции.<br />Кнопка Создать на панели Навигация служит для создания директорий и таблиц. С её помощью можно создать новую таблицу, не прибегая к командам YQL.<br /><strong>Decision:</strong><br />$ git clone https://github.com/yandex-cloud/ydb-python-sdk.git<br />$ mkdir ~/.ydb<br />$ yc iam key create \<br />--service-account-name sa-ydb \<br />--output ~/.ydb/authorized_key.json <br />$ export YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS=~/.ydb/authorized_key.json<br />$ cd ydb-python-sdk/examples/basic_example_v1<br />$ python3 __main__.py \<br />-e &lt;Эндпоинт&gt; \<br />-d &lt;Размещение базы данных&gt; <br /><strong>Task:</strong><br />YQL и работа с данными<br />В этом уроке вы освоите базовый набор операций для работы с данными с использованием YQL и консоли управления Yandex.Cloud. <br /><strong>Decision:</strong><br />Чтобы начать, войдите в раздел Навигация консоли управления и откройте редактор SQL, нажав на кнопку SQL-запрос.<br />На прошлом уроке мы уже создали в нашей БД три таблицы, содержащие информацию о сериалах IT Crowd и Silicon Valley.<br />Добавим в БД еще одну таблицу с рейтингами эпизодов сериала IT Crowd на IMDb.com.<br />YQL является диалектом SQL, поэтому многие инструкции в этих языках идентичны.<br />Для создания таблицы вам понадобится сделать запрос к БД, содержащий инструкцию CREATE TABLE. Например, если бы мы хотели создать таблицу seasons (она уже есть в вашей БД), то SQL запрос выглядел бы следующим образом:<br />CREATE TABLE seasons<br />(<br />&nbsp;&nbsp;&nbsp; series_id Uint64, <br />&nbsp;&nbsp;&nbsp; season_id Uint64, <br />&nbsp;&nbsp;&nbsp; first_aired Date, <br />&nbsp;&nbsp;&nbsp; last_aired Date, <br />&nbsp;&nbsp;&nbsp; title Utf8, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRIMARY KEY (series_id, season_id)<br />); <br />Обратите внимание, что в пределах директории YDB имена таблиц должны быть уникальны. Первичный ключ (PRIMARY KEY) &mdash; это столбец или комбинация столбцов, однозначно идентифицирующих каждую строку в таблице. Он может содержать только неповторяющиеся значения. Для таблицы YDB указание первичного ключа обязательно, при этом он может быть только один.<br />Первичный ключ по сути является первичным индексом, который помогает СУБД быстрее обнаруживать отдельные записи в таблице и сокращает время выполнения запросов. Также в таблицу можно добавить один или несколько вторичных индексов. Они служат той же цели, но в отличие от первичного индекса могут содержать повторяющиеся значения. Добавить вторичные индексы можно в любой момент, когда возникнет необходимость, и это не вызовет деградацию производительности БД. Чтобы при создании таблицы добавить в нее вторичный индекс, используется такая конструкция:<br />INDEX &lt;имя индекса&gt; GLOBAL ON (&lt;имя столбца1&gt;, &lt;имя столбца2&gt;, ...) <br />Вторичный индекс можно добавить и в уже существующую таблицу. Работа БД при этом не прерывается. В отличие от предыдущего случая в существующую таблицу можно добавлять только один вторичный индекс за раз. Делается это с помощью следующей команды:<br />ALTER TABLE &lt;имя таблицы&gt; ADD INDEX &lt;имя индекса&gt; GLOBAL ON (&lt;имя столбца&gt;); <br /><strong>Task:</strong><br />создайте таблицу ratings, в которой будут содержаться рейтинги всех эпизодов сериала IT Crowd, со столбцами season_id (Uint64), episodes_id (Uint64), title (Utf8), air_date (Date) и imdb_rating (Uint64) и вторичным индексом rating_index по полю imdb_rating.<br /><strong>Decision:</strong><br />CREATE TABLE ratings (<br />&nbsp;&nbsp;&nbsp; season_id Uint64, <br />&nbsp;&nbsp;&nbsp; episodes_id Uint64, <br />&nbsp;&nbsp;&nbsp; title Utf8, <br />&nbsp;&nbsp;&nbsp; air_date Date, <br />&nbsp;&nbsp;&nbsp; imdb_rating Uint64, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PRIMARY KEY (season_id, episodes_id), <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INDEX rating_index GLOBAL ON (imdb_rating)<br />); <br /><strong>Decision:</strong><br />Добавим в эту таблицу данные. Для вставки данных в YDB помимо обычной SQL инструкции INSERT также используются инструкции REPLACE и UPSERT.<br />При выполнении INSERT перед операцией записи выполняется операция чтения данных. Это позволяет убедиться, что уникальность первичного ключа будет соблюдена. При выполнении инструкций REPLACE и UPSERT осуществляется слепая запись.<br />Инструкции REPLACE и UPSERT используются для добавления новой или изменения существующей строки по заданному значению первичного ключа. При операциях записи и изменения данных использование этих инструкций эффективнее.<br />Если при выполнении этих инструкций строка с указанным значением первичного ключа не существует, то она будет создана. Если же такая строка существует, то значения ее столбцов будут заменены на новые. Отличие между REPLACE и UPSERT заключается в том, что первая из этих инструкций устанавливает значения столбцов, не участвующих в операции, в значения по умолчанию, а вторая такие значения не меняет.<br />Одним запросом REPLACE, UPSERT или INSERT можно вставить в таблицу несколько строк.<br />Например, если бы мы хотели добавить в таблицу series те данные, которые в ней сейчас содержатся, то SQL запрос выглядел бы так:<br />REPLACE INTO series (series_id, title, release_date, series_info) <br />VALUES <br />&nbsp;&nbsp;&nbsp; ( <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "IT Crowd", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date("2006-02-03"), <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "The IT Crowd is a British sitcom produced by Channel 4, written by Graham Linehan, produced by Ash Atalla and starring Chris O'Dowd, Richard Ayoade, Katherine Parkinson, and Matt Berry."), <br />&nbsp;&nbsp;&nbsp; ( <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2, <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Silicon Valley", <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Date("2014-04-06"), <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Silicon Valley is an American comedy television series created by Mike Judge, John Altschuler and Dave Krinsky. The series focuses on five young men who founded a startup company in Silicon Valley." <br />&nbsp;&nbsp;&nbsp; ); <br /><strong>Task:</strong><br />добавьте в таблицу ratings данные из этого файла.<br /><strong>Decision:</strong><br />REPLACE INTO ratings (season_id, episodes_id, title, air_date, imdb_rating) VALUES <br />&nbsp;&nbsp;&nbsp; (1, 1, "Yesterday's Jam", Date("2006-02-03"), 76),<br />&nbsp;&nbsp;&nbsp; (1, 2, "Calamity Jen", Date("2006-02-03"), 82),<br />&nbsp;&nbsp;&nbsp; (1, 3, "Fifty-Fifty", Date("2006-02-10"), 79),<br />&nbsp;&nbsp;&nbsp; (1, 4, "The Red Door", Date("2006-02-17"), 80),<br />&nbsp;&nbsp;&nbsp; (1, 5, "The Haunting of Bill Crouse", Date("2006-02-24"), 85),<br />&nbsp;&nbsp;&nbsp; (1, 6, "Aunt Irma Visits", Date("2006-03-03"), 81),<br />&nbsp;&nbsp;&nbsp; (2, 1, "The Work Outing", Date("2006-08-24"), 95),<br />&nbsp;&nbsp;&nbsp; (2, 2, "Return of the Golden Child", Date("2007-08-31"), 82),<br />&nbsp;&nbsp;&nbsp; (2, 3, "Moss and the German", Date("2007-09-07"), 82),<br />&nbsp;&nbsp;&nbsp; (2, 4, "The Dinner Party", Date("2007-09-14"), 87),<br />&nbsp;&nbsp;&nbsp; (2, 5, "Smoke and Mirrors", Date("2007-09-21"), 78),<br />&nbsp;&nbsp;&nbsp; (2, 6, "Men Without Women", Date("2007-09-28"), 76),<br />&nbsp;&nbsp;&nbsp; (3, 1, "From Hell", Date("2008-11-21"), 78),<br />&nbsp;&nbsp;&nbsp; (3, 2, "Are We Not Men?", Date("2008-11-28"), 85),<br />&nbsp;&nbsp;&nbsp; (3, 3, "Tramps Like Us", Date("2008-12-05"), 82),<br />&nbsp;&nbsp;&nbsp; (3, 4, "The Speech", Date("2008-12-12"), 90),<br />&nbsp;&nbsp;&nbsp; (3, 5, "Friendface", Date("2008-12-19"), 85),<br />&nbsp;&nbsp;&nbsp; (3, 6, "Calendar Geeks", Date("2008-12-26"), 78),<br />&nbsp;&nbsp;&nbsp; (4, 1, "Jen The Fredo", Date("2010-06-25"), 80),<br />&nbsp;&nbsp;&nbsp; (4, 2, "The Final Countdown", Date("2010-07-02"), 84),<br />&nbsp;&nbsp;&nbsp; (4, 3, "Something Happened", Date("2010-07-09"), 75),<br />&nbsp;&nbsp;&nbsp; (4, 4, "Italian For Beginners", Date("2010-07-16"), 82),<br />&nbsp;&nbsp;&nbsp; (4, 5, "Bad Boys", Date("2010-07-23"), 84),<br />&nbsp;&nbsp;&nbsp; (4, 6, "Reynholm vs Reynholm", Date("2010-07-30"), 76); <br /><strong>Decision:</strong><br />C помощью SQL запросов можно добавлять и удалять не только строки таблицы, но и столбцы. Для этого используется команда ALTER TABLE и фразы ADD COLUMN и DROP COLUMN.<br />Например, если вы хотите добавить в таблицу ratings столбец viewed с данными о том, какие эпизоды сериала вы уже посмотрели, то это можно сделать с помощью следующей команды.<br />ALTER TABLE ratings ADD COLUMN viewed Bool; &nbsp;<br /><strong>Task:</strong><br />Вы решили, что столбец с датой выхода эпизодов в таблице ratings не нужен, поскольку эта информация уже содержится в другой таблице. Удалите столбец air_date из таблицы ratings.<br /><strong>Decision:</strong><br />ALTER TABLE ratings DROP COLUMN air_date; <br /><strong>Decision:</strong> <br />Теперь потренируемся извлекать данные из БД. Для этого используется команда SELECT. В простейшем случае ее синтаксис выглядит так:<br />SELECT &lt;имя столбца1&gt;, &lt;имя столбца2&gt;, ...<br />FROM &lt;имя таблицы&gt;; <br />Например, чтобы выбрать всю информацию из таблицы seasons, нужно сделать следующий запрос к БД.<br />SELECT * FROM seasons; <br />Если нужно выбрать из таблицы только те строки, которые удовлетворяют определенному условию, в запросе используют секцию WHERE. В этой секции должно находиться выражение, возвращающее логический результат. Обычно оно состоит из логических операций and, or, not и операций сравнения.<br />Например, выбрать из таблицы episodes только первые эпизоды всех сезонов можно так:<br />SELECT * FROM episodes<br />WHERE episode_id = 1; &nbsp;<br />Запрос SELECT извлекает строки без определенного порядка. Чтобы отсортировать полученные данные нужным образом, в этот запрос включают секцию ORDER BY. В ней указывается список столбцов, которые будут определять порядок сортировки результатов запроса.<br /><strong>Task:</strong> <br />получите список самых популярных (с рейтингом не менее 85) эпизодов сериала IT Crowd. При поиске используйте созданный ранее вторичный индекс rating_index. Чтобы упорядочить результаты по убыванию рейтинга используйте конструкцию ORDER BY &hellip; DESC.<br /><strong>Decision:</strong><br />SELECT <br />&nbsp;&nbsp;&nbsp; season_id, <br />&nbsp;&nbsp;&nbsp; episodes_id, <br />&nbsp;&nbsp;&nbsp; title, <br />&nbsp;&nbsp;&nbsp; imdb_rating<br />FROM ratings VIEW rating_index <br />WHERE <br />&nbsp;&nbsp;&nbsp; imdb_rating &gt;= 85 <br />ORDER BY <br />&nbsp;&nbsp;&nbsp; imdb_rating DESC; &nbsp;<br /><strong>Decision:</strong><br />Для получения обобщённых сведений о содержащихся в таблице данных &mdash; например, о числе строк в таблице или среднем значении какого-либо выражения &mdash; в запрос SELECT включают агрегатные функции и секцию GROUP BY. Эта секция используется для агрегации внутри каждого ключа. Ключом является значение одной или более колонок, указанных в GROUP BY.<br />Примеры агрегатных функций:<br />COUNT(*) &mdash; вычисляет число строк в таблице.<br />MAX(expr) &mdash; находит максимум выражения expr по всем строкам.<br />SUM(expr) &mdash; суммирует выражение expr по всем строкам. Тип выражения должен быть числовым.<br />AVG(expr) &mdash; находит среднее значение выражения expr по всем строкам. Тип выражения должен быть числовым или интервалом.<br />SOME(expr) &mdash; возвращает одно произвольное значение выражения по всем строкам.<br />Результаты выполнения агрегатной функции выводятся в отдельном столбце. Чтобы задать этому столбцу имя, используют оператор AS. Конструкция может выглядеть, например, так:<br />SELECT <br />&nbsp;&nbsp;&nbsp; &lt;имя столбца1&gt;, <br />&nbsp;&nbsp;&nbsp; MAX(&lt;имя столбца2&gt;) AS max_value<br />...; <br /><strong>Task:</strong><br />Напишите SQL запрос к таблице episodes, который выводит данные о числе эпизодов каждого сериала.<br />Вам понадобится вычислить число строк для каждого значения столбца series_id и сгруппировать результаты по series_id.<br /><strong>Decision:</strong><br />SELECT <br />&nbsp;&nbsp;&nbsp; series_id, <br />&nbsp;&nbsp;&nbsp; COUNT(*) AS total_episodes <br />FROM episodes <br />GROUP BY <br />&nbsp;&nbsp;&nbsp; series_id <br />ORDER BY <br />&nbsp;&nbsp;&nbsp; series_id; <br /><strong>Task:</strong> <br />Напишите SQL запрос, с помощью которого можно сравнить популярность сезонов сериала IT Crowd. <br />Вам понадобится вычислить средний рейтинг эпизодов для каждого сезона и сгруппировать результаты по столбцу season_id.<br /><strong>Decision:</strong><br />SELECT <br />&nbsp;&nbsp;&nbsp; season_id, <br />&nbsp;&nbsp;&nbsp; AVG (imdb_rating) AS avg_rating<br />FROM ratings <br />GROUP BY season_id<br />ORDER BY avg_rating DESC; <br /><strong>Decision:</strong><br />В реляционной БД таблицы логически связаны друг с другом. С помощью объединений (JOIN) можно получить данные из нескольких связанных друг с другом таблиц и представить их в виде одной результирующей таблицы.<br />Столбцы, по которым выполняется объединение, можно указать одним из двух способов.<br />- После ключевого слова USING, например table1 AS a JOIN table2 AS b USING (foo). Это более короткий способ записи, удобный для простых случаев. Имена столбцов, по которым происходит объединение таблиц, должны быть одинаковы.<br />- После ключевого слова ON (например, a JOIN b ON a.foo = b.bar). Этот способ позволяет использовать разные имена столбцов и указывать дополнительные условия по аналогии с WHERE.<br />Поскольку такие запросы затрагивают столбцы разных таблиц, имена столбцов должны содержать и имя таблицы (то есть, например, не просто series_id, а seasons.series_id).<br />В YDB доступны следующие логические типы объединений:<br />INNER (используется по умолчанию) &mdash; строки попадают в результат, только если значение ключевых колонок присутствует в обеих таблицах;<br />FULL, LEFT и RIGHT &mdash; при отсутствии значения в обеих или в одной из таблиц включает строку в результат, но оставляет пустыми (NULL) колонки, соответствующие противоположной таблице.<br />LEFT/RIGHT SEMI &mdash; одна сторона выступает как белый список (whitelist) ключей, её значения недоступны. В результат включаются столбцы только из одной таблицы, декартового произведения не возникает;<br />LEFT/RIGHT ONLY &mdash; вычитание множеств по ключам (blacklist). Практически эквивалентно добавлению условия IS NULL на ключ противоположной стороны в обычном LEFT/RIGHT, но, как и в SEMI, нет доступа к значениям;<br />CROSS &mdash; декартово произведение двух таблиц целиком без указания ключевых колонок, секция с ON/USING явно не пишется;<br />EXCLUSION &mdash; обе стороны минус пересечение.<br />Простой пример запроса с объединением таблиц приведен ниже.<br />SELECT<br />&nbsp;&nbsp;&nbsp; sa.title AS season_title,<br />&nbsp;&nbsp;&nbsp; sr.title AS series_title,<br />&nbsp;&nbsp;&nbsp; sr.series_id, sa.season_id <br />FROM seasons AS sa<br />INNER JOIN series AS sr ON sa.series_id = sr.series_id <br />WHERE sa.season_id = 1<br />ORDER BY sr.series_id; <br />Этот запрос извлекает из таблиц series и seasons сведения о первых сезонах всех сериалов и выводит объединённые данные в результирующей таблице.<br /><strong>Task:</strong> <br />напишите запрос, который выводит таблицу, содержащую название сериала IT Crowd и названия всех его эпизодов (то есть, каждая строка итоговой таблице должна содержать название сериала и название отдельного эпизода).<br /><strong>Decision:</strong><br />SELECT <br />&nbsp;&nbsp;&nbsp; sr.title AS series_title, <br />&nbsp;&nbsp;&nbsp; ep.title AS episode_title, <br />&nbsp;&nbsp;&nbsp; ep.season_id,&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; ep.episode_id <br />FROM <br />&nbsp;&nbsp;&nbsp; series AS sr <br />INNER JOIN <br />&nbsp;&nbsp;&nbsp; episodes AS ep <br />ON sr.series_id = ep.series_id <br />WHERE sr.series_id = 1 <br />ORDER BY <br />&nbsp;&nbsp;&nbsp; ep.season_id,&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; ep.episode_id; &nbsp;<br /><strong>Task:</strong><br />Создание кластера Hadoop.<br />На этом уроке вы создадите и настроите кластер Hadoop с помощью сервиса Yandex Data Proc. <br />Hadoop предназначается для работы с большими данными, поэтому создание кластера потребует от вас больше усилий, чем на предыдущих практических работах (но гораздо меньше, чем если бы вы делали это самостоятельно).<br /><strong>Decision:</strong><br />Для хранения зависимостей заданий нашего кластера и результатов их выполнения нужно предварительно создать бакет в объектном хранилище. О том, как это сделать, мы рассказывали на одном из предыдущих занятий.<br />Также создайте сервисный аккаунт для доступа к кластеру. Обратите внимание: можно использовать только аккаунт с ролью mdb.dataproc.agent. Для автоматического масштабирования кластера сервисному аккаунту также понадобятся роли editor и dataproc.agent.<br />Откройте каталог, где будете создавать кластер, и выберите сервис Data Proc.<br />В открывшемся окне нажмите кнопку Создать кластер.<br />Задайте для кластера имя и выберите версию образа &mdash; 1.4. В образ включена одна из версий Hadoop и дополнительные компоненты. Некоторые вы можете устанавливать по выбору. Кроме того, в каждую версию образа входит Conda (менеджер окружений для Python) и набор инструментов машинного обучения (scikit-learn, TensorFlow, CatBoost, LightGBM и XGBoost).<br />Обратите внимание на то, что некоторые из сервисов обязательны, чтобы использовать другие. На следующем уроке нам понадобится сервис HIVE. Выберите его, и рядом с MAPREDUCE и YARN вы увидите напоминания о том, что они нужны для HIVE.<br />Вставьте в поле публичный ключ публичную часть SSH-ключа. Как сгенерировать и использовать SSH-ключи, мы рассказывали в одной из практических работ о виртуальных машинах.<br />Выберите созданный сервисный аккаунт для доступа к кластеру.<br />Выберите зону доступности для кластера. Все подкластеры будут находиться в этой <br />Если нужно, задайте свойства Hadoop и его компонентов. Доступные свойства перечислены в документации.<br />Выберите бакет в объектном хранилище, где будут храниться зависимости заданий и результаты их выполнения.<br />Выберите или создайте сеть для кластера. Включите опцию NAT в интернет для подсетей, в которых размещается кластер.<br />Если нужно, создайте группу безопасности. Правила для неё вы добавите позже в сервисе Virtual Private Cloud.<br />Включите опцию UI Proxy, чтобы получить доступ к веб-интерфейсам компонентов Data Proc. У некоторых компонентов (например Hadoop, Spark, YARN и Zeppelin) есть пользовательские веб-интерфейсы, доступные на мастер-узле кластера. С помощью этих интерфейсов вы можете:<br />- отслеживать ресурсы кластера и управлять ими (YARN Resource Manager, HDFS NameNode);<br />- просматривать статус и отлаживать задания (Spark History, JobHistory);<br />- проводить эксперименты, совместно работать или выполнять отдельные операции (Zeppelin).<br />Настройка подкластеров. В состав кластера входит один главный подкластер (Мастер) с управляющим хостом, а также подкластеры для хранения данных (Data) или вычислений (Compute).<br />В подкластерах Data можно разворачивать компоненты для хранения данных, а в подкластерах Compute &mdash; для обработки данных. Хранилище в подкластере Compute предназначено только для временного хранения обрабатываемых файлов.<br />Для каждого подкластера можно задать число и класс хостов, размер и тип хранилища, а также подсеть той сети, в которой расположен кластер. Кроме того, для подкластеров Compute можно настроить автоматическое масштабирование. Это позволит выполнять задания на обработку данных быстрее без дополнительных усилий с вашей стороны.<br />Создадим подкластер Compute с одним хостом.<br />В блоке Добавить подкластер нажмите кнопку Добавить.<br />В поле Роли выберите COMPUTENODE. В блоке Масштабирование включите опцию Автоматическое масштабирование.<br />Все открывшиеся настройки знакомы вам из практических работ по созданию виртуальных машин.<br />Автоматическое масштабирование подкластеров обработки данных поддерживается в кластерах Yandex Data Proc версии 1.2 и выше. Чтобы оно работало, в кластере с установленным Spark или Hive должен быть также установлен сервис YARN.<br />Yandex Data Proc автоматически масштабирует кластер, используя для этого системные метрики нагрузки на кластер. Когда их значение выходит из установленного диапазона, запускается масштабирование. Если значение метрики превысит порог, в подкластер добавятся хосты. Если опустится ниже порога, начнётся декомиссия (высвобождение ненужных ресурсов), а избыточные хосты удалятся.<br />По умолчанию для масштабирования используется внутренняя метрика YARN (yarn.cluster.containersPending). Она показывает, сколько единиц ресурсов нужно заданиям в очереди. Выбирайте эту опцию Масштабирование по умолчанию, если в кластере выполняется много относительно небольших заданий.<br />Другой вариант &mdash; масштабирование на основе метрики загрузки процессора (vCPU). Чтобы использовать его, отключите опцию Масштабирование по умолчанию и укажите целевой уровень загрузки vCPU.<br />Настроив подкластеры, нажмите кнопку Создать кластер.<br />Сервис запустит создание кластера. После того как статус кластера изменится на Running, вы сможете подключиться к любому активному подкластеру с помощью указанного в настройках SSH-ключа.<br /><strong>Task:</strong><br />Подключение к кластеру и работа с Hive.<br />На этом уроке вы научитесь подключаться к кластеру Hadoop и работать с ним на примере выполнения запросов с помощью Hive.<br /><strong>Decision:</strong><br />Подключимся к управляющему хосту главного подкластера. Поскольку хостам кластера Hadoop не назначается публичный IP-адрес, для подключения к ним нужна виртуальная машина, расположенная в той же сети Yandex Cloud.<br />Выберите машину, которую создавали раньше, или создайте новую. Подключитесь к ней по SSH. Вы уже делали это, когда изучали виртуальные машины.<br />Подключитесь с этой машины к хосту главного подкластера также с помощью SSH. Для этого на машине должна быть закрытая часть SSH-ключа, открытую часть которого вы указали при создании кластера Data Proc. Вы можете скопировать ключ на виртуальную машину или подключаться к ней с запущенным SSH-агентом.<br />Скопировать ключ можно с помощью утилиты nano. На виртуальной машине выполните команду:<br />sudo nano ~/.ssh/&lt;имя ключа&gt; <br />В открывшийся редактор скопируйте содержимое закрытой части SSH-ключа с вашей локальной машины.<br />Запустите SSH-агент:<br />eval `ssh-agent -s` <br />Добавьте ключ в список доступных агенту:<br />ssh-add ~/.ssh/&lt;имя ключа&gt; <br />Узнайте внутренний FQDN хоста главного подкластера. Для этого в консоли управления на странице кластера перейдите на вкладку Хосты и выберите хост с ролью MASTERNODE.<br />Откройте SSH-соединение с хостом Data Proc для пользователя root, например:<br />ssh root@&lt;FQDN хоста&gt; <br />Пошаговые инструкции по различным способам подключения к кластеру Data Proc приведены в документации.<br />Проверим, что команды Hadoop выполняются, например:<br />hadoop version <br />Результат выполнения этой команды выглядит так:<br />Запуск заданий Apache Hive<br />Как мы уже говорили ранее, Hive &mdash; это платформа для хранения данных и управления ими в экосистеме Hadoop. Она используется для доступа к большим датасетам, сохранённым в распределённом хранилище.<br />Hive позволяет работать с данными различного формата (csv, tsv, Parquet, ORC, Avro и другими), подключаться к БД и взаимодействовать с ней с помощью SQL-подобного языка запросов. Hive используется преимущественно для работы с данными в HDFS, HBase, S3-совместимых хранилищах и реляционных СУБД.<br />Запрос на действия с данными в Hive называется заданием. Задания можно запускать на управляющем хосте с помощью командной оболочки CLI Hive, а также с помощью CLI Yandex Cloud.<br />Для запуска Hive CLI выполните команду hive на управляющем хосте.<br />Проверьте, всё ли работает: выполните, например, команду select 1; &mdash; корректный результат выглядит так:<br />Теперь создайте внешнюю таблицу (external table) в формате Parquet, содержащую открытые данные о списке перелётов между городами США в 2018 году. Для этого с помощью Hive CLI выполните запрос:<br />hive&gt; CREATE EXTERNAL TABLE flights (Year bigint, Month bigint, FlightDate string, Flight_Number_Reporting_Airline bigint, OriginAirportID bigint, DestAirportID bigint) STORED AS PARQUET LOCATION 's3a://yc-mdb-examples/dataproc/example01/set01'; <br />Проверим список таблиц, выполнив команду show tables. Результат должен выглядеть так:<br />Запросим число перелётов с разбивкой по месяцам:<br />hive&gt; SELECT Month, COUNT(*) FROM flights GROUP BY Month; <br />Пример результата такого запроса:<br />Безусловно, на одном примере сложно показать возможности сервиса Data Proc. Если вас интересует работа с большими данными в облаке, посмотрите доклады сотрудников Yandex Cloud об управлении кластерами Hadoop и заданиями в Data Proc на YouTube-канале Yandex Cloud.<br /><strong>Decision:</strong><br />$ cat YOUR-KEY<br />$ eval `ssh-agent -s`<br />$ ssh-add YOUR-KEY<br />$ ssh root@&lt;FQDN хоста&gt; <br />$ hadoop version<br />$ hive<br />hive&gt; select 1;<br />hive&gt; CREATE EXTERNAL TABLE flights (Year bigint, Month bigint, FlightDate string, Flight_Number_Reporting_Airline bigint, OriginAirportID bigint, DestAirportID bigint) STORED AS PARQUET LOCATION 's3a://yc-mdb-examples/dataproc/example01/set01';<br />hive&gt; show tables;<br />hive&gt; SELECT Month, COUNT(*) FROM flights GROUP BY Month;<br /><strong>Task:</strong><br />Создание датасетов, чартов и дашбордов.<br />На этом уроке вы научитесь создавать чарты и дашборды. Мы пройдём по всей цепочке сущностей DataLens начиная с источника данных.<br />Изучая ClickHouse, мы анализировали данные о погоде с помощью SQL-запросов. <br />Давайте посмотрим на примере того же самого набора данных, как с помощью DataLens быстро и наглядно показать отличия климата в Москве и Санкт-Петербурге.<br /><strong>Decision:</strong><br />Источник данных.ClickHouse и DataLens интегрированы друг с другом, поэтому подключение DataLens к ClickHouse можно настроить всего за пару кликов.<br />В консоли управления запустите кластер ClickHouse, в котором развёрнута БД с таблицей Weather, созданной вами ранее. Перейдите на страницу кластера, на панели слева выберите DataLens.<br />Подключение. Нажмите кнопку Создать подключение. В открывшемся диалоговом окне вы увидите, что кластер ClickHouse, из которого мы возьмём данные для анализа, имя хоста и имя пользователя БД уже указаны.<br />Вам осталось только дать имя подключению в пустом поле вверху, ввести пароль к БД, нажать кнопку Проверить подключение и убедиться, что всё в порядке, а потом &mdash; кнопку Создать.<br />Датасет. После того как подключение будет создано, DataLens выведет на панели слева таблицы из БД и предложит создать датасет. Наш датасет будет состоять из одной таблицы: db1.Weather. Перетащите её на центральную панель, и внизу откроется предпросмотр данных.<br />Нажмите кнопку Сохранить и задайте имя датасета.<br />Подготовим данные. Это важная часть аналитической работы, и её не стоит пропускать. Прежде всего укажем имена полей на русском языке. Перейдите на вкладку Поля и переименуйте их:<br />- LocalDateTime - Дата и время<br />- LocalDate - Дата<br />- Month - Месяц<br />- Day - День<br />- TempC - Температура<br />- Pressure - Давление<br />- RelHumidity - Влажность<br />- Тип WindSpeed10MinAvg - Скорость ветра<br />- VisibilityKm - Видимость<br />- City - Город<br />Поля Дата и время, Дата, Месяц, День, Город будут полями-измерениями, а Температура, Давление, Влажность, Скорость ветра, Видимость &mdash; полями-показателями. Зададим для показателей тип агрегации Среднее.<br />Чарты. Приступим к созданию первого чарта. Нажмите кнопку Создать чарт. Выберите тип чарта Линейная диаграмма и перетащите Дата в раздел X , а Температура &mdash; в раздел Y.<br />На этом примере видно, что средства визуализации иногда помогают быстро проверить качество датасета: есть ли в нём пропущенные или странные, выбивающиеся из общей тенденции данные.<br />В нашем случае можно сделать вывод о том, что в датасете не хватает данных примерно с середины 2015-го по середину 2016-го.<br />Разделим показатели температуры для двух городов. Для этого перетащим Город в раздел Цвета. Кроме того, округлим значения поля Дата до месяцев, чтобы лучше увидеть, как различаются данные для Москвы и Санкт-Петербурга. Для этого слева от поля Дата нажмите зелёный значок календаря и в разделе Группировка выберите округление по месяцам.<br />Из этого графика уже можно делать выводы. В целом температура в Москве выше, чем в Санкт-Петербурге. Летом примерно на 5 градусов, зимой &mdash; на 1&minus;2 градуса.<br />Сохраните чарт, чтобы затем использовать его для дашборда.<br />Чтобы окончательно разобраться с температурой, построим ещё один чарт &mdash; Столбчатую диаграмму &mdash; и сравним среднегодовую температуру. Выберите тип диаграммы. Добавьте поле Город в раздел X, чтобы разделить отображение значений температуры. Также для поля Дата выберите группировку по годам.<br />Кроме того, для чарта понадобится задать фильтр по датам. Поскольку мы сравниваем среднегодовые значения, неполные данные за 2009 и 2019 годы отбросим. В разделе Фильтры нажмите + и выберите поле Дата.<br />Для этого чарта мы возьмём только данные из диапазона с начала 2010-го по конец 2018-го. Нажмите кнопку Применить фильтр и сохраните чарт.<br />Сделайте сами два таких же чарта с данными о скорости ветра: линейную диаграмму со среднемесячными значениями скорости ветра в городах и столбчатую диаграмму со среднегодовыми значениями.<br />Теперь у нас достаточно чартов для информативного дашборда.<br />Дашборд. На панели слева выберите Дашборды и нажмите кнопку Создать дашборд. Введите название дашборда и нажмите Создать.<br />Если в каталоге это первый дашборд &mdash; он откроется сразу после создания. Если в каталоге есть другие дашборды, вы увидите список. В этом случае выберите из списка только что созданный дашборд.<br />Теперь добавим созданные нами чарты на дашборд. Нажмите Добавить и в выпадающем списке выберите Чарт. Поочерёдно выбирайте из списка и добавляйте чарты.<br />В результате на дашборде появятся четыре виджета с чартами. Меняйте размеры и положение виджетов для лучшей визуализации.<br />Осталось лишь несколько последних штрихов. В том же пункте меню Добавить создадим пару заголовков и селектор по датам. В правом верхнем углу каждого виджета нажмите значок шестерёнки, чтобы изменить названия. Сохраним дашборд. <br />То, какие чарты сделать и как их разместить на дашборде, бывает понятно не сразу. Рассмотрите несколько вариантов, когда строите дашборд, чтобы разобраться, какая именно визуализация лучше помогает ответить на вопросы.<br />В маркетплейсе DataLens вы найдёте ещё один дашборд с погодой. Он хорошо демонстрирует возможности визуализации данных этого сервиса.<br />Чтобы открыть публичный доступ к дашборду, справа от его названия нажмите &middot;&middot;&middot; и выберите Публичный доступ. Скопируйте ссылку. По ней дашборд будет доступен всем, с любых устройств и без аутентификации.</p>
                    </div>
                </div> 
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Devops и автоматизация в Yandex Cloud</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты практической работы по теме "Devops и автоматизация" поднял кластер Kubernetes в Yandex Cloud, благодаря которому развернул приложение веб-сервер NGINX c Балансировкой нагрузки и Автомасштабированием в Yandex Managed Kubernetes и проверил на отказоустойчивость по основным сценариям сбоев<br /><strong>Task:</strong><br />Начало работы в CLI. На этой практической работе мы установим утилиту yc, познакомимся с режимом подсказок --help и выполним несколько простых команд.<br /><strong>Decision:</strong><br />Первым делом скачайте и установите CLI (если вы ещё не сделали этого в предыдущих курсах).<br />Теперь настройте программу для работы с вашим аккаунтом и облаком. Для этого запустите командную строку и введите команду:<br />yc init <br />В консоли появится предложение перейти по ссылке, чтобы программа получила доступ к аккаунту и облаку. Перейдите по ссылке, согласитесь с условиями, затем скопируйте токен и вставьте его в окно командной строки.<br />Срок жизни токена &mdash; один год. Через год необходимо получить новый токен и повторить аутентификацию.<br />Если кто-то узнал ваш токен, отзовите его и запросите новый.<br />Продолжайте установку: выберите облако, каталог и зону доступности по умолчанию. Следуйте указаниям системы и завершите настройку.<br />При установке автоматически создается профиль default, в него записываются выбранные настройки.<br />Список профилей можно посмотреть командой:<br />yc config profile list <br />Флаг --help<br />На прошлом уроке вы узнали о флагах, которые используются при запуске команд. Пожалуй, самый важный и частый флаг &mdash; --help (сокращенно -h), поэтому поговорим о нём подробнее.<br />Команд для управления ресурсами облака много. Вы запомните некоторые, но помнить всё невозможно. Пользуйтесь флагом --help, когда пишете команду. В этом случае она не выполняется, а в консоль выводится информация о ресурсах, которыми управляет команда, и параметрах запуска.<br />Помните, на предыдущем уроке мы говорили о типичной структуре большинства команд CLI (сервис &mdash; ресурс &mdash; действие &mdash; флаги)?<br />Важная особенность флага --help заключается в том, что его можно применять для каждого уровня этой структуры и писать команду постепенно.<br />В этой практической работе нам понадобится ВМ в облаке. Если у вас нет ВМ &mdash; создайте её в консоли управления, как мы это делали в предыдущих курсах.<br />Допустим, вы хотите перезапустить эту ВМ, но не помните полный синтаксис команды.<br />Сначала вызовите описание сервиса Yandex Compute Cloud:<br />yc compute --help <br />Вы увидите синтаксис команды (раздел Usage), список ресурсов, которыми можно управлять (Groups), а также действий (Commands) и флагов<br />Вам нужна ВМ &mdash; ресурс instance. Теперь узнайте, как получить список активных ВМ и какая команда отвечает за перезапуск:<br />yc compute instance --help <br />Сначала получите список ВМ, это команда list:<br />yc compute instance list <br />Результатом выполнения команды будет список машин в том каталоге, где вы работаете, с именами и идентификаторами:<br />+----------------------+-------------+---------------+---------+----------------+-------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp; ZONE ID&nbsp;&nbsp;&nbsp; | STATUS&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |<br />+----------------------+-------------+---------------+---------+----------------+-------------+<br />| fhm2p20bifmg3k3voda7 | my-instance | ru-central1-a | RUNNING | ХХХ.ХХХ.ХХХ.ХХ | ХХ.ХХХ.Х.ХХ |<br />+----------------------+-------------+---------------+---------+----------------+-------------+ <br />На шаге 2 вы нашли команду перезапуска &mdash; restart, теперь можно посмотреть её синтаксис:<br />yc compute instance restart --help <br />Наконец, вы получили полный синтаксис команды перезапуска. Примените её к ВМ:<br />yc compute instance restart --name &lt;имя_ВМ&gt; <br />По такому принципу вы можете сформировать в консоли любую команду.<br />Итак, подведём итоги. Чтобы уточнить синтаксис или порядок действий при работе с CLI, выберите один из трёх путей: найдите нужное действие на странице сервиса Yandex Cloud в документации и там переключитесь на вкладку CLI; найти команду в справочнике о yc; воспользуйтесь флагом --help, шаг за шагом уточняя возможности и синтаксис команды.<br />Синхронный и асинхронный режимы работы. Некоторые команды выполняются очень быстро. Например, создание каталога или просмотр настроек профиля. Такие команды можно выполнять подряд, одну за другой &mdash; без задержек.<br />Если при выполнении команды ресурс изменяет состояние, создается операция. Примеры операций &mdash; перезапуск ВМ после обновления или резервное копирование базы данных.<br />Если каждая следующая команда ждёт завершения предыдущей операции, такой режим выполнения называется синхронным. Когда какая-то операция в синхронном режиме выполняется долго, CLI выводит в консоли точки и время с начала операции, чтобы показать, что процесс не завис:<br />...1s...6s...12s...17s <br />Операция может выполняться довольно долго, а ожидание &mdash; затормозить процесс. В таких случаях важно оценить, нужен ли результат операции для выполнения следующих команд. Если нет &mdash; можно не ждать её завершения и сразу же переходить к следующей команде. Этот режим называется асинхронным.<br />Чтобы выполнить команду асинхронно, используйте флаг --async.<br />Перезапустите одну из ранее созданных ВМ в асинхронном режиме (в команде укажите имя этой ВМ):<br />yc compute instance restart --name &lt;имя_ВМ&gt; --async <br />В ответ на асинхронный вызов CLI выводит идентификатор операции (в поле id) и информацию о ней:<br />id: fhm5k7iq03rm2s7enhdk<br />description: Restart instance<br />created_at: "2021-03-27T08:32:47.562595036Z"<br />created_by: aje9cb7k03512mrugcee<br />modified_at: "2021-03-27T08:32:47.562595036Z"<br />metadata:<br />&nbsp; '@type': type.googleapis.com/yandex.cloud.compute.v1.RestartInstanceMetadata<br />&nbsp; instance_id: fhm2p20bifmg3k3voda7 <br />С помощью идентификатора операции вы можете проверить результаты её выполнения:<br />yc operation get &lt;идентификатор_операции&gt; <br />Когда операция завершится, вы увидите результат:<br />id: fhm5k7iq03rm2s7enhdk<br />...<br />done: true<br />... <br /><strong>Decision:</strong><br />$ yc init<br />$ yc config profile list<br />$ yc compute --help<br />$ yc compute instance --help<br />$ yc compute instance list<br />$ yc compute instance restart --help<br />$ yc compute instance restart --name ubuntu-test<br />$ yc compute instance restart --name ubuntu-test --async<br />$ yc operation get fhmq5a4aren4lmigbt03<br /><strong>Task:</strong><br />Создание виртуальных машин с помощью CLI. Создание ВМ &mdash; одна из самых сложных команд CLI, потому что в ней очень много параметров. <br />Давайте потренируемся работать с ней.&nbsp; Но сначала подготовим окружение.<br />Мы будем работать в каталоге по умолчанию. Создадим в нём сеть, в ней &mdash; три подсети, а затем по ВМ в каждой подсети.<br /><strong>Decision:</strong><br />Создайте сеть my-network в Virtual Private Cloud. Эта команда относится к группе vpc. <br />yc vpc network create --name my-network<br />Выполнение операции займёт какое-то время. В итоге сеть появится в каталоге, который вы выбрали в предыдущей практической работе.<br />Теперь создадим три подсети в разных зонах доступности (ru-central1-a, ru-central1-b, ru-central1-c). Чтобы проще было выполнять задания дальше, назовите их my-subnet-1, my-subnet-2 и my-subnet-3. А пространства IP-адресов для подсетей укажите, соответственно, как 192.168.1.0/24, 192.168.2.0/24 и 192.168.3.0/24.<br />Не забудьте указать, что вы создаёте подсети в новой сети, созданной на предыдущем шаге. Иначе они появятся в сети по умолчанию, которая есть в каждом каталоге.<br />Вот так выглядит команда создания подсети в зоне доступности ru-central1-a:<br />yc vpc subnet create \<br />&nbsp; --name my-subnet-1 \<br />&nbsp; --zone ru-central1-a \<br />&nbsp; --range 192.168.1.0/24 \<br />&nbsp; --network-name my-network <br />Где: name &mdash; имя подсети. zone &mdash; зона доступности. range &mdash; адресное пространство подсети. network-name &mdash; имя сети, в которой создаётся подсеть.<br />Создайте две другие подсети сами.<br />yc vpc subnet create \<br />&nbsp; --name my-subnet-2 \<br />&nbsp; --zone ru-central1-b \<br />&nbsp; --range 192.168.2.0/24 \<br />&nbsp; --network-name my-network<br />yc vpc subnet create \<br />&nbsp; --name my-subnet-3 \<br />&nbsp; --zone ru-central1-c \<br />&nbsp; --range 192.168.3.0/24 \<br />&nbsp; --network-name my-network <br />Осталось создать три ВМ в нужных зонах доступности и привязать к ним подсети.<br />Пусть машины работают под управлением ОС Ubuntu 20.04 LTS, имеют диски объёмом 30 Гб, 4 Гб оперативной памяти и два виртуальных процессорных ядра.<br />ВМ могут создаваться долго, поэтому запускайте команды в асинхронном режиме.<br />Пример команды для первой ВМ:<br />yc compute instance create \<br />&nbsp; --name my-instance-1 \<br />&nbsp; --hostname my-instance-1 \<br />&nbsp; --zone ru-central1-a \<br />&nbsp; --create-boot-disk image-family=ubuntu-2004-lts,size=30,type=network-nvme \<br />&nbsp; --image-folder-id standard-images \<br />&nbsp; --memory 4 --cores 2 --core-fraction 100 \<br />&nbsp; --network-interface subnet-name=my-subnet-1,nat-ip-version=ipv4 \<br />&nbsp; --async <br />Посмотрите внимательно на все параметры. Подумайте, какой из них за что отвечает.<br />Создайте две другие машины сами.<br />yc compute instance create \<br />&nbsp; --name my-instance-2 \<br />&nbsp; --hostname my-instance-2 \<br />&nbsp; --zone ru-central1-b \<br />&nbsp; --create-boot-disk image-family=ubuntu-2004-lts,size=30,type=network-nvme \<br />&nbsp; --image-folder-id standard-images \<br />&nbsp; --memory 4 --cores 2 --core-fraction 100 \<br />&nbsp; --network-interface subnet-name=my-subnet-2,nat-ip-version=ipv4 \<br />&nbsp; --async<br />&nbsp;yc compute instance create \<br />&nbsp; --name my-instance-3 \<br />&nbsp; --hostname my-instance-3 \<br />&nbsp; --zone ru-central1-c \<br />&nbsp; --create-boot-disk image-family=ubuntu-2004-lts,size=30,type=network-nvme \<br />&nbsp; --image-folder-id standard-images \<br />&nbsp; --memory 4 --cores 2 --core-fraction 100 \<br />&nbsp; --network-interface subnet-name=my-subnet-3,nat-ip-version=ipv4 \<br />&nbsp; --async <br />После выполнения каждой команды благодаря флагу --async вы получите идентификатор операции и ее описание в виде:<br />id: c9q9v4bsn1hs9api4b13<br />description: Create instance<br />created_at: "2021-03-01T03:23:00.079888Z"<br />created_by: aje8s4vd4pp7cduq2o4k<br />modified_at: "2022-07-29T09:14:53.567744154Z"<br />metadata:<br />&nbsp; '@type': type.googleapis.com/yandex.cloud.compute.v1.CreateInstanceMetadata<br />&nbsp; instance_id: fhmepiaciq5l9slqid3k <br />Проследите за статусом одной из операций, используя ее идентификатор.<br />Проверьте синтаксис команды.<br />yc operation get &lt;идентификатор_операции&gt; <br />Дождитесь, пока операция завершится. Используйте для этого команду wait.<br />Проверьте синтаксис команды<br />yc operation wait &lt;идентификатор_операции&gt; <br />Убедитесь, что ВМ созданы. Для этого выведите их список.<br />yc compute instance list <br />По умолчанию список выдается в виде таблицы:<br />+----------------------+---------------+---------------+---------+---------------+--------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp; ZONE ID&nbsp;&nbsp;&nbsp; | STATUS&nbsp; |&nbsp; EXTERNAL IP&nbsp; | INTERNAL IP&nbsp; |<br />+----------------------+---------------+---------------+---------+---------------+--------------+<br />| ef34r4fs8dsva3qtsivs | my-instance-3 | ru-central1-c | RUNNING | 51.250.44.130 | 192.168.3.34 |<br />| epdj7u79isrolup3vfo8 | my-instance-2 | ru-central1-b | RUNNING | 158.160.6.249 | 192.168.2.28 |<br />| fhmepiaciq5l9slqid3k | my-instance-1 | ru-central1-a | RUNNING | 62.84.126.39&nbsp; | 192.168.1.30 |<br />+----------------------+---------------+---------------+---------+---------------+--------------+ <br />Список можно вывести в формате YAML или JSON (эта возможность пригодится вам на следующих уроках):<br />yc compute instance list --format json <br />Список в формате JSON содержит больше информации, чем таблица.<br />Посмотрите результат<br />[<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "id": "ef3rutmaas72bsujcja7",<br />&nbsp;&nbsp;&nbsp; "folder_id": "b1gfdbij3ijgopgqv9m9",<br />&nbsp;&nbsp;&nbsp; "created_at": "2021-06-21T12:41:10Z",<br />&nbsp;&nbsp;&nbsp; "name": "my-instance-3",<br />&nbsp;&nbsp;&nbsp; "zone_id": "ru-central1-c",<br />&nbsp;&nbsp;&nbsp; "platform_id": "standard-v2",<br />&nbsp;&nbsp;&nbsp; "resources": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "memory": "4294967296",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "cores": "2",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "core_fraction": "100"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "status": "RUNNING",<br />&nbsp;&nbsp;&nbsp; "metadata_options": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "gce_http_endpoint": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aws_v1_http_endpoint": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "gce_http_token": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aws_v1_http_token": "ENABLED"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "boot_disk": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mode": "READ_WRITE",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "device_name": "ef3v2lor1u4pfn3ce1al",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "auto_delete": true,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "disk_id": "ef3v2lor1u4pfn3ce1al"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "network_interfaces": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "index": "0",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mac_address": "d0:0d:1b:f7:6c:a5",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "subnet_id": "b0c4h992tbuodl5hudpu",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "primary_v4_address": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "address": "10.128.0.32",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "one_to_one_nat": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "address": "178.154.212.5",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ip_version": "IPV4"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; ],<br />&nbsp;&nbsp;&nbsp; "fqdn": "my-instance-3.ru-central1.internal",<br />&nbsp;&nbsp;&nbsp; "scheduling_policy": {},<br />&nbsp;&nbsp;&nbsp; "network_settings": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "type": "STANDARD"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "placement_policy": {}<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "id": "epd928ffks7m8ssc4i3k",<br />&nbsp;&nbsp;&nbsp; "folder_id": "b1gfdbij3ijgopgqv9m9",<br />&nbsp;&nbsp;&nbsp; "created_at": "2021-06-21T12:40:35Z",<br />&nbsp;&nbsp;&nbsp; "name": "my-instance-2",<br />&nbsp;&nbsp;&nbsp; "zone_id": "ru-central1-b",<br />&nbsp;&nbsp;&nbsp; "platform_id": "standard-v2",<br />&nbsp;&nbsp;&nbsp; "resources": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "memory": "4294967296",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "cores": "2",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "core_fraction": "100"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "status": "RUNNING",<br />&nbsp;&nbsp;&nbsp; "metadata_options": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "gce_http_endpoint": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aws_v1_http_endpoint": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "gce_http_token": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aws_v1_http_token": "ENABLED"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "boot_disk": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mode": "READ_WRITE",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "device_name": "epddf7t0ljn9i1jp2pbs",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "auto_delete": true,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "disk_id": "epddf7t0ljn9i1jp2pbs"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "network_interfaces": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "index": "0",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mac_address": "d0:0d:91:21:ef:a7",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "subnet_id": "e2l1fgq2fbhnp6b929t7",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "primary_v4_address": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "address": "10.129.0.9",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "one_to_one_nat": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "address": "84.201.176.134",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ip_version": "IPV4"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; ],<br />&nbsp;&nbsp;&nbsp; "fqdn": "my-instance-2.ru-central1.internal",<br />&nbsp;&nbsp;&nbsp; "scheduling_policy": {},<br />&nbsp;&nbsp;&nbsp; "network_settings": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "type": "STANDARD"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "placement_policy": {}<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "id": "fhm1op9id0dc6bubfags",<br />&nbsp;&nbsp;&nbsp; "folder_id": "b1gfdbij3ijgopgqv9m9",<br />&nbsp;&nbsp;&nbsp; "created_at": "2021-06-21T12:39:43Z",<br />&nbsp;&nbsp;&nbsp; "name": "my-instance-1",<br />&nbsp;&nbsp;&nbsp; "zone_id": "ru-central1-a",<br />&nbsp;&nbsp;&nbsp; "platform_id": "standard-v2",<br />&nbsp;&nbsp;&nbsp; "resources": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "memory": "4294967296",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "cores": "2",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "core_fraction": "100"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "status": "RUNNING",<br />&nbsp;&nbsp;&nbsp; "metadata_options": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "gce_http_endpoint": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aws_v1_http_endpoint": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "gce_http_token": "ENABLED",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "aws_v1_http_token": "ENABLED"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "boot_disk": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mode": "READ_WRITE",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "device_name": "fhmms7r7ia4uteikv1to",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "auto_delete": true,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "disk_id": "fhmms7r7ia4uteikv1to"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "network_interfaces": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "index": "0",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "mac_address": "d0:0d:1c:65:32:68",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "subnet_id": "e9bcvlanhbum9ggdvkh2",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "primary_v4_address": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "address": "10.130.0.6",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "one_to_one_nat": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "address": "178.154.225.167",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ip_version": "IPV4"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; ],<br />&nbsp;&nbsp;&nbsp; "fqdn": "my-instance-1.ru-central1.internal",<br />&nbsp;&nbsp;&nbsp; "scheduling_policy": {},<br />&nbsp;&nbsp;&nbsp; "network_settings": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "type": "STANDARD"<br />&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; "placement_policy": {}<br />&nbsp; }<br />] <br />Чтобы избежать ненужных расходов, удалите три созданные ВМ (в следующих практических работах они не понадобятся).<br />yc compute instance delete my-instance-1 my-instance-2 my-instance-3 <br /><strong>Decision:</strong><br />$ yc vpc network create --name my-network<br />$ yc vpc subnet create \<br />&nbsp; --name my-subnet-1 \<br />&nbsp; --zone ru-central1-a \<br />&nbsp; --range 192.168.1.0/24 \<br />&nbsp; --network-name my-network<br />$ yc vpc subnet create \<br />&nbsp; --name my-subnet-2 \<br />&nbsp; --zone ru-central1-b \<br />&nbsp; --range 192.168.2.0/24 \<br />&nbsp; --network-name my-network<br />$ yc vpc subnet create \<br />&nbsp; --name my-subnet-3 \<br />&nbsp; --zone ru-central1-c \<br />&nbsp; --range 192.168.3.0/24 \<br />&nbsp; --network-name my-network<br />$ yc compute instance create \<br />&nbsp; --name my-instance-1 \<br />&nbsp; --hostname my-instance-1 \<br />&nbsp; --zone ru-central1-a \<br />&nbsp; --create-boot-disk image-family=ubuntu-2004-lts,size=30,type=network-nvme \<br />&nbsp; --image-folder-id standard-images \<br />&nbsp; --memory 4 --cores 2 --core-fraction 100 \<br />&nbsp; --network-interface subnet-name=my-subnet-1,nat-ip-version=ipv4 \<br />&nbsp; --async<br />$ yc compute instance create \<br />&nbsp; --name my-instance-2 \<br />&nbsp; --hostname my-instance-2 \<br />&nbsp; --zone ru-central1-b \<br />&nbsp; --create-boot-disk image-family=ubuntu-2004-lts,size=30,type=network-nvme \<br />&nbsp; --image-folder-id standard-images \<br />&nbsp; --memory 4 --cores 2 --core-fraction 100 \<br />&nbsp; --network-interface subnet-name=my-subnet-2,nat-ip-version=ipv4 \<br />&nbsp; --async<br />$ yc compute instance create \<br />&nbsp; --name my-instance-3 \<br />&nbsp; --hostname my-instance-3 \<br />&nbsp; --zone ru-central1-c \<br />&nbsp; --create-boot-disk image-family=ubuntu-2004-lts,size=30,type=network-nvme \<br />&nbsp; --image-folder-id standard-images \<br />&nbsp; --memory 4 --cores 2 --core-fraction 100 \<br />&nbsp; --network-interface subnet-name=my-subnet-3,nat-ip-version=ipv4 \<br />&nbsp; --async <br />$ yc operation get ef3vcn9383adr1anudcg<br />$ yc operation get epdk80vb9jjjc3190s6a<br />$ yc operation get fhm0u5fo2bq3cl2gagpr<br />$ yc operation wait fhm0u5fo2bq3cl2gagpr<br />$ yc compute instance list<br />$ yc compute instance list --format json<br />$ yc compute instance delete my-instance-1 my-instance-2 my-instance-3<br /><strong>Task:</strong><br />Использование файлов спецификаций<br />В этой практической работе вы создадите, обновите и удалите группу ВМ.<br />Вы уже убедились, что создать даже одну ВМ через yc непросто: нужно установить много разных параметров. Создание группы ВМ требует ещё больше параметров. <br />Чтобы не указывать их все в командной строке, конфигурацию описывают в файле, который используют при создании группы. Такой файл называется спецификацией. <br />Использование спецификаций &mdash; это первый шаг в освоении подхода Infrastructure as Code (IaC), который мы будем применять на следующих уроках.<br />Спецификации пишутся в разных форматах. Для группы ВМ используется язык YAML. Если вы не знакомы с ним &mdash; ничего страшного. <br /><strong>Decision:</strong><br />Часть 1. Создание Instance Group. Для разворачивания группы ВМ потребуется сеть. Если сети ещё нет, создайте её. Посмотрите информацию об имеющихся сетях.<br />yc vpc network list<br />Сохраните идентификатор сети, он понадобиться нам в дальнейшем.<br />По умолчанию все операции в Instance Groups выполняются от имени сервисного аккаунта c ролью editor на каталог. Если сервисного аккаунта нет, то тоже создайте его и назначьте эту роль.<br />Посмотрите информацию об имеющихся сервисных аккаунтах.<br />yc iam service-account list<br />Сохраните идентификатор сервисного аккаунта, он понадобится нам в дальнейшем.<br />Для создания группы необходимо подготовить её спецификацию. Создайте в любом текстовом редакторе файл с расширением yaml, например specification.yaml.<br />Обратите внимание: в формате YAML важны отступы слева. Даже если текст правильный, но отступы не соблюдены, при выполнении спецификации возникнут ошибки.<br />Сначала внесите информацию о группе. Пусть группа называется my-group. Укажите идентификатор сервисного аккаунта, от имени которого будете работать (см. шаг 2).<br />Идентификаторы ресурсов уникальны. Копируя команды из текста урока, не забывайте подставлять свои идентификаторы.<br />name: my-group<br />service_account_id: &lt;идентификатор_сервисного_аккаунта&gt;<br />Наша группа будет содержать три одинаковые ВМ. Машины создадим из публичного образа Ubuntu 18.04 LTS (возьмём не последнюю версию, чтобы потренироваться обновлять ВМ). Узнайте идентификатор образа с помощью команды:<br />yc compute image list --folder-id standard-images<br />В столбце FAMILY найдите ubuntu-1804-lts, в столбце ID будет указан нужный идентификатор.<br />Опишите в спецификации ВМ. Это раздел instance_template.<br />Пусть каждая машина использует платформу Intel Broadwell (посмотрите поддерживаемые платформы в документации Yandex Compute Cloud),&nbsp; имеет 2 Гб оперативной памяти и два процессорных ядра.<br />&nbsp;instance_template:<br />&nbsp;&nbsp;&nbsp;&nbsp; platform_id: standard-v1<br />&nbsp;&nbsp;&nbsp;&nbsp; resources_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: 2g<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cores: 2<br />Добавьте описание загрузочного диска. Он будет использоваться на чтение и запись (режим READ_WRITE). Укажите идентификатор образа, который получили на шаге 5. Выделите сетевой HDD объёмом 32 Гб.<br />&nbsp;&nbsp;&nbsp;&nbsp; boot_disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode: READ_WRITE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id: &lt;идентификатор_образа&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type_id: network-hdd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 32g<br />Теперь опишите сеть: идентификатор сети из каталога по умолчанию (см. шаг 1). Задайте публичный IP-адрес, чтобы к ВМ можно было обращаться извне.<br />&nbsp;&nbsp;&nbsp;&nbsp; network_interface_specs:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - network_id: &lt;идентификатор_сети&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; primary_v4_address_spec: { one_to_one_nat_spec: { ip_version: IPV4 }}<br />В политике планирования укажите, что машина не прерываемая.<br />&nbsp;&nbsp;&nbsp;&nbsp; scheduling_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; preemptible: false<br />В политике развертывания (раздел deploy policy) укажите, что в каждый момент времени может быть неработоспособной только одна машина, не больше. Запретите увеличивать число ВМ, т. е. создавать больше трех машин одновременно. Мы чуть подробнее разберём эти настройки, когда будем обновлять ВМ в группе.<br />&nbsp;&nbsp;&nbsp;&nbsp; deploy_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_unavailable: 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_expansion: 0<br />Мы создаем группу фиксированного размера из трёх ВМ. Укажите это в политике масштабирования (раздел scale_policy):<br />&nbsp;&nbsp;&nbsp; scale_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fixed_scale:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 3 <br />Наконец, в политике распределения машин по зонам (раздел allocation_policy) укажите, что будет использоваться зона ru-central1-a. Мы делаем это для простоты. Лучше распределять ВМ группы по разным зонам доступности &mdash; это позволит пережить краткие сбои или выход зоны из строя.<br />&nbsp;&nbsp;&nbsp; allocation_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-a <br />Для балансировщика нагрузки (раздел load_balancer_spec) укажите целевую группу, к которой он будет привязан (это мы рассмотрим чуть ниже).<br />&nbsp;&nbsp;&nbsp; load_balancer_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; target_group_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: my-target-group <br />Нашей спецификации уже достаточно, чтобы создать группу ВМ. Но на эти машины не будет установлено никакого ПО, только операционная система из публичного образа. Если не менять конфигурацию, то после создания ВМ вам придётся устанавливать программы вручную.<br />Чтобы сэкономить время и сократить число ошибок, давайте максимально автоматизируем создание ВМ, включая установку ПО. Для этого добавим в конфигурацию машины секцию, где будут вызываться команды установки программ. В этой же секции можно описать создание пользователей, но мы этого делать не будем, так как заходить на ВМ не планируем.<br />Установим на машины веб-сервер NGINX и на веб-странице index.nginx-debian.html, которая создается по умолчанию и выводит приветственное сообщение &laquo;Welcome to nginx&raquo;, заменим слово nginx идентификатором активной ВМ и версией ОС. Поскольку мы подключим балансировщик нагрузки, идентификатор активной ВМ будет различаться для разных пользователей. Это и позволит нам убедиться в том, что балансировщик работает.<br />Для установки ПО используйте cloud-init &mdash; пакет, выполняющий команды на ВМ при первом запуске. Вы узнали о нём из курса о ВМ. Команды опишите в блоке конфигурации #cloud-config. Примеры команд смотрите в документации cloud-init.<br />Содержимое #cloud-config описывается в разделе instance_template в секции metadata:<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user-data: |-<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #cloud-config<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; package_update: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runcmd:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [apt-get, install, -y, nginx ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [/bin/bash, -c, 'source /etc/lsb-release; sed -i "s/Welcome to nginx/It is $(hostname) on $DISTRIB_DESCRIPTION/" /var/www/html/index.nginx-debian.html'] <br />Спецификация готова. Вот ее полный текст. Помните, что в формате YAML важно соблюдать отступы слева.<br />name: my-group<br />service_account_id: ajeu495h1s9tn1rorulb<br />instance_template:<br />&nbsp;&nbsp;&nbsp; platform_id: standard-v1<br />&nbsp;&nbsp;&nbsp; resources_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: 2g<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cores: 2<br />&nbsp;&nbsp;&nbsp; boot_disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode: READ_WRITE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id: fd8fosbegvnhj5haiuoq <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type_id: network-hdd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 32g<br />&nbsp;&nbsp;&nbsp; network_interface_specs:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - network_id: enpnr4onfs6ihtoao32u<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; primary_v4_address_spec: { one_to_one_nat_spec: { ip_version: IPV4 }}<br />&nbsp;&nbsp;&nbsp; scheduling_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; preemptible: false<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user-data: |-<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #cloud-config<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; package_update: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runcmd:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [ apt-get, install, -y, nginx ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [/bin/bash, -c, 'source /etc/lsb-release; sed -i "s/Welcome to nginx/It is $(hostname) on $DISTRIB_DESCRIPTION/" /var/www/html/index.nginx-debian.html']<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 1<br />&nbsp;&nbsp;&nbsp; max_expansion: 0<br />scale_policy:<br />&nbsp;&nbsp;&nbsp; fixed_scale:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 3<br />allocation_policy:<br />&nbsp;&nbsp;&nbsp; zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-a<br />load_balancer_spec:<br />&nbsp;&nbsp;&nbsp; target_group_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: my-target-group <br />Теперь создайте группу ВМ по подготовленной спецификации. Уточните синтаксис команды сами:<br />yc compute instance-group --help <br />Проверить синтаксис команды<br />yc compute instance-group create --file &lt;путь_к_файлу_specification.yaml&gt; &nbsp;<br />Для тренировки можете вызвать эту команду в асинхронном режиме, а затем проверить её статус и дождаться завершения.<br />Убедитесь, что группа создана, в веб-консоли или выведя список групп с помощью yc.<br />yc compute instance-group list <br />В списке вы должны увидеть свою группу машин my-group:<br />+----------------------+------------+------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp; | SIZE |<br />+----------------------+------------+------+<br />| amc65sbgfqeqf00m02sc | my-group&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp; 3 |<br />+----------------------+------------+------+ <br />Часть 2. Балансировщик<br />Создайте балансировщик my-load-balancer. Посмотрите, какие параметры должны быть у соответствующей команды:<br />yc load-balancer network-load-balancer create --help <br />В выводе справки обратите внимание, что при создании балансировщика можно сразу создать и обработчик входящего трафика (параметр --listener).<br />Формат параметра --listener достаточно хитрый: в нём можно указать сразу несколько подпараметров через запятую:<br />...<br />--listener name=my-listener,external-ip-version=ipv4,port=80<br />... <br />Помимо имени обработчика, здесь указывается версия IP-протокола и порт, на котором балансировщик будет принимать трафик.<br />Проверить синтаксис команды<br />yc load-balancer network-load-balancer create \<br />&nbsp; --region-id ru-central1 \<br />&nbsp; --name my-load-balancer \<br />&nbsp; --listener name=my-listener,external-ip-version=ipv4,port=80 <br />Затем подключите к балансировщику целевую группу (команда attach-target-group). Вам понадобится идентификатор целевой группы. Чтобы узнать его, запросите с помощью yc список доступных целевых групп и выберите ту, которую вы указали в спецификации specification.yaml. <br />Проверить синтаксис команды<br />yc load-balancer target-group list <br />Целевая группа также подключается с помощью нескольких подпараметров, которые соответствуют настройкам в консоли управления (их вы изучали на первом курсе). Для целевой группы укажите такие параметры:<br />&nbsp;&nbsp;&nbsp; target-group-id &mdash; идентификатор группы;<br />&nbsp;&nbsp;&nbsp; healthcheck-name, healthcheck-interval, healthcheck-timeout, healthcheck-unhealthythreshold, healthcheck-healthythreshold, healthcheck-http-port &mdash; параметры проверки состояния (см. документацию). Эти параметры аналогичны тем, что задаются в консоли управления при создании балансировщика. Вы изучали их в первом курсе.<br />Укажите 80-й порт, на котором запущен NGINX.<br />Проверить синтаксис команды<br />yc load-balancer network-load-balancer attach-target-group my-load-balancer \ <br />&nbsp; --target-group target-group-id=&lt;идентификатор целевой группы&gt;,healthcheck-name=test-health-check,healthcheck-interval=2s,healthcheck-timeout=1s,healthcheck-unhealthythreshold=2,healthcheck-healthythreshold=2,healthcheck-http-port=80<br />Можно не выполнять две команды (создание балансировщика и подключение целевой группы) по очереди, а одной командой create создать балансировщик с привязанной целевой группой.<br />Убедитесь, что балансировщик создан, а целевая группа подключена через консоль управления или с помощью yc.<br />Часть 3. Доступ к машинам группы<br />Проверьте состояние машин группы. Для этого запросите список машин и дождитесь статуса HEALTHY.<br />yc load-balancer network-load-balancer target-states my-load-balancer \<br />&nbsp;&nbsp;&nbsp; --target-group-id &lt;идентификатор_целевой_группы&gt; <br />Теперь откройте в браузере страницу балансировщика. IP-адрес балансировщика вы можете узнать с помощью консоли управления или yc.<br />На странице вы увидите приветственное сообщение и в нём идентификатор одной из машин.<br />Часть 4. Обновление Instance Group<br />При создании на ВМ группы была установлена ОС Ubuntu 18.04 LTS. Теперь обновите её до Ubuntu 20.04 LTS (ubuntu-2004-lts в столбце FAMILY). Ещё раз посмотрите список доступных образов (см. часть 1) и в файле спецификации specification.yaml измените параметр image_id.<br />...<br />boot_disk_spec:<br />&nbsp;&nbsp; mode: READ_WRITE<br />&nbsp;&nbsp; disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id: &lt;идентификатор_образа&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type_id: network-hdd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 32g<br />... <br />Теперь запустите обновление группы с изменённым файлом спецификации.<br />Проверить синтаксис команды<br />yc compute instance-group update \<br />&nbsp; --name my-group \<br />&nbsp; --file &lt;путь_к_файлу_specification.yaml&gt; <br />Группа будет обновляться постепенно: когда одна машина из группы удаляется, ей на замену создаётся новая. Общее число машин в группе не увеличится. Именно такую политику обновления мы задали в файле спецификации (см. часть 1):<br />...<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 1<br />&nbsp;&nbsp;&nbsp; max_expansion: 0<br />... <br />Есть и другой режим обновления: сначала в группу добавляется ВМ с новой конфигурацией, а затем отключается старая машина. Это повторяется, пока не обновятся все машины. Такому режиму соответствовала бы другая конфигурация:<br />...<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 0<br />&nbsp;&nbsp;&nbsp; max_expansion: 1<br />... <br />Убедитесь, что машины обновились. На приветственной странице должна выводиться новая версия ОС.<br />Часть 5. Удаление машины из группы<br />На приветственной странице балансировщика посмотрите имя активной машины и попробуйте удалить ее. Убедитесь, что приветственная страница остаётся доступна всё время: балансировщик переключит трафик на другую машину группы. А Yandex Cloud тем временем пересоздаст удалённую машину.<br />Проверить синтаксис команды<br />yc compute instance delete &lt;имя_ВМ&gt; <br />Часть 6. Удаление Instance Group<br />Теперь удалите группу и балансировщик командами yc.<br />Проверить синтаксис команд<br />yc compute instance-group delete --name my-group<br />yc load-balancer network-load-balancer delete --name my-load-balancer <br />Кстати, ключевой параметр --name можно и не писать. Достаточно указать имя группы или балансировщика.<br />Убедитесь, что группы и балансировщика больше нет, через консоль управления или с помощью yc. <br /><strong>Decision:</strong><br />$ yc vpc network list<br />$ yc iam service-account list<br />$ vim specification.yaml<br />$ cat specification.yaml<br />name: my-group<br />service_account_id: ajeq7kga9ms7bhup4gbe<br />$ yc compute image list --folder-id standard-images<br />$ vim specification.yaml<br />$ cat specification.yaml<br />name: my-group<br />service_account_id: ajeq7kga9ms7bhup4gbe<br />instance_template:<br />&nbsp;&nbsp;&nbsp; platform_id: standard-v1<br />&nbsp;&nbsp;&nbsp; resources_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: 2g<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cores: 2<br />&nbsp;&nbsp;&nbsp; boot_disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode: READ_WRITE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id: fd8k6joqhuk8ts8eb1ao <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type_id: network-hdd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 32g<br />&nbsp;&nbsp;&nbsp; network_interface_specs:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - network_id: enpboucd6803lg6jspnh<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; primary_v4_address_spec: { one_to_one_nat_spec: { ip_version: IPV4 }}<br />&nbsp;&nbsp;&nbsp; scheduling_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; preemptible: false<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user-data: |-<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #cloud-config<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; package_update: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runcmd:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [ apt-get, install, -y, nginx ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [/bin/bash, -c, 'source /etc/lsb-release; sed -i "s/Welcome to nginx/It is $(hostname) on $DISTRIB_DESCRIPTION/" /var/www/html/index.nginx-debian.html']<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 1<br />&nbsp;&nbsp;&nbsp; max_expansion: 0<br />scale_policy:<br />&nbsp;&nbsp;&nbsp; fixed_scale:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 3<br />allocation_policy:<br />&nbsp;&nbsp;&nbsp; zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-a<br />load_balancer_spec:<br />&nbsp;&nbsp;&nbsp; target_group_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: my-target-group<br />$ yc compute instance-group --help <br />$ yc compute instance-group create --file /YOUR-DIR/specification.yaml<br />$ yc compute instance-group list<br />$ yc load-balancer network-load-balancer create --help<br />$ yc load-balancer network-load-balancer create \<br />&nbsp; --region-id ru-central1 \<br />&nbsp; --name my-load-balancer \<br />&nbsp; --listener name=my-listener,external-ip-version=ipv4,port=80 <br />$ yc load-balancer target-group list<br />$ yc load-balancer network-load-balancer attach-target-group my-load-balancer \ <br />--target-group target-group-id=enp3edjdaoot0v64qth0,healthcheck-name=test-health-check,healthcheck-interval=2s,healthcheck-timeout=1s,healthcheck-unhealthythreshold=2,healthcheck-healthythreshold=2,healthcheck-http-port=80<br />$ yc load-balancer network-load-balancer target-states my-load-balancer \<br />--target-group-id enp3edjdaoot0v64qth0<br />$ vim specification.yaml<br />$ cat specification.yaml<br />...<br />boot_disk_spec:<br />&nbsp;&nbsp; mode: READ_WRITE<br />&nbsp;&nbsp; disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id: &lt;идентификатор_образа&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type_id: network-hdd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 32g<br />...<br />$ yc compute instance-group update \<br />&nbsp; --name my-group \<br />&nbsp; --file /YOUR-DIR/specification.yaml<br />$ yc compute instance-group delete --name my-group<br />$ yc load-balancer network-load-balancer delete --name my-load-balancer<br /><strong>Task:</strong><br />Создаём образ виртуальной машины.<br />В этой практической работе вы установите Packer, подготовите с его помощью образ, а затем создадите из образа виртуальную машину.<br /><strong>Decision:</strong><br />Установите Packer, если ещё не сделали это на предыдущем уроке. Он поддерживает все популярные операционные системы &mdash; Windows, macOS, Linux и FreeBSD.<br />Скачать дистрибутив Packer для вашей ОС также можно с зеркала Yandex Cloud.<br />Подготовьте файл в формате HCL со спецификацией образа, например my-ubuntu-nginx.pkr.hcl.<br />При создании файла опирайтесь на документацию Packer.<br />В качестве примера можете взять спецификацию из предыдущего урока:<br />&nbsp;source "yandex" "ubuntu-nginx" {<br />&nbsp;&nbsp; token&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "&lt;OAuth-токен&gt;"<br />&nbsp;&nbsp; folder_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "&lt;идентификатор_каталога&gt;"<br />&nbsp;&nbsp; source_image_family = "ubuntu-2004-lts"<br />&nbsp;&nbsp; ssh_username&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ubuntu"<br />&nbsp;&nbsp; use_ipv4_nat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "true"<br />&nbsp;&nbsp; image_description&nbsp;&nbsp; = "my custom ubuntu with nginx"<br />&nbsp;&nbsp; image_family&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ubuntu-2004-lts"<br />&nbsp;&nbsp; image_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "my-ubuntu-nginx"<br />&nbsp;&nbsp; subnet_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "&lt;идентификатор_подсети&gt;"<br />&nbsp;&nbsp; disk_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "network-ssd"<br />&nbsp;&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp;}<br />&nbsp;build {<br />&nbsp;&nbsp; sources = ["source.yandex.ubuntu-nginx"]<br />&nbsp;&nbsp; provisioner "shell" {<br />&nbsp;&nbsp;&nbsp;&nbsp; inline = ["sudo apt-get update -y",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "sudo apt-get install -y nginx",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "sudo systemctl enable nginx.service"]<br />&nbsp;&nbsp; }<br />&nbsp;}<br />Не забудьте подставить в спецификацию идентификаторы своего каталога и подсети (подсеть должна быть в той же зоне доступности, которая указана в параметре zone). Также укажите свой OAuth-токен (или воспользуйтесь переменной окружения YC_TOKEN при сборке образа).<br />Теперь создайте образ ВМ на основе файла спецификации:<br />&nbsp;packer build &lt;путь_к_файлу_my-ubuntu-nginx.pkr.hcl&gt;<br />После того как команда отработает, убедитесь, что образ появился в каталоге. Для этого в консоли управления перейдите в сервис Compute Cloud. Найдите образ на вкладке Образы.<br />Перейдите на вкладку Виртуальные машины и начните создавать ВМ.<br />Раньше для создания загрузочного диска вы выбирали один из публичных образов, например Ubuntu 20.04. Теперь вместо этого переключитесь на вкладку Пользовательские. Нажмите кнопку Выбрать и в открывшемся окне переключитесь на вкладку Образ.<br />Выберите созданный образ и нажмите Применить.<br />Из образа создастся загрузочный диск.<br />Завершите создание ВМ.<br />Проверьте ВМ: введите её IP-адрес в адресную строку браузера. Убедитесь, что веб-сервер работает.<br />Удалите ВМ: на следующих уроках она не понадобится. А вот образ удалять не стоит.<br /><strong>Decision:</strong><br />$ sudo apt-get install packer<br />$ vim my-ubuntu-nginx.pkr.hcl<br />$ cat my-ubuntu-nginx.pkr.hcl<br />source "yandex" "ubuntu-nginx" {<br />&nbsp;&nbsp; token&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "YOUR-KEY"<br />&nbsp;&nbsp; folder_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "YOUR-ID"<br />&nbsp;&nbsp; source_image_family = "ubuntu-2004-lts"<br />&nbsp;&nbsp; ssh_username&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ubuntu"<br />&nbsp;&nbsp; use_ipv4_nat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "true"<br />&nbsp;&nbsp; image_description&nbsp;&nbsp; = "my custom ubuntu with nginx"<br />&nbsp;&nbsp; image_family&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ubuntu-2004-lts"<br />&nbsp;&nbsp; image_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "my-ubuntu-nginx"<br />&nbsp;&nbsp; subnet_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "enpboucd6803lg6jspnh"<br />&nbsp;&nbsp; disk_type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "network-ssd"<br />&nbsp;&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />}<br />build {<br />&nbsp;&nbsp; sources = ["source.yandex.ubuntu-nginx"]<br />&nbsp;&nbsp; provisioner "shell" {<br />&nbsp;&nbsp;&nbsp;&nbsp; inline = ["sudo apt-get update -y",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "sudo apt-get install -y nginx",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "sudo systemctl enable nginx.service"]<br />&nbsp;&nbsp; &nbsp;}<br />}<br />$ packer build /YOUR-DIR/my-ubuntu-nginx.pkr.hcl<br /><strong>Task:</strong><br />Создаём виртуальную машину из образа и базу данных.<br />В этой практической работе вы установите Terraform и подготовите спецификацию, с помощью которой создадите виртуальную машину, а затем управляемую базу данных.<br /><strong>Decision:</strong><br />Установите Terraform. Дистрибутив для вашей платформы можно скачать из зеркала. После загрузки добавьте путь к папке, в которой находится исполняемый файл, в переменную PATH.<br />Настройте провайдер. Если раньше у вас был настроен провайдер из реестра Hashicorp, сохраните его настройки:<br />mv ~/.terraformrc ~/.terraformrc.old<br />Укажите источник, из которого будет устанавливаться провайдер.<br />Откройте файл конфигурации Terraform CLI:<br />nano ~/.terraformrc<br />Добавьте в него следующий блок:<br />provider_installation {<br />&nbsp; network_mirror {<br />&nbsp;&nbsp;&nbsp; url = "https://terraform-mirror.yandexcloud.net/"<br />&nbsp;&nbsp;&nbsp; include = ["registry.terraform.io/*/*"]<br />&nbsp; }<br />&nbsp; direct {<br />&nbsp;&nbsp;&nbsp; exclude = ["registry.terraform.io/*/*"]<br />&nbsp; }<br />}<br />В начале конфигурационного файла .tf добавьте следующие блоки:<br />terraform {<br />&nbsp; required_providers {<br />&nbsp;&nbsp;&nbsp; yandex = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source = "yandex-cloud/yandex"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; required_version = "&gt;= 0.13"<br />}<br />provider "yandex" {<br />&nbsp; zone = "&lt;зона доступности по умолчанию&gt;"<br />}<br />Где: source &mdash; глобальный адрес источника провайдера. required_version &mdash; минимальная версия Terraform, с которой совместим провайдер. provider &mdash; название провайдера. zone &mdash; зона доступности, в которой по умолчанию будут создаваться все облачные ресурсы.<br />Выполните команду terraform init в папке с конфигурационным файлом .tf. Эта команда инициализирует провайдеров, указанных в конфигурационных файлах, и позволяет работать с ресурсами и источниками данных провайдера.<br />Если провайдер не установился, создайте обращение в поддержку с именем и версией провайдера.<br />Если вы использовали файл .terraform.lock.hcl, то перед инициализацией выполните команду terraform providers lock, указав адрес зеркала, откуда будет загружаться провайдер, и платформы, на которых будет использоваться конфигурация:<br />terraform providers lock -net-mirror=https://terraform-mirror.yandexcloud.net -platform=linux_amd64 -platform=darwin_arm64 yandex-cloud/yandex<br />Если вы использовали модули, то сначала выполните terraform init, затем удалите lock-файл, а затем выполните команду terraform providers lock.<br />Создайте файл спецификации my-config.tf и укажите в нём Yandex Cloud в качестве провайдера.<br />&nbsp;terraform {<br />&nbsp;&nbsp; required_providers {<br />&nbsp;&nbsp;&nbsp;&nbsp; yandex = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source = "yandex-cloud/yandex"<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp; }<br />&nbsp;}<br />&nbsp;provider "yandex" {<br />&nbsp;&nbsp; token&nbsp; =&nbsp; "&lt;OAuth-токен&gt;"<br />&nbsp;&nbsp; cloud_id&nbsp; = "&lt;идентификатор_облака&gt;"<br />&nbsp;&nbsp; folder_id = "&lt;идентификатор_каталога&gt;"<br />&nbsp;&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "&lt;зона_доступности_по_умолчанию&gt;"<br />&nbsp;}<br />Далее мы будем считать, что в качестве зоны доступности по умолчанию выбрана ru-central1-a.<br />Добавьте в файл блок, описывающий создание ВМ. Его сложно написать с нуля, поэтому опирайтесь на пример из документации. Чтобы вам было проще опознать в консоли управления объекты, созданные по этой спецификации, указывайте уникальные имена для ВМ, сети и подсети, а не оставляйте имена по умолчанию (default).<br />Для создания ВМ используйте образ, созданный с помощью Packer в предыдущей практической работе.<br />Можно использовать переменные в спецификации Terraform и передавать в них разные значения при запуске команд. Например, если сделать переменную для идентификатора образа image-id, тогда с помощью одного и того же файла спецификации вы сможете создавать ВМ с разным наполнением.<br />Переменные Terraform хранятся в файлах с расширением .tfvars. Создайте файл my-variables.tfvars и укажите в нём идентификатор своего образа Packer (узнайте идентификатор с помощью команды yc compute image list):<br />&nbsp;image-id = "&lt;идентификатор_образа&gt;"<br />В файле спецификации my-config.tf объявите эту переменную (ключевое слово variable). Тогда в секции, где описываются настройки ВМ, вы сможете обратиться к переменной как var.image-id:<br />&nbsp;...<br />&nbsp;variable "image-id" {<br />&nbsp;&nbsp;&nbsp;&nbsp; type = string<br />&nbsp;}<br />&nbsp;resource "yandex_compute_instance" "vm-1" {<br />&nbsp;...&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp; boot_disk {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; initialize_params {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id = var.image-id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;...<br />Скорректируйте описание для сети и подсети.<br />Для сети достаточно указать имя:<br />&nbsp; resource "yandex_vpc_network" "network-1" {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name = "from-terraform-network"<br />&nbsp; }<br />Для подсети укажите зону доступности и сеть, а также внутренние IP-адреса, уникальные в рамках сети. Используйте адреса из адресного пространства 10.0.0.0/16.<br />&nbsp; resource "yandex_vpc_subnet" "subnet-1" {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "from-terraform-subnet"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; network_id&nbsp;&nbsp;&nbsp;&nbsp; = "${yandex_vpc_network.network-1.id}"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v4_cidr_blocks = ["10.2.0.0/16"]<br />&nbsp; }<br />Проверьте синтаксис спецификации:<br />variable "image-id" {<br />&nbsp; type = string<br />}<br />resource "yandex_compute_instance" "vm-1" {<br />&nbsp; name = "from-terraform-vm"<br />&nbsp; platform_id = "standard-v1"<br />&nbsp; zone = "ru-central1-a"<br />&nbsp; resources {<br />&nbsp;&nbsp;&nbsp; cores&nbsp; = 2<br />&nbsp;&nbsp;&nbsp; memory = 2<br />&nbsp; }<br />&nbsp; boot_disk {<br />&nbsp;&nbsp;&nbsp; initialize_params {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id = var.image-id<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; network_interface {<br />&nbsp;&nbsp;&nbsp; subnet_id = yandex_vpc_subnet.subnet-1.id<br />&nbsp;&nbsp;&nbsp; nat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true<br />&nbsp; }<br />&nbsp; metadata = {<br />&nbsp;&nbsp;&nbsp; ssh-keys = "ubuntu:${file("~/.ssh/id_rsa.pub")}"<br />&nbsp; }<br />}<br />resource "yandex_vpc_network" "network-1" {<br />&nbsp; name = "from-terraform-network"<br />}<br />resource "yandex_vpc_subnet" "subnet-1" {<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "from-terraform-subnet"<br />&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp; network_id&nbsp;&nbsp;&nbsp;&nbsp; = "${yandex_vpc_network.network-1.id}"<br />&nbsp; v4_cidr_blocks = ["10.2.0.0/16"]<br />}<br />output "internal_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.ip_address<br />}<br />output "external_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.nat_ip_address<br />}<br />Теперь попробуйте применить спецификацию. Перейдите в папку с файлом спецификации и выполните инициализацию.<br />&nbsp;terraform init<br />Если всё сделано верно, Terraform покажет сообщение:<br />&nbsp;...<br />&nbsp;Terraform has been successfully initialized!<br />&nbsp;...<br />Важно: выполняйте команды Terraform в папке, где находится файл спецификации.<br />Проверьте спецификацию с помощью команды terraform plan.<br />Terraform использует все файлы .tf из папки, в которой запущена команда. Поэтому название файла спецификации my-config.tf указывать не нужно: его Terraform подхватит и так.<br />Если файл с переменными называется стандартно (terraform.tfvars), его тоже можно не указывать при запуске команды. А если название файла нестандартное, то его нужно указывать:<br />&nbsp;terraform plan -var-file=my-variables.tfvars<br />Terraform выведет план: объекты, которые будут созданы, и т. п.:<br />&nbsp;...<br />&nbsp;Terraform will perform the following actions:<br />&nbsp;...<br />На самом деле необязательно помещать переменные в файл, их можно просто указывать при запуске команды. Поскольку у вас только одна переменная, это было бы несложно:<br />&nbsp;terraform plan -var="image-id=&lt;идентификатор_образа&gt;"<br />Создайте в облаке инфраструктуру по описанной вами спецификации. Выполните команду:<br />&nbsp;terraform apply -var-file=my-variables.tfvars<br />Terraform запросит подтверждение:<br />&nbsp;...<br />&nbsp;Do you want to perform these actions?<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Terraform will perform the actions described above.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Only 'yes' will be accepted to approve.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Enter a value:<br />В ответ введите yes.<br />Когда команда будет выполнена, вы увидите сообщение:<br />&nbsp; Apply complete! Resources: ... added, 0 changed, 0 destroyed.<br />&nbsp; Outputs:<br />&nbsp; external_ip_address_vm_1 = "84.201.133.49"<br />&nbsp; internal_ip_address_vm_1 = "10.2.0.24"<br />В консоли управления убедитесь, что ВМ создана. Откройте в браузере страницу с указанным IP-адресом и проверьте, доступна ли ВМ.<br />Как мы говорили на предыдущем уроке, Terraform хранит описание инфраструктуры в стейт-файлах. Посмотрите, как выглядит стейт-файл сейчас:<br />&nbsp;terraform state list<br />Вы увидите список объектов:<br />&nbsp;yandex_compute_instance.vm-1<br />&nbsp;yandex_vpc_network.network-1<br />&nbsp;yandex_vpc_subnet.subnet-1<br />Теперь добавьте в файл спецификации блок, описывающий создание кластера БД PostgreSQL. Подсказки ищите в справочнике ресурсов. Не забудьте заменить в спецификации имя подсети.<br />Проверьте синтаксис спецификации:<br />resource "yandex_mdb_postgresql_cluster" "postgres-1" {<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "postgres-1"<br />&nbsp; environment = "PRESTABLE"<br />&nbsp; network_id&nbsp; = yandex_vpc_network.network-1.id<br />&nbsp; config {<br />&nbsp;&nbsp;&nbsp; version = 12<br />&nbsp;&nbsp;&nbsp; resources {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resource_preset_id = "s2.micro"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_type_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "network-ssd"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 16<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; postgresql_config = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_connections&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 395<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enable_parallel_hash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vacuum_cleanup_index_scale_factor = 0.2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; autovacuum_vacuum_scale_factor&nbsp;&nbsp;&nbsp; = 0.34<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_transaction_isolation&nbsp;&nbsp;&nbsp;&nbsp; = "TRANSACTION_ISOLATION_READ_COMMITTED"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shared_preload_libraries&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "SHARED_PRELOAD_LIBRARIES_AUTO_EXPLAIN,SHARED_PRELOAD_LIBRARIES_PG_HINT_PLAN"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp;&nbsp; database {<br />&nbsp;&nbsp;&nbsp; name&nbsp; = "postgres-1"<br />&nbsp;&nbsp;&nbsp; owner = "my-name"<br />&nbsp; }<br />&nbsp; user {<br />&nbsp;&nbsp;&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "my-name"<br />&nbsp;&nbsp;&nbsp; password&nbsp;&nbsp; = "Test1234"<br />&nbsp;&nbsp;&nbsp; conn_limit = 50<br />&nbsp;&nbsp;&nbsp; permission {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database_name = "postgres-1"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; settings = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_transaction_isolation = "read committed"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log_min_duration_statement&nbsp;&nbsp;&nbsp; = 5000<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; host {<br />&nbsp;&nbsp;&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp;&nbsp;&nbsp; subnet_id = yandex_vpc_subnet.subnet-1.id<br />&nbsp; }<br />}<br />Сохраните файл спецификации.<br />Проверьте синтаксис спецификации:<br />terraform {<br />&nbsp; required_providers {<br />&nbsp;&nbsp;&nbsp; yandex = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source = "yandex-cloud/yandex"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}<br />provider "yandex" {<br />&nbsp; token&nbsp; =&nbsp; "&lt;OAuth-токен&gt;"<br />&nbsp; cloud_id&nbsp; = "&lt;идентификатор_облака&gt;"<br />&nbsp; folder_id = "&lt;идентификатор_каталога&gt;"<br />&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />}<br />variable "image-id" {<br />&nbsp; type = string<br />}<br />resource "yandex_compute_instance" "vm-1" {<br />&nbsp; name = "from-terraform-vm"<br />&nbsp; platform_id = "standard-v1"<br />&nbsp; zone = "ru-central1-a"<br />&nbsp; resources {<br />&nbsp;&nbsp;&nbsp; cores&nbsp; = 2<br />&nbsp;&nbsp;&nbsp; memory = 2<br />&nbsp; }<br />&nbsp; boot_disk {<br />&nbsp;&nbsp;&nbsp; initialize_params {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id = var.image-id<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; network_interface {<br />&nbsp;&nbsp;&nbsp; subnet_id = yandex_vpc_subnet.subnet-1.id<br />&nbsp;&nbsp;&nbsp; nat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true<br />&nbsp; }<br />&nbsp; metadata = {<br />&nbsp;&nbsp;&nbsp; ssh-keys = "ubuntu:${file("~/.ssh/id_rsa.pub")}"<br />&nbsp; }<br />}<br />resource "yandex_vpc_network" "network-1" {<br />&nbsp; name = "from-terraform-network"<br />}<br />resource "yandex_vpc_subnet" "subnet-1" {<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "from-terraform-subnet"<br />&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp; network_id&nbsp;&nbsp;&nbsp;&nbsp; = yandex_vpc_network.network-1.id<br />&nbsp; v4_cidr_blocks = ["10.2.0.0/16"]<br />}<br />resource "yandex_mdb_postgresql_cluster" "postgres-1" {<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "postgres-1"<br />&nbsp; environment = "PRESTABLE"<br />&nbsp; network_id&nbsp; = yandex_vpc_network.network-1.id<br />&nbsp; config {<br />&nbsp;&nbsp;&nbsp; version = 12<br />&nbsp;&nbsp;&nbsp; resources {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resource_preset_id = "s2.micro"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_type_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "network-ssd"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 16<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; postgresql_config = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_connections&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 395<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enable_parallel_hash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vacuum_cleanup_index_scale_factor = 0.2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; autovacuum_vacuum_scale_factor&nbsp;&nbsp;&nbsp; = 0.34<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_transaction_isolation&nbsp;&nbsp;&nbsp;&nbsp; = "TRANSACTION_ISOLATION_READ_COMMITTED"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shared_preload_libraries&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "SHARED_PRELOAD_LIBRARIES_AUTO_EXPLAIN,SHARED_PRELOAD_LIBRARIES_PG_HINT_PLAN"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; database {<br />&nbsp;&nbsp;&nbsp; name&nbsp; = "postgres-1"<br />&nbsp;&nbsp;&nbsp; owner = "my-name"<br />&nbsp; }<br />&nbsp; user {<br />&nbsp;&nbsp;&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "my-name"<br />&nbsp;&nbsp;&nbsp; password&nbsp;&nbsp; = "Test1234"<br />&nbsp;&nbsp;&nbsp; conn_limit = 50<br />&nbsp;&nbsp;&nbsp; permission {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database_name = "postgres-1"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; settings = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_transaction_isolation = "read committed"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log_min_duration_statement&nbsp;&nbsp;&nbsp; = 5000<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; host {<br />&nbsp;&nbsp;&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp;&nbsp;&nbsp; subnet_id = yandex_vpc_subnet.subnet-1.id<br />&nbsp; }<br />}<br />output "internal_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.ip_address<br />}<br />output "external_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.nat_ip_address<br />}<br />Теперь примените обновлённую спецификацию. В папке с файлом спецификации выполните команду terraform plan:<br />terraform plan -var-file=my-variables.tfvars <br />Если появляются сообщения об ошибках &mdash; исправьте ошибки и снова выполните команду.<br />Обновите инфраструктуру в соответствии с дополненной спецификацией командой terraform apply:<br />terraform apply -var-file=my-variables.tfvars <br />Поскольку спецификация теперь включает создание БД, команда может выполняться довольно долго (около 10 минут).<br />В консоли управления откройте раздел Managed Service for PostgreSQL и убедитесь, что кластер postgres-1 создан и имеет статус Alive.<br />Проверьте, как изменился стейт-файл:<br />terraform state list <br />В списке появился новый объект:<br />yandex_compute_instance.vm-1<br />yandex_mdb_postgresql_cluster.postgres-1<br />yandex_vpc_network.network-1<br />yandex_vpc_subnet.subnet-1 <br />Удалите инфраструктуру:<br />terraform destroy -var-file=my-variables.tfvars <br />В конце вы увидите сообщение о выполнении команды:<br />...<br />Destroy complete! Resources: 4 destroyed. <br />В консоли управления убедитесь, что объекты удалены.<br /><strong>Decision:</strong><br />$ wget https://hashicorp-releases.yandexcloud.net/terraform/1.6.5/terraform_1.6.5_linux_amd64.zip<br />$ unzip terraform_1.6.5_linux_amd64.zip <br />$ vim my-config.tf<br />$ cat my-config.tf<br />terraform {<br />&nbsp; required_providers {<br />&nbsp;&nbsp;&nbsp; yandex = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source = "yandex-cloud/yandex"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}<br />provider "yandex" {<br />&nbsp; token&nbsp; =&nbsp; "YOUR-TOKEN"<br />&nbsp; cloud_id&nbsp; = "YOUR-ID1"<br />&nbsp; folder_id = "YOUR-ID2"<br />&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />}<br />variable "image-id" {<br />&nbsp; type = string<br />}<br />resource "yandex_compute_instance" "vm-1" {<br />&nbsp; name = "from-terraform-vm"<br />&nbsp; platform_id = "standard-v1"<br />&nbsp; zone = "ru-central1-a"<br />&nbsp; resources {<br />&nbsp;&nbsp;&nbsp; cores&nbsp; = 2<br />&nbsp;&nbsp;&nbsp; memory = 2<br />&nbsp; }<br />&nbsp; boot_disk {<br />&nbsp;&nbsp;&nbsp; initialize_params {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id = var.image-id<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; network_interface {<br />&nbsp;&nbsp;&nbsp; subnet_id = yandex_vpc_subnet.subnet-1.id<br />&nbsp;&nbsp;&nbsp; nat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true<br />&nbsp; }<br />&nbsp; metadata = {<br />&nbsp;&nbsp;&nbsp; ssh-keys = "ubuntu:${file("/YOUR-DIR/YOUR-KEY.pub")}"<br />&nbsp; }<br />}<br />resource "yandex_vpc_network" "network-1" {<br />&nbsp; name = "from-terraform-network"<br />}<br />resource "yandex_vpc_subnet" "subnet-1" {<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "from-terraform-subnet"<br />&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp; network_id&nbsp;&nbsp;&nbsp;&nbsp; = "${yandex_vpc_network.network-1.id}"<br />&nbsp; v4_cidr_blocks = ["10.2.0.0/16"]<br />}<br />output "internal_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.ip_address<br />}<br />output "external_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.nat_ip_address<br />}<br />$ vim my-variables.tfvars<br />$ cat my-variables.tfvars<br />image-id = "YOUR-ID3"<br />$ terraform init<br />$ terraform plan -var-file=my-variables.tfvars<br />$ terraform apply -var-file=my-variables.tfvars<br />$ terraform state list<br />$ vim my-config.tf<br />$ cat my-config.tf<br />terraform {<br />&nbsp; required_providers {<br />&nbsp;&nbsp;&nbsp; yandex = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source = "yandex-cloud/yandex"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />}<br />provider "yandex" {<br />&nbsp; token&nbsp; =&nbsp; "YOUR-TOKEN"<br />&nbsp; cloud_id&nbsp; = "YOUR-ID1"<br />&nbsp; folder_id = "YOUR-ID2"<br />&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />}<br />variable "image-id" {<br />&nbsp; type = string<br />}<br />resource "yandex_compute_instance" "vm-1" {<br />&nbsp; name = "from-terraform-vm"<br />&nbsp; platform_id = "standard-v1"<br />&nbsp; zone = "ru-central1-a"<br />&nbsp; resources {<br />&nbsp;&nbsp;&nbsp; cores&nbsp; = 2<br />&nbsp;&nbsp;&nbsp; memory = 2<br />&nbsp; }<br />&nbsp; boot_disk {<br />&nbsp;&nbsp;&nbsp; initialize_params {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id = var.image-id<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; network_interface {<br />&nbsp;&nbsp;&nbsp; subnet_id = yandex_vpc_subnet.subnet-1.id<br />&nbsp;&nbsp;&nbsp; nat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true<br />&nbsp; }<br />&nbsp; metadata = {<br />&nbsp;&nbsp;&nbsp; ssh-keys = "ubuntu:${file("/YOUR-DIR/YOUR-KEY.pub")}"<br />&nbsp; }<br />}<br />resource "yandex_vpc_network" "network-1" {<br />&nbsp; name = "from-terraform-network"<br />}<br />resource "yandex_vpc_subnet" "subnet-1" {<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "from-terraform-subnet"<br />&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp; network_id&nbsp;&nbsp;&nbsp;&nbsp; = yandex_vpc_network.network-1.id<br />&nbsp; v4_cidr_blocks = ["10.2.0.0/16"]<br />}<br />resource "yandex_mdb_postgresql_cluster" "YOUR-DB" {<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "YOUR-DB"<br />&nbsp; environment = "PRESTABLE"<br />&nbsp; network_id&nbsp; = yandex_vpc_network.network-1.id<br />&nbsp; config {<br />&nbsp;&nbsp;&nbsp; version = 12<br />&nbsp;&nbsp;&nbsp; resources {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resource_preset_id = "s2.micro"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_type_id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "network-ssd"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 16<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; postgresql_config = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_connections&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 395<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; enable_parallel_hash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vacuum_cleanup_index_scale_factor = 0.2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; autovacuum_vacuum_scale_factor&nbsp;&nbsp;&nbsp; = 0.34<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_transaction_isolation&nbsp;&nbsp;&nbsp;&nbsp; = "TRANSACTION_ISOLATION_READ_COMMITTED"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; shared_preload_libraries&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "SHARED_PRELOAD_LIBRARIES_AUTO_EXPLAIN,SHARED_PRELOAD_LIBRARIES_PG_HINT_PLAN"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; } <br />&nbsp; database {<br />&nbsp;&nbsp;&nbsp; name&nbsp; = "YOUR-DB"<br />&nbsp;&nbsp;&nbsp; owner = "YOUR-USERNAME"<br />&nbsp; } <br />&nbsp; user {<br />&nbsp;&nbsp;&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "YOUR-USERNAME"<br />&nbsp;&nbsp;&nbsp; password&nbsp;&nbsp; = "YOUR-PASSWORD"<br />&nbsp;&nbsp;&nbsp; conn_limit = 50<br />&nbsp;&nbsp;&nbsp; permission {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database_name = "YOUR-DB"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; settings = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_transaction_isolation = "read committed"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log_min_duration_statement&nbsp;&nbsp;&nbsp; = 5000<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; } <br />&nbsp; host {<br />&nbsp;&nbsp;&nbsp; zone&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = "ru-central1-a"<br />&nbsp;&nbsp;&nbsp; subnet_id = yandex_vpc_subnet.subnet-1.id<br />&nbsp; }<br />} <br />output "internal_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.ip_address<br />} <br />output "external_ip_address_vm_1" {<br />&nbsp; value = yandex_compute_instance.vm-1.network_interface.0.nat_ip_address<br />}<br />$ terraform plan -var-file=my-variables.tfvars<br />$ terraform apply -var-file=my-variables.tfvars<br />$ terraform state list<br />$ terraform destroy -var-file=my-variables.tfvars<br /><strong>Task:</strong><br />Создание докер-образа и загрузка его в Container Registry<br />В этой практической работе вы создадите реестр в Yandex Container Registry, подготовите Docker-образ виртуальной машины и поместите его в реестр, <br />а затем создадите машину из этого образа.<br /><strong>Decision:</strong><br />Установите Docker. Создайте реестр в Yandex Container Registry:<br />&nbsp;yc container registry create --name my-registry<br />Обратите внимание, что в выводе есть уникальный идентификатор (id) реестра. Он пригодится вам для следующих команд.<br />&nbsp;id: crpfpd8jhhldiqah91rc<br />&nbsp;folder_id: b1gfdbij3ijgopgqv9m9<br />&nbsp;name: my-registry<br />&nbsp;status: ACTIVE<br />&nbsp;created_at: "2021-04-06T00:46:48.150Z"<br />Аутентифицируйтесь в Yandex Container Registry с помощью Docker Credential helper. Это нужно для того, чтобы внешняя платформа Docker могла от вашего имени отправить образ в ваш приватный реестр в Yandex Cloud.<br />&nbsp;yc container registry configure-docker<br />Подготовьте Dockerfile. Можно использовать файл из урока о Docker:<br />&nbsp;FROM ubuntu:latest<br />&nbsp;RUN apt-get update -y<br />&nbsp;RUN apt-get install -y nginx<br />&nbsp;ENTRYPOINT ["nginx", "-g", "daemon off;"]<br />По умолчанию Docker использует файл с именем Dockerfile и без расширения.<br />Перейдите в папку с Dockerfile и соберите образ (не забудьте подставить идентификатор своего реестра):<br />&nbsp;docker build . -t cr.yandex/&lt;идентификатор_реестра&gt;/ubuntu-nginx:latest<br />Ключ -t позволяет задать образу имя.<br />Напоминаем, что в Yandex Container Registry можно загрузить только образы, названные по такому шаблону:<br />&nbsp;cr.yandex/&lt;ID реестра&gt;/&lt;имя Docker-образа&gt;:&lt;тег&gt;<br />Загрузите Docker-образ в реестр:<br />&nbsp;docker push cr.yandex/&lt;идентификатор_реестра&gt;/ubuntu-nginx:latest<br />В консоли управления перейдите в реестр и предоставьте всем пользователям право использовать хранящиеся образы. Для этого перейдите на вкладку Права доступа, в правом верхнем углу нажмите кнопку Назначить роли. В открывшемся окне нажмите кнопку Выбрать пользователя, на вкладке Группы выберите All users. Нажмите кнопку Добавить роль и последовательно введите viewer и container-registry.images.puller. Нажмите кнопку Сохранить.<br />В консоли управления создайте ВМ с помощью Container Optimized Image.<br />При создании машины в разделе Выбор образа загрузочного диска переключитесь на вкладку Container Solution и нажмите Настроить. Выберите из реестра созданный образ, остальные настройки оставьте по умолчанию и нажмите Применить.<br />Другие настройки ВМ мы уже разбирали.<br />Когда новая ВМ получит статус Running, найдите её внешний IP адрес в консоли управления и убедитесь, что по этому адресу отображается приветственная страница NGINX.<br />Обратите внимание! C помощью Docker-образа вы создали и запустили виртуальную машину с предустановленным, нужным вам ПО. При этом вам даже не потребовалось заходить внутрь ВМ и выполнять установку или настройку ПО вручную.<br /><strong>Decision:</strong><br />$ sudo apt update<br />$ sudo apt install apt-transport-https ca-certificates curl software-properties-common<br />$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -<br />$ sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"<br />$ sudo apt update<br />$ apt-cache policy docker-ce<br />$ sudo apt install docker-ce<br />$ sudo /etc/init.d/docker start<br />$ yc container registry create --name my-registry<br />$ yc container registry configure-docker<br />$ cd docker/<br />$ vim Dockerfile<br />$ cat Dockerfile<br />FROM ubuntu:latest<br />RUN apt-get update -y<br />RUN apt-get install -y nginx<br />ENTRYPOINT ["nginx", "-g", "daemon off;"]<br />$ sudo docker build . -t cr.yandex/YOUR-ID/ubuntu-nginx:latest<br />$ sudo docker push cr.yandex/YOUR-ID/ubuntu-nginx:latest<br /><strong>Task:</strong><br />Создание кластера. В этой практической работе вы создадите кластер Kubernetes и группу узлов в нём.<br /><strong>Decision:</strong><br />Выберите каталог для кластера.<br />Выберите сервис Managed Service for Kubernetes. Нажмите кнопку Создать кластер. Дальше заполним настройки кластера:<br />Для Kubernetes необходим сервисный аккаунт для ресурсов и узлов.<br />Сервисный аккаунт для ресурсов &mdash; это аккаунт, под которым сервису Kubernetes будут выделяться ресурсы в нашем облаке.<br />Сервисный аккаунт для узлов необходим уже созданным узлам самого кластера Kubernetes для доступа к другим ресурсам. Например, чтобы получить Docker-образы из Container Registry.<br />Этим аккаунтам нужны разные права, и поэтому у них бывают разные роли. В общем случае вы можете использовать один и тот же сервисный аккаунт. Выберите аккаунт, который создали на первом курсе, или заведите новый.<br />Ключ шифрования Yandex Key Management Service позволяет защитить конфиденциальную информацию (пароли, OAuth-токены и SSH-ключи) и повысить безопасность. Это необязательно &mdash; кластер запустится и без ключа. Для этой практической работы не создавайте его.<br />Релизные каналы RAPID, REGULAR и STABLE отличаются процессом обновления и доступными вам версиями Kubernetes.<br />RAPID и REGULAR содержат все версии, включая минорные. STABLE &mdash; только стабильные версии. RAPID обновляется автоматически, а в REGULAR и STABLE обновление можно отключить. Когда появляется обновление, информация о нём отображается в консоли управления.<br />Выберите REGULAR.<br />Внимательно выбирайте релизный канал! Изменить его после создания кластера Kubernetes нельзя.<br />Конфигурация мастера. Мастер &mdash; ведущая нода группы узлов кластера &mdash; следит за состоянием Kubernetes и запускает управляющие процессы. Сконфигурируем мастер:<br />Выберите версию Kubernetes. Их набор зависит от релизного канала. Версии мастера и других нод могут не совпадать, но это достаточно тонкая настройка, могут возникнуть проблемы совместимости, которые повлияют на работу всего кластера.<br />Кластеру может назначаться публичный IP-адрес. Выберите вариант Автоматически. В этом случае IP выбирается из пула свободных IP-адресов. Если вы не используете Cloud Interconnect или VPN для подключения к облаку, то без автоматического назначения IP-адресов вы не сможете подключиться к кластеру: он будет доступен только во внутренней сети вашего облака.<br />Тип мастера влияет на отказоустойчивость. Зональный работает только в одной зоне доступности, а региональный &mdash; в трёх подсетях в каждой зоне доступности.<br />Выберите зональный тип. В будущем для рабочей среды используйте региональные кластеры, а для разработки и тестирования &mdash; более дешёвые зональные.<br />Выбор типа мастера также влияет на подсети, в которых будет развёрнут кластер. У вас уже есть подсети, созданные по умолчанию для функционирования облака. Выберите их.<br />Настройки окна обновлений.<br />Режимов обновления четыре: Отключено, В любое время, Ежедневно и В выбранные дни. Региональный мастер во время обновления остаётся доступен, зональный &mdash; нет.<br />Группа узлов кластера обновляется с выделением дополнительных ресурсов, так как при обновлении создаются узлы с обновлённой конфигурацией. При обновлении поды с контейнерами будут переезжать с одного узла на другой.<br />По умолчанию выставлен пункт В любое время. Оставьте его.<br />Сетевые настройки кластера. Сетевые политики для кластера Kubernetes необязательны. Эта опция включает сетевой контроллер Calico, который позволяет применять тонкие настройки политик доступа для кластера. Не выбирайте эту опцию.<br />Во время работы кластера подам с контейнерами и сервисам самого кластера Kubernetes будут автоматически присваиваться внутренние IP-адреса. Чтобы IP-адреса подов и сервисов Kubernetes не пересеклись с другими адресами в вашем облаке, задайте CIDR (Classless Inter-Domain Routing &mdash; бесклассовая междоменная маршрутизация). Оставьте адреса пустыми: они будут назначены автоматически.<br />Маска подсети узлов влияет на количество подов, которые могут запускаться. Если адресов не хватит, под не запустится.<br />Вы заполнили все настройки, теперь нажмите Создать кластер. Дождитесь, пока статус кластера станет RUNNING, а состояние &mdash; HEALTHY. Это может занять около 10 минут.<br />Создание группы узлов. Зайдите в созданный кластер, перейдите на вкладку Управление узлами и нажмите Создать группу узлов. Группы узлов &mdash; это группы виртуальных машин.<br />Введите имя и описание группы, выберите версию Kubernetes. Выберите Автоматический тип масштабирования и количество узлов от 1 до 5. Укажите среду запуска контейнеров &mdash; Docker.<br />В сетевых настройках задайте автоматический IP-адрес и выберите зону доступности (кластер зональный, поэтому зона доступности только одна). Задайте SSH-ключ, чтобы иметь доступ к виртуальным машинам кластера. Настройки обновления идентичны настройкам мастера.<br />Остальные настройки группы, которые мы не упомянули (вычислительные ресурсы, хранилище и т. д.), оставьте по умолчанию.<br />Нажмите Создать группу узлов и дождитесь, пока операция выполнится.<br /><strong>Task:</strong><br />Первое приложение в кластере. <br />На прошлом уроке вы создали в консоли управления Yandex Cloud кластер Kubernetes и группу узлов в нём. <br />Теперь с помощью командной строки вы развернете в кластере приложение &mdash; веб-сервер NGINX.<br /><strong>Decision:</strong><br />В консоли управления войдите в созданный кластер Managed Service for Kubernetes и нажмите кнопку Подключиться. В открывшемся окне скопируйте команду для подключения:<br />&nbsp;yc managed-kubernetes cluster get-credentials \<br />&nbsp;&nbsp; --id &lt;идентификатор_кластера&gt; \<br />&nbsp;&nbsp; --external<br />Чтобы проверить правильность установки и подключения, посмотрите на конфигурацию:<br />&nbsp;kubectl config view<br />Ответ получится примерно таким (IP-адрес сервера и название кластера будут отличаться):<br />&nbsp;apiVersion: v1<br />&nbsp;clusters:<br />&nbsp;- cluster:<br />&nbsp;&nbsp;&nbsp;&nbsp; certificate-authority-data: DATA+OMITTED<br />&nbsp;&nbsp;&nbsp;&nbsp; server: https://178.154.206.242<br />&nbsp;&nbsp; name: yc-managed-k8s-cat2oek6hbp7mnhhhr4m<br />&nbsp;contexts:<br />&nbsp;...<br />Создание манифеста<br />Для описания настроек приложения в кластере создадим файл my-nginx.yaml. Такой файл называется манифестом.<br />apiVersion: apps/v1<br />kind: Deployment<br />metadata:<br />&nbsp; name: my-nginx-deployment<br />spec:<br />&nbsp; replicas: 1<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp; matchLabels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp; template:<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp;&nbsp;&nbsp; spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; containers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: cr.yandex/&lt;идентификатор_реестра&gt;/ubuntu-nginx:latest <br />Рассмотрим, из чего он состоит.<br />Директива apiVersion определяет, для какой версии Kubernetes написан манифест. От версии к версии обозначение может меняться.<br />&nbsp;apiVersion: apps/v1<br />Директива kind описывает механизм использования. Она может принимать значения Deployment, Namespace, Service, Pod, LoadBalancer и т. д. Для развёртывания приложения укажите значение Deployment.<br />&nbsp;kind: Deployment<br />Директива metadata определяет метаданные приложения: имя, метки (labels), аннотации.<br />С помощью Меток можно идентифицировать, группировать объекты, выбирать их подмножества. Добавляйте и изменяйте метки при создании объектов или позднее, в любое время.<br />Аннотации используют, чтобы добавить собственные метаданные к объектам.<br />Укажем имя приложения:<br />&nbsp;metadata:<br />&nbsp;&nbsp; name: my-nginx-deployment<br />В основном блоке spec содержится описание объектов Kubernetes.<br />Директива replicas определяет масштабирование. Для первого запуска укажите, что приложению нужен один под. Позже вы посмотрите, как приложения масштабируются, и сможете увеличить число подов.<br />Директива selector определяет, какими подами будет управлять контейнер (подробнее о ней можно прочитать в документации). Поды отбираются с помощью метки (label).<br />Директива template определяет шаблон пода. Метка в шаблоне должна совпадать с меткой селектора &mdash; nginx.<br />В шаблоне содержится ещё одна, собственная директива spec. Она задаёт настройки контейнеров, которые будет развёрнуты на поде. Нам нужен один контейнер. Используйте для него образ, созданный ранее с помощью Docker и помещённый в реестр Yandex Container Registry.<br />&nbsp;spec: <br />&nbsp;&nbsp; matchLabels: <br />&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp;&nbsp; replicas: 1<br />&nbsp;&nbsp; selector: ~<br />&nbsp;&nbsp; template: <br />&nbsp;&nbsp;&nbsp;&nbsp; metadata: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp;&nbsp;&nbsp;&nbsp; spec: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; containers: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: "cr.yandex/&lt;идентификатор_реестра&gt;/ubuntu-nginx:latest"<br />Выполнение манифеста. Для создания или обновления ресурсов в кластере используется команда apply. Файл манифеста указывается после флага -f.<br />&nbsp;kubectl apply -f &lt;путь_к_файлу_my-nginx.yaml&gt;<br />Если результат будет успешным, вы увидите сообщение:<br />&nbsp;deployment.apps/my-nginx-deployment created<br />Чтобы убедиться, что приложение создано, посмотрите список подов:<br />&nbsp;kubectl get pods<br />Дождитесь статуса Running:<br />&nbsp;NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; READY&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp; RESTARTS&nbsp;&nbsp; AGE<br />&nbsp;my-nginx-deployment-65b9b678b6-zmfww&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5m27s<br />Теперь получите более подробную информацию, выполнив ту же команду с флагом -o wide:<br />&nbsp;kubectl get pods -o wide<br />Вы увидите внутренний IP-адрес, который присвоен поду. Это пригодится, если нужно узнать, где именно развёрнуто приложение.<br />Чтобы получить максимально подробную информацию о запущенном приложении, используйте команду describe:<br />&nbsp;kubectl describe deployment/my-nginx-deployment<br />Масштабирование. Теперь увеличьте количество подов. Вручную это можно сделать двумя способами:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; изменить файл манифеста, указав в директиве replicas нужное число подов, и снова выполнить команду apply;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; если файла манифеста нет под рукой &mdash; использовать команду scale:<br />kubectl scale --replicas=3 deployment/my-nginx-deployment <br />Если всё получится, в выводе команды kubectl get pods вы увидите сообщение:<br />NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; READY&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp; RESTARTS&nbsp;&nbsp; AGE<br />my-nginx-deployment-65b9b678b6-6whpp&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 117s<br />my-nginx-deployment-65b9b678b6-wtph9&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 117s<br />my-nginx-deployment-65b9b678b6-zmfww&nbsp;&nbsp; 1/1&nbsp;&nbsp;&nbsp;&nbsp; Running&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 14m <br />На следующей практической работе мы посмотрим, как обращаться извне к кластеру Kubernetes и развёрнутому в нём приложению.<br />Кластер как код. Как видите, управление кластерами Kubernetes отлично вписывается в концепцию Infrastructure as Code: вы можете описать конфигурацию кластера в текстовом файле &mdash; манифесте. Вы также можете разворачивать кластеры Kubernetes с помощью Terraform.<br /><strong>Decision:</strong><br />$ sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https<br />$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -<br />$ echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee -a /etc/apt/sources.list.d/kubernetes.list<br />$ sudo apt-get update<br />$ sudo apt-get install -y kubectl<br />$ yc managed-kubernetes cluster get-credentials \<br />&nbsp;&nbsp; --id YOUR-ID1 \<br />&nbsp;&nbsp; --external<br />$ kubectl config view<br />$ vim my-nginx.yaml<br />$ cat my-nginx.yaml<br />apiVersion: apps/v1<br />kind: Deployment<br />metadata:<br />&nbsp; name: my-nginx-deployment<br />spec:<br />&nbsp; replicas: 1<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp; matchLabels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp; template:<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp;&nbsp;&nbsp; spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; containers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: cr.yandex/YOUR-ID/ubuntu-nginx:latest<br />$ kubectl apply -f my-nginx.yaml<br />$ kubectl get pods<br />$ kubectl get pods -o wide<br />$ kubectl describe deployment/my-nginx-deployment<br />$ kubectl scale --replicas=3 deployment/my-nginx-deployment<br />$ kubectl get pods<br /><strong>Task:</strong><br />Балансировка нагрузки.<br />Большинство веб-приложений созданы, чтобы взаимодействовать через интернет. <br />Вы развернули в кластере приложение, но у вас пока нет к нему доступа из интернета. Чтобы исправить эту проблему, воспользуемся сервисом LoadBalancer.<br />У созданного пода есть внутренний IP-адрес.<br />Помните, мы говорили о том, что в кластере есть собственный сервис DNS? Он работает с внутренними IP-адресами объектов кластера, чтобы те могли взаимодействовать.<br />Однако внутренний IP-адрес может меняться, когда ресурсы группы узлов обновляются. Чтобы обращаться к приложению извне, требуется неизменный публичный IP-адрес &mdash; это и будет IP-адрес балансировщика.<br /><strong>Decision:</strong><br />Создайте файл-манифест load-balancer.yaml:<br />&nbsp;apiVersion: v1<br />&nbsp;kind: Service<br />&nbsp;metadata:<br />&nbsp;&nbsp; name: my-loadbalancer<br />&nbsp;spec:<br />&nbsp;&nbsp; selector:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp;&nbsp; ports:<br />&nbsp;&nbsp; - port: 80<br />&nbsp;&nbsp;&nbsp;&nbsp; targetPort: 80<br />&nbsp;&nbsp; type: LoadBalancer<br />Где: port &mdash; порт сетевого балансировщика, на котором будут обслуживаться пользовательские запросы; targetPort &mdash; порт контейнера, на котором доступно приложение; selector &mdash; метка селектора из шаблона подов в манифесте объекта Deployment.<br />Выполните манифест:<br />&nbsp;kubectl apply -f &lt;путь_к_файлу_load-balancer.yaml&gt;<br />Вы увидите сообщение:<br />&nbsp;service/my-loadbalancer created<br />В консоли управления откройте раздел Load Balancer. Там должен появиться балансировщик нагрузки с префиксом k8s в имени и уникальным идентификатором кластера Kubernetes.<br />Скопируйте IP-адрес балансировщика в адресную строку браузера. Вы увидите приветственную страницу NGINX.<br />Если при создании ресурсов вы получаете ошибку failed to ensure cloud loadbalancer: failed to start cloud lb creation: Permission denied, убедитесь, что вашему сервисному аккаунту хватает прав. Подробнее читайте в документации. <br /><strong>Decision:</strong><br />$ vim load-balancer.yaml<br />$ cat load-balancer.yaml<br />&nbsp;apiVersion: v1<br />&nbsp;kind: Service<br />&nbsp;metadata:<br />&nbsp;&nbsp; name: my-loadbalancer<br />&nbsp;spec:<br />&nbsp;&nbsp; selector:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx<br />&nbsp;&nbsp; ports:<br />&nbsp;&nbsp; - port: 80<br />&nbsp;&nbsp;&nbsp;&nbsp; targetPort: 80<br />&nbsp;&nbsp; type: LoadBalancer<br />$ kubectl apply -f load-balancer.yaml<br /><strong>Task:</strong><br />Автомасштабирование в Yandex Managed Kubernetes. <br />В этой работе вы увидите, как в Kubernetes выполняется горизонтальное автомасштабирование.<br /><strong>Decision:</strong><br />Создайте манифест load-balancer-hpa.yaml.<br />Для начала скопируйте в него настройки спецификаций, которые вы составляли на предыдущих уроках: из my-nginx.yaml (в примере ниже это раздел Deployment) и из load-balancer.yaml (раздел Service).<br />Поскольку новый балансировщик должен отслеживать отдельную группу контейнеров, используйте для контейнеров другие метки (labels), например nginx-hpa.<br />---<br />### Deployment<br />apiVersion: apps/v1<br />kind: Deployment<br />metadata:<br />&nbsp; name: my-loadbalancer-hpa<br />&nbsp; labels:<br />&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />spec:<br />&nbsp; replicas: 1<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp; matchLabels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp; template:<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp;&nbsp;&nbsp; spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; containers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: k8s.gcr.io/hpa-example<br />---<br />### Service<br />apiVersion: v1<br />kind: Service<br />metadata:<br />&nbsp; name: my-loadbalancer-hpa<br />spec:<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp; ports:<br />&nbsp;&nbsp;&nbsp; - protocol: TCP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port: 80<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; targetPort: 80<br />&nbsp; type: LoadBalancer <br />В разделе Deployment смените образ с Yandex Container Registry на k8s.gcr.io/hpa-example &mdash; это специальный тестовый образ из публичного репозитория, создающий высокую нагрузку на процессор. Так вам будет удобно отслеживать работу Horizontal Pod Autoscaler.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; containers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: k8s.gcr.io/hpa-example <br />Теперь добавьте в шаблон контейнера настройки requests и limits: мы попросим по умолчанию 256 мебибайтов памяти и 500 милли-CPU (половину ядра), а ограничим контейнер 500 мебибайтами и 1 CPU.<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; spec:<br />&nbsp;&nbsp;&nbsp;&nbsp; containers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: k8s.gcr.io/hpa-example<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resources:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requests:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: "256Mi"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu: "500m"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; limits:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: "500Mi"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu: "1" <br />Дополните манифест настройками для Horizontal Pod Autoscaler:<br />apiVersion: autoscaling/v1<br />kind: HorizontalPodAutoscaler<br />metadata:<br />&nbsp; name: my-hpa<br />spec:<br />&nbsp; scaleTargetRef:<br />&nbsp;&nbsp;&nbsp; apiVersion: apps/v1<br />&nbsp;&nbsp;&nbsp; kind: Deployment<br />&nbsp;&nbsp;&nbsp; name: my-nginx-deployment-hpa<br />&nbsp; minReplicas: 1<br />&nbsp; maxReplicas: 5<br />&nbsp; targetCPUUtilizationPercentage: 20 <br />В результате должен получиться такой манифест:<br />---<br />### Deployment<br />apiVersion: apps/v1<br />kind: Deployment<br />metadata:<br />&nbsp; name: my-nginx-deployment-hpa<br />&nbsp; labels:<br />&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />spec:<br />&nbsp; replicas: 1<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp; matchLabels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp; template:<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp;&nbsp;&nbsp; spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; containers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: k8s.gcr.io/hpa-example<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resources:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requests:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: "256Mi"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu: "500m"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; limits:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: "500Mi"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu: "1"<br />---<br />### Service<br />apiVersion: v1<br />kind: Service<br />metadata:<br />&nbsp; name: my-loadbalancer-hpa<br />spec:<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp; ports:<br />&nbsp;&nbsp;&nbsp; - protocol: TCP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port: 80<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; targetPort: 80<br />&nbsp; type: LoadBalancer<br />---<br />### HPA<br />apiVersion: autoscaling/v1<br />kind: HorizontalPodAutoscaler<br />metadata:<br />&nbsp; name: my-hpa<br />spec:<br />&nbsp; scaleTargetRef:<br />&nbsp;&nbsp;&nbsp; apiVersion: apps/v1<br />&nbsp;&nbsp;&nbsp; kind: Deployment<br />&nbsp;&nbsp;&nbsp; name: my-nginx-deployment-hpa<br />&nbsp; minReplicas: 1<br />&nbsp; maxReplicas: 5<br />&nbsp; targetCPUUtilizationPercentage: 20 <br />Примените манифест:<br />kubectl apply -f &lt;путь_к_load-balancer-hpa.yaml&gt; <br />Вы увидите три сообщения:<br />deployment.apps/my-nginx-deployment-hpa created<br />service/my-loadbalancer-hpa created<br />horizontalpodautoscaler.autoscaling/my-hpa created <br />В консоли управления перейдите в раздел Network Load Balancer. Дождитесь, пока статус my-nginx-deployment-hpa станет Running, после чего посмотрите IP-адрес балансировщика. Убедитесь, что в браузере этот адрес доступен. В терминале сохраните IP-адрес в переменную. Например, так:<br />LOAD_BALANCER_IP=&lt;IP-адрес балансировщика&gt; <br />Запустите в отдельном окне отслеживание интересующих вас компонентов кластера Kubernetes:<br />while true; do kubectl get pod,svc,hpa,nodes -o wide; sleep 5; done &nbsp;<br />Теперь сымитируйте рабочую нагрузку на приложение. Для этого подойдёт утилита wget (установите её с помощью пакетного менеджера или с сайта).<br />while true; do wget -q -O- http://$LOAD_BALANCER_IP; done &nbsp;<br />Вы увидите, что сначала увеличится число подов, а затем добавятся узлы. Число узлов ограничено настройками группы узлов кластера, которые вы задали при создании кластера (в нашем случае максимальное количество узлов &mdash; пять).<br />Остановите цикл создания нагрузки на приложение (комбинация клавиш Ctrl + C). В окне консоли с отслеживанием компонентов кластера вы увидите, как удаляются узлы и поды без нагрузки.<br /><strong>Decision:</strong><br />$ vim load-balancer-hpa.yaml<br />$ cat load-balancer-hpa.yaml<br />### Deployment<br />apiVersion: apps/v1<br />kind: Deployment<br />metadata:<br />&nbsp; name: my-nginx-deployment-hpa<br />&nbsp; labels:<br />&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />spec:<br />&nbsp; replicas: 1<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp; matchLabels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp; template:<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp;&nbsp;&nbsp; spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; containers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: nginx-hpa<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image: k8s.gcr.io/hpa-example<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; resources:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; requests:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: "256Mi"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu: "500m"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; limits:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: "500Mi"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cpu: "1"<br />### Service<br />apiVersion: v1<br />kind: Service<br />metadata:<br />&nbsp; name: my-loadbalancer-hpa<br />spec:<br />&nbsp; selector:<br />&nbsp;&nbsp;&nbsp; app: nginx-hpa<br />&nbsp; ports:<br />&nbsp;&nbsp;&nbsp; - protocol: TCP<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port: 80<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; targetPort: 80<br />&nbsp; type: LoadBalancer<br />### HPA<br />apiVersion: autoscaling/v1<br />kind: HorizontalPodAutoscaler<br />metadata:<br />&nbsp; name: my-hpa<br />spec:<br />&nbsp; scaleTargetRef:<br />&nbsp;&nbsp;&nbsp; apiVersion: apps/v1<br />&nbsp;&nbsp;&nbsp; kind: Deployment<br />&nbsp;&nbsp;&nbsp; name: my-nginx-deployment-hpa<br />&nbsp; minReplicas: 1<br />&nbsp; maxReplicas: 5<br />&nbsp; targetCPUUtilizationPercentage: 20<br />$ kubectl apply -f load-balancer-hpa.yaml<br /><strong>Task:</strong><br />Сбой виртуальной машины.<br />Давайте посмотрим, как принципы построения отказоустойчивых систем реализованы в Yandex Cloud. <br />В практических работах этой темы вы проверите четыре основных сценария отказов: сбой виртуальной машины, сбой всей зоны доступности, обновление приложения, сбой приложения.<br />Вы сымитируете эти отказы и понаблюдаете, как Yandex Cloud обеспечивает доступность приложения и восстанавливает инфраструктуру после сбоев.<br /><strong>Decision:</strong><br />Начнем с самого простого сценария &mdash; сбоя виртуальной машины.<br />Создайте группу из трёх ВМ в трёх зонах доступности под балансировщиком нагрузки. Используйте образ с ОС Ubuntu 18.04 (потом мы обновим его на более свежую версию ОС).<br />Используйте спецификацию specification.yaml из практической работы по CLI Yandex Cloud, но адаптируйте её для того, чтобы на ней можно было проверить разные сценарии сбоев.<br />Во-первых, будут задействованы все три зоны доступности, поэтому нужно немного исправить блок allocation_policy:<br />allocation_policy:<br />&nbsp;&nbsp;&nbsp; zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-a<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-b<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-c <br />Также пропишите подсети для каждой зоны (не забывайте подставлять идентификаторы ваших подсетей):<br />&nbsp;&nbsp;&nbsp; network_interface_specs:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - network_id: &lt;идентификатор_сети&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; subnet_ids: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - &lt;идентификатор_подсети_№1&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - &lt;идентификатор_подсети_№2&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - &lt;идентификатор_подсети_№3&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; primary_v4_address_spec: { one_to_one_nat_spec: { ip_version: IPV4 }} <br />Во-вторых, в секции #cloud-config укажите пользователя, которого нужно создать для входа в виртуальные машины по SSH (это понадобится позднее, на одной из следующих практических работ):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; users:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: my-user<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; groups: sudo<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lock_passwd: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sudo: 'ALL=(ALL) NOPASSWD:ALL'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ssh-authorized-keys:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - ssh-rsa AAAAB3Nza... <br />Обновленный файл спецификации specification.yaml:<br />name: my-group<br />service_account_id: &lt;идентификатор_сервисного_аккаунта&gt;<br />instance_template:<br />&nbsp;&nbsp;&nbsp; platform_id: standard-v1<br />&nbsp;&nbsp;&nbsp; resources_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: 2g<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cores: 2<br />&nbsp;&nbsp;&nbsp; boot_disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode: READ_WRITE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id: &lt;идентификатор_образа_Ubuntu_18.04&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type_id: network-hdd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 32g<br />&nbsp;&nbsp;&nbsp; network_interface_specs:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - network_id: &lt;идентификатор_сети&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; subnet_ids: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - &lt;идентификатор_подсети_№1&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - &lt;идентификатор_подсети_№2&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - &lt;идентификатор_подсети_№3&gt; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; primary_v4_address_spec: { one_to_one_nat_spec: { ip_version: IPV4 }}<br />&nbsp;&nbsp;&nbsp; scheduling_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; preemptible: false<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user-data: |-<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #cloud-config<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; users:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: my-user<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; groups: sudo<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lock_passwd: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sudo: 'ALL=(ALL) NOPASSWD:ALL'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ssh-authorized-keys:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - &lt;содержимое_публичной_части_SSH-ключа&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; package_update: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runcmd:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [ apt-get, install, -y, nginx ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [/bin/bash, -c, 'source /etc/lsb-release; sed -i "s/Welcome to nginx/It is $(hostname) on $DISTRIB_DESCRIPTION/" /var/www/html/index.nginx-debian.html']<br />&nbsp;deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 1<br />&nbsp;&nbsp;&nbsp; max_expansion: 0<br />scale_policy:<br />&nbsp;&nbsp;&nbsp; fixed_scale:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 3<br />allocation_policy:<br />&nbsp;&nbsp;&nbsp; zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-a<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-b<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-c<br />&nbsp;load_balancer_spec:<br />&nbsp;&nbsp;&nbsp; target_group_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: my-target-group<br />Создайте группу по новой спецификации:<br />yc compute instance-group create --file &lt;путь_к_файлу_specification.yaml&gt; <br />Если ранее вы удаляли балансировщик нагрузки, создайте его снова и привяжите к целевой группе:<br />yc load-balancer network-load-balancer create \<br />&nbsp; --region-id ru-central1 \<br />&nbsp; --name my-load-balancer \<br />&nbsp; --listener name=my-listener,external-ip-version=ipv4,port=80 \<br />&nbsp; --target-group target-group-id=&lt;идентификатор_целевой_группы&gt;,healthcheck-name=test-health-check,healthcheck-interval=2s,healthcheck-timeout=1s,healthcheck-unhealthythreshold=2,healthcheck-healthythreshold=2,healthcheck-http-port=80 <br />В консоли управления убедитесь, что ресурсы созданы. Проверьте вывод по внешнему IP-адресу балансировщика &mdash; должна отображаться приветственная страница с идентификатором одной из виртуальных машин группы.<br />Начните отслеживать состояние виртуальных машин группы и целевой группы балансировщика:<br />while true; do \<br />yc compute instance-group \<br />&nbsp; --id &lt;идентификатор_группы_ВМ&gt; list-instances; \<br />yc load-balancer network-load-balancer \<br />&nbsp; --id &lt;идентификатор_балансировщика&gt; target-states \<br />&nbsp; --target-group-id &lt;идентификатор_целевой_группы&gt;; \<br />sleep 5; done <br />Информация выводится в виде таблиц:<br />+----------------------+---------------------------+----------------+-------------+------------------------+----------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | STATUS MESSAGE |<br />+----------------------+---------------------------+----------------+-------------+------------------------+----------------+<br />| ef34nv4tp3ha8gl6p3df | cl1m5ksvljnq5frekghi-uzex | 84.201.148.207 | 10.128.0.42 | RUNNING_ACTUAL [1m54s] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [13m]&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [6h]&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+------------------------+----------------+<br />+----------------------+-------------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; | STATUS&nbsp; |<br />+----------------------+-------------+---------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY |<br />| e2luooifg8ruecr7g6fk | 10.128.0.6&nbsp; | HEALTHY |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY |<br />+----------------------+-------------+---------+<br />Сбой виртуальной машины может произойти из-за падения физического хоста, на котором она запущена. Иногда виртуальную машину могут удалить случайно, по ошибке. Чтобы сымитировать сбой, удалим одну из виртуальных машин в группе через консоль управления.<br />Если бы это была единственная машина, на которую поступает трафик, система стала бы недоступна. Но у нас система развернута на нескольких виртуальных машинах, поэтому трафик будет перенаправлен на две оставшиеся. Через несколько секунд будет обнаружена проблема, и виртуальная машина будет выведена из-под балансировки. Об этом говорит статус UNHEALTHY.<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | STATUS MESSAGE |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />| ef330no5frc5de91v77n | cl1m5ksvljnq5frekghi-uzex | 84.201.147.33&nbsp; | 10.128.0.6&nbsp; | RUNNING_ACTUAL [15m] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [32m] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [6h]&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />+----------------------+-------------+-----------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; |&nbsp; STATUS&nbsp;&nbsp; |<br />+----------------------+-------------+-----------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY&nbsp;&nbsp; |<br />| e2luooifg8ruecr7g6fk | 10.128.0.6&nbsp; | UNHEALTHY |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY&nbsp;&nbsp; |<br />+----------------------+-------------+-----------+ <br />Далее подсеть перейдет в статус DRAINING &mdash; ресурс удаляется, и с него снимается трафик. Балансировщик перестает передавать трафик этому ресурсу.<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | STATUS MESSAGE |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />| ef330no5frc5de91v77n | cl1m5ksvljnq5frekghi-uzex | 84.201.147.33&nbsp; | 10.128.0.6&nbsp; | CLOSING_TRAFFIC [0s] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [33m] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [6h]&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />+----------------------+-------------+----------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; |&nbsp; STATUS&nbsp; |<br />+----------------------+-------------+----------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY&nbsp; |<br />| e2luooifg8ruecr7g6fk | 10.128.0.6&nbsp; | DRAINING |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY&nbsp; |<br />+----------------------+-------------+----------+<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | STATUS MESSAGE |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />| ef330no5frc5de91v77n | cl1m5ksvljnq5frekghi-uzex | 84.201.147.33&nbsp; | 10.128.0.6&nbsp; | CLOSING_TRAFFIC [9s] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [33m] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [6h]&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />+----------------------+-------------+----------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; |&nbsp; STATUS&nbsp; |<br />+----------------------+-------------+----------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY&nbsp; |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY&nbsp; |<br />+----------------------+-------------+----------+ <br />После этого Instance Group начнет пересоздавать удалённую виртуальную машину. Процесс восстановления может занять некоторое время. Понаблюдаем за ним.<br />Сначала новая виртуальная машина появится в группе в статусе CREATING_INSTANCE.<br />+----------------------+---------------------------+----------------+-------------+-------------------------+----------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | STATUS MESSAGE |<br />+----------------------+---------------------------+----------------+-------------+-------------------------+----------------+<br />| ef330no5frc5de91v77n | cl1m5ksvljnq5frekghi-uzex | 84.201.147.33&nbsp; | 10.128.0.6&nbsp; | CREATING_INSTANCE [-1s] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [33m]&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [6h]&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+-------------------------+----------------+<br />+----------------------+-------------+----------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; |&nbsp; STATUS&nbsp; |<br />+----------------------+-------------+----------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY&nbsp; |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY&nbsp; |<br />+----------------------+-------------+----------+<br />Далее виртуальная машина будет открыта для трафика (статус OPEN_TRAFFIC). Балансировщик начнет процесс включения машины в список доступных машин.<br />+----------------------+---------------------------+----------------+-------------+-----------------------+--------------------------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS MESSAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+-----------------------+--------------------------------+<br />| ef374t9ghea78p471gal | cl1m5ksvljnq5frekghi-uzex | 84.252.135.153 | 10.128.0.32 | OPENING_TRAFFIC [-1s] | Adding target(s)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 10.128.0.32 to target group&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | b7rh0bhm9f82dglb2p9r&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [34m]&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [7h]&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+-----------------------+--------------------------------+<br />+----------------------+-------------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; | STATUS&nbsp; |<br />+----------------------+-------------+---------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY |<br />+----------------------+-------------+---------+<br />+----------------------+---------------------------+----------------+-------------+----------------------+--------------------------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS MESSAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+----------------------+--------------------------------+<br />| ef374t9ghea78p471gal | cl1m5ksvljnq5frekghi-uzex | 84.252.135.153 | 10.128.0.32 | OPENING_TRAFFIC [1s] | Adding target(s)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 10.128.0.32 to target group&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | b7rh0bhm9f82dglb2p9r&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [34m] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [7h]&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+----------------------+--------------------------------+<br />+----------------------+-------------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; | STATUS&nbsp; |<br />+----------------------+-------------+---------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY |<br />| e2luooifg8ruecr7g6fk | 10.128.0.32 | INITIAL |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY |<br />+----------------------+-------------+---------+<br />+----------------------+---------------------------+----------------+-------------+-----------------------+--------------------------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS MESSAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+-----------------------+--------------------------------+<br />| ef374t9ghea78p471gal | cl1m5ksvljnq5frekghi-uzex | 84.252.135.153 | 10.128.0.32 | OPENING_TRAFFIC [18s] | Awaiting HEALTHY state for&nbsp;&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | target(s) 10.128.0.32. Elapsed |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | time: 3s.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [34m]&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [7h]&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+-----------------------+--------------------------------+<br />+----------------------+-------------+----------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; |&nbsp; STATUS&nbsp; |<br />+----------------------+-------------+----------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.32 | INITIAL&nbsp; |<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | INACTIVE |<br />| b0c4h992tbuodl5hudpu | 10.128.0.9&nbsp; | HEALTHY&nbsp; |<br />+----------------------+-------------+----------+<br />+----------------------+---------------------------+----------------+-------------+-------------------------+--------------------------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS MESSAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+-------------------------+--------------------------------+<br />| ef374t9ghea78p471gal | cl1m5ksvljnq5frekghi-uzex | 84.252.135.153 | 10.128.0.32 | OPENING_TRAFFIC [1m32s] | [NLB unhealthy]; Awaiting&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | HEALTHY state for target(s)&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 10.128.0.32. Elapsed time: 1m&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 17s.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [35m]&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [7h]&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+-------------------------+--------------------------------+<br />+----------------------+-------------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; | STATUS&nbsp; |<br />+----------------------+-------------+---------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY |<br />| e2luooifg8ruecr7g6fk | 10.128.0.32 | HEALTHY |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY |<br />+----------------------+-------------+---------+ <br />И в завершение подсеть перейдет в статус HEALTHY, а машина &mdash; в статус RUNNING_ACTUAL, и трафик будет снова разделен между тремя машинами.<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />|&nbsp;&nbsp;&nbsp;&nbsp; INSTANCE ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp; EXTERNAL IP&nbsp;&nbsp; | INTERNAL IP |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | STATUS MESSAGE |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />| ef374t9ghea78p471gal | cl1m5ksvljnq5frekghi-uzex | 84.252.135.153 | 10.128.0.32 | RUNNING_ACTUAL [-1s] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3nquhoicdq0ccl0tlq | cl1m5ksvljnq5frekghi-iduv | 84.201.171.248 | 10.128.0.9&nbsp; | RUNNING_ACTUAL [35m] |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />| ef3oio9su52imaod7rad | cl1m5ksvljnq5frekghi-ixac | 84.252.132.4&nbsp;&nbsp; | 10.128.0.37 | RUNNING_ACTUAL [7h]&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----------------------+---------------------------+----------------+-------------+----------------------+----------------+<br />+----------------------+-------------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SUBNET ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; ADDRESS&nbsp;&nbsp; | STATUS&nbsp; |<br />+----------------------+-------------+---------+<br />| b0c4h992tbuodl5hudpu | 10.128.0.37 | HEALTHY |<br />| e2luooifg8ruecr7g6fk | 10.128.0.32 | HEALTHY |<br />| e9bn57jvjnbujnmk3mba | 10.128.0.9&nbsp; | HEALTHY |<br />+----------------------+-------------+---------+ <br />Восстановление произошло автоматически без ручного вмешательства.<br /><strong>Decision:</strong><br />$ vim specification1.yaml<br />$ cat specification1.yaml<br />name: my-group<br />service_account_id: YOUR-ID<br />instance_template:<br />&nbsp;&nbsp;&nbsp; platform_id: standard-v1<br />&nbsp;&nbsp;&nbsp; resources_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memory: 2g<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cores: 2<br />&nbsp;&nbsp;&nbsp; boot_disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mode: READ_WRITE<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; disk_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; image_id: YOUR-ID1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type_id: network-hdd<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 32g<br />&nbsp;&nbsp;&nbsp; network_interface_specs:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - network_id: YOUR-ID2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; subnet_ids: <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - YOUR-ID3<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - YOUR-ID4<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - YOUR-ID5<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; primary_v4_address_spec: { one_to_one_nat_spec: { ip_version: IPV4 }}<br />&nbsp;&nbsp;&nbsp; scheduling_policy:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; preemptible: false<br />&nbsp;&nbsp;&nbsp; metadata:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user-data: |-<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #cloud-config<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; users:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: YOUR-USERNAME<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; groups: sudo<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lock_passwd: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sudo: 'ALL=(ALL) NOPASSWD:ALL'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ssh-authorized-keys:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - YOUR-KEY<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; package_update: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runcmd:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [ apt-get, install, -y, nginx ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - [/bin/bash, -c, 'source /etc/lsb-release; sed -i "s/Welcome to nginx/It is $(hostname) on $DISTRIB_DESCRIPTION/" /var/www/html/index.nginx-debian.html']<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 1<br />&nbsp;&nbsp;&nbsp; max_expansion: 0<br />scale_policy:<br />&nbsp;&nbsp;&nbsp; fixed_scale:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; size: 3<br />allocation_policy:<br />&nbsp;&nbsp;&nbsp; zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-a<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-b<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - zone_id: ru-central1-c<br />load_balancer_spec:<br />&nbsp;&nbsp;&nbsp; target_group_spec:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: my-target-group<br />$ yc compute instance-group create --file specification.yaml<br />$ yc load-balancer network-load-balancer create \<br />&nbsp; --region-id ru-central1 \<br />&nbsp; --name my-load-balancer \<br />&nbsp; --listener name=my-listener,external-ip-version=ipv4,port=80 \<br />&nbsp; --target-group target-group-id=YOUR-ID6,healthcheck-name=test-health-check,healthcheck-interval=2s,healthcheck-timeout=1s,healthcheck-unhealthythreshold=2,healthcheck-healthythreshold=2,healthcheck-http-port=80<br />$ while true; do \<br />yc compute instance-group \<br />&nbsp; --id YOUR-ID8 list-instances; \<br />yc load-balancer network-load-balancer \<br />&nbsp; --id YOUR-ID7 target-states \<br />&nbsp; --target-group-id YOUR-ID6; \<br />sleep 5; done<br /><strong>Task:</strong><br />Сбой зоны доступности.<br />В этом сценарии рассмотрим ситуацию, когда произошел сбой сразу всей зоны доступности. Такие ситуации возникают крайне редко и могут быть связаны с какими-то масштабными стихийными бедствиями, однако и их стоит предусмотреть.<br />Посмотрим, как будет решаться проблема неожиданного выхода из строя зоны доступности.<br /><strong>Decision:</strong><br />В нашем примере (см. предыдущий урок) используются все три зоны доступности &mdash; ru-central1-a, ru-central1-b и ru-central1-c. В каждой зоне располагается одна ВМ.<br />Установите такие настройки политики развертывания &mdash; пусть группу можно расширять на 1 ВМ и уменьшать на 1 ВМ:<br />Теперь в настройках группы виртуальных машин уберите одну зону доступности, например ru-central1-c. Переключитесь на вкладку Список ВМ и посмотрите, что будет происходить.<br />Для ВМ, которая располагалась в зоне ru-central1-c, отключается трафик (статус Closing traffic), а затем сама машина удаляется (статус Deleting instance). Одновременно в другой зоне доступности создаётся и запускается новая ВМ. Остальные машины в группе продолжают работать без изменений.<br />Таким образом, даже при выходе из строя всей зоны доступности группа виртуальных машин продолжит работать и будет способна принимать прежнюю нагрузку.<br /><strong>Task:</strong><br />Обновление приложения.<br />На практической работе с CLI мы уже рассматривали обновление операционной системы для группы виртуальных машин. Любые приложения, установленные на ВМ, обновляются по тем же правилам. Давайте рассмотрим этот процесс ещё раз.<br /><strong>Decision:</strong><br />Первый вариант обновления<br />Если вы работаете в консоли управления, измените шаблон ВМ и выберите образ с ОС Ubuntu 20.04. Убедитесь, что параметры политики развёртывания такие: группу нельзя расширять, а уменьшать можно только на одну ВМ.<br />Политика развёртывания группы виртуальных машин (вариант 1)<br />Если вы работаете в командной строке, в спецификации specification.yaml измените параметр image_id (например с fd8s2gbn4d5k2rcf12d9 на fd8ju9iqf6g5bcq77jns) и запустите обновление группы:<br />yc compute instance-group update \<br />&nbsp; --name my-group \<br />&nbsp; --file &lt;путь_к_файлу_specification.yaml&gt; <br />В консоли управления на странице группы ВМ перейдите на вкладку Список ВМ и проследите, как меняются статусы машин.<br />Сначала вы увидите статус Running outdated. Это означает, что машины работают со старой версией приложения.<br />Затем одна из машин начинает обновляться: для неё закрывается трафик (статус Closing traffic), она останавливается (статус Stopping instance), обновляется (статус Updating instance), затем трафик снова открывается (статус Opening traffic), и наконец статус меняется на Running actual. Обновление выполнено.<br />Затем то же самое последовательно выполняется для остальных машин в группе.<br />Порядок обновления зависит от политики развёртывания. Мы запретили увеличивать размер группы и указали, что одновременно неработоспособной может быть только одна машина. Именно так и произошло обновление: машины по одной выводились из строя, обновлялись и запускались снова.<br />Второй вариант обновления<br />Теперь давайте изменим настройки политики развёртывания.<br />Если вы работаете в консоли управления, измените шаблон ВМ и выберите образ с Ubuntu и NGINX, созданный ранее и помещённый в Container Registry.<br />Измените параметры развёртывания. Теперь группу можно расширять на одну ВМ, а уменьшать нельзя:<br />Политика развёртывания группы виртуальных машин (вариант 2)<br />Если вы работаете в командной строке, в спецификации specification.yaml измените параметр image_id (например, снова с fd8ju9iqf6g5bcq77jns на fd8s2gbn4d5k2rcf12d9). Параметры обновления измените так:<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 0<br />&nbsp;&nbsp;&nbsp; max_expansion: 1 <br />Запустите обновление группы.<br />В консоли управления на странице группы ВМ перейдите на вкладку Список ВМ и проследите, как меняются статусы машин.<br />Сначала вы увидите статус Running outdated. Затем создаётся новая машина (статус Creating instance), для неё открывается трафик (статус Opening traffic), статус машины меняется на Running actual, при этом одна из &laquo;устаревших&raquo; ВМ выводится из строя (статусы Closing traffic и Stopping instance).<br />Затем то же самое последовательно выполняется для остальных машин в группе.<br /><strong>Decision:</strong><br />$ yc compute instance-group update \<br />&nbsp; --id YOUR-ID \<br />&nbsp; --file specification1.yaml<br />$ cat specification1.yaml<br />...<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 1<br />&nbsp;&nbsp;&nbsp; max_expansion: 0<br />...<br />$ vim specification1.yaml<br />$ cat specification1.yaml<br />...<br />deploy_policy:<br />&nbsp;&nbsp;&nbsp; max_unavailable: 0<br />&nbsp;&nbsp;&nbsp; max_expansion: 1<br />...<br /><strong>Task:</strong><br />Сбой приложения.<br />Последний сценарий, который мы рассмотрим, это сбой приложения. Ситуация, когда сама ВМ работоспособна, но по каким-то причинам произошла ошибка в приложении. Это может быть потеря соединения с базой данных или какой-то баг в запущенном приложении (например утечка памяти). Давайте сымитируем такой сценарий. На наших виртуальных машинах запущен только веб-сервер NGINX, давайте остановим его. Но сначала включим проверку состояния ВМ.<br /><strong>Decision:</strong><br />В консоли управления откройте вкладку Обзор для вашей группы виртуальных машин, нажмите кнопку Изменить и активируйте проверку состояний. Сохраните изменения.<br />В браузере откройте страницу с внешним IP-адресом балансировщика, привязанного к вашей группе, и посмотрите, на какую из машин выводится трафик. Узнайте внешний IP-адрес этой машины.<br />В новой вкладке браузера откройте IP-адрес этой виртуальной машины и убедитесь, что выводится приветственная страница, т. е. сервер доступен.<br />Помните, когда вы меняли файл конфигурации для группы машин, вы добавили в него пользователя my-user? Теперь он вам пригодится &mdash; из консоли зайдите на ВМ от его имени:<br />&nbsp;ssh my-user@&lt;внешний_IP-адрес_ВМ&gt;<br />Посмотрите список запущенных процессов:<br />&nbsp;ps axu<br />Убедитесь, что в списке есть процессы nginx:<br />Теперь остановите эти процессы, чтобы сделать сервер недоступным:<br />&nbsp;sudo killall nginx<br />В браузере обновите страницу балансировщика. Вы увидите, что теперь трафик направляется на другую виртуальную машину группы. Это означает, что Instance Group обнаружил сбой приложения и переключил трафик.<br />Теперь обновите страницу виртуальной машины, на которой вы остановили NGINX. Убедитесь, что сервер теперь недоступен.<br />Откройте список машин вашей группы и проследите, как меняется состояние одной из машин.<br />Сначала будет закрыт трафик (статус Closing traffic), затем виртуальная машина будет остановлена (статус Stopping instance), а затем перезапущена (статус Running actual).<br />Убедитесь, что веб-сервер на этой ВМ снова доступен.<br />Мы проверили четыре основных сценария сбоев и убедились, что Yandex Cloud автоматически отрабатывает их и восстанавливает работоспособность группы.<br />$ ssh YOUR-USERNAME@YOUR-IP<br />$ ps axu<br />$ sudo killall nginx<br /><strong>Task:</strong><br />Отправка собственных метрик.<br />Часто бывает полезно отслеживать более широкий набор метрик, чем тот, что доступен в Yandex Monitoring &laquo;из коробки&raquo;.<br />Предположим, вам интересно узнать, сколько людей заходит на ваш сайт и как их число зависит от времени дня или дня недели. <br />Вы можете выгружать эти данные из Яндекс Метрики или вашей собственной аналитической системы и самостоятельно загружать в Yandex Monitoring с помощью API.<br />Давайте попробуем сделать это с нашим сайтом.<br /><strong>Decision:</strong><br />Отправка метрик через API<br />Получите IAM-токен: Инструкция для аккаунта на Яндексе, Инструкция для сервисного аккаунта.<br />Обратите внимание &mdash; токены устаревают через 12 часов после создания. Поэтому если вы сделаете паузу при выполнении данной практической работы, для продолжения лучше запросить новый токен.<br />Сохраните токен в переменной окружения, так его будет проще использовать:<br />&nbsp;export IAM_TOKEN=&lt;IAM-токен&gt;<br />Создайте файл с телом запроса, например my-metrics.json. В свойстве metrics указывается список метрик для записи. Пусть это будет количество пользователей сайта. В массиве timeseries указываются значения на разные моменты времени (измените число на сегодняшнее в формате год-месяц-день).<br />{<br />&nbsp; "metrics": [<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "name": "number_of_users",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "labels": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "site": "aibolit"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "type": "IGAUGE",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "timeseries": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T10:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "22"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T11:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "44"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T12:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "11"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T13:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "55"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T14:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "33"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; ]<br />} <br />Отправьте запрос, указав в нем идентификатор каталога и имя сервиса custom (это имя указывается для всех пользовательских метрик):<br />&nbsp;curl -X POST \<br />&nbsp;&nbsp;&nbsp;&nbsp; -H "Content-Type: application/json" \<br />&nbsp;&nbsp;&nbsp;&nbsp; -H "Authorization: Bearer ${IAM_TOKEN}" \<br />&nbsp;&nbsp;&nbsp;&nbsp; -d '@&lt;путь_к_файлу_my-metrics.json&gt;' \<br />&nbsp;'https://monitoring.api.cloud.yandex.net/monitoring/v2/data/write?folderId=&lt;идентификатор_каталога&gt;&amp;service=custom'<br />Мониторинг пользовательских метрик<br />Создайте на вашем дашборде новый виджет с графиком, назовите его &laquo;Число пользователей сайта&raquo;.<br />В виджете создайте запрос с параметрами service = Custom Metrics и name = number_of_users. Убедитесь, что в виджете выбран нужный период:<br />Этот график станет нагляднее, если вместо точек отображать столбцы. Тип графика можно изменить с помощью кнопки в правом верхнем углу виджета:<br />Мониторинг метрик Linux<br />Другой пример &mdash; ваши приложения запущены на виртуальных машинах под Linux. По умолчанию вы можете посмотреть утилизацию ресурсов процессора или диска для ВМ в целом. Но вам будет полезно знать, сколько ресурсов потребляет каждое из них. В Yandex Monitoring вы можете отслеживать системные метрики Linux, такие как объём свободной памяти или загрузка процессора. Но для этого нужно дополнительно настроить отправку этих метрик с помощью Yandex Unified Agent, который мы уже упоминали.<br />Установка Yandex Unified Agent<br />Создайте виртуальную машину. На неё вы будете устанавливать Yandex Unified Agent. Можете использовать образ с ОС Ubuntu, который вы создали ранее и поместили в Container Registry. Назовите машину, например, for-ua.<br />При создании используйте ваш сервисный аккаунт. Задайте логин (например ua-user) и ssh-ключ.<br />Для сервисного аккаунта добавьте роль monitoring.editor.<br />Посмотрите публичный IP-адрес машины for-ua и зайдите на неё по ssh:<br />&nbsp;ssh ua-user@&lt;публичный_адрес_ВМ&gt;<br />Теперь вы можете установить Yandex Unified Agent:<br />&nbsp;ua_version=$(curl -s https://storage.yandexcloud.net/yc-unified-agent/latest-version) bash -c 'curl -s -O https://storage.yandexcloud.net/yc-unified-agent/releases/$ua_version/unified_agent &amp;&amp; chmod +x ./unified_agent'<br />Также вы можете выбрать опцию Установить в поле Агент сбора метрик при создании ВМ, тогда Yandex Unified Agent будет установлен автоматически.<br />Создайте файл config.yml с типовой спецификацией для доставки метрик Linux.<br />В параметре folder_id укажите идентификатор вашего каталога.<br />status:<br />port: "16241"<br />storages:<br />- name: main<br />&nbsp; plugin: fs<br />&nbsp; config:<br />&nbsp;&nbsp;&nbsp; directory: /var/lib/yandex/unified_agent/main<br />&nbsp;&nbsp;&nbsp; max_partition_size: 100mb<br />&nbsp;&nbsp;&nbsp; max_segment_size: 10mb<br />channels:<br />- name: cloud_monitoring<br />&nbsp; channel:<br />&nbsp;&nbsp;&nbsp; pipe:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - storage_ref:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: main<br />&nbsp;&nbsp;&nbsp; output:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; plugin: yc_metrics<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; folder_id: "&lt;идентификатор_каталога&gt;"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; iam:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cloud_meta: {}<br />routes:<br />- input:<br />&nbsp;&nbsp;&nbsp; plugin: linux_metrics<br />&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; namespace: sys<br />&nbsp; channel:<br />&nbsp;&nbsp;&nbsp; channel_ref:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: cloud_monitoring<br />- input:<br />&nbsp;&nbsp;&nbsp; plugin: agent_metrics<br />&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; namespace: ua<br />&nbsp; channel:<br />&nbsp;&nbsp;&nbsp; pipe:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - filter:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; plugin: filter_metrics<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; match: "{scope=health}"<br />&nbsp;&nbsp;&nbsp; channel_ref:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: cloud_monitoring<br />import:<br />- /etc/yandex/unified_agent/conf.d/*.yml <br />В секции status достаточно указать порт для просмотра статуса Yandex Unified Agent.<br />Секция storage содержит список хранилищ, в которых будут находиться выгруженные данные. Для практической работы достаточно одного файлового хранилища (fs).<br />Секция channels содержит список именованных каналов, к этим каналам можно обращаться по имени из других секций спецификации. Здесь обозначен один канал с именем cloud_monitoring. К нему идёт обращение из секции routes, которая содержит список маршрутов доставки метрик.<br />Подробнее о конфигурировании Yandex Unified Agent вы можете почитать в документации.<br />Скопируйте файл спецификации в виртуальную машину for-ua:<br />&nbsp;scp config.yml ua-user@84.252.135.237:config.yml<br />Теперь запустите Unified Agent с созданной спецификацией:<br />&nbsp;sudo ./unified_agent --config config.yml<br />Если запуск прошел успешно, в конце вы увидите сообщение такого вида:<br />&nbsp;... NOTICE agent started<br />Настройка виджета для мониторинга метрик Linux. Создайте на вашем дашборде новый виджет с графиком, назовите его &laquo;Метрики Linux&raquo;.<br />В виджете создайте запрос с параметром service = Custom Metrics. В параметре name выберите любой параметр, начинающийся с sys &mdash; всё это системные метрики, поставляемые Unified Agent. Например, name = sys.memory.MemAvailable.<br />Теперь в виджете отображается график наличия свободной оперативной памяти в виртуальной машине for-ua.<br /><strong>Decision:</strong><br />$ yc iam key create --service-account-name monitortest --output key.json<br />$ yc config profile create monitortest-profile<br />$ yc config set service-account-key key.json<br />$ yc iam create-token<br />$ cat key.json<br />...<br />t1.9euelZqMx8vGx5rNj4qezM7MyJ2Vj-3rnpWal47Gj8vOzZuZzc2ejZycks7l8_cfU1Fl-e8cMVEZ_d3z918BT2X57xwxURn9zef1656Vmp6RyMqKl8fIxo2Rm5XHzcbM7_0.XW7UF1ymvhuU-4VWP34TmF1Yw4YEDuWUggt0pWoxIqaC8dkP8UKcbjfHwk3JLcYRsrkgvCosBvnHl1IRfUvECA<br />$ export IAM_TOKEN=t1.9euelZqMx8vGx5rNj4qezM7MyJ2Vj-3rnpWal47Gj8vOzZuZzc2ejZycks7l8_cfU1Fl-e8cMVEZ_d3z918BT2X57xwxURn9zef1656Vmp6RyMqKl8fIxo2Rm5XHzcbM7_0.XW7UF1ymvhuU-4VWP34TmF1Yw4YEDuWUggt0pWoxIqaC8dkP8UKcbjfHwk3JLcYRsrkgvCosBvnHl1IRfUvECA<br />$ vim my-metrics.json<br />$ cat my-metrics.json<br />{<br />&nbsp; "metrics": [<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "name": "number_of_users",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "labels": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "site": "aibolit"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "type": "IGAUGE",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "timeseries": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T10:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "22"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T11:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "44"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T12:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "11"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T13:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "55"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ts": "2021-05-10T14:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "value": "33"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; ]<br />}<br />$ curl -X POST \<br />&nbsp;&nbsp;&nbsp;&nbsp; -H "Content-Type: application/json" \<br />&nbsp;&nbsp;&nbsp;&nbsp; -H "Authorization: Bearer ${t1.9euelZqMx8vGx5rNj4qezM7MyJ2Vj-3rnpWal47Gj8vOzZuZzc2ejZycks7l8_cfU1Fl-e8cMVEZ_d3z918BT2X57xwxURn9zef1656Vmp6RyMqKl8fIxo2Rm5XHzcbM7_0.XW7UF1ymvhuU-4VWP34TmF1Yw4YEDuWUggt0pWoxIqaC8dkP8UKcbjfHwk3JLcYRsrkgvCosBvnHl1IRfUvECA}" \<br />&nbsp;&nbsp;&nbsp;&nbsp; -d '@/home/YOUR-DIR/my-metrics.json' \<br />&nbsp;'https://monitoring.api.cloud.yandex.net/monitoring/v2/data/write?folderId=ajehq9p412df22arccm1&amp;service=custom'<br />$ ssh ua-user@&lt;публичный_адрес_ВМ&gt;<br />$ ua_version=$(curl -s https://storage.yandexcloud.net/yc-unified-agent/latest-version) bash -c 'curl -s -O https://storage.yandexcloud.net/yc-unified-agent/releases/$ua_version/unified_agent &amp;&amp; chmod +x ./unified_agent'<br />$ exit<br />$ vim config.yml<br />$ cat config.yml<br />status:<br />&nbsp;port: "16241"<br />storages:<br />&nbsp;- name: main<br />&nbsp;&nbsp;&nbsp;&nbsp; plugin: fs<br />&nbsp;&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; directory: /var/lib/yandex/unified_agent/main<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_partition_size: 100mb<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_segment_size: 10mb<br />channels:<br />&nbsp;- name: cloud_monitoring<br />&nbsp;&nbsp;&nbsp;&nbsp; channel:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pipe:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - storage_ref:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: main<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; output:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; plugin: yc_metrics<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; folder_id: "&lt;идентификатор_каталога&gt;"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; iam:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cloud_meta: {}<br />routes:<br />&nbsp;- input:<br />&nbsp;&nbsp;&nbsp;&nbsp; plugin: linux_metrics<br />&nbsp;&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; namespace: sys<br />&nbsp; channel:<br />&nbsp;&nbsp;&nbsp; channel_ref:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: cloud_monitoring<br />&nbsp;- input:<br />&nbsp;&nbsp;&nbsp;&nbsp; plugin: agent_metrics<br />&nbsp;&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; namespace: ua<br />&nbsp;&nbsp; channel:<br />&nbsp;&nbsp;&nbsp;&nbsp; pipe:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - filter:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; plugin: filter_metrics<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; match: "{scope=health}"<br />&nbsp;&nbsp;&nbsp;&nbsp; channel_ref:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: cloud_monitoring<br />import:<br />&nbsp;- /etc/yandex/unified_agent/conf.d/*.yml<br />$ scp config.yml ua-user@84.252.135.237:config.yml <br />$ sudo ./unified_agent --config config.yml<br /><strong>Task:</strong><br />Выгрузка метрик в формате Prometheus<br />Как мы уже говорили раньше, метрики можно выгружать из Yandex Cloud Monitoring в сторонние приложения и сервисы. <br />Пожалуй, чаще всего их выгружают для сервера Prometheus.<br />На сегодняшний день Prometheus &mdash; один из самых популярных инструментов для мониторинга приложений и сервисов. В основе его лежит специализированная СУБД для анализа временных рядов, которая обеспечивает высокое быстродействие. В отличие от большинства систем мониторинга, Prometheus не ждёт, пока сторонние приложения передадут ему свои метрики, а сам опрашивает подключенные к нему приложения и собирает нужные данные.<br />Prometheus и Yandex Cloud Monitoring решают схожие задачи &mdash; хранят значения разных метрик. Prometheus фактически является стандартом для обмена метриками. Поэтому даже используя сервисы Yandex Cloud, IT-администраторы часто хотят отслеживать их работу с помощью Prometheus. Чтобы не лишать специалистов привычных инструментов, Yandex Cloud Monitoring поддерживает выгрузку данных в формате Prometheus. Для этого используется метод prometheusMetrics.<br />Для визуализации данных, собираемых Prometheus, можно использовать сервис Grafana (в нем можно зарегистрироваться бесплатно на тестовый период). <br />Вы можете установить Grafana на свой компьютер, а можете работать в облачной версии.<br />Посмотрим, как происходит выгрузка метрик в Prometheus и работа с ними в Grafana. Вы снова будете мониторить сайт клиники &laquo;Доктор Айболит&raquo;.<br /><strong>Decision:</strong><br />Создайте API-ключ через консоль управления Yandex Cloud или CLI.<br />Если вы создаете ключ в консоли управления, то перейдите в каталог, из которого будете выгружать метрики (например default). Затем перейдите на вкладку Сервисные аккаунты и выберите существующий аккаунт. Нажмите кнопку Создать новый ключ и выберите Создать API-ключ. В описании ключа можно указать, например, &laquo;для доступа к Prometheus&raquo;. Сохраните секретную часть ключа в отдельный файл, например, prometheus-key.txt.<br />Назначьте сервисному аккаунту роль monitoring.viewer на выбранный каталог.<br />Создайте файл спецификации prometheus.yml (см. пример ниже, замените в нем значение параметра folderId на идентификатор каталога, а значение для bearer_token &mdash; на ключ доступа из файла prometheus-key.txt):<br />global:<br />&nbsp; scrape_interval:&nbsp;&nbsp;&nbsp;&nbsp; 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.<br />&nbsp; evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.<br />&nbsp; # scrape_timeout is set to the global default (10s).<br />rule_files:<br />scrape_configs:<br />&nbsp; - job_name: 'prometheus'<br />&nbsp;&nbsp;&nbsp; static_configs:<br />&nbsp;&nbsp;&nbsp; - targets: ['localhost:9090'] <br />&nbsp; - job_name: 'yc-monitoring-export'<br />&nbsp;&nbsp;&nbsp; metrics_path: '/monitoring/v2/prometheusMetrics'<br />&nbsp;&nbsp;&nbsp; params:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; folderId:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - '&lt;идентификатор_каталога&gt;' <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 'storage' <br />&nbsp;&nbsp;&nbsp; bearer_token: '&lt;секретная_часть_API-ключа&gt;'<br />&nbsp;&nbsp;&nbsp; static_configs:<br />&nbsp;&nbsp;&nbsp; - targets: ['monitoring.api.cloud.yandex.net']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; folderId: '&lt;идентификатор_каталога&gt;'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service: 'storage' <br />Запуск сервера Prometheus. Если вы уже работаете с Prometheus, пропустите все шаги по установке &mdash; просто добавьте секцию scrape_configs из примера выше в спецификацию вашего сервера Prometheus и перезапустите сервер, а затем переходите к настройке Grafana.<br />Для запуска сервера Prometheus используйте официальный Docker-образ prom/prometheus.<br />Сначала загрузите образ. Для этого запустите Docker Desktop (в терминале выполните команду):<br />&nbsp;docker pull prom/prometheus<br />Чтобы на сервере сразу был ваш файл спецификации, создайте свой образ на основе prom/prometheus. Подготовьте Dockerfile с двумя командами:<br />&nbsp;FROM prom/prometheus<br />&nbsp;ADD prometheus.yml /etc/prometheus/<br />Сохраните этот файл в тот же каталог, где находится prometheus.yml. Назовите его именем по умолчанию: Dockerfile.<br />В терминале перейдите в каталог с Dockerfile. Создайте образ с вашей конфигурацией (используйте ваш идентификатор в Yandex Container Registry):<br />&nbsp;docker build . -t cr.yandex/&lt;идентификатор_реестра&gt;/my-prometheus:latest -f Dockerfile<br />Аутентифицируйтесь в Yandex Container Registry с помощью Docker Credential helper (чтобы Docker мог от вашего имени отправить образ в ваш реестр):<br />&nbsp;yc container registry configure-docker<br />Теперь отправьте образ в ваше хранилище в облаке:<br />&nbsp;docker push cr.yandex/&lt;идентификатор_реестра&gt;/my-prometheus:latest<br />Создайте виртуальную машину с помощью Container Optimized Image, вы уже делали это раньше в практической работе (в разделе Выбор образа загрузочного диска переключитесь на вкладку Container Solution и нажмите Настроить. Выберите из реестра созданный вами образ, остальные настройки оставьте по умолчанию и нажмите Применить).<br />При создании виртуальной машины используйте ваш сервисный аккаунт. Задайте логин (например prom) и ssh-ключ.<br />Назовите машину, например, for-prometheus.<br />Проверьте статус сервера по адресу http://&lt;публичный IP-адрес ВМ с Prometheus&gt;:9090/targets. Через несколько минут после запуска статус процессов prometheus и yc-monitoring-export должен стать UP.<br />Подайте нагрузку на ваш сайт:<br />while true; do wget -q -O- &lt;адрес_сайта&gt;; done <br />Подождите несколько минут и проверьте, как поставляются метрики в Prometheus.<br />В верхнем меню выберите пункт Graph. Нажмите на значок &laquo;Земли&raquo;. Откроется меню с доступными метриками. Выберите метрику, которую вы хотите проверить, например, traffic и нажмите кнопку Execute.<br />Переключитесь на вкладку Graph. Выберите текущее время, для наглядности уменьшите интервал запроса данных (например до 15 минут). Вскоре вы увидите график изменения выбранной метрики.<br />Настройка Grafana. Теперь посмотрим, как метрики визуализируются в системе Grafana.<br />Если у вас еще нет аккаунта в Grafana, создайте его с помощью нескольких простых шагов, это бесплатно. Вам откроется интерфейс по адресу https://&lt;ваш_логин&gt;.grafana.net/.<br />Добавление источника данных. Настройте Prometheus в качестве источника данных. На главной странице нажмите кнопку Connect data. Из предложенного списка выберите источник Prometheus data source и нажмите кнопку Create Prometheus data source.<br />В следующем окне в поле URL введите endpoint сервера Prometheus http://&lt;публичный IP-адрес ВМ с Prometheus&gt;:9090. Больше никакие настройки менять не нужно.<br />Внизу нажмите кнопку Save &amp; Test. Должна отобразиться надпись Data source is working.<br />Добавление дашборда. Вернитесь на главную страницу (нажав на логотип в левом верхнем углу) и нажмите Create your first dashboard. Откроется окно настройки дашборда.<br />В нижней части экрана на вкладке Query выберите источник данных &mdash; Prometheus.<br />Выберите метрику, которую вы хотите отслеживать. Нажмите на поле Metrics, в открывшемся списке выберите метрику traffic.<br />Сверху отобразится график выбранной метрики.<br />Вверху справа в поле Panel Title укажите название графика (например, &laquo;Трафик сайта&raquo;).<br />Теперь сохраните настройки &mdash; в правом верхнем углу нажмите кнопку Save и укажите название дашборда (например, &laquo;Мой дашборд&raquo;).<br /><strong>Decision:</strong><br />$ vim prometheus-key.txt<br />$ cat prometheus-key.txt<br />YOUR-KEY<br />$ vim prometheus.yml<br />$ cat prometheus.yml<br />global:<br />&nbsp; scrape_interval:&nbsp;&nbsp;&nbsp;&nbsp; 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.<br />&nbsp; evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.<br />&nbsp; # scrape_timeout is set to the global default (10s).<br />rule_files:<br />scrape_configs:<br />&nbsp; - job_name: 'prometheus'<br />&nbsp;&nbsp;&nbsp; static_configs:<br />&nbsp;&nbsp;&nbsp; - targets: ['localhost:9090']<br />&nbsp; - job_name: 'yc-monitoring-export'<br />&nbsp;&nbsp;&nbsp; metrics_path: '/monitoring/v2/prometheusMetrics'<br />&nbsp;&nbsp;&nbsp; params:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; folderId:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 'YOUR-ID' <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 'storage' <br />&nbsp;&nbsp;&nbsp; bearer_token: 'YOUR-KEY'<br />&nbsp;&nbsp;&nbsp; static_configs:<br />&nbsp;&nbsp;&nbsp; - targets: ['monitoring.api.cloud.yandex.net']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; labels:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; folderId: 'YOUR-ID'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service: 'storage'<br />$ docker pull prom/prometheus<br />$ vim Dockerfile<br />$ cat Dockerfile<br />FROM prom/prometheus<br />ADD prometheus.yml /etc/prometheus/<br />$ docker build . -t cr.yandex/YOUR-ID1/my-prometheus:latest -f Dockerfile<br />$ yc container registry configure-docker<br />$ docker push cr.yandex/YOUR-ID1/my-prometheus:latest<br />$ while true; do wget -q -O- YOUR-IP; done &nbsp;<br /><strong>Task:</strong><br />В этой практической работе вы создадите алерт для случая, если трафик на сайте вдруг начнет существенно расти. <br />Снова используйте сайт клиники &laquo;Доктор Айболит&raquo;, для которого настраивали графики на дашборде.<br />Вы можете перейти на вкладку Алерты и там настроить алерт с нуля. А можете отталкиваться от графиков, которые уже выведены в виджете. <br />Ниже рассматривается именно второй вариант.<br /><strong>Decision:</strong><br />Создание алерта. Вернитесь на созданный вами дашборд и в меню виджета &laquo;Трафик сайта&raquo; выберите пункт Создать алерт.<br />Поскольку в виджете используются два запроса, вам будет предложено выбрать, для какого запроса вы хотите создать алерт. Выберите запрос с суммирующей функцией и нажмите Продолжить.<br />Теперь задайте имя и, если хотите, описание алерта. Укажите значение для статусов Alarm и Warning.<br />Откройте спойлер Показать дополнительные настройки. Там вы увидите, что система предложила вам использовать среднее значение за 5 минут. Оставьте эти параметры.<br />Теперь нужно выбрать канал для получения алертов. У вас пока ещё нет настроенных каналов, поэтому система предложить вам создать его. Нажмите кнопку Добавить канал и далее Создать канал.<br />Укажите имя канала, выберите метод &mdash; Email, SMS или Push-уведомления. Укажите получателей &mdash; себя. Затем нажмите кнопку Создать.<br />В настройках алерта выберите только что созданный канал.<br />Вы можете указать для одного алерта несколько каналов уведомлений. Например, если вы хотите получать алерты об увеличении трафика сайта не только в виде Push-уведомлений, но и по электронной почте, создайте еще один канал с методом Email и выберите также и его.<br />Для каждого канала можно настроить режим повторения уведомлений. Например, в данном случае при превышении трафика будет отправлен один алерт по электронной почте, а алерты в виде push-уведомлений будут отправляться каждые 5 минут до тех пор, пока проблема не будет устранена.<br />Нажмите кнопку Создать алерт.<br />Вы увидите настройки созданного алерта, а сверху &mdash; его текущий статус OK.<br />Нажмите слева на вкладку Алерты. Вы увидите ваш алерт, сейчас он единственный в списке. Когда алертов станет больше, вам понадобятся инструменты для работы с ними. Например, вы сможете отобрать из списка только алерты, имеющие статус Alarm или Warning, или временно деактивировать отдельные алерты.<br />Срабатывание алерта. Теперь посмотрим, как срабатывает алерт. Подайте трафик на сайт, который вы мониторите:<br />while true; do wget -q -O- &lt;адрес_сайта&gt;; done <br />Подождите немного и понаблюдайте за ростом нагрузки. Через какое-то время трафик начнет превышать пороговое значение Warning, и вы начнете получать Push-уведомления.<br />Если у администратора настроены другие каналы для алертов, он получил бы SMS или Email с предупреждением о пороговом значении трафика.<br />Как видите, алерты позволяют вовремя привлекать внимание администратора и устранять даже потенциальные, ещё не случившиеся проблемы.<br /><strong>Decision:</strong><br />$ while true; do wget -q -O- YOUR-IP; done</p>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Serverless</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты практической работы по теме "Serverless" разработал навык Алисы, которая повторяет всё, что вы ему напишете с сохранением фраз в новом файле в бакете, разработал функцию для проверки доступности сайта ya.ru, которая будет измерять время ответа, передавать в БД PostgreSQL результаты работы функции и запускать триггер-таймер для регулярного опроса сайта ya.ru, с помощью REST API получил до 50 результатов проверки из БД, реализовал проекты, которые позволят пользователям конвертировать видеофайлы в GIF конвертировать длинные ссылки в короткие<br /><strong>Task:</strong><br />Создаём вашу первую функцию<br />Мы уже достаточно сказали о том, что создавать облачные функции &mdash; просто. Давайте сделаем это на практике.<br /><strong>Decision:</strong><br />На главной странице консоли управления в списке сервисов выберите Cloud Functions:<br />На открывшейся странице нажмите кнопку Создать функцию:<br />Укажите имя функции, введите короткое описание того, что она будет делать, и нажмите кнопку Создать:<br />Затем выберите среду выполнения кода и нажмите кнопку Продолжить:<br />По умолчанию сервис предлагает создать Hello World &mdash; файл с примером кода на выбранном языке программирования. Этот файл будет создан и автоматически загружен в контейнер. В поле Способ укажите Редактор кода и выберите файл index.go.<br />По умолчанию сервис предлагает работать с редактором кода прямо в веб-интерфейсе (как на скриншоте выше). Однако вместо этого вы можете загрузить файл с кодом из бакета Object Storage (этот способ подойдёт для файлов больше 3,5 МБ) или загрузить ZIP-архив с кодом с локальной машины. Переключатель способа добавления кода находится прямо над окном редактора.<br />Код вашей функции может находиться как в одном файле, так и в нескольких. Вы также можете создавать папки. При этом обязательно нужно указывать точку входа &mdash; часть кода, которая будет вызываться первой и принимать параметры вызова. Формат точки входа &mdash; &lt;имя файла с функцией&gt;.&lt;имя обработчика вызова&gt;. Например, index.Handler.<br />Вверху справа нажмите кнопку Создать версию, чтобы сохранить текущее состояние функции.<br />Сервис создаст версию функции и покажет справочную страницу о ней.<br />Как протестировать созданную функцию<br />Теперь в панели слева перейдите на вкладку Тестирование. В поле Шаблон данных выберите HTTPS-вызов. Сервис автоматически сгенерирует входные данные в формате JSON.<br />Под полем с входными данными нажмите кнопку Запустить тест. Сервис выполнит HTTPS-вызов созданной функции и сформирует ответ (также в формате JSON).<br /><strong>Task:</strong><br />Запускаем функцию с помощью CLI.<br />В предыдущей практической работе вы познакомились с созданием функции через консоль управления. <br />На этом уроке вы научитесь создавать функцию с помощью интерфейса командной строки (утилиты yc).<br />Пользоваться консолью управления бывает очень удобно, но вести большой проект всё же лучше локально, с помощью среды разработки. <br />Артефакты локальной разработки можно с лёгкостью переносить в облако с помощью консольных утилит. <br /><strong>Decision:</strong><br />Шаг 1. Создание сервисного аккаунта<br />Создание аккаунта<br />Для начала убедитесь, что у вас установлена и инициализирована утилита yc.<br />У вас уже есть сервисные аккаунты, созданные на предыдущих занятиях. Однако гораздо лучше, когда для каждой конкретной задачи (или блока задач) вы заводите отдельный сервисный аккаунт. Это обеспечивает прозрачность в управлении доступом и контроле за ролями в сервисах.<br />Предварительно установите утилиту jq, она потребуется для выполнения задания:<br />sudo apt install jq <br />Создайте сервисный аккаунт с именем service-account-for-cf:<br />export SERVICE_ACCOUNT=$(yc iam service-account create \<br />&nbsp; --name service-account-for-cf \<br />&nbsp; --description "service account for cloud functions" \<br />&nbsp; --format json | jq -r .) <br />Проверьте текущий список сервисных аккаунтов:<br />yc iam service-account list<br />echo $SERVICE_ACCOUNT <br />После проверки запишите идентификатор (ID) созданного сервисного аккаунта в переменную SERVICE_ACCOUNT_ID:<br />echo "export SERVICE_ACCOUNT_ID=&lt;идентификатор_сервисного_аккаунта&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $SERVICE_ACCOUNT_ID <br />Назначение роли сервисному аккаунту<br />Добавьте вновь созданному сервисному аккаунту роль editor:<br />echo "export FOLDER_ID=$(yc config get folder-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc <br />echo $FOLDER_ID<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_ID \<br />&nbsp; --role editor <br />Не удаляйте файл ~/.bashrc после прохождения практической работы, он понадобится нам в дальнейшем.<br />Шаг 2. Создание и настройка функции<br />Создание функции<br />Создайте функцию с именем my-first-function:<br />yc serverless function create --name my-first-function <br />Вы получите URL, по которому можно будет сделать вызов функции http_invoke_url. По умолчанию функция будет непубличной.<br />Загрузка кода функции<br />Создайте файл&nbsp; index.py :<br />sudo nano index.py <br />Добавьте в index.py следующее содержимое:<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': 'Hello World!',<br />&nbsp;&nbsp;&nbsp; } <br />Успешное выполнение этой функции вернёт небольшую веб-страницу.<br />Загрузите код функции в облако и создайте её версию. Для этого перейдите в папку с файлом index.py и выполните команду:<br />yc serverless function version create \<br />&nbsp;&nbsp;&nbsp; --function-name my-first-function \<br />&nbsp;&nbsp;&nbsp; --memory 256m \<br />&nbsp;&nbsp;&nbsp; --execution-timeout 5s \<br />&nbsp;&nbsp;&nbsp; --runtime python37 \<br />&nbsp;&nbsp;&nbsp; --entrypoint index.handler \<br />&nbsp;&nbsp;&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp;&nbsp;&nbsp; --source-path index.py <br />Успешное выполнение команды приведёт к созданию версии функции. С помощью консоли управления убедитесь, что версия создана.<br />Вызов функции<br />Получите список функций, а затем &mdash; информацию о функции my-first-function:<br />yc serverless function list<br />yc serverless function version list --function-name my-first-function <br />В результате вызова последней команды из столбца FUNCTION ID вы узнаете идентификатор функции и сможете сделать вызов функции с помощью следующей команды:<br />yc serverless function invoke &lt;идентификатор_функции&gt; <br />По умолчанию функция создаётся непубличной. Чтобы сделать функцию my-first-function публичной, выполните следующую команду:<br />yc serverless function allow-unauthenticated-invoke my-first-function <br />После этого вы сможете вызвать её в браузере. Получите параметр http_invoke_url для функции my-first-function:<br />yc serverless function get my-first-function <br />Введите значение параметра http_invoke_url в браузере и наслаждайтесь вызовом вашей функции.<br /><strong>Decision:</strong><br />$ sudo apt install jq<br />$ export SERVICE_ACCOUNT=$(yc iam service-account create \<br />&nbsp; --name service-account-for-cf \<br />&nbsp; --description "service account for cloud functions" \<br />&nbsp; --format json | jq -r .) <br />$ yc iam service-account list<br />$ echo $SERVICE_ACCOUNT<br />$ echo "export SERVICE_ACCOUNT_ID=YOUR-ID" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $SERVICE_ACCOUNT_ID<br />$ echo "export FOLDER_ID=$(yc config get folder-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $FOLDER_ID<br />YOUR-ID1<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_ID \<br />&nbsp; --role editor <br />$ yc serverless function create --name my-first-function<br />$ vim index.py<br />$ cat index.py<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': 'Hello World!',<br />&nbsp;&nbsp;&nbsp; }<br />$ yc serverless function version create \<br />&nbsp;&nbsp;&nbsp; --function-name my-first-function \<br />&nbsp;&nbsp;&nbsp; --memory 256m \<br />&nbsp;&nbsp;&nbsp; --execution-timeout 5s \<br />&nbsp;&nbsp;&nbsp; --runtime python37 \<br />&nbsp;&nbsp;&nbsp; --entrypoint index.handler \<br />&nbsp;&nbsp;&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp;&nbsp;&nbsp; --source-path index.py<br />$ yc serverless function list<br />$ yc serverless function version list --function-name my-first-function<br />$ yc serverless function invoke YOUR-ID2<br />$ yc serverless function allow-unauthenticated-invoke my-first-function<br />$ yc serverless function get my-first-function<br /><strong>Task:</strong><br />Создание триггера от Object Storage.<br />В предыдущем практическом уроке вы познакомились с созданием одной функции с помощью интерфейса командной строки (yc). <br />В этом уроке мы продолжим разработку этой функции: модифицируем её содержание, добавим переменные окружения и т.д.<br /><strong>Decision:</strong><br />Шаг 1. Модификация сервисного аккаунта<br />Добавление роли сервисному аккаунту<br />По итогам прохождения предыдущей практической работы у вас есть сервисный аккаунт с именем service-account-for-cf. Для работы с Object Storage добавьте этому сервисному аккаунту роль storage.editor:<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp;&nbsp;&nbsp; --role storage.editor \<br />&nbsp;&nbsp;&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_ID <br />Создание ключа доступа для сервисного аккаунта<br />Этот этап нужен для получения идентификатора ключа доступа и секретного ключа, которые будут использованы для загрузки файлов в Object Storage, а также в том случае, если на следующем шаге для создания бакета в Object Storage вы планируете использовать Terraform.<br />Для создания ключа доступа необходимо вызвать следующую команду:<br />yc iam access-key create --service-account-name service-account-for-cf <br />В результате вы получите примерно следующее:<br />access_key:<br />&nbsp;&nbsp;&nbsp; id: ajefraollq5puj2tir1o<br />&nbsp;&nbsp;&nbsp; service_account_id: ajetdv28pl0a1a8r41f0<br />&nbsp;&nbsp;&nbsp; created_at: "2021-08-23T21:13:05.677319393Z"<br />&nbsp;&nbsp;&nbsp; key_id: BTPNvWthv0ZX2xVmlPIU<br />secret: cWLQ0HrTM0k_qAac43cwMNJA8VV_rfTg_kd4xVPi <br />Где: key_id &mdash; идентификатор ключа доступа, ACCESS_KEY. secret &mdash; секретный ключ, SECRET_KEY.<br />Переменные ACCESS_KEY и SECRET_KEY будут использованы для задания соответствующих значений aws_access_key_id и aws_secret_access_key при использовании библиотеки boto3 на следующих этапах.<br />Шаг 2. Object Storage<br />Самый простой способ создания бакета в Object Storage &mdash; через консоль управления. Более сложный, позволяющий автоматизировать разработку, &mdash; использование Terraform. Вы можете выбрать любой из них.<br />Способ 1. Консоль управления<br />В консоли управления в вашем рабочем каталоге выберите сервис Object Storage. Нажмите кнопку Создать бакет.<br />На странице создания бакета: Введите имя бакета, пусть это будет bucket-for-trigger. При необходимости ограничьте максимальный размер бакета, установив значение, например, 1 ГБ. Выберите тип доступа, в нашем уроке установим значения в Публичный во всех случаях. Выберите класс хранилища, по умолчанию используется Стандартное.<br />Нажмите кнопку Создать бакет для завершения операции. Далее вы всегда сможете поменять класс хранилища, его размер и настройки доступа.<br />Способ 2. Terraform<br />Прежде всего необходимо получить OAuth-токен для работы с Yandex Cloud. Для этого можно сделать запрос к сервису Яндекс.OAuth. Подробнее прочитать можно в документации.<br />Сохраните OAuth-токен в переменную OAuth, но никому не передавайте. Также вам потребуются значения переменных: идентификатор облака &mdash; CLOUD_ID и идентификатор каталога FOLDER_ID (сохранен в переменную ранее).<br />Также на предыдущем шаге вы получили ключ доступа для сервисного аккаунта. Нам потребуется идентификатор ключа доступа ACCESS_KEY и секретный ключ SECRET_KEY.<br />В файл main.tf, представленный далее, внесём все собранные переменные. Важно: переменная BUCKET_NAME содержит имя создаваемого бакета в Object Storage, куда будем загружать файлы. Допустим, переменная будет равна bucket-for-trigger. Сохраним все значения:<br />terraform {<br />&nbsp; required_providers {<br />&nbsp;&nbsp;&nbsp; yandex = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source = "yandex-cloud/yandex"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; required_version = "&gt;= 0.13"<br />}<br />provider "yandex" {<br />&nbsp; token&nbsp;&nbsp;&nbsp;&nbsp; = "&lt;OAuth&gt;"<br />&nbsp; cloud_id&nbsp; = "&lt;CLOUD_ID&gt;"<br />&nbsp; folder_id = "&lt;FOLDER_ID&gt;"<br />}<br />resource "yandex_storage_bucket" "bucket" {<br />&nbsp; access_key = "&lt;ACCESS_KEY&gt;"<br />&nbsp; secret_key = "&lt;SECRET_KEY&gt;"<br />&nbsp; bucket = "&lt;BUCKET_NAME&gt;"<br />} <br />После внесения правок, находясь в каталоге с файлом main.tf, последовательно выполните следующие команды:<br />terraform init<br />terraform plan<br />terraform apply <br />Успешное выполнение команд приведёт к созданию бакета bucket-for-trigger в объектном хранилище в вашем рабочем каталоге.<br />Шаг 3. Модификация функции<br />В предыдущей практической работе мы создали функцию с именем my-first-function с помощью следующей команды:<br />yc serverless function create --name my-first-function <br />При создании функции вы получили URL, по которому можно будет сделать вызов функции http_invoke_url.<br />Загрузка кода новой версии<br />Новая версия функции имеет зависимости, которые описаны в файле requirements.txt, а это значит, что для загрузки функции в облако необходимо файлы index.py и requirements.txt заархивировать и получить файл my-first-function.zip.<br />Новая версия index.py:<br />import os<br />import datetime<br />import boto3<br />import pytz<br />ACCESS_KEY = os.getenv("ACCESS_KEY")<br />SECRET_KEY = os.getenv("SECRET_KEY")<br />BUCKET_NAME = os.getenv("BUCKET_NAME")<br />TIME_ZONE = os.getenv("TIME_ZONE", "Europe/Moscow")<br />TEMP_FILENAME = "/tmp/temp_file"<br />TEXT_FOR_TEMP_FILE = "This is text file"<br />def write_temp_file():<br />&nbsp;&nbsp;&nbsp; temp_file = open(TEMP_FILENAME, 'w')<br />&nbsp;&nbsp;&nbsp; temp_file.write(TEXT_FOR_TEMP_FILE)<br />&nbsp;&nbsp;&nbsp; temp_file.close()<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Temp file is written")<br />def get_now_datetime_str():<br />&nbsp;&nbsp;&nbsp; now = datetime.datetime.now(pytz.timezone(TIME_ZONE))&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; return now.strftime('%Y-%m-%d__%H-%M-%S')<br />def get_s3_instance():<br />&nbsp;&nbsp;&nbsp; session = boto3.session.Session()<br />&nbsp;&nbsp;&nbsp; return session.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_access_key_id=ACCESS_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_secret_access_key=SECRET_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='s3',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://storage.yandexcloud.net'<br />&nbsp;&nbsp;&nbsp; )<br />def upload_dump_to_s3():<br />&nbsp;&nbsp;&nbsp; print("\U0001F4C2 Starting upload to Object Storage")<br />&nbsp;&nbsp;&nbsp; get_s3_instance().upload_file(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filename=TEMP_FILENAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bucket=BUCKET_NAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key=f'file-{get_now_datetime_str()}.txt'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Uploaded")<br />def remove_temp_files():<br />&nbsp;&nbsp;&nbsp; os.remove(TEMP_FILENAME)<br />&nbsp;&nbsp;&nbsp; print("\U0001F44D That's all!")<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; write_temp_file()<br />&nbsp;&nbsp;&nbsp; upload_dump_to_s3()<br />&nbsp;&nbsp;&nbsp; remove_temp_files()<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': 'File is uploaded',<br />&nbsp;&nbsp;&nbsp; } <br />Первая версия requirements.txt:<br />boto3==1.13.10<br />botocore==1.16.10<br />python-dateutil==2.8.1<br />pytz==2020.1 <br />Находясь в каталоге с файлом my-first-function.zip вызовите следующую команду, это позволит вам загрузить код функции в облако и создать её версию:<br />yc serverless function version create \<br />&nbsp; --function-name my-first-function \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-path my-first-function.zip <br />Новая версия функции при вызове будет загружать в Object Storage новый файл. Для создания этой версии необходимо подготовить несколько переменных. Переменные ACCESS_KEY и SECRET_KEY вы получили на первом шаге, а значение BUCKET_NAME на втором:<br />echo "export ACCESS_KEY=&lt;ACCESS_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export SECRET_KEY=&lt;SECRET_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export BUCKET_NAME=bucket-for-trigger" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc <br />Определим идентификатор (ID) для последней загруженной версии функции:<br />yc serverless function version list --function-name my-first-function <br />Создадим новую версию функции, задав при этом переменные окружения. Для этого выставим значение параметра source-version-id равное полученному ID в следующей команде:<br />yc serverless function version create \<br />&nbsp; --function-name my-first-function \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-version-id &lt;ID&gt; \<br />&nbsp; --environment ACCESS_KEY=$ACCESS_KEY \<br />&nbsp; --environment SECRET_KEY=$SECRET_KEY \<br />&nbsp; --environment BUCKET_NAME=$BUCKET_NAME <br />Успешное выполнение команды приведёт к созданию версии функции.<br />Вызов функции<br />Получите список функций и информацию о функции my-first-function:<br />yc serverless function list<br />yc serverless function version list --function-name my-first-function <br />В результате вызова последней команды в столбце FUNCTION ID вы узнаете идентификатор функции и сможете сделать вызов функции с помощью следующей команды:<br />yc serverless function invoke &lt;идентификатор_функции&gt; <br />В предыдущей практической работе мы сделали функцию my-first-function публичной с помощью команды:<br />yc serverless function allow-unauthenticated-invoke my-first-function <br />Теперь мы можем сделать её вызов в браузере. Получите параметр http_invoke_url для функции my-first-function<br />yc serverless function get my-first-function <br />Введите значение параметра http_invoke_url в браузере и наслаждайтесь вызовом вашей функции. Во время её вызова в Object Storage будет создан новый файл.<br />Шаг 4. Создание триггера<br />Создание функции<br />Для создания триггера нам необходима функция, которую триггер будет запускать. Аналогично предыдущему шагу создадим функцию my-trigger-function и её версию на основе файла index.py.<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; print("\U0001F4C2 Starting function after trigger")<br />&nbsp;&nbsp;&nbsp; print(event)&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': 'File is uploaded',<br />&nbsp;&nbsp;&nbsp; } <br />Находясь в каталоге с файлом index.py, вызовите следующие команды:<br />yc serverless function create --name my-trigger-function<br />yc serverless function version create \<br />&nbsp; --function-name my-trigger-function \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-path index.py<br />yc serverless function version list --function-name my-trigger-function <br />Создание триггера<br />Чтобы создать триггер my-first-trigger, который вызывает функцию my-trigger-function при создании нового объекта в бакете BUCKET_NAME, выполните команду:<br />yc serverless trigger create object-storage \<br />&nbsp; --name my-first-trigger \<br />&nbsp; --bucket-id $BUCKET_NAME \<br />&nbsp; --events 'create-object' \<br />&nbsp; --invoke-function-name my-trigger-function \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_ID <br />Вызов цепочки событий<br />Чтобы запустить цепочку событий, вызовем первую функцию my-first-function. Получите список функций и информацию о функции my-first-function:<br />yc serverless function list<br />yc serverless function version list --function-name my-first-function <br />В результате вызова последней команды в столбце FUNCTION ID вы узнаете идентификатор функции и сможете сделать вызов функции с помощью команды:<br />yc serverless function invoke &lt;идентификатор_функции&gt; <br />После этого вы можете сделать её вызов в браузере. Получите параметр http_invoke_url для функции my-first-function<br />yc serverless function get my-first-function <br />Введите значение параметра http_invoke_url в браузере. Во время вызова функции в Object Storage будет создан новый объект. Сразу после этого сработает триггер my-first-trigger, который вызовет функцию my-trigger-function. В итоге, наша вторая функция запишет в логи содержание переменной event. Убедиться в этом вы сможете как в UI, так и через CLI.<br />yc serverless function logs my-trigger-function <br /><strong>Decision:</strong><br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp;&nbsp;&nbsp; --role storage.editor \<br />&nbsp;&nbsp;&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_ID<br />$ yc iam access-key create --service-account-name service-account-for-cf<br />$ vim main.tf<br />$ cat main.tf<br />terraform {<br />&nbsp; required_providers {<br />&nbsp;&nbsp;&nbsp; yandex = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; source = "yandex-cloud/yandex"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />&nbsp; required_version = "&gt;= 0.13"<br />}<br />provider "yandex" {<br />&nbsp; token&nbsp;&nbsp;&nbsp;&nbsp; = "YOUR-KEY"<br />&nbsp; cloud_id&nbsp; = "YOUR-ID"<br />&nbsp; folder_id = "YOUR-ID1"<br />}<br />resource "yandex_storage_bucket" "bucket" {<br />&nbsp; access_key = "YOUR-KEY1"<br />&nbsp; secret_key = "YOUR-KEY2"<br />&nbsp; bucket = "YOUR-NAME"<br />}<br />$ yc serverless function create --name my-first-function<br />$ vim index.py<br />$ cat index.py<br />import os<br />import datetime<br />import boto3<br />import pytz<br />ACCESS_KEY = os.getenv("ACCESS_KEY")<br />SECRET_KEY = os.getenv("SECRET_KEY")<br />BUCKET_NAME = os.getenv("BUCKET_NAME")<br />TIME_ZONE = os.getenv("TIME_ZONE", "Europe/Moscow")<br />TEMP_FILENAME = "/tmp/temp_file"<br />TEXT_FOR_TEMP_FILE = "This is text file"<br />def write_temp_file():<br />&nbsp;&nbsp;&nbsp; temp_file = open(TEMP_FILENAME, 'w')<br />&nbsp;&nbsp;&nbsp; temp_file.write(TEXT_FOR_TEMP_FILE)<br />&nbsp;&nbsp;&nbsp; temp_file.close()<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Temp file is written")<br />def get_now_datetime_str():<br />&nbsp;&nbsp;&nbsp; now = datetime.datetime.now(pytz.timezone(TIME_ZONE))<br />&nbsp;&nbsp;&nbsp; return now.strftime('%Y-%m-%d__%H-%M-%S')<br />def get_s3_instance():<br />&nbsp;&nbsp;&nbsp; session = boto3.session.Session()<br />&nbsp;&nbsp;&nbsp; return session.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_access_key_id=ACCESS_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_secret_access_key=SECRET_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='s3',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://storage.yandexcloud.net'<br />&nbsp;&nbsp;&nbsp; )<br />def upload_dump_to_s3():<br />&nbsp;&nbsp;&nbsp; print("\U0001F4C2 Starting upload to Object Storage")<br />&nbsp;&nbsp;&nbsp; get_s3_instance().upload_file(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filename=TEMP_FILENAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bucket=BUCKET_NAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key=f'file-{get_now_datetime_str()}.txt'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Uploaded")<br />def remove_temp_files():<br />&nbsp;&nbsp;&nbsp; os.remove(TEMP_FILENAME)<br />&nbsp;&nbsp;&nbsp; print("\U0001F44D That's all!")<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; write_temp_file()<br />&nbsp;&nbsp;&nbsp; upload_dump_to_s3()<br />&nbsp;&nbsp;&nbsp; remove_temp_files()<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': 'File is uploaded',<br />&nbsp;&nbsp;&nbsp; }<br />$ vim requirements.txt<br />$ cat requirements.txt<br />boto3==1.13.10<br />botocore==1.16.10<br />python-dateutil==2.8.1<br />pytz==2020.1boto3==1.13.10<br />botocore==1.16.10<br />python-dateutil==2.8.1<br />pytz==2020.1<br />$ zip my-first-function.zip requirements.txt index.py<br />$ yc serverless function version create \<br />&nbsp; --function-name my-first-function \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-path my-first-function.zip<br />$ echo "export ACCESS_KEY=YOUR-KEY1" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export SECRET_KEY=YOUR-KEY2" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export BUCKET_NAME=bucket-for-trigger" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ yc serverless function version list --function-name my-first-function<br />$ yc serverless function version create \<br />&nbsp; --function-name my-first-function \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-version-id YOUR-ID2 \<br />&nbsp; --environment ACCESS_KEY=$ACCESS_KEY \<br />&nbsp; --environment SECRET_KEY=$SECRET_KEY \<br />&nbsp; --environment BUCKET_NAME=$BUCKET_NAME<br />$ yc serverless function list<br />$ yc serverless function version list --function-name my-first-function<br />$ yc serverless function invoke YOUR-ID3<br />$ yc serverless function allow-unauthenticated-invoke my-first-function<br />$ yc serverless function get my-first-function<br />$ vim index1.py<br />$ cat index1.py<br />import os<br />import datetime<br />import boto3<br />import pytz<br />ACCESS_KEY = os.getenv("ACCESS_KEY")<br />SECRET_KEY = os.getenv("SECRET_KEY")<br />BUCKET_NAME = os.getenv("BUCKET_NAME")<br />TIME_ZONE = os.getenv("TIME_ZONE", "Europe/Moscow")<br />TEMP_FILENAME = "/tmp/temp_file"<br />TEXT_FOR_TEMP_FILE = "This is text file"<br />def write_temp_file():<br />&nbsp;&nbsp;&nbsp; temp_file = open(TEMP_FILENAME, 'w')<br />&nbsp;&nbsp;&nbsp; temp_file.write(TEXT_FOR_TEMP_FILE)<br />&nbsp;&nbsp;&nbsp; temp_file.close()<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Temp file is written")<br />def get_now_datetime_str():<br />&nbsp;&nbsp;&nbsp; now = datetime.datetime.now(pytz.timezone(TIME_ZONE))&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; return now.strftime('%Y-%m-%d__%H-%M-%S')<br />def get_s3_instance():<br />&nbsp;&nbsp;&nbsp; session = boto3.session.Session()<br />&nbsp;&nbsp;&nbsp; return session.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_access_key_id=ACCESS_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_secret_access_key=SECRET_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='s3',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://storage.yandexcloud.net'<br />&nbsp;&nbsp;&nbsp; )<br />def upload_dump_to_s3():<br />&nbsp;&nbsp;&nbsp; print("\U0001F4C2 Starting upload to Object Storage")<br />&nbsp;&nbsp;&nbsp; get_s3_instance().upload_file(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filename=TEMP_FILENAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bucket=BUCKET_NAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key=f'file-{get_now_datetime_str()}.txt'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Uploaded")<br />def remove_temp_files():<br />&nbsp;&nbsp;&nbsp; os.remove(TEMP_FILENAME)<br />&nbsp;&nbsp;&nbsp; print("\U0001F44D That's all!")<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; print("\U0001F4C2 Starting function after trigger")<br />&nbsp;&nbsp;&nbsp; print(event)&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': 'File is uploaded',<br />&nbsp;&nbsp;&nbsp; }<br />$ yc serverless function create --name my-trigger-function<br />$ yc serverless function version create \<br />&nbsp; --function-name my-trigger-function \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-path index.py<br />$ yc serverless function version list --function-name my-trigger-function<br />$ yc serverless trigger create object-storage \<br />&nbsp; --name my-first-trigger \<br />&nbsp; --bucket-id $BUCKET_NAME \<br />&nbsp; --events 'create-object' \<br />&nbsp; --invoke-function-name my-trigger-function \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_ID<br />$ yc serverless function list<br />$ yc serverless function version list --function-name my-first-function<br />$ yc serverless function invoke YOUR-ID3<br />$ yc serverless function get my-first-function<br />$ yc serverless function logs my-trigger-function<br /><strong>Task:</strong><br />Навык Алисы. <br />В предыдущих практических работах вы создали сервисный аккаунт с именем service-account-for-cf, добавили ему роли editor и storage.editor и создали ключ доступа.<br />Также вы создали бакет в Object Storage с именем bucket-for-trigger, триггер my-first-trigger для его обработки и вызываемую им функцию my-trigger-function.<br />Ещё была создана функция my-first-function, её использовали для того, чтобы запустить цепочку событий. <br />Публичный вызов этой функции приводил к созданию нового объекта в бакете в Object Storage. <br />Это запускало вызов триггера my-first-trigger, который стартовал функцию my-trigger-function. <br />В итоге последняя функция записывала в логи содержание переменной event.<br /><strong>Decision:</strong><br />Шаг 1. Создание функции<br />На предыдущем уроке мы создали функцию с именем my-first-function. Поменяем её исходный код так, чтобы обрабатывать запросы от Алисы.<br />На основе функции будет создан навык Попугай, который повторяет все, что ему написал или сказал пользователь.<br />Функция parrot. Создадим новую функцию с именем parrot с помощью команды:<br />yc serverless function create \<br />&nbsp; --name parrot \<br />&nbsp; --description "function for Alice" <br />По умолчанию функция не является публичной.<br />Загрузка кода новой версии<br />Функция имеет зависимости, которые описаны в файле requirements.txt, а это значит, что для загрузки функции в облако необходимо заархивировать файлы parrot.py и requirements.txt и получить файл parrot.zip.<br />Содержание функции parrot.py:<br />import os<br />import datetime<br />import boto3<br />import pytz<br />ACCESS_KEY = os.getenv("ACCESS_KEY")<br />SECRET_KEY = os.getenv("SECRET_KEY")<br />BUCKET_NAME = os.getenv("BUCKET_NAME")<br />TIME_ZONE = os.getenv("TIME_ZONE", "Europe/Moscow")<br />TEMP_FILENAME = "/tmp/temp_file"<br />TEXT_FOR_TEMP_FILE = "This is text file"<br />def write_temp_file(text_for_s3):<br />&nbsp;&nbsp;&nbsp; TEXT_FOR_TEMP_FILE = text_for_s3<br />&nbsp;&nbsp;&nbsp; temp_file = open(TEMP_FILENAME, 'w')&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; temp_file.write(TEXT_FOR_TEMP_FILE)<br />&nbsp;&nbsp;&nbsp; temp_file.close()<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Temp file is written")<br />def get_now_datetime_str():<br />&nbsp;&nbsp;&nbsp; now = datetime.datetime.now(pytz.timezone(TIME_ZONE))<br />&nbsp;&nbsp;&nbsp; return now.strftime('%Y-%m-%d__%H-%M-%S')<br />def get_s3_instance():<br />&nbsp;&nbsp;&nbsp; session = boto3.session.Session()<br />&nbsp;&nbsp;&nbsp; return session.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_access_key_id=ACCESS_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_secret_access_key=SECRET_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='s3',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://storage.yandexcloud.net'<br />&nbsp;&nbsp;&nbsp; )<br />def upload_dump_to_s3():<br />&nbsp;&nbsp;&nbsp; print("\U0001F4C2 Starting upload to Object Storage")<br />&nbsp;&nbsp;&nbsp; get_s3_instance().upload_file(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filename=TEMP_FILENAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bucket=BUCKET_NAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key=f'file-{get_now_datetime_str()}.txt'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Uploaded")<br />def remove_temp_files():<br />&nbsp;&nbsp;&nbsp; os.remove(TEMP_FILENAME)<br />&nbsp;&nbsp;&nbsp; print("\U0001F44D That's all!")<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; Entry-point for Serverless Function.<br />&nbsp;&nbsp;&nbsp; :param event: request payload.<br />&nbsp;&nbsp;&nbsp; :param context: information about current execution context.<br />&nbsp;&nbsp;&nbsp; :return: response to be serialized as JSON.<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; text = 'Hello! I\'ll repeat anything you say to me.'<br />&nbsp;&nbsp;&nbsp; if 'request' in event and \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'original_utterance' in event['request'] \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and len(event['request']['original_utterance']) &gt; 0:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; text = event['request']['original_utterance']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; write_temp_file(text)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; upload_dump_to_s3()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; remove_temp_files()<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'version': event['version'],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'session': event['session'],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'response': {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Respond with the original request or welcome the user if this is the beginning of the dialog and the request has not yet been made.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text': text,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Don't finish the session after this response.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'end_session': 'false'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; }<br />Содержание файла зависимостей requirements.txt:<br />boto3==1.13.10<br />botocore==1.16.10<br />python-dateutil==2.8.1<br />pytz==2020.1 <br />Находясь в каталоге с файлом parrot.zip, вызовите приведенную ниже команду. Это позволит вам загрузить код функции в облако и создать её версию:<br />yc serverless function version create \<br />&nbsp; --function-name=parrot \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=parrot.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-path parrot.zip <br />Шаг 2. Создание новой версии функции<br />Новая версия функции при вызове будет загружать в Object Storage новый файл. Для создания этой новой версии функции необходимы переменные.<br />Если переменные среды не сохранились, то в консоли управления можно посмотреть имя бакета, а ACCESS_KEY и SECRET_KEY скопировать из предыдущей функции my-first-function:<br />echo "export ACCESS_KEY=&lt;ACCESS_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export SECRET_KEY=&lt;SECRET_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export BUCKET_NAME=bucket-for-trigger" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc <br />Определим идентификатор (ID) последней загруженной версии функции:<br />yc serverless function version list --function-name parrot <br />Создадим новую версию функции, задав переменные окружения. Для этого выставим значение параметра source-version-id равное полученному идентификатору версии функции (ID) в следующей команде:<br />yc serverless function version create \<br />&nbsp; --function-name parrot \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint parrot.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-version-id &lt;идентификатор_версии_функции&gt; \<br />&nbsp; --environment ACCESS_KEY=$ACCESS_KEY \<br />&nbsp; --environment SECRET_KEY=$SECRET_KEY \<br />&nbsp; --environment BUCKET_NAME=$BUCKET_NAME <br />Успешное выполнение команды приведёт к созданию версии функции.<br />Шаг 3. Вызов функции и её тестирование<br />По умолчанию функция создаётся непубличной. Чтобы сделать функцию parrot публичной, вызовите следующую команду:<br />yc serverless function allow-unauthenticated-invoke parrot <br />Протестируйте функцию parrot, чтобы проверить правильность кода перед созданием связки с Алисой. В консоли управления на странице сервиса Cloud Functions выберите созданную функцию и перейдите на вкладку Тестирование. В поле Шаблон данных данных укажите Навык Алисы и нажмите кнопку Запустить тест.<br />В блоке Результат тестирования убедитесь, что функция выполнена и приведен ответ.<br />Перейдите по ссылке https://dialogs.yandex.ru/developer/ и создайте новый диалог Алисы (подробности о создании навыков вы можете узнать из документации):<br />Нажмите кнопку Создать диалог. Выберите тип диалога Навык в Алисе, у вас откроется форма на вкладке Настройки.<br />Заполните имя навыка, оно должно состоять минимум из двух слов, например My parrot.<br />В блоке Backend выберите вариант Функция в Яндекс.Облаке и в выпадающем списке выберите созданную вами функцию parrot.<br />В блоке Тип доступа в выпадающем списке выберите Приватный.<br />В блоке Публикация в каталоге выберите Примеры запросов, например Запусти навык - My parrot, Имя разработчика, Категорию, Описание и Иконку.<br />Нажмите кнопку Сохранить и перейдите на вкладку Тестирование.<br />Если вы сделали всё правильно, то на экране появится приветствие навыка. Далее навык будет повторять всё, что вы ему напишете. При этом фразы, которые вы отправите Алисе, будут сохраняться в новом файле в бакете. Вы можете это проверить в консоли управления.<br /><strong>Decision:</strong><br />$ yc serverless function create \<br />&nbsp; --name parrot \<br />&nbsp; --description "function for Alice"<br />$ vim parrot.py<br />$ cat parrot.py<br />import os<br />import datetime<br />import boto3<br />import pytz<br />ACCESS_KEY = os.getenv("ACCESS_KEY")<br />SECRET_KEY = os.getenv("SECRET_KEY")<br />BUCKET_NAME = os.getenv("BUCKET_NAME")<br />TIME_ZONE = os.getenv("TIME_ZONE", "Europe/Moscow")<br />TEMP_FILENAME = "/tmp/temp_file"<br />TEXT_FOR_TEMP_FILE = "This is text file"<br />def write_temp_file(text_for_s3):<br />&nbsp;&nbsp;&nbsp; TEXT_FOR_TEMP_FILE = text_for_s3<br />&nbsp;&nbsp;&nbsp; temp_file = open(TEMP_FILENAME, 'w')&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; temp_file.write(TEXT_FOR_TEMP_FILE)<br />&nbsp;&nbsp;&nbsp; temp_file.close()<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Temp file is written")<br />def get_now_datetime_str():<br />&nbsp;&nbsp;&nbsp; now = datetime.datetime.now(pytz.timezone(TIME_ZONE))<br />&nbsp;&nbsp;&nbsp; return now.strftime('%Y-%m-%d__%H-%M-%S')<br />def get_s3_instance():<br />&nbsp;&nbsp;&nbsp; session = boto3.session.Session()<br />&nbsp;&nbsp;&nbsp; return session.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_access_key_id=ACCESS_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_secret_access_key=SECRET_KEY,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='s3',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://storage.yandexcloud.net'<br />&nbsp;&nbsp;&nbsp; )<br />def upload_dump_to_s3():<br />&nbsp;&nbsp;&nbsp; print("\U0001F4C2 Starting upload to Object Storage")<br />&nbsp;&nbsp;&nbsp; get_s3_instance().upload_file(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filename=TEMP_FILENAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bucket=BUCKET_NAME,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key=f'file-{get_now_datetime_str()}.txt'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; print("\U0001f680 Uploaded")<br />def remove_temp_files():<br />&nbsp;&nbsp;&nbsp; os.remove(TEMP_FILENAME)<br />&nbsp;&nbsp;&nbsp; print("\U0001F44D That's all!")<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; Entry-point for Serverless Function.<br />&nbsp;&nbsp;&nbsp; :param event: request payload.<br />&nbsp;&nbsp;&nbsp; :param context: information about current execution context.<br />&nbsp;&nbsp;&nbsp; :return: response to be serialized as JSON.<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; text = 'Hello! I\'ll repeat anything you say to me.'<br />&nbsp;&nbsp;&nbsp; if 'request' in event and \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'original_utterance' in event['request'] \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and len(event['request']['original_utterance']) &gt; 0:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; text = event['request']['original_utterance']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; write_temp_file(text)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; upload_dump_to_s3()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; remove_temp_files()<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'version': event['version'],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'session': event['session'],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'response': {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Respond with the original request or welcome the user if this is the beginning of the dialog and the request has not yet been made.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text': text,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Don't finish the session after this response.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'end_session': 'false'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp; }<br />$ zip parrot.zip parrot.py<br />$ zip parrot.zip requirements.txt<br />$ yc serverless function version create \<br />&nbsp; --function-name=parrot \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=parrot.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-path parrot.zip<br />$ echo "export ACCESS_KEY=&lt;ACCESS_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export SECRET_KEY=&lt;SECRET_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export BUCKET_NAME=bucket-for-trigger" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ yc serverless function version list --function-name parrot<br />$ yc serverless function version create \<br />&nbsp; --function-name parrot \<br />&nbsp; --memory 256m \<br />&nbsp; --execution-timeout 5s \<br />&nbsp; --runtime python37 \<br />&nbsp; --entrypoint parrot.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --source-version-id &lt;идентификатор_версии_функции&gt; \<br />&nbsp; --environment ACCESS_KEY=$ACCESS_KEY \<br />&nbsp; --environment SECRET_KEY=$SECRET_KEY \<br />&nbsp; --environment BUCKET_NAME=$BUCKET_NAME<br />$ yc serverless function allow-unauthenticated-invoke parrot<br /><strong>Task:</strong><br />Проверка доступности<br />На этом практическом занятии вы создадите функцию для проверки доступности сайта yandex.ru, которая будет измерять время ответа. <br />Результаты работы функции будут передаваться в базу данных сервиса Yandex Managed Service for PostgreSQL с использованием подключения к управляемой БД из функции. <br />Также вы запустите триггер-таймер, который будет регулярно производить опрос сайта yandex.ru.<br /><strong>Decision:</strong><br />Шаг 1. Дополнительная роль для сервисного аккаунта<br />В предыдущих практических работах вы создали сервисный аккаунт с именем service-account-for-cf, назначили ему роли editor и&nbsp; storage.editor и создали ключ доступа. Чтобы подключаться к управляемым БД из функции, нужно добавить сервисному аккаунту роль serverless.mdbProxies.user.<br />Для этого выполните следующую команду:<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --role serverless.mdbProxies.user \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_ID <br />Шаг 2. Создание базы данных<br />Создание кластера PostgreSQL<br />Конечно, кластер PostgreSQL можно создать с помощью консоли управления, но в этой практической работе мы используем CLI. Прежде всего, давайте определим подсеть, в которой будет расположен кластер. Разместим кластер в зоне ru-central1-c и с помощью следующей команды узнаем идентификатор(ID) соответствующей подсети:<br />yc vpc subnet list <br />Создадим кластер версии PostgreSQL 13 с именем my-pg-database. Установим тип хоста burstable b2.nano &mdash; это самый дешёвый и простой вариант хоста. Из-за невысокой производительности он подходит только для тестовых целей. Используем для хоста жёсткий диск (HDD) размером 10 ГБ.<br />Сразу создадим пользователя с именем user1 и паролем user1user1, а также базу данных db1. Для удобства администрирования откроем доступ из консоли управления. Используйте опцию websql-access &mdash; это позволит выполнять SQL-запросы прямо в консоли управления. Чтобы открыть возможность подключения к PostgreSQL из функции, необходимо подключить опцию serverless-access.<br />Следующая команда за несколько минут создаст кластер PostgreSQL (не забудьте подставить идентификатор вашей подсети):<br />yc managed-postgresql cluster create \<br />&nbsp; --name my-pg-database \<br />&nbsp; --description 'For Serverless' \<br />&nbsp; --postgresql-version 13 \<br />&nbsp; --environment production \<br />&nbsp; --network-name default \<br />&nbsp; --resource-preset b2.nano \<br />&nbsp; --host zone-id=ru-central1-c,subnet-id=&lt;идентификатор_подсети&gt; \<br />&nbsp; --disk-type network-hdd \<br />&nbsp; --disk-size 10 \<br />&nbsp; --user name=user1,password=user1user1 \<br />&nbsp; --database name=db1,owner=user1 \<br />&nbsp; --websql-access \<br />&nbsp; --serverless-access <br />После успешного создания кластера проверьте результат:<br />yc managed-postgresql cluster list<br />yc managed-postgresql cluster get &lt;имя или идентификатор кластера&gt; <br />Создание таблицы для хранения данных<br />При создании кластера мы использовали опцию websql-access, что открывает нам возможности по исполнению SQL-команд в консоли управления. Воспользуемся этим и сделаем таблицу в созданной нами базе данных. В эту таблицу мы будем складывать результаты выполнения функции. В консоли управления перейдите в каталог, в котором создан кластер PostgreSQL. Откройте сервис Managed Service for PostgreSQL и перейдите в кластер my-pg-database.<br />В боковом меню перейдите на вкладку SQL. Для базы данных db1введите имя user1 и пароль user1user1, нажмите кнопку Подключиться.<br />В открывшемся окне введите SQL-запрос и исполните его:<br />CREATE TABLE measurements (<br />&nbsp;&nbsp;&nbsp; result integer,<br />&nbsp;&nbsp;&nbsp; time float<br />); <br />Успешное выполнение команды создаст таблицу, куда мы будем складывать результаты.<br />Шаг 3. Подключение к управляемой БД из функции<br />Создание подключения<br />В консоли управления перейдите в каталог, в котором хотите создать подключение. Откройте сервис Cloud Functions. В боковом меню перейдите на вкладку Подключения к БД. Нажмите кнопку Создать подключение.<br />&nbsp;&nbsp;&nbsp; Введите имя, описание подключения и в выпадающем списке выберите тип подключения &mdash; PostgreSQL.<br />&nbsp;&nbsp;&nbsp; Укажите кластер &mdash; my-pg-database.<br />&nbsp;&nbsp;&nbsp; Укажите базу данных &mdash; db1.<br />&nbsp;&nbsp;&nbsp; Введите данные пользователя БД: имя user1 и пароль user1user1.<br />&nbsp;&nbsp;&nbsp; Нажмите кнопку Создать.<br />Выберите созданное подключение. На вкладке Обзор скопируйте параметры Идентификатор и Точка входа. Они будут использованы в функции на следующем шаге.<br />Шаг 4. Создание функции<br />Перед созданием функции определите переменные для инициации подключения: CONNECTION_ID &mdash; идентификатор подключения, DB_USER &mdash; имя пользователя БД, DB_HOST &mdash; точка входа. Используйте следующие команды:<br />echo "export CONNECTION_ID=&lt;CONNECTION_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export DB_USER=&lt;DB_USER&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export DB_HOST=&lt;DB_HOST&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc <br />Они будут использованы в функции function-for-postgresql.py. Код функции:<br />import datetime<br />import logging<br />import requests<br />import os<br />#Эти библиотеки нужны для работы с PostgreSQL<br />import psycopg2<br />import psycopg2.errors<br />CONNECTION_ID = os.getenv("CONNECTION_ID")<br />DB_USER = os.getenv("DB_USER")<br />DB_HOST = os.getenv("DB_HOST")<br /># Настраиваем функцию для записи информации в журнал функции<br /># Получаем стандартный логер языка Python<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br /># Вычитываем переменную VERBOSE_LOG, которую мы указываем в переменных окружения <br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />#Функция log, которая запишет текст в журнал выполнения функции, если в переменной окружения VERBOSE_LOG будет значение True<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />#Запись в базу данных<br />def save(result, time, context):<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; postgres_insert_query = """INSERT INTO measurements (result, time) VALUES (%s,%s)"""<br />&nbsp;&nbsp;&nbsp; record_to_insert = (result, time)<br />&nbsp;&nbsp;&nbsp; cursor.execute(postgres_insert_query, record_to_insert)<br />&nbsp;&nbsp;&nbsp; connection.commit()<br /># Это обработчик. Он будет вызван первым при запуске функции<br />def entry(event, context):<br />&nbsp;&nbsp;&nbsp; #Выводим в журнал значения входных параметров event и context<br />&nbsp;&nbsp;&nbsp; log(event)<br />&nbsp;&nbsp;&nbsp; log(context)<br />&nbsp;&nbsp;&nbsp; # Тут мы запоминаем текущее время, отправляем запрос к yandex.ru и вычисляем время выполнения запроса<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now = datetime.datetime.now()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #здесь указано два таймаута: 1c для установки связи с сервисом и 3 секунды на получение ответа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = requests.get('https://yandex.ru', timeout=(1.0000, 3.0000))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; timediff = datetime.datetime.now() - now<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #сохраняем результат запроса<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = response.status_code<br />&nbsp;&nbsp;&nbsp; #если в процессе запроса сработали таймауты, то в результат записываем соответствующие коды<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ReadTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 601<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ConnectTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 602<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.Timeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 603<br />&nbsp;&nbsp;&nbsp; log(f'Result: {result} Time: {timediff.total_seconds()}')&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; save(result, timediff.total_seconds(), context)<br />&nbsp;&nbsp;&nbsp; #возвращаем результат запроса<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': result,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'headers': {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Content-Type': 'text/plain'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'isBase64Encoded': False<br />&nbsp;&nbsp;&nbsp; } <br />Перейдем в директорию с кодом функции и создадим нашу функцию function-for-postgresql. При этом сразу зададим все необходимые переменные и сервисный аккаунт:<br />yc serverless function create \<br />&nbsp; --name&nbsp; function-for-postgresql \<br />&nbsp; --description "function for postgresql"<br />yc serverless function version create \<br />&nbsp; --function-name=function-for-postgresql \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=function-for-postgresql.entry \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --environment VERBOSE_LOG=True \<br />&nbsp; --environment CONNECTION_ID=$CONNECTION_ID \<br />&nbsp; --environment DB_USER=$DB_USER \<br />&nbsp; --environment DB_HOST=$DB_HOST \<br />&nbsp; --source-path function-for-postgresql.py <br />Проверим работоспособность функции:<br />yc serverless function version list --function-name function-for-postgresql<br />yc serverless function invoke --name function-for-postgresql <br />Успешный вызов функции приведёт к измерению времени ответа сайта и формированию записи в базе данных.<br />Шаг 5. Создание триггера<br />Создание триггера-таймера<br />Проверять доступность сайта лучше в автоматическом режиме через равные промежутки времени. Для этой задачи создайте триггер-таймер. Он будет использовать cron-выражения:<br />yc serverless trigger create timer \<br />&nbsp; --name trigger-for-postgresql \<br />&nbsp; --invoke-function-name function-for-postgresql \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --cron-expression '* * * * ? *' <br />Cron-выражение * * * * ? * означает вызов функции function-for-postgresql один раз в минуту. Успешное выполнение функции раз в минуту будет создавать запись в базе данных, в чём вы можете убедиться, просмотрев записи в таблице.<br />Убедились? Поздравляем: вы успешно создали функцию, которая через заданный промежуток времени выполняется по триггеру, чтобы проверить доступность yandex.ru и записать результат проверки в базу данных.<br />Удаление триггера-таймера<br />После завершения практической работы не забудьте удалить созданный триггер trigger-for-postgresql, иначе он будет продолжать работать:<br />yc serverless trigger delete trigger-for-postgresql <br /><strong>Decision:</strong><br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --role serverless.mdbProxies.user \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_ID<br />$ yc vpc subnet list<br />$ yc managed-postgresql cluster create \<br />&nbsp; --name my-pg-database \<br />&nbsp; --description 'For Serverless' \<br />&nbsp; --postgresql-version 13 \<br />&nbsp; --environment production \<br />&nbsp; --network-name default \<br />&nbsp; --resource-preset b2.nano \<br />&nbsp; --host zone-id=ru-central1-c,subnet-id=&lt;идентификатор_подсети&gt; \<br />&nbsp; --disk-type network-hdd \<br />&nbsp; --disk-size 10 \<br />&nbsp; --user name=user1,password=user1user1 \<br />&nbsp; --database name=db1,owner=user1 \<br />&nbsp; --websql-access \<br />&nbsp; --serverless-access<br />$ yc managed-postgresql cluster list<br />$ yc managed-postgresql cluster get &lt;имя или идентификатор кластера&gt;<br />$ echo "export CONNECTION_ID=&lt;CONNECTION_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export DB_USER=&lt;DB_USER&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export DB_HOST=&lt;DB_HOST&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ vim function-for-postgresql.py<br />$ cat function-for-postgresql.py<br />import datetime<br />import logging<br />import requests<br />import os<br />#Эти библиотеки нужны для работы с PostgreSQL<br />import psycopg2<br />import psycopg2.errors<br />CONNECTION_ID = os.getenv("CONNECTION_ID")<br />DB_USER = os.getenv("DB_USER")<br />DB_HOST = os.getenv("DB_HOST")<br /># Настраиваем функцию для записи информации в журнал функции<br /># Получаем стандартный логер языка Python<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br /># Вычитываем переменную VERBOSE_LOG, которую мы указываем в переменных окружения <br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />#Функция log, которая запишет текст в журнал выполнения функции, если в переменной окружения VERBOSE_LOG будет значение True<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />#Запись в базу данных<br />def save(result, time, context):<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; postgres_insert_query = """INSERT INTO measurements (result, time) VALUES (%s,%s)"""<br />&nbsp;&nbsp;&nbsp; record_to_insert = (result, time)<br />&nbsp;&nbsp;&nbsp; cursor.execute(postgres_insert_query, record_to_insert)<br />&nbsp;&nbsp;&nbsp; connection.commit()<br /># Это обработчик. Он будет вызван первым при запуске функции<br />def entry(event, context):<br />&nbsp;&nbsp;&nbsp; #Выводим в журнал значения входных параметров event и context<br />&nbsp;&nbsp;&nbsp; log(event)<br />&nbsp;&nbsp;&nbsp; log(context)<br />&nbsp;&nbsp;&nbsp; # Тут мы запоминаем текущее время, отправляем запрос к ya.ru и вычисляем время выполнения запроса<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now = datetime.datetime.now()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #здесь указано два таймаута: 1c для установки связи с сервисом и 3 секунды на получение ответа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = requests.get('https://ya.ru', timeout=(1.0000, 3.0000))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; timediff = datetime.datetime.now() - now<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #сохраняем результат запроса<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = response.status_code<br />&nbsp;&nbsp;&nbsp; #если в процессе запроса сработали таймауты, то в результат записываем соответствующие коды<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ReadTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 601<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ConnectTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 602<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.Timeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 603<br />&nbsp;&nbsp;&nbsp; log(f'Result: {result} Time: {timediff.total_seconds()}')&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; save(result, timediff.total_seconds(), context)<br />&nbsp;&nbsp;&nbsp; #возвращаем результат запроса<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': result,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'headers': {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Content-Type': 'text/plain'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'isBase64Encoded': False<br />&nbsp;&nbsp;&nbsp; }<br />$ yc serverless function create \<br />&nbsp; --name&nbsp; function-for-postgresql \<br />&nbsp; --description "function for postgresql"<br />$ yc serverless function version create \<br />&nbsp; --function-name=function-for-postgresql \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=function-for-postgresql.entry \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --environment VERBOSE_LOG=True \<br />&nbsp; --environment CONNECTION_ID=$CONNECTION_ID \<br />&nbsp; --environment DB_USER=$DB_USER \<br />&nbsp; --environment DB_HOST=$DB_HOST \<br />&nbsp; --source-path function-for-postgresql.py<br />$ yc serverless function version list --function-name function-for-postgresql<br />$ yc serverless function invoke --name function-for-postgresql<br />$ yc serverless trigger create timer \<br />&nbsp; --name trigger-for-postgresql \<br />&nbsp; --invoke-function-name function-for-postgresql \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --cron-expression '* * * * ? *'<br />$ yc serverless trigger delete trigger-for-postgresql<br /><strong>Task:</strong><br />Создание HTTP API с помощью Cloud Functions и API Gateway.<br />На предыдущем практическом занятии мы создали простую систему, которая проверяет доступность сайта yandex.ru и измеряет время ответа на запрос. <br />Полученную информацию функция записывала в базу данных PostgreSQL. <br />На этом уроке мы доработаем начатый проект и добавим REST API, который позволит получать до 50 результатов проверки из базы данных.<br /><strong>Decision:</strong><br />Шаг 1. Проверить наличие сервисного аккаунта<br />Для работы нам понадобится сервисный аккаунт с именем service-account-for-cf и ролями editor, serverless.mdbProxies.user, который мы создали ранее.<br />Шаг 2. Yandex API Gateway<br />Создание спецификации<br />В рабочем каталоге создадим спецификацию hello-world.yaml:<br />openapi: "3.0.0"<br />info:<br />&nbsp; version: 1.0.0<br />&nbsp; title: Test API<br />paths:<br />&nbsp; /hello:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; summary: Say hello<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: hello<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parameters:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: user<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in: query<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description: User name to appear in greetings<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; required: false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default: 'world'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; responses:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '200':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description: Greeting<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text/plain':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: "string"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: dummy<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http_code: 200<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http_headers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Content-Type': "text/plain"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text/plain': "Hello, {user}!\n" <br />Мы можем создать API-шлюз с помощью консоли управления, но сейчас воспользуемся CLI.<br />Инициализация спецификации<br />Чтобы развернуть API-шлюз, используем спецификацию hello-world.yaml:<br />yc serverless api-gateway create \<br />&nbsp; --name hello-world \<br />&nbsp; --spec=hello-world.yaml \<br />&nbsp; --description "hello world" <br />В результате успешного создания API-шлюза получим значение параметра domain:<br />yc serverless api-gateway list<br />yc serverless api-gateway get --name hello-world <br />Скопируем служебный домен, чтобы проверить работоспособность API-шлюза. Вставим его в адресную строку браузера и допишем в конец /hello. Должно получиться следующее:<br />https://&lt;идентификатор API Gateway&gt;.apigw.yandexcloud.net/hello <br />Теперь протестируем запрос с параметрами. Добавьте к предыдущему запросу ?user=my_user. Должно получиться следующее:<br />https://&lt;идентификатор API Gateway&gt;.apigw.yandexcloud.net/hello?user=my_user <br />В первом случае в окне браузера вы увидите &laquo;Hello, world!&raquo;, во втором &laquo;Hello, my_user!&raquo;.<br />Шаг 3. Создание функции<br />Работа с библиотеками и переменными<br />До этого момента мы использовали рантайм python37, который не требовал явного указания библиотек, но начиная с версии python39, нужно указывать библиотеки явно. Для работы с requirements.txt можно воспользоваться удобной Python-библиотекой pipreqs: чтобы сгенерировать requirements.txt с помощью pipreqs, достаточно указать рабочий каталог. В большинстве интерпретаторов Linux для указания текущего каталога предусмотрена переменная $PWD. Если файл requirements.txt уже существует, актуализируйте его с помощью флага --force, например:<br />pip install pipreqs<br />pipreqs $PWD --print<br />pipreqs $PWD --force <br />Чтобы создать функцию, проверим доступность переменных для инициации подключения CONNECTION_ID, DB_USER, DB_HOST, которые мы создали в предыдущей работе с помощью следующих команд:<br />echo "export CONNECTION_ID=&lt;CONNECTION_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export DB_USER=&lt;DB_USER&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export DB_HOST=&lt;DB_HOST&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc <br />Создание функции<br />Создадим функцию function-for-user-requests.py:<br />import json<br />import logging<br />import requests<br />import os<br />#Эти библиотеки нужны для работы с PostgreSQL<br />import psycopg2<br />import psycopg2.errors<br />import psycopg2.extras<br />CONNECTION_ID = os.getenv("CONNECTION_ID")<br />DB_USER = os.getenv("DB_USER")<br />DB_HOST = os.getenv("DB_HOST")<br /># Настраиваем функцию для записи информации в журнал функции<br /># Получаем стандартный логер языка Python<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br /># Вычитываем переменную VERBOSE_LOG, которую мы указываем в переменных окружения<br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />#Функция log, которая запишет текст в журнал выполнения функции, если в переменной окружения VERBOSE_LOG будет значение True<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />#Запись в базу данных<br />def save(result, time, context):<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; postgres_insert_query = """INSERT INTO measurements (result, time) VALUES (%s,%s)"""<br />&nbsp;&nbsp;&nbsp; record_to_insert = (result, time)<br />&nbsp;&nbsp;&nbsp; cursor.execute(postgres_insert_query, record_to_insert)<br />&nbsp;&nbsp;&nbsp; connection.commit()<br />#Формируем запрос<br />def generateQuery():<br />&nbsp;&nbsp;&nbsp; select = f"SELECT * FROM measurements LIMIT 50"<br />&nbsp;&nbsp;&nbsp; result = select<br />&nbsp;&nbsp;&nbsp; return result<br />#Получаем подключение<br />def getConnString(context):<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; Extract env variables to connect to DB and return a db string<br />&nbsp;&nbsp;&nbsp; Raise an error if the env variables are not set<br />&nbsp;&nbsp;&nbsp; :return: string<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; return connection<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; secret = event['queryStringParameters']['secret']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if secret != 'cecfb23c-bc86-4ca2-b611-e79bc77e5c31':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise Exception()<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 401<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; sql = generateQuery()<br />&nbsp;&nbsp;&nbsp; log(f'Exec: {sql}')<br />&nbsp;&nbsp;&nbsp; connection = getConnString(context)<br />&nbsp;&nbsp;&nbsp; log(f'Connecting: {connection}')<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(sql)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 200<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': json.dumps(cursor.fetchall()),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; except psycopg2.errors.UndefinedTable as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.rollback()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 500<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 500<br />&nbsp;&nbsp;&nbsp; cursor.close()<br />&nbsp;&nbsp;&nbsp; connection.close()<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': json.dumps({<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'event': event,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }),<br />&nbsp;&nbsp;&nbsp; }<br />Обратите внимание, в коде функции мы заложили параметр secret и его значение cecfb23c-bc86-4ca2-b611-e79bc77e5c31, при котором функция будет выполняться. Таким образом мы обеспечиваем дополнительную защиту при доступе к БД.<br />При создании функции сразу зададим все необходимые переменные и сервисный аккаунт:<br />yc serverless function create \<br />&nbsp; --name function-for-user-requests \<br />&nbsp; --description "function for response to user"<br />yc serverless function version create \<br />&nbsp; --function-name=function-for-user-requests \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=function-for-user-requests.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --environment VERBOSE_LOG=True \<br />&nbsp; --environment CONNECTION_ID=$CONNECTION_ID \<br />&nbsp; --environment DB_USER=$DB_USER \<br />&nbsp; --environment DB_HOST=$DB_HOST \<br />&nbsp; --source-path function-for-user-requests.py <br />Шаг 4. Обновление спецификации API Gateway<br />Наша функция готова, но по умолчанию она не является публичной. Предоставим доступ к этой функции с помощью API-шлюза &mdash; обновим ранее созданную спецификацию hello-world.yaml. Не забудьте вставить в файл идентификаторы вашей функции и вашего сервисного аккаунта:<br />openapi: "3.0.0"<br />info:<br />&nbsp; version: 1.0.0<br />&nbsp; title: Updated API<br />paths:<br />&nbsp; /results:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud-functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id: &lt;идентификатор функции&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account_id: &lt;идентификатор сервисного аккаунта&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: function-for-user-requests <br />Вызовем перезагрузку нашей спецификации:<br />yc serverless api-gateway update \<br />&nbsp; --name hello-world \<br />&nbsp; --spec=hello-world.yaml <br />Для тестирования вызовем функцию в браузере сначала без параметра secret, а затем &mdash; с ним:<br />https://&lt;идентификатор API Gateway&gt;.apigw.yandexcloud.net/results<br />https://&lt;идентификатор API Gateway&gt;.apigw.yandexcloud.net/results?secret=cecfb23c-bc86-4ca2-b611-e79bc77e5c31 <br />В ответе увидим результаты тестирования сервиса yandex.ru из базы данных.<br />Иногда приходится тестировать функцию в процессе разработки: для этого в консоли управления на странице функции перейдите на вкладку Тестирование, в поле Шаблон данных выберите HTTPS-вызов. Нажмите кнопку Запустить тест, и вы увидите код ошибки.<br />Код функции проверяет параметр secret для авторизации, то есть при вызове вы должны передать секретную последовательность, чтобы функция выдала результат. Добавим secret в параметры запроса в поле Входные данные:<br />&nbsp;&nbsp;&nbsp; "queryStringParameters": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "a": "2",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "b": "1",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "secret": "cecfb23c-bc86-4ca2-b611-e79bc77e5c31"<br />&nbsp;&nbsp;&nbsp; }, <br />Запустим тест ещё раз. В ответе отобразятся данные из базы, как и с запросами через браузер.<br /><strong>Decision:</strong><br />$ vim hello-world.yaml<br />$ cat hello-world.yaml<br />openapi: "3.0.0"<br />info:<br />&nbsp; version: 1.0.0<br />&nbsp; title: Test API<br />paths:<br />&nbsp; /hello:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; summary: Say hello<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: hello<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parameters:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: user<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in: query<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description: User name to appear in greetings<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; required: false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default: 'world'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; responses:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '200':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description: Greeting<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text/plain':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: "string"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: dummy<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http_code: 200<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http_headers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Content-Type': "text/plain"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text/plain': "Hello, {user}!\n"<br />$ yc serverless api-gateway create \<br />&nbsp; --name hello-world \<br />&nbsp; --spec=hello-world.yaml \<br />&nbsp; --description "hello world"<br />$ yc serverless api-gateway list<br />$ yc serverless api-gateway get --name hello-world<br />$ touch requirements.txt<br />$ sudo apt install python3-pip<br />$ pip install pipreqs<br />$ pipreqs $PWD --print<br />$ pipreqs $PWD --force<br />$ echo "export CONNECTION_ID=&lt;CONNECTION_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export DB_USER=&lt;DB_USER&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export DB_HOST=&lt;DB_HOST&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ vim function-for-user-requests.py<br />$ cat function-for-user-requests.py<br />import json<br />import logging<br />import requests<br />import os<br />#Эти библиотеки нужны для работы с PostgreSQL<br />import psycopg2<br />import psycopg2.errors<br />import psycopg2.extras<br />CONNECTION_ID = os.getenv("CONNECTION_ID")<br />DB_USER = os.getenv("DB_USER")<br />DB_HOST = os.getenv("DB_HOST")<br /># Настраиваем функцию для записи информации в журнал функции<br /># Получаем стандартный логер языка Python<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br /># Вычитываем переменную VERBOSE_LOG, которую мы указываем в переменных окружения<br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />#Функция log, которая запишет текст в журнал выполнения функции, если в переменной окружения VERBOSE_LOG будет значение True<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />#Запись в базу данных<br />def save(result, time, context):<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; postgres_insert_query = """INSERT INTO measurements (result, time) VALUES (%s,%s)"""<br />&nbsp;&nbsp;&nbsp; record_to_insert = (result, time)<br />&nbsp;&nbsp;&nbsp; cursor.execute(postgres_insert_query, record_to_insert)<br />&nbsp;&nbsp;&nbsp; connection.commit()<br />#Формируем запрос<br />def generateQuery():<br />&nbsp;&nbsp;&nbsp; select = f"SELECT * FROM measurements LIMIT 50"<br />&nbsp;&nbsp;&nbsp; result = select<br />&nbsp;&nbsp;&nbsp; return result<br />#Получаем подключение<br />def getConnString(context):<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; Extract env variables to connect to DB and return a db string<br />&nbsp;&nbsp;&nbsp; Raise an error if the env variables are not set<br />&nbsp;&nbsp;&nbsp; :return: string<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; return connection<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; secret = event['queryStringParameters']['secret']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if secret != 'cecfb23c-bc86-4ca2-b611-e79bc77e5c31':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise Exception()<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 401<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; sql = generateQuery()<br />&nbsp;&nbsp;&nbsp; log(f'Exec: {sql}')<br />&nbsp;&nbsp;&nbsp; connection = getConnString(context)<br />&nbsp;&nbsp;&nbsp; log(f'Connecting: {connection}')<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(sql)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 200<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': json.dumps(cursor.fetchall()),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; except psycopg2.errors.UndefinedTable as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.rollback()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 500<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 500<br />&nbsp;&nbsp;&nbsp; cursor.close()<br />&nbsp;&nbsp;&nbsp; connection.close()<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': json.dumps({<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'event': event,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }),<br />&nbsp;&nbsp;&nbsp; }<br />$ yc serverless function create \<br />&nbsp; --name function-for-user-requests \<br />&nbsp; --description "function for response to user"<br />$ yc serverless function version create \<br />&nbsp; --function-name=function-for-user-requests \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=function-for-user-requests.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --environment VERBOSE_LOG=True \<br />&nbsp; --environment CONNECTION_ID=$CONNECTION_ID \<br />&nbsp; --environment DB_USER=$DB_USER \<br />&nbsp; --environment DB_HOST=$DB_HOST \<br />&nbsp; --source-path function-for-user-requests.py<br />$ vim hello-world1.yaml<br />$ cat hello-world1.yaml<br />openapi: "3.0.0"<br />info:<br />&nbsp; version: 1.0.0<br />&nbsp; title: Updated API<br />paths:<br />&nbsp; /results:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud-functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id: &lt;идентификатор функции&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account_id: &lt;идентификатор сервисного аккаунта&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: function-for-user-requests<br />$ yc serverless api-gateway update \<br />&nbsp; --name hello-world \<br />&nbsp; --spec=hello-world.yaml<br /><strong>Task:</strong><br />Загрузка данных, выполнение запросов AWS CLI.<br />B предыдущем уроке мы рассмотрели, как работать с YDB через Document API &mdash; низкоуровневый HTTP API, совместимый с AWS DynamoDB API.<br />В этом уроке рассмотрим операции создания таблицы, записи, чтения, изменения и удаления данных в таблице с помощью AWS CLI.<br /><strong>Decision:</strong><br />Сервисный аккаунт и ключ доступа. Для работы инструментов AWS вам понадобится создать сервисный аккаунт в облаке.<br />Выберите вкладку Сервисные аккаунты в каталоге, где расположена БД.<br />Нажмите кнопку Создать сервисный аккаунт.<br />Введите имя сервисного аккаунта. Чтобы назначить сервисному аккаунту роль на текущий каталог, нажмите Добавить роль и выберите роль, например editor.<br />Нажмите кнопку Создать.<br />Выберите созданный сервисный аккаунт и нажмите на строку с его именем. Нажмите кнопку Создать новый ключ на верхней панели. Выберите пункт Создать статический ключ доступа.<br />Сохраните идентификатор и секретный ключ.<br />Работа с AWS CLI. Установите AWS CLI с сайта https://aws.amazon.com/ru/cli/.<br />Для Windows: загрузите и запустите 64- или 32-разрядный установщик.<br />Для Mac и Linux: установите AWS CLI с помощью утилиты pip (требуется Python 2.6.5 или более поздней версии).<br />pip install awscli <br />Для настройки AWS CLI&nbsp; запустите команду:<br />aws configure <br />Введите сохраненные значения идентификатора ключа AWS Access Key ID и ключа AWS Secret Access Key и укажите ru-central1 в качестве Default region name.<br />Убедитесь, что в качестве переменной окружения ENDPOINT указано корректное значение эндпойнта вашей базы данных, либо добавьте его, как вы это делали в прошлом уроке: сохраните значение эндпойнта, указанное в строке Document API эндпоинт, в переменной окружения с помощью команды<br />export ENDPOINT=&lt;значение endpoint&gt; <br />Создание таблицы. Создайте таблицу с помощью команды:<br />aws dynamodb create-table \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --attribute-definitions \<br />&nbsp; AttributeName=series_id,AttributeType=N \<br />&nbsp; AttributeName=title,AttributeType=S \<br />&nbsp; --key-schema \<br />&nbsp; AttributeName=series_id,KeyType=HASH \<br />&nbsp; AttributeName=title,KeyType=RANGE \<br />&nbsp; --endpoint $ENDPOINT <br />Убедитесь, что в директории docapitest появилась таблица series.<br />Добавление данных в таблицу<br />Добавьте в таблицу две строки c помощью команд:<br />aws dynamodb put-item \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --item '{"series_id": {"N": "1"}, "title": {"S": "IT Crowd"}, "series_info": {"S": "The IT Crowd is a British sitcom produced by Channel 4, written by Graham Linehan, produced by Ash Atalla and starring Chris ODowd, Richard Ayoade, Katherine Parkinson, and Matt Berry."}, "release_date": {"S": "2006-02-03"}}' \<br />&nbsp; --endpoint $ENDPOINT <br />и<br />aws dynamodb put-item \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --item '{"series_id": {"N": "2"}, "title": {"S": "Silicon Valley"}, "series_info": {"S": "Silicon Valley is an American comedy television series created by Mike Judge, John Altschuler and Dave Krinsky."}, "release_date": {"S": "2014-04-06"}}' \<br />&nbsp; --endpoint $ENDPOINT <br />Чтение данных из таблицы. Для того чтобы прочитать данные из таблицы, выполните команду:<br />aws dynamodb get-item --consistent-read \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --key '{"series_id": {"N": "1"}, "title": {"S": "IT Crowd"}}' \<br />&nbsp; --endpoint $ENDPOINT <br />В качестве вывода вы увидите:<br />{<br />&nbsp;&nbsp;&nbsp; "Item": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S": "2006-02-03"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_id": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "N": "1"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S": "The IT Crowd is a British sitcom produced by Channel 4, written by Graham Linehan, produced by Ash Atalla and starring Chris ODowd, Richard Ayoade, Katherine Parkinson, and Matt Berry."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "title": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S": "IT Crowd"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />} <br />Для того, чтобы выбрать данные из таблицы series по ключу series_id, выполните следующую команду:<br />aws dynamodb query \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --key-condition-expression "series_id = :name" \<br />&nbsp; --expression-attribute-values '{":name":{"N":"2"}}' \<br />&nbsp; --endpoint $ENDPOINT <br />В качестве результата вы увидите:<br />{<br />&nbsp;&nbsp;&nbsp; "Items": [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S": "2014-04-06"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_id": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "N": "2"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S": "Silicon Valley is an American comedy television series created by Mike Judge, John Altschuler and Dave Krinsky."<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "title": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "S": "Silicon Valley"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; ],<br />&nbsp;&nbsp;&nbsp; "Count": 1,<br />&nbsp;&nbsp;&nbsp; "ScannedCount": 1,<br />&nbsp;&nbsp;&nbsp; "ConsumedCapacity": null<br />} <br />Удаление таблицы<br />aws dynamodb delete-table \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --endpoint $ENDPOINT <br />На следующем практическом занятии мы разберём пример использования AWS SDK для работы с YDB в serverless-режиме.<br /><strong>Decision:</strong><br />$ pip install awscli<br />$ aws configure<br />$ export ENDPOINT=&lt;значение endpoint&gt;<br />$ aws dynamodb create-table \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --attribute-definitions \<br />&nbsp; AttributeName=series_id,AttributeType=N \<br />&nbsp; AttributeName=title,AttributeType=S \<br />&nbsp; --key-schema \<br />&nbsp; AttributeName=series_id,KeyType=HASH \<br />&nbsp; AttributeName=title,KeyType=RANGE \<br />&nbsp; --endpoint $ENDPOINT<br />$ aws dynamodb put-item \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --item '{"series_id": {"N": "1"}, "title": {"S": "IT Crowd"}, "series_info": {"S": "The IT Crowd is a British sitcom produced by Channel 4, written by Graham Linehan, produced by Ash Atalla and starring Chris ODowd, Richard Ayoade, Katherine Parkinson, and Matt Berry."}, "release_date": {"S": "2006-02-03"}}' \<br />&nbsp; --endpoint $ENDPOINT<br />$ aws dynamodb put-item \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --item '{"series_id": {"N": "2"}, "title": {"S": "Silicon Valley"}, "series_info": {"S": "Silicon Valley is an American comedy television series created by Mike Judge, John Altschuler and Dave Krinsky."}, "release_date": {"S": "2014-04-06"}}' \<br />&nbsp; --endpoint $ENDPOINT<br />$ aws dynamodb get-item --consistent-read \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --key '{"series_id": {"N": "1"}, "title": {"S": "IT Crowd"}}' \<br />&nbsp; --endpoint $ENDPOINT<br />$ aws dynamodb query \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --key-condition-expression "series_id = :name" \<br />&nbsp; --expression-attribute-values '{":name":{"N":"2"}}' \<br />&nbsp; --endpoint $ENDPOINT<br />$ aws dynamodb delete-table \<br />&nbsp; --table-name docapitest/series \<br />&nbsp; --endpoint $ENDPOINT<br /><strong>Task:</strong><br />Запуск тестового приложения<br />В предыдущем уроке вы прошли подготовительные этапы: создали и настроили сервисный аккаунт, выпустили статический ключ, а также научились работать с таблицами и данными с помощью низкоуровневого API и CLI.<br />В этом уроке вы продолжите работу с инструментами AWS и с помощью AWS SDK для языка Python научитесь выполнять такие базовые операции, как создание таблиц БД, запись и чтение данных.<br /><strong>Decision:</strong><br />Для выполнения работы вам понадобится Python версии 3.6 и выше и библиотека boto3.<br />Установить эту библиотеку можно с помощью команды:<br />pip install boto3 <br />Создание таблицы<br />Создайте файл с именем SeriesCreateTable.py и скопируйте в него исходный код программы:<br />import boto3<br />def create_series_table():<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.create_table(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TableName = 'docapitest/series', # Series &mdash; имя таблицы <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeySchema = [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'series_id',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'KeyType': 'HASH'&nbsp; # Ключ партицирования<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'title',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'KeyType': 'RANGE'&nbsp; # Ключ сортировки<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AttributeDefinitions = [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'series_id',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeType': 'N'&nbsp; # Целое число<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'title',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeType': 'S'&nbsp; # Строка<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return table<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; series_table = create_series_table()<br />&nbsp;&nbsp;&nbsp; print("Table status:", series_table.table_status) <br />Отредактируйте исходный код файла и укажите значение endpoint_url вашей базы. Затем запустите написанный код:<br />python SeriesCreateTable.py <br />С помощью консоли управления убедитесь, что&nbsp; в директории docapitest появилась таблица series.<br />Первоначальная загрузка данных<br />Для того чтобы вставить данные в созданную таблицу series, создайте файл с именем SeriesLoadData.py и скопируйте в него следующий исходный код программы:<br />from decimal import Decimal<br />import json<br />import boto3<br />def load_series(series):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document API эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; for serie in series:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; series_id = int(serie['series_id'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; title = serie['title']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Series added:", series_id, title)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; table.put_item(Item = serie)<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; with open("seriesdata.json") as json_file:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serie_list = json.load(json_file, parse_float = Decimal)<br />&nbsp;&nbsp;&nbsp; load_series(serie_list) <br />Отредактируйте файл SeriesLoadData.py и укажите значение endpoint_url вашей базы.<br />Для загрузки данных приложение будет использовать данные, которые записаны в файл seriesdata.json. Создайте этот файл и скопируйте в него описание сериалов:<br />[{<br />&nbsp;&nbsp;&nbsp; "series_id": 1,<br />&nbsp;&nbsp;&nbsp; "title": "IT Crowd",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2006-02-03T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "The IT Crowd is a British sitcom produced by Channel 4, written by Graham Linehan, produced by Ash Atalla and starring Chris O'Dowd, Richard Ayoade, Katherine Parkinson, and Matt Berry"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 2,<br />&nbsp;&nbsp;&nbsp; "title": "Silicon Valley",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2014-04-06T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "Silicon Valley is an American comedy television series created by Mike Judge, John Altschuler and Dave Krinsky. The series focuses on five young men who founded a startup company in Silicon Valley"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 3,<br />&nbsp;&nbsp;&nbsp; "title": "House of Cards",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2013-02-01T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "House of Cards is an American political thriller streaming television series created by Beau Willimon. It is an adaptation of the 1990 BBC miniseries of the same name and based on the 1989 novel of the same name by Michael Dobbs"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 3,<br />&nbsp;&nbsp;&nbsp; "title": "The Office",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2005-03-24T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "The Office is an American mockumentary sitcom television series that depicts the everyday work lives of office employees in the Scranton, Pennsylvania, branch of the fictional Dunder Mifflin Paper Company"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 3,<br />&nbsp;&nbsp;&nbsp; "title": "True Detective",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2014-01-12T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "True Detective is an American anthology crime drama television series created and written by Nic Pizzolatto. The series, broadcast by the premium cable network HBO in the United States, premiered on January 12, 2014"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 4,<br />&nbsp;&nbsp;&nbsp; "title": "The Big Bang Theory",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2007-09-24T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "The Big Bang Theory is an American television sitcom created by Chuck Lorre and Bill Prady, both of whom served as executive producers on the series, along with Steven Molaro"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 5,<br />&nbsp;&nbsp;&nbsp; "title": "Twin Peaks",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "1990-04-08T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "Twin Peaks is an American mystery horror drama television series created by Mark Frost and David Lynch that premiered on April 8, 1990, on ABC until its cancellation after its second season in 1991 before returning as a limited series in 2017 on Showtime"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />] <br />Запустите программу (для её успешного выполнения может понадобиться указать в скрипте SeriesLoadData.py полный путь к файлу seriesdata.json):<br />python SeriesLoadData.py <br />В результате выполнения вы увидите вывод программы:<br />Series added: 1 IT Crowd<br />Series added: 2 Silicon Valley<br />Series added: 3 House of Cards<br />Series added: 3 The Office<br />Series added: 3 True Detective<br />Series added: 4 The Big Bang Theory<br />Series added: 5 Twin Peaks <br />Работа с записями<br />Создание записи<br />Теперь создайте файл SeriesItemPut.py и скопируйте в него следующий код:<br />from pprint import pprint<br />import boto3<br />def put_serie(series_id, title, release_date, series_info):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; response = table.put_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Item = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_id': series_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'title': title,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'info': {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'release_date': release_date,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_info': series_info<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return response<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; serie_resp = put_serie(3, "Supernatural", "2015-09-13",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Supernatural is an American television series created by Eric Kripke")<br />&nbsp;&nbsp;&nbsp; print("Series added successfully:")<br />&nbsp;&nbsp;&nbsp; pprint(serie_resp, sort_dicts = False) <br />В результате выполнения этого кода в таблице добавится запись о сериале Supernatural.<br />Чтение записи<br />Создайте файл SeriesItemGet.py и скопируйте в него следующий код:<br />from pprint import pprint<br />import boto3<br />from botocore.exceptions import ClientError<br />def get_serie(title, series_id):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = table.get_item(Key = {'series_id': series_id, 'title': title})<br />&nbsp;&nbsp;&nbsp; except ClientError as e:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(e.response['Error']['Message'])<br />&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response['Item']<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; serie = get_serie("Supernatural", 3,)<br />&nbsp;&nbsp;&nbsp; if serie:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Record read:")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(serie, sort_dicts = False) <br />Результатом будет сообщение в формате JSON с данными о сериале.<br />Обновление записи<br />В файле SeriesItemUpdate.py разместите код обновления записи:<br />from decimal import Decimal<br />from pprint import pprint<br />import boto3<br />def update_serie(title, series_id, release_date,&nbsp; rating):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; response = table.update_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_id': series_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'title': title<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UpdateExpression = "set info.release_date = :d, info.rating = :r ",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExpressionAttributeValues = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ':d': release_date,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ':r': Decimal(rating)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReturnValues = "UPDATED_NEW"<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return response<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; update_response = update_serie(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Supernatural", 3, "2005-09-13", 8)<br />&nbsp;&nbsp;&nbsp; print("Series updated:")<br />&nbsp;&nbsp;&nbsp; pprint(update_response, sort_dicts = False) <br />Результатом будет сообщение в формате JSON с измененными данными.<br />Удаление записи<br />Создайте файл SeriesItemDelete.py и скопируйте в него следующий код:<br />from decimal import Decimal<br />from pprint import pprint<br />import boto3<br />from botocore.exceptions import ClientError<br />def delete_underrated_serie(title, series_id, rating):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = table.delete_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_id': series_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'title': title<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ConditionExpression = "info.rating &lt;= :val",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExpressionAttributeValues = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ":val": Decimal(rating)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; except ClientError as e:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if e.response['Error']['Code'] == "ConditionalCheckFailedException":<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(e.response['Error']['Message'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise<br />&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; print("Deleting...")<br />&nbsp;&nbsp;&nbsp; delete_response = delete_underrated_serie("Supernatural", 3, 8)<br />&nbsp;&nbsp;&nbsp; if delete_response:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Series data deleted:")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(delete_response, sort_dicts = False) <br />Убедитесь, что данные о сериале Supernatural удалены из таблицы.<br />Поиск по ключам партицирования и сортировки<br />Код поиска разместите в новом файле SeriesQuery.py:<br />from pprint import pprint<br />import boto3<br />from boto3.dynamodb.conditions import Key<br />def query_and_project_series(series_id, title_range):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; response = table.query(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectionExpression = "series_id, title, info.release_date",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyConditionExpression = Key('series_id').eq(series_id) &amp; Key('title').begins_with(title_range)<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return response['Items']<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; query_id = 3<br />&nbsp;&nbsp;&nbsp; query_range = 'T'<br />&nbsp;&nbsp;&nbsp; print(f"Series with ID = {query_id} and names beginning with "<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"{query_range}")<br />&nbsp;&nbsp;&nbsp; series = query_and_project_series(query_id, query_range)<br />&nbsp;&nbsp;&nbsp; for serie in series:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(f"\n{serie['series_id']} : {serie['title']}")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(serie['info']) <br />Результатом будет сообщение:<br />Series with ID = 3 and names beginning with T<br />3 : The Office<br />{'release_date': '2005-03-24T00:00:00Z'}<br />3 : True Detective<br />{'release_date': '2014-01-12T00:00:00Z'} <br />Запуск операции Scan<br />Создайте файл SeriesTableScan.py и скопируйте в него следующий код:<br />from pprint import pprint<br />import boto3<br />from boto3.dynamodb.conditions import Key<br />def scan_series(id_range, display_series):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; scan_kwargs = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'FilterExpression': Key('series_id').between(*id_range),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ProjectionExpression': "series_id, title, info.release_date"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; done = False<br />&nbsp;&nbsp;&nbsp; start_key = None<br />&nbsp;&nbsp;&nbsp; while not done:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if start_key:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scan_kwargs['ExclusiveStartKey'] = start_key<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = table.scan(**scan_kwargs)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; display_series(response.get('Items', []))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; start_key = response.get('LastEvaluatedKey', None)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; done = start_key is None<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; def print_series(series):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for serie in series:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(f"\n{serie['series_id']} : {serie['title']}")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(serie['info'])<br />&nbsp;&nbsp;&nbsp; query_range = (1, 3)<br />&nbsp;&nbsp;&nbsp; print(f"Series with IDs from {query_range[0]} to {query_range[1]}...")<br />&nbsp;&nbsp;&nbsp; scan_series(query_range, print_series) <br />Результатом будет сообщение:<br />Series with IDs from 1 to 3...<br />3 : House of Cards<br />{'release_date': '2013-02-01T00:00:00Z'}<br />3 : The Office<br />{'release_date': '2005-03-24T00:00:00Z'}<br />3 : True Detective<br />{'release_date': '2014-01-12T00:00:00Z'}<br />1 : IT Crowd<br />{'release_date': '2006-02-03T00:00:00Z'}<br />2 : Silicon Valley<br />{'release_date': '2014-04-06T00:00:00Z'} <br />Удаление таблицы<br />Создайте файл SeriesTableDelete.py и скопируйте в него следующий код:<br />import boto3<br />def delete_serie_table():<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; table.delete()<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; delete_serie_table()<br />&nbsp;&nbsp;&nbsp; print("Table Series deleted") <br />Убедитесь, что таблица удалена из базы данных.<br /><strong>Decision:</strong><br />$ pip install boto3<br />$ vim SeriesCreateTable.py<br />$ cat SeriesCreateTable.py<br />import boto3<br />def create_series_table():<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.create_table(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TableName = 'docapitest/series', # Series &mdash; имя таблицы <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeySchema = [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'series_id',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'KeyType': 'HASH'&nbsp; # Ключ партицирования<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'title',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'KeyType': 'RANGE'&nbsp; # Ключ сортировки<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AttributeDefinitions = [<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'series_id',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeType': 'N'&nbsp; # Целое число<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeName': 'title',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'AttributeType': 'S'&nbsp; # Строка<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return table<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; series_table = create_series_table()<br />&nbsp;&nbsp;&nbsp; print("Table status:", series_table.table_status)<br />$ python SeriesCreateTable.py<br />$ vim SeriesLoadData.py<br />$ cat SeriesLoadData.py<br />from decimal import Decimal<br />import json<br />import boto3<br />def load_series(series):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document API эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; for serie in series:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; series_id = int(serie['series_id'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; title = serie['title']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Series added:", series_id, title)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; table.put_item(Item = serie)<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; with open("seriesdata.json") as json_file:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; serie_list = json.load(json_file, parse_float = Decimal)<br />&nbsp;&nbsp;&nbsp; load_series(serie_list)<br />$ vim seriesdata.json<br />$ cat seriesdata.json<br />[{<br />&nbsp;&nbsp;&nbsp; "series_id": 1,<br />&nbsp;&nbsp;&nbsp; "title": "IT Crowd",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2006-02-03T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "The IT Crowd is a British sitcom produced by Channel 4, written by Graham Linehan, produced by Ash Atalla and starring Chris O'Dowd, Richard Ayoade, Katherine Parkinson, and Matt Berry"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 2,<br />&nbsp;&nbsp;&nbsp; "title": "Silicon Valley",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2014-04-06T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "Silicon Valley is an American comedy television series created by Mike Judge, John Altschuler and Dave Krinsky. The series focuses on five young men who founded a startup company in Silicon Valley"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 3,<br />&nbsp;&nbsp;&nbsp; "title": "House of Cards",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2013-02-01T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "House of Cards is an American political thriller streaming television series created by Beau Willimon. It is an adaptation of the 1990 BBC miniseries of the same name and based on the 1989 novel of the same name by Michael Dobbs"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 3,<br />&nbsp;&nbsp;&nbsp; "title": "The Office",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2005-03-24T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "The Office is an American mockumentary sitcom television series that depicts the everyday work lives of office employees in the Scranton, Pennsylvania, branch of the fictional Dunder Mifflin Paper Company"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 3,<br />&nbsp;&nbsp;&nbsp; "title": "True Detective",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2014-01-12T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "True Detective is an American anthology crime drama television series created and written by Nic Pizzolatto. The series, broadcast by the premium cable network HBO in the United States, premiered on January 12, 2014"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 4,<br />&nbsp;&nbsp;&nbsp; "title": "The Big Bang Theory",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "2007-09-24T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "The Big Bang Theory is an American television sitcom created by Chuck Lorre and Bill Prady, both of whom served as executive producers on the series, along with Steven Molaro"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; },<br />&nbsp; {<br />&nbsp;&nbsp;&nbsp; "series_id": 5,<br />&nbsp;&nbsp;&nbsp; "title": "Twin Peaks",<br />&nbsp;&nbsp;&nbsp; "info": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "release_date": "1990-04-08T00:00:00Z",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "series_info": "Twin Peaks is an American mystery horror drama television series created by Mark Frost and David Lynch that premiered on April 8, 1990, on ABC until its cancellation after its second season in 1991 before returning as a limited series in 2017 on Showtime"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; }<br />]<br />$ python SeriesLoadData.py<br />$ vim SeriesItemPut.py<br />$ cat SeriesItemPut.py<br />from pprint import pprint<br />import boto3<br />def put_serie(series_id, title, release_date, series_info):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; response = table.put_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Item = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_id': series_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'title': title,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'info': {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'release_date': release_date,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_info': series_info<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return response<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; serie_resp = put_serie(3, "Supernatural", "2015-09-13",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Supernatural is an American television series created by Eric Kripke")<br />&nbsp;&nbsp;&nbsp; print("Series added successfully:")<br />&nbsp;&nbsp;&nbsp; pprint(serie_resp, sort_dicts = False)<br />$ vim SeriesItemGet.py<br />$ cat SeriesItemGet.py<br />from pprint import pprint<br />import boto3<br />from botocore.exceptions import ClientError<br />def get_serie(title, series_id):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = table.get_item(Key = {'series_id': series_id, 'title': title})<br />&nbsp;&nbsp;&nbsp; except ClientError as e:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(e.response['Error']['Message'])<br />&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response['Item']<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; serie = get_serie("Supernatural", 3,)<br />&nbsp;&nbsp;&nbsp; if serie:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Record read:")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(serie, sort_dicts = False)<br />$ vim SeriesItemUpdate.py<br />$ cat SeriesItemUpdate.py<br />from decimal import Decimal<br />from pprint import pprint<br />import boto3<br />def update_serie(title, series_id, release_date,&nbsp; rating):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; response = table.update_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_id': series_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'title': title<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UpdateExpression = "set info.release_date = :d, info.rating = :r ",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExpressionAttributeValues = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ':d': release_date,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ':r': Decimal(rating)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReturnValues = "UPDATED_NEW"<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return response<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; update_response = update_serie(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Supernatural", 3, "2005-09-13", 8)<br />&nbsp;&nbsp;&nbsp; print("Series updated:")<br />&nbsp;&nbsp;&nbsp; pprint(update_response, sort_dicts = False)<br />$ vim SeriesItemDelete.py<br />$ cat SeriesItemDelete.py<br />from decimal import Decimal<br />from pprint import pprint<br />import boto3<br />from botocore.exceptions import ClientError<br />def delete_underrated_serie(title, series_id, rating):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = table.delete_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'series_id': series_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'title': title<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ConditionExpression = "info.rating &lt;= :val",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExpressionAttributeValues = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ":val": Decimal(rating)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; except ClientError as e:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if e.response['Error']['Code'] == "ConditionalCheckFailedException":<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(e.response['Error']['Message'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise<br />&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; print("Deleting...")<br />&nbsp;&nbsp;&nbsp; delete_response = delete_underrated_serie("Supernatural", 3, 8)<br />&nbsp;&nbsp;&nbsp; if delete_response:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Series data deleted:")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(delete_response, sort_dicts = False)<br />$ vim SeriesQuery.py<br />$ cat SeriesQuery.py<br />from pprint import pprint<br />import boto3<br />from boto3.dynamodb.conditions import Key<br />def query_and_project_series(series_id, title_range):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; response = table.query(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProjectionExpression = "series_id, title, info.release_date",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeyConditionExpression = Key('series_id').eq(series_id) &amp; Key('title').begins_with(title_range)<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return response['Items']<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; query_id = 3<br />&nbsp;&nbsp;&nbsp; query_range = 'T'<br />&nbsp;&nbsp;&nbsp; print(f"Series with ID = {query_id} and names beginning with "<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; f"{query_range}")<br />&nbsp;&nbsp;&nbsp; series = query_and_project_series(query_id, query_range)<br />&nbsp;&nbsp;&nbsp; for serie in series:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(f"\n{serie['series_id']} : {serie['title']}")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(serie['info'])<br />$ vim SeriesTableScan.py<br />$ cat SeriesTableScan.py<br />from pprint import pprint<br />import boto3<br />from boto3.dynamodb.conditions import Key<br />def scan_series(id_range, display_series):<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; scan_kwargs = {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'FilterExpression': Key('series_id').between(*id_range),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ProjectionExpression': "series_id, title, info.release_date"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; done = False<br />&nbsp;&nbsp;&nbsp; start_key = None<br />&nbsp;&nbsp;&nbsp; while not done:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if start_key:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scan_kwargs['ExclusiveStartKey'] = start_key<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = table.scan(**scan_kwargs)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; display_series(response.get('Items', []))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; start_key = response.get('LastEvaluatedKey', None)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; done = start_key is None<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; def print_series(series):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for serie in series:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(f"\n{serie['series_id']} : {serie['title']}")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pprint(serie['info'])<br />&nbsp;&nbsp;&nbsp; query_range = (1, 3)<br />&nbsp;&nbsp;&nbsp; print(f"Series with IDs from {query_range[0]} to {query_range[1]}...")<br />&nbsp;&nbsp;&nbsp; scan_series(query_range, print_series)<br />$ vim SeriesTableDelete.py<br />$ cat SeriesTableDelete.py<br />import boto3<br />def delete_serie_table():<br />&nbsp;&nbsp;&nbsp; ydb_docapi_client = boto3.resource('dynamodb', endpoint_url = "&lt;Document_API_эндпоинт&gt;")<br />&nbsp;&nbsp;&nbsp; table = ydb_docapi_client.Table('docapitest/series')<br />&nbsp;&nbsp;&nbsp; table.delete()<br />if __name__ == '__main__':<br />&nbsp;&nbsp;&nbsp; delete_serie_table()<br />&nbsp;&nbsp;&nbsp; print("Table Series deleted")<br /><strong>Task:</strong><br />Проверка доступности веб-ресурсов. <br />В этом уроке вы доработаете систему проверки доступности веб-ресурсов, которую создали на предыдущих практических занятиях. <br />В текущем варианте она проверяет только доступность сайта yandex.ru. <br />Теперь давайте добавим в неё возможность ставить задачи по проверке доступности других веб-ресурсов.<br /><strong>Decision:</strong><br />Общая архитектура системы. У системы есть два метода: CheckUrl &mdash; ставит задачу на проверку указанного URL. GetResult &mdash; считывает результаты проверки.<br />Метод CheckUrl обрабатывается функцией, которая будет складывать все запросы в очередь. Функция-обработчик будет вызываться раз в секунду, считывать URL из очереди,&nbsp; проверять его доступность и записывать результат в базу данных. Оттуда этот результат можно будет получить с помощью метода GetResult.<br />Мы не будем менять уже созданные функции и таблицу в PostgreSQL, сделаем новые.<br />Работать с YMQ из функций мы будем с помощью библиотеки boto3. Чтобы её использовать, нужно создать сервисный аккаунт с секретным ключом доступа, а затем настроить зависимости функции. Сделаем это после того, как создадим очередь.<br />Шаг 1. Проверить наличие сервисного аккаунта<br />Если вы ранее создавали сервисный аккаунт с именем service-account-for-cf, добавляли вновь созданному сервисному аккаунту роли editor и другие, то вам остаётся только создать ключ доступа:<br />yc iam access-key create --service-account-name service-account-for-cf <br />В результате вы получите примерно следующее:<br />&nbsp;&nbsp;&nbsp; access_key:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; id: ajefraollq5puj2tir1o<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account_id: ajetdv28pl0a1a8r41f0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; created_at: "2021-08-23T21:13:05.677319393Z"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; key_id: BTPNvWthv0ZX2xVmlPIU<br />&nbsp;&nbsp;&nbsp; secret: cWLQ0HrTM0k_qAac43cwMNJA8VV_rfTg_kd4xVPi <br />Здесь key_id &mdash; это идентификатор ключа доступа ACCESS_KEY. А secret &mdash; это секретный ключ SECRET_KEY. Переменные ACCESS_KEY и SECRET_KEY могут быть использованы для задания соответствующих значений aws_access_key_id и aws_secret_access_key при использовании библиотеки boto3.<br />Шаг 2. Создание очереди Yandex Message Queue<br />Вы можете создать очередь одним из трёх способов: через консоль управления; с помощью консольной утилиты aws; с помощью Terraform.<br />В этом уроке мы будем использовать консоль управления. Откройте раздел Message Queue и нажмите кнопку Создать очередь.<br />В настройках создаваемой очереди задайте имя очереди my-first-queue, затем выберите тип очереди Стандартная и нажмите кнопку Создать.<br />Очередь создана.<br />Теперь зайдите в настройки очереди, чтобы посмотреть параметры подключения к ней. Нам потребуется значение URL.<br />Шаг 3. Создание функции<br />Для создания функции зададим ряд переменных: VERBOSE_LOG &mdash; определяет, пишет ли функция подробности своего выполнения в журнал. AWS_ACCESS_KEY_ID &mdash; значение &laquo;Идентификатор ключа&raquo; из сервисного аккаунта, который мы сделали ранее. AWS_SECRET_ACCESS_KEY &mdash; значение &laquo;Секретный ключ&raquo; из того же сервисного аккаунта. QUEUE_URL &mdash; URL на очередь, его можно получить на обзорной странице созданной ранее очереди.<br />Чтобы задать переменные, в консоли выполните следующие команды:<br />echo "export VERBOSE_LOG=True" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export AWS_ACCESS_KEY_ID=&lt;AWS_ACCESS_KEY_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export AWS_SECRET_ACCESS_KEY=&lt;AWS_SECRET_ACCESS_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export QUEUE_URL=&lt;QUEUE_URL&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc <br />Воспользуйтесь командой pipreqs $PWD --force для формирования файла requirements.txt. Затем создайте функцию my-url-receiver-function.py:<br />import logging<br />import os<br />import boto3<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />queue_url = os.environ['QUEUE_URL']<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; # Get url<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url = event['queryStringParameters']['url']<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 400<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; # Create client<br />&nbsp;&nbsp;&nbsp; client = boto3.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='sqs',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://message-queue.api.cloud.yandex.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; # Send message to queue<br />&nbsp;&nbsp;&nbsp; client.send_message(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QueueUrl=queue_url,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBody=url<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; log('Successfully sent test message to queue')<br />&nbsp;&nbsp;&nbsp; statusCode = 200<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp; } <br />Перейдите в директорию с исходными файлами и упакуйте файлы с функцией и требованиями в ZIP-архив. При этом сразу задайте все необходимые переменные и сервисный аккаунт:<br />zip my-url-receiver-function my-url-receiver-function.py requirements.txt<br />yc serverless function create \<br />&nbsp; --name&nbsp; my-url-receiver-function \<br />&nbsp; --description "function for url"<br />yc serverless function version create \<br />&nbsp; --function-name=my-url-receiver-function \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=my-url-receiver-function.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --environment VERBOSE_LOG=$VERBOSE_LOG \<br />&nbsp; --environment AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \<br />&nbsp; --environment AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \<br />&nbsp; --environment QUEUE_URL=$QUEUE_URL \<br />&nbsp; --source-path my-url-receiver-function.zip <br />Тестирование функции. Находясь в вашем рабочем каталоге, перейдите в раздел Cloud Functions консоли управления и выберите ранее созданную функцию my-url-receiver-function. Перейдите на вкладку Тестирование в боковом меню, выберите шаблон HTTPS-вызов и замените раздел queryStringParameters:<br />&nbsp;&nbsp;&nbsp; "queryStringParameters": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "a": "2",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "b": "1",<br />&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp; &nbsp;<br />на аналогичный, но с параметром url с любым сайтом. Важно указывать ссылку целиком.<br />&nbsp;&nbsp;&nbsp; "queryStringParameters": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "url": "https://ya.ru/"<br />&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp; &nbsp;<br />Нажмите кнопку Запустить тест.<br />Если вы всё сделали правильно, то увидите код статуса 200. При этом в очереди увеличится количество сообщений.<br />Шаг 4. Обновление спецификации API Gateway<br />Функция готова, но по умолчанию она не является публичной. Предоставим доступ к ней с помощью API-шлюза. Для этого необходимо обновить ранее созданную спецификацию hello-world.yaml. Если у вас нет её под рукой, выгрузите её из облака:<br />yc serverless api-gateway get-spec \<br />&nbsp; --name hello-world &gt;&gt; hello-world-new.yaml <br />Внесите изменения, добавив секцию о ранее созданной функции:<br />&nbsp;&nbsp;&nbsp; /check:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud-functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id: &lt;идентификатор функции&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account_id: &lt;идентификатор сервисного аккаунта&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: add-url <br />Обновите конфигурацию:<br />yc serverless api-gateway update \<br />&nbsp; --name hello-world \<br />&nbsp; --spec=hello-world-new.yaml <br />Для тестирования выполните вызов функции в браузере:<br />https://&lt;идентификатор API Gateway&gt;.apigw.yandexcloud.net/check?url=https://ya.ru/ <br />После каждого запроса количество сообщений в очереди будет увеличиваться на одно.<br />Шаг 5. Создание функции для чтения из очереди<br />В предыдущих работах мы создавали функцию, использующую подключение к БД. Здесь мы повторим этот опыт.<br />Проверим, что нам доступны переменные для инициации подключения: CONNECTION_ID, DB_USER, DB_HOST. Мы создавали их в предыдущей работе с помощью следующих команд:<br />echo "export CONNECTION_ID=&lt;CONNECTION_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export DB_USER=&lt;DB_USER&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo "export DB_HOST=&lt;DB_HOST&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc <br />Также для работы с очередью нам потребуются переменные VERBOSE_LOG, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY и QUEUE_URL, заданные на предыдущих шагах.<br />Создадим функцию function-for-url-from-mq.py и воспользуемся командой pipreqs $PWD --force, чтобы сформировать для нее файл requirements.txt.<br />import logging<br />import os<br />import boto3<br />import datetime<br />import requests<br />#Эти библиотеки нужны для работы с PostgreSQL<br />import psycopg2<br />import psycopg2.errors<br />import psycopg2.extras<br />CONNECTION_ID = os.getenv("CONNECTION_ID")<br />DB_USER = os.getenv("DB_USER")<br />DB_HOST = os.getenv("DB_HOST")<br />QUEUE_URL = os.environ['QUEUE_URL']<br /># Настраиваем функцию для записи информации в журнал функции<br /># Получаем стандартный логер языка Python<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br /># Вычитываем переменную VERBOSE_LOG, которую мы указываем в переменных окружения <br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />#Функция log, которая запишет текст в журнал выполнения функции, если в переменной окружения VERBOSE_LOG будет значение True<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />#Получаем подключение<br />def getConnString(context):<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; Extract env variables to connect to DB and return a db string<br />&nbsp;&nbsp;&nbsp; Raise an error if the env variables are not set<br />&nbsp;&nbsp;&nbsp; :return: string<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")<br />&nbsp;&nbsp;&nbsp; return connection<br />"""<br />&nbsp;&nbsp;&nbsp; Create SQL query with table creation<br />"""<br />def makeCreateDataTableQuery(table_name):<br />&nbsp;&nbsp;&nbsp; query = f"""CREATE TABLE public.{table_name} (<br />&nbsp;&nbsp;&nbsp; url text,<br />&nbsp;&nbsp;&nbsp; result integer,<br />&nbsp;&nbsp;&nbsp; time float<br />&nbsp;&nbsp;&nbsp; )"""<br />&nbsp;&nbsp;&nbsp; return query<br />def makeInsertDataQuery(table_name, url, result, time):<br />&nbsp;&nbsp;&nbsp; query = f"""INSERT INTO {table_name} <br />&nbsp;&nbsp;&nbsp; (url, result,time)<br />&nbsp;&nbsp;&nbsp; VALUES('{url}', {result}, {time})<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; return query<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; # Create client<br />&nbsp;&nbsp;&nbsp; client = boto3.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='sqs',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://message-queue.api.cloud.yandex.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; # Receive sent message<br />&nbsp;&nbsp;&nbsp; messages = client.receive_message(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QueueUrl=QUEUE_URL,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MaxNumberOfMessages=1,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VisibilityTimeout=60,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WaitTimeSeconds=1<br />&nbsp;&nbsp;&nbsp; ).get('Messages')<br />&nbsp;&nbsp;&nbsp; if messages is None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; for msg in messages:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('Received message: "{}"'.format(msg.get('Body')))<br />&nbsp;&nbsp;&nbsp; # Get url from message<br />&nbsp;&nbsp;&nbsp; url = msg.get('Body');<br />&nbsp;&nbsp;&nbsp; # Check url<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now = datetime.datetime.now()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = requests.get(url, timeout=(1.0000, 3.0000))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; timediff = datetime.datetime.now() - now<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = response.status_code<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ReadTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 601<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ConnectTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 602<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.Timeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 603<br />&nbsp;&nbsp;&nbsp; log(f'Result: {result} Time: {timediff.total_seconds()}')<br />&nbsp;&nbsp;&nbsp; connection = getConnString(context)<br />&nbsp;&nbsp;&nbsp; log(f'Connecting: {connection}')&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()<br />&nbsp;&nbsp;&nbsp; table_name = 'custom_request_result'<br />&nbsp;&nbsp;&nbsp; sql = makeInsertDataQuery(table_name, url, result, timediff.total_seconds())<br />&nbsp;&nbsp;&nbsp; log(f'Exec: {sql}')<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(sql)<br />&nbsp;&nbsp;&nbsp; except psycopg2.errors.UndefinedTable as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(f'Table not exist - create and repeate insert')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.rollback()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; createTable = makeCreateDataTableQuery(table_name)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(f'Exec: {createTable}')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(createTable)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.commit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(f'Exec: {sql}')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(sql)<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error( error)<br />&nbsp;&nbsp;&nbsp; connection.commit()<br />&nbsp;&nbsp;&nbsp; cursor.close()<br />&nbsp;&nbsp;&nbsp; connection.close()<br />&nbsp;&nbsp;&nbsp; # Delete processed messages<br />&nbsp;&nbsp;&nbsp; for msg in messages:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; client.delete_message(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QueueUrl=QUEUE_URL,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReceiptHandle=msg.get('ReceiptHandle')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print('Successfully deleted message by receipt handle "{}"'.format(msg.get('ReceiptHandle')))<br />&nbsp;&nbsp;&nbsp; statusCode = 200<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp; } <br />При создании сразу задайте все необходимые переменные и сервисный аккаунт:<br />zip function-for-url-from-mq function-for-url-from-mq.py requirements.txt<br />yc serverless function create \<br />&nbsp; --name function-for-url-from-mq \<br />&nbsp; --description "function for url from mq"<br />yc serverless function version create \<br />&nbsp; --function-name=function-for-url-from-mq \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=function-for-url-from-mq.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --environment VERBOSE_LOG=True \<br />&nbsp; --environment CONNECTION_ID=$CONNECTION_ID \<br />&nbsp; --environment DB_USER=$DB_USER \<br />&nbsp; --environment DB_HOST=$DB_HOST \<br />&nbsp; --environment AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \<br />&nbsp; --environment AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \<br />&nbsp; --environment QUEUE_URL=$QUEUE_URL \<br />&nbsp; --source-path function-for-url-from-mq.zip <br />Протестируйте функцию.<br />После её выполнения количество сообщений в очереди уменьшится, а в базе данных появится новая таблица с результатами тестирования доступности функции.<br />Шаг 6. Создание триггера<br />Создадим триггер, который будет вызывать функцию обработки сообщений из очереди один раз в минуту. Он будет использовать cron-выражение:<br />yc serverless trigger create timer \<br />&nbsp; --name trigger-for-mq \<br />&nbsp; --invoke-function-name function-for-url-from-mq \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --cron-expression '* * * * ? *' <br />Cron-выражение * * * * ? * означает вызов функции function-for-url-from-mq один раз в минуту. Подробнее про cron-выражения можно прочитать в документации.<br />Теперь у нас есть функция, которая раз в минуту будет пробовать взять из очереди URL и проверить его. Также есть метод REST API, который позволяет записывать URL в очередь независимо от работы обработчика. Мы можем вызывать созданный метод как угодно часто. Очередь будет просто накапливаться, а затем обработчик будет постепенно её разбирать.<br />В итоге вы получили асинхронную систему проверки доступности URL с доступом по REST API. Вы не создали ни одной виртуальной машины, но решили вопросы масштабирования и отказоустойчивости системы.<br />Удаление триггера-таймера<br />По завершении практической работы не забудьте удалить созданный вами триггер trigger-for-mq, иначе он будет работать, пока не исчерпает деньги на аккаунте:<br />yc serverless trigger delete trigger-for-mq <br />Не забудьте удалить или остановить все созданные вами ресурсы: триггеры, очереди YMQ и кластер базы данных.<br /><strong>Decision:</strong><br />$ yc iam access-key create --service-account-name service-account-for-cf<br />$ echo "export VERBOSE_LOG=True" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export AWS_ACCESS_KEY_ID=&lt;AWS_ACCESS_KEY_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export AWS_SECRET_ACCESS_KEY=&lt;AWS_SECRET_ACCESS_KEY&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export QUEUE_URL=&lt;QUEUE_URL&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ vim my-url-receiver-function.py<br />$ cat my-url-receiver-function.py<br />import logging<br />import os<br />import boto3<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />queue_url = os.environ['QUEUE_URL']<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; # Get url<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url = event['queryStringParameters']['url']<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; statusCode = 400<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; # Create client<br />&nbsp;&nbsp;&nbsp; client = boto3.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='sqs',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://message-queue.api.cloud.yandex.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; # Send message to queue<br />&nbsp;&nbsp;&nbsp; client.send_message(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QueueUrl=queue_url,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MessageBody=url<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; log('Successfully sent test message to queue')<br />&nbsp;&nbsp;&nbsp; statusCode = 200<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp; }<br />$ touch requirements.txt<br />$ pipreqs $PWD --force<br />$ zip my-url-receiver-function my-url-receiver-function.py requirements.txt<br />$ yc serverless function create \<br />&nbsp;&nbsp;&nbsp; --name&nbsp; my-url-receiver-function \<br />&nbsp;&nbsp;&nbsp; --description "function for url"<br />$ yc serverless function version create \<br />&nbsp;&nbsp;&nbsp; --function-name=my-url-receiver-function \<br />&nbsp;&nbsp;&nbsp; --memory=256m \<br />&nbsp;&nbsp;&nbsp; --execution-timeout=5s \<br />&nbsp;&nbsp;&nbsp; --runtime=python37 \<br />&nbsp;&nbsp;&nbsp; --entrypoint=my-url-receiver-function.handler \<br />&nbsp;&nbsp;&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp;&nbsp;&nbsp; --environment VERBOSE_LOG=$VERBOSE_LOG \<br />&nbsp;&nbsp;&nbsp; --environment AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \<br />&nbsp;&nbsp;&nbsp; --environment AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \<br />&nbsp;&nbsp;&nbsp; --environment QUEUE_URL=$QUEUE_URL \<br />&nbsp;&nbsp;&nbsp; --source-path my-url-receiver-function.zip<br />$ yc serverless api-gateway get-spec \<br />&nbsp;&nbsp;&nbsp; --name hello-world &gt;&gt; hello-world-new.yaml<br />$ vim hello-world-new.yaml <br />$ cat hello-world-new.yaml <br />openapi: "3.0.0"<br />info:<br />&nbsp; version: 1.0.0<br />&nbsp; title: Test API<br />paths:<br />&nbsp; /hello:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; summary: Say hello<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: hello<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parameters:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - name: user<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in: query<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description: User name to appear in greetings<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; required: false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default: 'world'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; responses:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '200':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; description: Greeting<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text/plain':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: "string"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: dummy<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http_code: 200<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; http_headers:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Content-Type': "text/plain"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; content:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'text/plain': "Hello, {user}!\n"<br />&nbsp;&nbsp;&nbsp; /check:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud-functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id: &lt;идентификатор функции&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account_id: &lt;идентификатор сервисного аккаунта&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: add-url<br />$ yc serverless api-gateway update \<br />&nbsp; --name hello-world \<br />&nbsp; --spec=hello-world-new.yaml<br />$ echo "export CONNECTION_ID=&lt;CONNECTION_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export DB_USER=&lt;DB_USER&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo "export DB_HOST=&lt;DB_HOST&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ vim function-for-url-from-mq.py<br />$ cat function-for-url-from-mq.py<br />import logging<br />import os<br />import boto3<br />import datetime<br />import requests<br />#Эти библиотеки нужны для работы с PostgreSQL<br />import psycopg2<br />import psycopg2.errors<br />import psycopg2.extras<br />CONNECTION_ID = os.getenv("CONNECTION_ID")<br />DB_USER = os.getenv("DB_USER")<br />DB_HOST = os.getenv("DB_HOST")<br />QUEUE_URL = os.environ['QUEUE_URL']<br /># Настраиваем функцию для записи информации в журнал функции<br /># Получаем стандартный логер языка Python<br />logger = logging.getLogger()<br />logger.setLevel(logging.INFO)<br /># Вычитываем переменную VERBOSE_LOG, которую мы указываем в переменных окружения <br />verboseLogging = eval(os.environ['VERBOSE_LOG'])&nbsp; ## Convert to bool<br />#Функция log, которая запишет текст в журнал выполнения функции, если в переменной окружения VERBOSE_LOG будет значение True<br />def log(logString):<br />&nbsp;&nbsp;&nbsp; if verboseLogging:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.info(logString)<br />#Получаем подключение<br />def getConnString(context):<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; Extract env variables to connect to DB and return a db string<br />&nbsp;&nbsp;&nbsp; Raise an error if the env variables are not set<br />&nbsp;&nbsp;&nbsp; :return: string<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; connection = psycopg2.connect(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database=CONNECTION_ID, # Идентификатор подключения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; user=DB_USER, # Пользователь БД<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; password=context.token["access_token"],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host=DB_HOST, # Точка входа<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; port=6432,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sslmode="require")<br />&nbsp;&nbsp;&nbsp; return connection<br />"""<br />&nbsp;&nbsp;&nbsp; Create SQL query with table creation<br />"""<br />def makeCreateDataTableQuery(table_name):<br />&nbsp;&nbsp;&nbsp; query = f"""CREATE TABLE public.{table_name} (<br />&nbsp;&nbsp;&nbsp; url text,<br />&nbsp;&nbsp;&nbsp; result integer,<br />&nbsp;&nbsp;&nbsp; time float<br />&nbsp;&nbsp;&nbsp; )"""<br />&nbsp;&nbsp;&nbsp; return query<br />def makeInsertDataQuery(table_name, url, result, time):<br />&nbsp;&nbsp;&nbsp; query = f"""INSERT INTO {table_name} <br />&nbsp;&nbsp;&nbsp; (url, result,time)<br />&nbsp;&nbsp;&nbsp; VALUES('{url}', {result}, {time})<br />&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; return query<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; # Create client<br />&nbsp;&nbsp;&nbsp; client = boto3.client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='sqs',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://message-queue.api.cloud.yandex.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; # Receive sent message<br />&nbsp;&nbsp;&nbsp; messages = client.receive_message(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QueueUrl=QUEUE_URL,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MaxNumberOfMessages=1,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VisibilityTimeout=60,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WaitTimeSeconds=1<br />&nbsp;&nbsp;&nbsp; ).get('Messages')<br />&nbsp;&nbsp;&nbsp; if messages is None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': 200<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; for msg in messages:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log('Received message: "{}"'.format(msg.get('Body')))<br />&nbsp;&nbsp;&nbsp; # Get url from message<br />&nbsp;&nbsp;&nbsp; url = msg.get('Body');<br />&nbsp;&nbsp;&nbsp; # Check url<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; now = datetime.datetime.now()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; response = requests.get(url, timeout=(1.0000, 3.0000))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; timediff = datetime.datetime.now() - now<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = response.status_code<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ReadTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 601<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.ConnectTimeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 602<br />&nbsp;&nbsp;&nbsp; except requests.exceptions.Timeout:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result = 603<br />&nbsp;&nbsp;&nbsp; log(f'Result: {result} Time: {timediff.total_seconds()}')<br />&nbsp;&nbsp;&nbsp; connection = getConnString(context)<br />&nbsp;&nbsp;&nbsp; log(f'Connecting: {connection}')&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; cursor = connection.cursor()<br />&nbsp;&nbsp;&nbsp; table_name = 'custom_request_result'<br />&nbsp;&nbsp;&nbsp; sql = makeInsertDataQuery(table_name, url, result, timediff.total_seconds())<br />&nbsp;&nbsp;&nbsp; log(f'Exec: {sql}')<br />&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(sql)<br />&nbsp;&nbsp;&nbsp; except psycopg2.errors.UndefinedTable as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(f'Table not exist - create and repeate insert')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.rollback()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error(error)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; createTable = makeCreateDataTableQuery(table_name)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(f'Exec: {createTable}')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(createTable)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; connection.commit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; log(f'Exec: {sql}')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cursor.execute(sql)<br />&nbsp;&nbsp;&nbsp; except Exception as error:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.error( error)<br />&nbsp;&nbsp;&nbsp; connection.commit()<br />&nbsp;&nbsp;&nbsp; cursor.close()<br />&nbsp;&nbsp;&nbsp; connection.close()<br />&nbsp;&nbsp;&nbsp; # Delete processed messages<br />&nbsp;&nbsp;&nbsp; for msg in messages:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; client.delete_message(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QueueUrl=QUEUE_URL,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ReceiptHandle=msg.get('ReceiptHandle')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print('Successfully deleted message by receipt handle "{}"'.format(msg.get('ReceiptHandle')))<br />&nbsp;&nbsp;&nbsp; statusCode = 200<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode<br />&nbsp;&nbsp;&nbsp; }<br />$ zip function-for-url-from-mq function-for-url-from-mq.py requirements.txt<br />$ yc serverless function create \<br />&nbsp; --name function-for-url-from-mq \<br />&nbsp; --description "function for url from mq"<br />$ yc serverless function version create \<br />&nbsp; --function-name=function-for-url-from-mq \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=function-for-url-from-mq.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --environment VERBOSE_LOG=True \<br />&nbsp; --environment CONNECTION_ID=$CONNECTION_ID \<br />&nbsp; --environment DB_USER=$DB_USER \<br />&nbsp; --environment DB_HOST=$DB_HOST \<br />&nbsp; --environment AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \<br />&nbsp; --environment AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \<br />&nbsp; --environment QUEUE_URL=$QUEUE_URL \<br />&nbsp; --source-path function-for-url-from-mq.zip<br />$ yc serverless trigger create timer \<br />&nbsp; --name trigger-for-mq \<br />&nbsp; --invoke-function-name function-for-url-from-mq \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_ID \<br />&nbsp; --cron-expression '* * * * ? *'<br />$ yc serverless trigger delete trigger-for-mq<br /><strong>Task:</strong><br />Однократная отправка сообщений<br />В этой практической работе мы реализуем проект, который позволит пользователям конвертировать видеофайлы в GIF. <br />Такая задача хорошо подходит для Cloud Functions, потому что конвертирование отнимает немало ресурсов процессора, и чем качественнее видео, тем больше ресурсов требуется на его обработку.<br />Почему для решения этой задачи нужны очереди?<br />Представим, что мы попытались решить эту задачу &laquo;в лоб&raquo;. Пользователь заходит на страницу и вводит ссылку на видеофайл. Сервис скачивает его, конвертирует и отдает ссылку на GIF. Возникают две серьёзные проблемы:<br />Синхронное соединение не всегда стабильно. Чем дольше вы его держите, тем выше вероятность, что оно разорвётся. В этом случае всё придётся сделать заново. А если соединение нестабильно, то пользователь может и не дождаться результата.<br />Задача ресурсоёмкая: если сервисом одновременно воспользуются много пользователей с большими видеороликами, мощностей может не хватить.<br />Чтобы избежать этих проблем, в архитектуру сервиса необходимо встроить очередь.<br /><strong>Decision:</strong><br />Шаг 1. Сервисный аккаунт и Lockbox<br />Создание сервисного аккаунта<br />Создайте сервисный аккаунт с именем ffmpeg-account-for-cf:<br />export SERVICE_ACCOUNT=$(yc iam service-account create --name ffmpeg-account-for-cf \<br />&nbsp; --description "service account for serverless" \<br />&nbsp; --format json | jq -r .) <br />Проверьте текущий список сервисных аккаунтов:<br />yc iam service-account list <br />После проверки запишите ID созданного сервисного аккаунта в переменную SERVICE_ACCOUNT_ID:<br />echo "export SERVICE_ACCOUNT_FFMPEG_ID=&lt;ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $SERVICE_ACCOUNT_FFMPEG_ID <br />Назначение роли сервисному аккаунту<br />Добавим вновь созданному сервисному аккаунту роли storage.viewer, storage.uploader, ymq.reader, ymq.writer, ydb.admin, serverless.functions.invoker, и lockbox.payloadViewer:<br />echo "export FOLDER_ID=$(yc config get folder-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $FOLDER_ID<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role storage.viewer<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role storage.uploader<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role ymq.reader<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role ymq.writer<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role ydb.admin<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role serverless.functions.invoker<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role lockbox.payloadViewer<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role editor <br />Вы можете назначить несколько ролей и с помощью команды set-access-binding. Но эта команда полностью перезаписывает права доступа к ресурсу и все текущие роли на него будут удалены! Поэтому сначала убедитесь, что ресурсу не назначены роли, которые вы не хотите потерять:<br />yc resource-manager folder list-access-bindings $FOLDER_ID<br />yc resource-manager folder set-access-bindings $FOLDER_ID \<br />&nbsp; --access-binding role=storage.viewer,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=storage.uploader,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=ymq.reader,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=ymq.writer,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=ydb.admin,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=serverless.functions.invoker,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=lockbox.payloadViewer,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=editor,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID <br />Создание ключа доступа для сервисного аккаунта<br />Этот этап нужен для получения идентификатора ключа доступа и секретного ключа, которые будут использованы для загрузки файлов в Object Storage, работы с Yandex Message Queue и т. д. Для создания ключа доступа необходимо вызвать следующую команду:<br />yc iam access-key create --service-account-name ffmpeg-account-for-cf <br />В результате вы получите примерно следующее:<br />&nbsp;&nbsp;&nbsp; access_key:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; id: ajefraollq5puj2tir1o<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account_id: ajetdv28pl0a1a8r41f0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; created_at: "2021-08-23T21:13:05.677319393Z"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; key_id: BTPNvWthv0ZX2xVmlPIU<br />&nbsp;&nbsp;&nbsp; secret: cWLQ0HrTM0k_qAac43cwMNJA8VV_rfTg_kd4xVPi <br />Здесь key_id &mdash; это идентификатор ключа доступа ACCESS_KEY_ID. А secret &mdash; это секретный ключ SECRET_ACCESS_KEY. Переменные ACCESS_KEY_ID и SECRET_ACCESS_KEY могут быть использованы для задания соответствующих значений aws_access_key_id и aws_secret_access_key при использовании библиотеки boto3.<br />Создание элемента в сервисе Lockbox<br />В сервисе Lockbox (находится на стадии Preview) создайте ваш первый секрет, состоящий из набора версий, в которых хранятся ваши данные. Версия содержит наборы ключей и значений:<br />&nbsp;&nbsp;&nbsp; Ключ &mdash; несекретное название для значения, по которому вы будете его идентифицировать.<br />&nbsp;&nbsp;&nbsp; Значение &mdash; это секретные данные.<br />Версия не изменяется. Для любого изменения количества пар ключей-значений или их содержимого необходимо создать новую версию. Создадим секрет с именем ffmpeg-sa-key и парой ключей ACCESS_KEY_ID и SECRET_ACCESS_KEY:<br />yc lockbox secret create --name ffmpeg-sa-key \<br />&nbsp; --folder-id $FOLDER_ID \<br />&nbsp; --description "keys for serverless" \<br />&nbsp; --payload '[{"key": "ACCESS_KEY_ID", "text_value": &lt;ACCESS_KEY_ID&gt;}, {"key": "SECRET_ACCESS_KEY", "text_value": "&lt;SECRET_ACCESS_KEY&gt;"}]' <br />Получим и запишем значение SECRET_ID, оно нам потребуется при создании функции:<br />yc lockbox secret list<br />yc lockbox secret get --name ffmpeg-sa-key<br />echo "export SECRET_ID=&lt;SECRET_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $SECRET_ID <br />Шаг 2. Создание очереди Yandex Message Queue<br />Для создания очереди Yandex Message Queue вы можете использовать три разных способа:<br />&nbsp;&nbsp;&nbsp; консоль управления;<br />&nbsp;&nbsp;&nbsp; консольная утилита aws;<br />&nbsp;&nbsp;&nbsp; Terraform.<br />Создание очереди с помощью утилиты aws<br />Воспользуемся AWS CLI. Для начала задайте конфигурацию с помощью команды aws configure. При этом от вас потребуется ввести:<br />&nbsp;&nbsp;&nbsp; AWS Access Key ID &mdash; идентификатор ключа доступа key_id сервисного аккаунта, полученный на предыдущем шаге.<br />&nbsp;&nbsp;&nbsp; AWS Secret Access Key &mdash; секретный ключ secret сервисного аккаунта, полученный на предыдущем шаге.<br />&nbsp;&nbsp;&nbsp; Default region name &mdash; используйте значение ru-central1.<br />По завершению конфигурации вы сможете создать очередь:<br />aws configure<br />aws sqs create-queue --queue-name ffmpeg --endpoint https://message-queue.api.cloud.yandex.net/ <br />В результате успешного выполнения предыдущей команды в ответ вы получите URL:<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "QueueUrl": "https://message-queue.api.cloud.yandex.net/b1ga4gj7agij03ln6aov/dj6000000003kv2t02b3/ffmpeg"<br />&nbsp;&nbsp;&nbsp; } <br />Запишем значения URL в переменную YMQ_QUEUE_URL. Она потребуется нам при создании функции:<br />echo "export YMQ_QUEUE_URL=&lt;YMQ_QUEUE_URL&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $YMQ_QUEUE_URL <br />Ещё вам потребует значение атрибута QueueArn, получим его:<br />aws sqs get-queue-attributes \<br />&nbsp; --endpoint https://message-queue.api.cloud.yandex.net \<br />&nbsp; --queue-url $YMQ_QUEUE_URL \<br />&nbsp; --attribute-names QueueArn <br />В результате вы получите ответ вида:<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "Attributes": {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "QueueArn": "yrn:yc:ymq:ru-central1:b1gl21bkgss4msekt08i:ffmpeg"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; } <br />Сохраним значение QueueArn в переменную YMQ_QUEUE_ARN:<br />echo "export YMQ_QUEUE_ARN=&lt;YMQ_QUEUE_ARN&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $YMQ_QUEUE_ARN <br />Шаг 3. Создание базы данных в сервисе Yandex Database<br />Создадим базу данных YDB с именем ffmpeg и типом serverless, используя для этого флаг --serverless:<br />yc ydb database create ffmpeg \<br />&nbsp; --serverless \<br />&nbsp; --folder-id $FOLDER_ID<br />yc ydb database list <br />Сразу получим и сохраним document_api_endpoint в значение переменной DOCAPI_ENDPOINT:<br />yc ydb database get --name ffmpeg<br />echo "export DOCAPI_ENDPOINT=&lt;DOCAPI_ENDPOINT&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $DOCAPI_ENDPOINT <br />Как только база данных создана, воспользуемся ранее использованной утилитой AWS CLI для создания документной таблицы в этой базе данных. Всю конфигурацию возьмем из файла tasks.json:<br />{<br />&nbsp; "AttributeDefinitions": [<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "AttributeName": "task_id",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "AttributeType": "S"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; ],<br />&nbsp; "KeySchema": [<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "AttributeName": "task_id",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "KeyType": "HASH"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; ],<br />&nbsp; "TableName": "tasks"<br />} <br />Находясь в одном каталоге с файлом tasks.json, вызовите следующую команду для создания таблицы:<br />aws dynamodb create-table \<br />&nbsp; --cli-input-json file://tasks.json \<br />&nbsp; --endpoint-url $DOCAPI_ENDPOINT \<br />&nbsp; --region ru-central1 <br />В консоли управления убедитесь, что БД ffmpeg создана, и в ней есть пустая таблица tasks.<br />Шаг 4. Создание бакета в сервисе Object Storage<br />Самый простой способ создания бакета в Object Storage &mdash; это использование консоли управления.<br />В консоли управления в вашем рабочем каталоге выберите сервис Object Storage. Нажмите кнопку Создать бакет. На странице создания бакета введите имя, в нашем примере это будет storage-for-ffmpeg, остальные параметры не меняйте.<br />Нажмите кнопку Создать бакет для завершения операции. Далее вы всегда сможете поменять класс хранилища, его размер и настройки доступа.<br />Сохраним название бакета для дальнейшего использования:<br />echo "export S3_BUCKET=&lt;имя бакета&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $S3_BUCKET <br />Шаг 5. Создание функций<br />При создании функций нам потребуется ряд переменных:<br />&nbsp;&nbsp;&nbsp; SECRET_ID &mdash; идентификатор секрета (можно получить из таблицы со списком секретов);<br />&nbsp;&nbsp;&nbsp; YMQ_QUEUE_URL &mdash; URL очереди (можно получить на странице обзора);<br />&nbsp;&nbsp;&nbsp; DOCAPI_ENDPOINT &mdash; его можно получить на странице обзора БД, нужен именно Document API;<br />&nbsp;&nbsp;&nbsp; S3_BUCKET &mdash; имя бакета, в нашем случае это storage-for-ffmpeg.<br />Проверим заданные ранее переменные:<br />echo $SERVICE_ACCOUNT_FFMPEG_ID<br />echo $SECRET_ID<br />echo $YMQ_QUEUE_URL<br />echo $DOCAPI_ENDPOINT<br />echo $S3_BUCKET <br />Для обработки видео нам потребуется утилита FFmpeg. Скачайте статический релизный бинарный файл для Linux amd64 на сайте ffmpeg.org. Обычно он находится в разделе FFmpeg Static Builds и называется примерно так: ffmpeg-release-amd64-static.tar.xz. Распакуйте архив. Из него вам понадобится только файл ffmpeg. Поскольку есть ограничение на размер&nbsp; файла, который можно приложить через консоль, загрузим код функций и ffmpeg в Object Storage.<br />Исходный код в файле index.py содержит обе необходимые нам функции:<br />import json<br />import os<br />import subprocess<br />import uuid<br />from urllib.parse import urlencode<br />import boto3<br />import requests<br />import yandexcloud<br />from yandex.cloud.lockbox.v1.payload_service_pb2 import GetPayloadRequest<br />from yandex.cloud.lockbox.v1.payload_service_pb2_grpc import PayloadServiceStub<br />boto_session = None<br />storage_client = None<br />docapi_table = None<br />ymq_queue = None<br />def get_boto_session():<br />&nbsp;&nbsp;&nbsp; global boto_session<br />&nbsp;&nbsp;&nbsp; if boto_session is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return boto_session<br />&nbsp;&nbsp;&nbsp; # initialize lockbox and read secret value<br />&nbsp;&nbsp;&nbsp; yc_sdk = yandexcloud.SDK()<br />&nbsp;&nbsp;&nbsp; channel = yc_sdk._channels.channel("lockbox-payload")<br />&nbsp;&nbsp;&nbsp; lockbox = PayloadServiceStub(channel)<br />&nbsp;&nbsp;&nbsp; response = lockbox.Get(GetPayloadRequest(secret_id=os.environ['SECRET_ID']))<br />&nbsp;&nbsp;&nbsp; # extract values from secret<br />&nbsp;&nbsp;&nbsp; access_key = None<br />&nbsp;&nbsp;&nbsp; secret_key = None<br />&nbsp;&nbsp;&nbsp; for entry in response.entries:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if entry.key == 'ACCESS_KEY_ID':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; access_key = entry.text_value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; elif entry.key == 'SECRET_ACCESS_KEY':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; secret_key = entry.text_value<br />&nbsp;&nbsp;&nbsp; if access_key is None or secret_key is None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise Exception("secrets required")<br />&nbsp;&nbsp;&nbsp; print("Key id: " + access_key)<br />&nbsp;&nbsp;&nbsp; # initialize boto session<br />&nbsp;&nbsp;&nbsp; boto_session = boto3.session.Session(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_access_key_id=access_key,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_secret_access_key=secret_key<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return boto_session<br />def get_ymq_queue():<br />&nbsp;&nbsp;&nbsp; global ymq_queue<br />&nbsp;&nbsp;&nbsp; if ymq_queue is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ymq_queue<br />&nbsp;&nbsp;&nbsp; ymq_queue = get_boto_session().resource(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='sqs',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://message-queue.api.cloud.yandex.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; ).Queue(os.environ['YMQ_QUEUE_URL'])<br />&nbsp;&nbsp;&nbsp; return ymq_queue<br />def get_docapi_table():<br />&nbsp;&nbsp;&nbsp; global docapi_table<br />&nbsp;&nbsp;&nbsp; if docapi_table is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return docapi_table<br />&nbsp;&nbsp;&nbsp; docapi_table = get_boto_session().resource(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'dynamodb',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url=os.environ['DOCAPI_ENDPOINT'],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; ).Table('tasks')<br />&nbsp;&nbsp;&nbsp; return docapi_table<br />def get_storage_client():<br />&nbsp;&nbsp;&nbsp; global storage_client<br />&nbsp;&nbsp;&nbsp; if storage_client is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return storage_client<br />&nbsp;&nbsp;&nbsp; storage_client = get_boto_session().client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='s3',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://storage.yandexcloud.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return storage_client<br /># API handler<br />def create_task(src_url):<br />&nbsp;&nbsp;&nbsp; task_id = str(uuid.uuid4())<br />&nbsp;&nbsp;&nbsp; get_docapi_table().put_item(Item={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'task_id': task_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ready': False<br />&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp; get_ymq_queue().send_message(MessageBody=json.dumps({'task_id': task_id, "src": src_url}))<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'task_id': task_id<br />&nbsp;&nbsp;&nbsp; }<br />def get_task_status(task_id):<br />&nbsp;&nbsp;&nbsp; task = get_docapi_table().get_item(Key={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "task_id": task_id<br />&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp; if task['Item']['ready']:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ready': True,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'gif_url': task['Item']['gif_url']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; return {'ready': False}<br />def handle_api(event, context):<br />&nbsp;&nbsp;&nbsp; action = event['action']<br />&nbsp;&nbsp;&nbsp; if action == 'convert':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return create_task(event['src_url'])<br />&nbsp;&nbsp;&nbsp; elif action == 'get_task_status':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return get_task_status(event['task_id'])<br />&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {"error": "unknown action: " + action}<br /># Converter handler<br />def download_from_ya_disk(public_key, dst):<br />&nbsp;&nbsp;&nbsp; api_call_url = 'https://cloud-api.yandex.net/v1/disk/public/resources/download?' + \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; urlencode(dict(public_key=public_key))<br />&nbsp;&nbsp;&nbsp; response = requests.get(api_call_url)<br />&nbsp;&nbsp;&nbsp; download_url = response.json()['href']<br />&nbsp;&nbsp;&nbsp; download_response = requests.get(download_url)<br />&nbsp;&nbsp;&nbsp; with open(dst, 'wb') as video_file:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; video_file.write(download_response.content)<br />def upload_and_presign(file_path, object_name):<br />&nbsp;&nbsp;&nbsp; client = get_storage_client()<br />&nbsp;&nbsp;&nbsp; bucket = os.environ['S3_BUCKET']<br />&nbsp;&nbsp;&nbsp; client.upload_file(file_path, bucket, object_name)<br />&nbsp;&nbsp;&nbsp; return client.generate_presigned_url('get_object', Params={'Bucket': bucket, 'Key': object_name}, ExpiresIn=3600)<br />def handle_process_event(event, context):<br />&nbsp;&nbsp;&nbsp; for message in event['messages']:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; task_json = json.loads(message['details']['message']['body'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; task_id = task_json['task_id']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Download video<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; download_from_ya_disk(task_json['src'], '/tmp/video.mp4')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Convert with ffmpeg<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; subprocess.run(['ffmpeg', '-i', '/tmp/video.mp4', '-r', '10', '-s', '320x240', '/tmp/result.gif'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result_object = task_id + ".gif"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Upload to Object Storage and generate presigned url<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result_download_url = upload_and_presign('/tmp/result.gif', result_object)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Update task status in DocAPI<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get_docapi_table().update_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key={'task_id': task_id},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AttributeUpdates={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ready': {'Value': True, 'Action': 'PUT'},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'gif_url': {'Value': result_download_url, 'Action': 'PUT'},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return "OK" <br />Сгенерируйте файл requirements.txt:<br />pipreqs $PWD --force <br />Находясь в директории с исходными файлами, упакуем все нужные файлы в ZIP-архив.<br />zip src.zip index.py requirements.txt ffmpeg <br />В Object Storage для простоты используем тот же бакет, куда далее будем складывать видео. На вкладке Объекты, вверху справа нажмите кнопку Загрузить и выберите созданный архив.<br />Создадим функции ffmpeg-api и ffmpeg-converter, при этом сразу зададим все необходимые переменные и сервисный аккаунт:<br />yc serverless function create \<br />&nbsp; --name ffmpeg-api \<br />&nbsp; --description "function for ffmpeg-api"<br />yc serverless function create \<br />&nbsp; --name ffmpeg-converter \<br />&nbsp; --description "function for ffmpeg-converter"<br />yc serverless function version create \<br />&nbsp; --function-name ffmpeg-api \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=index.handle_api \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --environment SECRET_ID=$SECRET_ID \<br />&nbsp; --environment YMQ_QUEUE_URL=$YMQ_QUEUE_URL \<br />&nbsp; --environment DOCAPI_ENDPOINT=$DOCAPI_ENDPOINT \<br />&nbsp; --package-bucket-name $S3_BUCKET \<br />&nbsp; --package-object-name src.zip<br />yc serverless function version create \<br />&nbsp; --function-name ffmpeg-converter \<br />&nbsp; --memory=2048m \<br />&nbsp; --execution-timeout=600s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=index.handle_process_event \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --environment SECRET_ID=$SECRET_ID \<br />&nbsp; --environment YMQ_QUEUE_URL=$YMQ_QUEUE_URL \<br />&nbsp; --environment DOCAPI_ENDPOINT=$DOCAPI_ENDPOINT \<br />&nbsp; --environment S3_BUCKET=$S3_BUCKET \<br />&nbsp; --package-bucket-name $S3_BUCKET \<br />&nbsp; --package-object-name src.zip <br />Тестирование функции<br />В консоли управления перейдите из рабочего каталога в раздел Cloud Functions и выберите ранее созданную функцию ffmpeg-api. Перейдите на вкладку Тестирование в боковом меню, выберите шаблон данных Без шаблона и добавьте во вводные данные JSON:<br />{"action":"convert", "src_url":"https://disk.yandex.ru/i/38RbVC0spb_jQQ"} <br />Нажмите кнопку Запустить тест. Этим самым мы загрузим файл в хранилище и создадим задачу в БД. Если всё сделано правильно, то вы увидите такой результат:<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "task_id": "133e05c2-1b98-41cc-9aab-b816d71af343"<br />&nbsp;&nbsp;&nbsp; } <br />Воспользуемся полученным идентификатором задачи task_id для получения статуса из базы данных. Для этого внесите в вводные данные JSON следующие изменения:<br />{"action":"get_task_status", "task_id":"&lt;идентификатор задачи&gt;"} <br />Нажмите кнопку Запустить тест. Так как мы ещё не обрабатывали задачи в очереди, результат очевиден:<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "ready": false<br />&nbsp;&nbsp;&nbsp; } <br />Шаг 6. Создание триггера<br />Теперь создайте триггер, который будет вызывать функцию обработки сообщений из очереди. После создания триггер начинает работать через пять минут. Он будет брать по одному сообщению и раз в 10 секунд отправлять в функцию:<br />yc serverless trigger create message-queue \<br />&nbsp; --name ffmpeg \<br />&nbsp; --queue $YMQ_QUEUE_ARN \<br />&nbsp; --queue-service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --invoke-function-name ffmpeg-converter&nbsp; \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --batch-size 1 \<br />&nbsp; --batch-cutoff 10s <br />С этого момента очередь начнёт обрабатываться. Можно проверить, готова ли задача, и, если это так, запросить по URL результат обработки из Object Storage.<br />Теперь у нас есть функция, которая выполняет функцию API, через которую мы можем ставить задачи в очередь на исполнение. Триггер раз в 10 секунд берет по одному сообщению в очереди и передает функции обработчику. Функция-обработчик формирует результат и обновляет данные в базе данных. При этом мы получаем сконвертированные GIF-файлы из видео.<br />Протестируйте систему, используя полученный ранее идентификатор задачи task_id для получения статуса из базы данных. Для этого внесите изменения в вводные данные JSON:<br />{"action":"get_task_status", "task_id":"133e05c2-1b98-41cc-9aab-b816d71af343"} <br />Нажмите кнопку Запустить тест. Если задача уже успела обработаться, то вы получите URL.<br />Удаление триггера<br />По завершении работы не забудьте удалить созданный триггер ffmpeg, иначе он будет продолжать работать:<br />yc serverless trigger delete ffmpeg <br /><strong>Decision:</strong><br />$ export SERVICE_ACCOUNT=$(yc iam service-account create --name ffmpeg-account-for-cf \<br />&nbsp; --description "service account for serverless" \<br />&nbsp; --format json | jq -r .)<br />$ yc iam service-account list<br />$ echo "export SERVICE_ACCOUNT_FFMPEG_ID=&lt;ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $SERVICE_ACCOUNT_FFMPEG_ID<br />$ echo "export FOLDER_ID=$(yc config get folder-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $FOLDER_ID<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role storage.viewer<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role storage.uploader<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role ymq.reader<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role ymq.writer<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role ydb.admin<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role serverless.functions.invoker<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role lockbox.payloadViewer<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --role editor<br />$ yc resource-manager folder list-access-bindings $FOLDER_ID<br />$ yc resource-manager folder set-access-bindings $FOLDER_ID \<br />&nbsp; --access-binding role=storage.viewer,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=storage.uploader,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=ymq.reader,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=ymq.writer,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=ydb.admin,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=serverless.functions.invoker,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=lockbox.payloadViewer,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --access-binding role=editor,subject=serviceAccount:$SERVICE_ACCOUNT_FFMPEG_ID<br />$ yc iam access-key create --service-account-name ffmpeg-account-for-cf<br />$ yc lockbox secret create --name ffmpeg-sa-key \<br />&nbsp; --folder-id $FOLDER_ID \<br />&nbsp; --description "keys for serverless" \<br />&nbsp; --payload '[{"key": "ACCESS_KEY_ID", "text_value": &lt;ACCESS_KEY_ID&gt;}, {"key": "SECRET_ACCESS_KEY", "text_value": "&lt;SECRET_ACCESS_KEY&gt;"}]'<br />$ yc lockbox secret list<br />$ yc lockbox secret get --name ffmpeg-sa-key<br />$ echo "export SECRET_ID=&lt;SECRET_ID&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $SECRET_ID<br />$ aws configure<br />$ aws sqs create-queue --queue-name ffmpeg --endpoint https://message-queue.api.cloud.yandex.net/<br />$ echo "export YMQ_QUEUE_URL=&lt;YMQ_QUEUE_URL&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $YMQ_QUEUE_URL<br />$ aws sqs get-queue-attributes \<br />&nbsp; --endpoint https://message-queue.api.cloud.yandex.net \<br />&nbsp; --queue-url $YMQ_QUEUE_URL \<br />&nbsp; --attribute-names QueueArn<br />$ echo "export YMQ_QUEUE_ARN=&lt;YMQ_QUEUE_ARN&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $YMQ_QUEUE_ARN<br />$ yc ydb database create ffmpeg \<br />&nbsp; --serverless \<br />&nbsp; --folder-id $FOLDER_ID<br />$ yc ydb database list<br />$ yc ydb database get --name ffmpeg<br />$ echo "export DOCAPI_ENDPOINT=&lt;DOCAPI_ENDPOINT&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $DOCAPI_ENDPOINT<br />$ vim tasks.json<br />$ cat tasks.json<br />{<br />&nbsp; "AttributeDefinitions": [<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "AttributeName": "task_id",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "AttributeType": "S"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; ],<br />&nbsp; "KeySchema": [<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "AttributeName": "task_id",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "KeyType": "HASH"<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp; ],<br />&nbsp; "TableName": "tasks"<br />}<br />$ aws dynamodb create-table \<br />&nbsp; --cli-input-json file://tasks.json \<br />&nbsp; --endpoint-url $DOCAPI_ENDPOINT \<br />&nbsp; --region ru-central1<br />$ echo "export S3_BUCKET=&lt;имя бакета&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $S3_BUCKET<br />$ echo $SERVICE_ACCOUNT_FFMPEG_ID<br />$ echo $SECRET_ID<br />$ echo $YMQ_QUEUE_URL<br />$ echo $DOCAPI_ENDPOINT<br />$ echo $S3_BUCKET<br />$ sudo apt install ffmpeg<br />$ vim index.py<br />$ cat index.py<br />import json<br />import os<br />import subprocess<br />import uuid<br />from urllib.parse import urlencode<br />import boto3<br />import requests<br />import yandexcloud<br />from yandex.cloud.lockbox.v1.payload_service_pb2 import GetPayloadRequest<br />from yandex.cloud.lockbox.v1.payload_service_pb2_grpc import PayloadServiceStub<br />boto_session = None<br />storage_client = None<br />docapi_table = None<br />ymq_queue = None<br />def get_boto_session():<br />&nbsp;&nbsp;&nbsp; global boto_session<br />&nbsp;&nbsp;&nbsp; if boto_session is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return boto_session<br />&nbsp;&nbsp;&nbsp; # initialize lockbox and read secret value<br />&nbsp;&nbsp;&nbsp; yc_sdk = yandexcloud.SDK()<br />&nbsp;&nbsp;&nbsp; channel = yc_sdk._channels.channel("lockbox-payload")<br />&nbsp;&nbsp;&nbsp; lockbox = PayloadServiceStub(channel)<br />&nbsp;&nbsp;&nbsp; response = lockbox.Get(GetPayloadRequest(secret_id=os.environ['SECRET_ID']))<br />&nbsp;&nbsp;&nbsp; # extract values from secret<br />&nbsp;&nbsp;&nbsp; access_key = None<br />&nbsp;&nbsp;&nbsp; secret_key = None<br />&nbsp;&nbsp;&nbsp; for entry in response.entries:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if entry.key == 'ACCESS_KEY_ID':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; access_key = entry.text_value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; elif entry.key == 'SECRET_ACCESS_KEY':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; secret_key = entry.text_value<br />&nbsp;&nbsp;&nbsp; if access_key is None or secret_key is None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise Exception("secrets required")<br />&nbsp;&nbsp;&nbsp; print("Key id: " + access_key)<br />&nbsp;&nbsp;&nbsp; # initialize boto session<br />&nbsp;&nbsp;&nbsp; boto_session = boto3.session.Session(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_access_key_id=access_key,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; aws_secret_access_key=secret_key<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return boto_session<br />def get_ymq_queue():<br />&nbsp;&nbsp;&nbsp; global ymq_queue<br />&nbsp;&nbsp;&nbsp; if ymq_queue is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ymq_queue<br />&nbsp;&nbsp;&nbsp; ymq_queue = get_boto_session().resource(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='sqs',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://message-queue.api.cloud.yandex.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; ).Queue(os.environ['YMQ_QUEUE_URL'])<br />&nbsp;&nbsp;&nbsp; return ymq_queue<br />def get_docapi_table():<br />&nbsp;&nbsp;&nbsp; global docapi_table<br />&nbsp;&nbsp;&nbsp; if docapi_table is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return docapi_table<br />&nbsp;&nbsp;&nbsp; docapi_table = get_boto_session().resource(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'dynamodb',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url=os.environ['DOCAPI_ENDPOINT'],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; ).Table('tasks')<br />&nbsp;&nbsp;&nbsp; return docapi_table<br />def get_storage_client():<br />&nbsp;&nbsp;&nbsp; global storage_client<br />&nbsp;&nbsp;&nbsp; if storage_client is not None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return storage_client<br />&nbsp;&nbsp;&nbsp; storage_client = get_boto_session().client(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_name='s3',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endpoint_url='https://storage.yandexcloud.net',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; region_name='ru-central1'<br />&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return storage_client<br /># API handler<br />def create_task(src_url):<br />&nbsp;&nbsp;&nbsp; task_id = str(uuid.uuid4())<br />&nbsp;&nbsp;&nbsp; get_docapi_table().put_item(Item={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'task_id': task_id,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ready': False<br />&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp; get_ymq_queue().send_message(MessageBody=json.dumps({'task_id': task_id, "src": src_url}))<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'task_id': task_id<br />&nbsp;&nbsp;&nbsp; }<br />def get_task_status(task_id):<br />&nbsp;&nbsp;&nbsp; task = get_docapi_table().get_item(Key={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "task_id": task_id<br />&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp; if task['Item']['ready']:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ready': True,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'gif_url': task['Item']['gif_url']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; return {'ready': False}<br />def handle_api(event, context):<br />&nbsp;&nbsp;&nbsp; action = event['action']<br />&nbsp;&nbsp;&nbsp; if action == 'convert':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return create_task(event['src_url'])<br />&nbsp;&nbsp;&nbsp; elif action == 'get_task_status':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return get_task_status(event['task_id'])<br />&nbsp;&nbsp;&nbsp; else:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return {"error": "unknown action: " + action}<br /># Converter handler<br />def download_from_ya_disk(public_key, dst):<br />&nbsp;&nbsp;&nbsp; api_call_url = 'https://cloud-api.yandex.net/v1/disk/public/resources/download?' + \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; urlencode(dict(public_key=public_key))<br />&nbsp;&nbsp;&nbsp; response = requests.get(api_call_url)<br />&nbsp;&nbsp;&nbsp; download_url = response.json()['href']<br />&nbsp;&nbsp;&nbsp; download_response = requests.get(download_url)<br />&nbsp;&nbsp;&nbsp; with open(dst, 'wb') as video_file:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; video_file.write(download_response.content)<br />def upload_and_presign(file_path, object_name):<br />&nbsp;&nbsp;&nbsp; client = get_storage_client()<br />&nbsp;&nbsp;&nbsp; bucket = os.environ['S3_BUCKET']<br />&nbsp;&nbsp;&nbsp; client.upload_file(file_path, bucket, object_name)<br />&nbsp;&nbsp;&nbsp; return client.generate_presigned_url('get_object', Params={'Bucket': bucket, 'Key': object_name}, ExpiresIn=3600)<br />def handle_process_event(event, context):<br />&nbsp;&nbsp;&nbsp; for message in event['messages']:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; task_json = json.loads(message['details']['message']['body'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; task_id = task_json['task_id']<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Download video<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; download_from_ya_disk(task_json['src'], '/tmp/video.mp4')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Convert with ffmpeg<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; subprocess.run(['ffmpeg', '-i', '/tmp/video.mp4', '-r', '10', '-s', '320x240', '/tmp/result.gif'])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result_object = task_id + ".gif"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Upload to Object Storage and generate presigned url<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result_download_url = upload_and_presign('/tmp/result.gif', result_object)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Update task status in DocAPI<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; get_docapi_table().update_item(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Key={'task_id': task_id},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AttributeUpdates={<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'ready': {'Value': True, 'Action': 'PUT'},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'gif_url': {'Value': result_download_url, 'Action': 'PUT'},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />&nbsp;&nbsp;&nbsp; return "OK"<br />$ pipreqs $PWD --force<br />$ zip src.zip index.py requirements.txt ffmpeg<br />$ yc serverless function create \<br />&nbsp; --name ffmpeg-api \<br />&nbsp; --description "function for ffmpeg-api"<br />$ yc serverless function create \<br />&nbsp; --name ffmpeg-converter \<br />&nbsp; --description "function for ffmpeg-converter"<br />$ yc serverless function version create \<br />&nbsp; --function-name ffmpeg-api \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=index.handle_api \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --environment SECRET_ID=$SECRET_ID \<br />&nbsp; --environment YMQ_QUEUE_URL=$YMQ_QUEUE_URL \<br />&nbsp; --environment DOCAPI_ENDPOINT=$DOCAPI_ENDPOINT \<br />&nbsp; --package-bucket-name $S3_BUCKET \<br />&nbsp; --package-object-name src.zip<br />$ yc serverless function version create \<br />&nbsp; --function-name ffmpeg-converter \<br />&nbsp; --memory=2048m \<br />&nbsp; --execution-timeout=600s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=index.handle_process_event \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --environment SECRET_ID=$SECRET_ID \<br />&nbsp; --environment YMQ_QUEUE_URL=$YMQ_QUEUE_URL \<br />&nbsp; --environment DOCAPI_ENDPOINT=$DOCAPI_ENDPOINT \<br />&nbsp; --environment S3_BUCKET=$S3_BUCKET \<br />&nbsp; --package-bucket-name $S3_BUCKET \<br />&nbsp; --package-object-name src.zip<br />$ yc serverless trigger create message-queue \<br />&nbsp; --name ffmpeg \<br />&nbsp; --queue $YMQ_QUEUE_ARN \<br />&nbsp; --queue-service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --invoke-function-name ffmpeg-converter&nbsp; \<br />&nbsp; --invoke-function-service-account-id $SERVICE_ACCOUNT_FFMPEG_ID \<br />&nbsp; --batch-size 1 \<br />&nbsp; --batch-cutoff 10s<br />$ yc serverless trigger delete ffmpeg<br /><strong>Task:</strong><br />Сокращатель ссылок. <br />В рамках этого курса вы изучили несколько ключевых сервисов Yandex Cloud, относящихся к группе Serverless. <br />Давайте объединим их для решения ещё одной практической задачи и создадим сервис, который конвертирует длинные ссылки в короткие.<br /><strong>Decision:</strong><br />Шаг 1. Сервисный аккаунт<br />Создание аккаунта<br />Создайте сервисный аккаунт с именем serverless-shortener:<br />&nbsp;export SERVICE_ACCOUNT_SHORTENER_ID=$(yc iam service-account create --name serverless-shortener \<br />&nbsp; --description "service account for serverless" \<br />&nbsp; --format json | jq -r .) <br />Проверьте текущий список сервисных аккаунтов:<br />yc iam service-account list <br />После проверки запишите идентификатор созданного сервисного аккаунта в переменную SERVICE_ACCOUNT_SHORTENER_ID:<br />echo "export SERVICE_ACCOUNT_SHORTENER_ID=&lt;идентификатор сервисного аккаунта&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $SERVICE_ACCOUNT_SHORTENER_ID <br />Назначение ролей<br />Добавьте созданному сервисному аккаунту роли editor, storage.viewer и ydb.admin:<br />echo "export FOLDER_ID=$(yc config get folder-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $FOLDER_ID<br />echo "export OAUTH_TOKEN=$(yc config get token)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $OAUTH_TOKEN<br />echo "export CLOUD_ID=$(yc config get cloud-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $CLOUD_ID<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --role editor<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --role ydb.admin<br />yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --role storage.viewer <br />Шаг 2. Создание бакета в Object Storage<br />Сделаем для нашего сервиса веб-интерфейс. Поскольку это будет статическая веб-страница, разместим её в объектном хранилище.<br />В консоли управления в вашем рабочем каталоге выберите сервис Object Storage. Нажмите кнопку Создать бакет.<br />На странице создания бакета:<br />&nbsp;&nbsp;&nbsp; Введите имя бакета. В нашем примере это будет storage-for-serverless-shortener.<br />&nbsp;&nbsp;&nbsp; Ограничьте максимальный размер бакета (например 1 ГБ).<br />&nbsp;&nbsp;&nbsp; Выберите тип доступа Публичный во всех случаях.<br />&nbsp;&nbsp;&nbsp; Выберите класс хранилища Стандартное.<br />Нажмите кнопку Создать бакет для завершения операции.<br />Создайте и загрузите файл index.html в созданный бакет &mdash; это будет стартовая страничка для нашего сокращателя:<br />&lt;!DOCTYPE html&gt;<br />&lt;html lang="en"&gt;<br />&lt;head&gt;<br />&nbsp;&nbsp;&nbsp; &lt;meta charset="UTF-8"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Сокращатель URL&lt;/title&gt;<br />&nbsp;&nbsp;&nbsp; &lt;!-- предостережет от лишнего GET запроса на адрес /favicon.ico --&gt;<br />&nbsp;&nbsp;&nbsp; &lt;link rel="icon" href="data:;base64,iVBORw0KGgo="&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&lt;h1&gt;Добро пожаловать&lt;/h1&gt;<br />&lt;form action="javascript:shorten()"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;label for="url"&gt;Введите ссылку:&lt;/label&gt;&lt;br&gt;<br />&nbsp;&nbsp;&nbsp; &lt;input id="url" name="url" type="text"&gt;&lt;br&gt;<br />&nbsp;&nbsp;&nbsp; &lt;input type="submit" value="Сократить"&gt;<br />&lt;/form&gt;<br />&lt;p id="shortened"&gt;&lt;/p&gt;<br />&lt;/body&gt;<br />&lt;script&gt;<br />&nbsp;&nbsp;&nbsp; function shorten() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const link = document.getElementById("url").value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fetch("/shorten", {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; method: 'POST',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; headers: {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Content-Type': 'application/json'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; body: link<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .then(response =&gt; response.json())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .then(data =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const url = data.url<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.getElementById("shortened").innerHTML = `&lt;a href=${url}&gt;${url}&lt;/a&gt;`<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .catch(error =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.getElementById("shortened").innerHTML = `&lt;p&gt;Произошла ошибка ${error}, попробуйте еще раз&lt;/p&gt;`<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp; }<br />&lt;/script&gt;<br />&lt;/html&gt; <br />Шаг 3. Создание базы данных<br />&nbsp;&nbsp;&nbsp; Создадим бессерверную базу данных YDB с именем for-serverless-shortener. Чтобы не переключаться из терминала, снова воспользуемся CLI. Обязательно укажите флаг --serverless для выбора типа создаваемой базы данных:<br />yc ydb database create for-serverless-shortener \<br />&nbsp; --serverless \<br />&nbsp; --folder-id $FOLDER_ID<br />yc ydb database list <br />&nbsp;&nbsp;&nbsp; Выполните команду:<br />yc ydb database get --name for-serverless-shortener <br />В выводе вы увидите значение endpoint. Оно состоит из двух частей: собственно эндпоинта (обычно это ydb.serverless.yandexcloud.net:2135) и пути базы данных (он указывается после ключевого слова database и начинается с символа /, например /ru-central1/...). Сохраним адрес эндпоинта в переменную YDB_ENDPOINT, а путь базы данных &mdash; в переменную YDB_DATABASE. Они пригодятся нам для подключения функции.<br />yc ydb database get --name for-serverless-shortener<br />echo "export YDB_ENDPOINT=&lt;YDB_ENDPOINT&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $YDB_ENDPOINT<br />echo "export YDB_DATABASE=&lt;YDB_DATABASE&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $YDB_DATABASE <br />&nbsp;&nbsp;&nbsp; Для дальнейшей работы нам понадобится утилита ydb:<br />curl https://storage.yandexcloud.net/yandexcloud-ydb/install.sh | bash <br />&nbsp;&nbsp;&nbsp; С помощью CLI создадим авторизованный ключ сервисного аккаунта serverless-shortener:<br />&nbsp;&nbsp;&nbsp; yc iam key create \<br />&nbsp;&nbsp;&nbsp; --service-account-name serverless-shortener \<br />&nbsp;&nbsp;&nbsp; --output serverless-shortener.sa <br />Сохраним путь к файлу с ключом в переменную окружения:<br />echo "export SA_KEY_FILE=$PWD/serverless-shortener.sa" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />echo $SA_KEY_FILE <br />&nbsp;&nbsp;&nbsp; Проверим работоспособность с помощью команды:<br />ydb \<br />&nbsp; --endpoint $YDB_ENDPOINT \<br />&nbsp; --database $YDB_DATABASE \<br />&nbsp; --sa-key-file $SA_KEY_FILE \<br />&nbsp; discovery whoami \<br />&nbsp; --groups <br />&nbsp;&nbsp;&nbsp; Сохраним в файл links.yql SQL-скрипт для создания таблицы:<br />CREATE TABLE links<br />(<br />&nbsp;&nbsp;&nbsp; id Utf8,<br />&nbsp;&nbsp;&nbsp; link Utf8,<br />&nbsp;&nbsp;&nbsp; PRIMARY KEY (id)<br />);<br />COMMIT; <br />&nbsp;&nbsp;&nbsp; Запустите создание таблицы, а затем проверьте результат:<br />ydb \<br />&nbsp; --endpoint $YDB_ENDPOINT \<br />&nbsp; --database $YDB_DATABASE \<br />&nbsp; --sa-key-file $SA_KEY_FILE \<br />&nbsp; scripting yql --file links.yql<br />ydb \<br />&nbsp; --endpoint $YDB_ENDPOINT \<br />&nbsp; --database $YDB_DATABASE \<br />&nbsp; --sa-key-file $SA_KEY_FILE \<br />&nbsp; scheme describe links <br />Шаг 4. Создание функции<br />&nbsp;&nbsp;&nbsp; В рабочем каталоге создайте файл index.py:<br />from kikimr.public.sdk.python import client as ydb<br />import urllib.parse<br />import hashlib<br />import base64<br />import json<br />import os<br />def decode(event, body):<br />&nbsp;&nbsp;&nbsp; # тело запроса может быть закодировано<br />&nbsp;&nbsp;&nbsp; is_base64_encoded = event.get('isBase64Encoded')<br />&nbsp;&nbsp;&nbsp; if is_base64_encoded:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; body = str(base64.b64decode(body), 'utf-8')<br />&nbsp;&nbsp;&nbsp; return body<br />def response(statusCode, headers, isBase64Encoded, body):<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'headers': headers,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'isBase64Encoded': isBase64Encoded,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': body,<br />&nbsp;&nbsp;&nbsp; }<br />def get_config():<br />&nbsp;&nbsp;&nbsp; endpoint = os.getenv("endpoint")<br />&nbsp;&nbsp;&nbsp; database = os.getenv("database")<br />&nbsp;&nbsp;&nbsp; if endpoint is None or database is None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise AssertionError("Нужно указать обе переменные окружения")<br />&nbsp;&nbsp;&nbsp; credentials = ydb.construct_credentials_from_environ()<br />&nbsp;&nbsp;&nbsp; return ydb.DriverConfig(endpoint, database, credentials=credentials)<br />def execute(config, query, params):<br />&nbsp;&nbsp;&nbsp; with ydb.Driver(config) as driver:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; driver.wait(timeout=5)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; except TimeoutError:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Connect failed to YDB")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Last reported errors by discovery:")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(driver.discovery_debug_details())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return None<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session = driver.table_client.session().create()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; prepared_query = session.prepare(query)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return session.transaction(ydb.SerializableReadWrite()).execute(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; prepared_query,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; params,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit_tx=True<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />def insert_link(id, link):<br />&nbsp;&nbsp;&nbsp; config = get_config()<br />&nbsp;&nbsp;&nbsp; query = """<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DECLARE $id AS Utf8;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DECLARE $link AS Utf8;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UPSERT INTO links (id, link) VALUES ($id, $link);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; params = {'$id': id, '$link': link}<br />&nbsp;&nbsp;&nbsp; execute(config, query, params)<br />def find_link(id):<br />&nbsp;&nbsp;&nbsp; print(id)<br />&nbsp;&nbsp;&nbsp; config = get_config()<br />&nbsp;&nbsp;&nbsp; query = """<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DECLARE $id AS Utf8;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT link FROM links where id=$id;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; params = {'$id': id}<br />&nbsp;&nbsp;&nbsp; result_set = execute(config, query, params)<br />&nbsp;&nbsp;&nbsp; if not result_set or not result_set[0].rows:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return None<br />&nbsp;&nbsp;&nbsp; return result_set[0].rows[0].link<br />def shorten(event):<br />&nbsp;&nbsp;&nbsp; body = event.get('body')<br />&nbsp;&nbsp;&nbsp; if body:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; body = decode(event, body)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; original_host = event.get('headers').get('Origin')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; link_id = hashlib.sha256(body.encode('utf8')).hexdigest()[:6]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # в ссылке могут быть закодированные символы, например, %. это помешает работе api-gateway при редиректе,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # поэтому следует избавиться от них вызовом urllib.parse.unquote<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert_link(link_id, urllib.parse.unquote(body))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response(200, {'Content-Type': 'application/json'}, False, json.dumps({'url': f'{original_host}/r/{link_id}'}))<br />&nbsp;&nbsp;&nbsp; return response(400, {}, False, 'В теле запроса отсутствует параметр url')<br />def redirect(event):<br />&nbsp;&nbsp;&nbsp; link_id = event.get('pathParams').get('id')<br />&nbsp;&nbsp;&nbsp; redirect_to = find_link(link_id)<br />&nbsp;&nbsp;&nbsp; if redirect_to:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response(302, {'Location': redirect_to}, False, '')<br />&nbsp;&nbsp;&nbsp; return response(404, {}, False, 'Данной ссылки не существует')<br /># эти проверки нужны, поскольку функция у нас одна<br /># в идеале сделать по функции на каждый путь в api-gw<br />def get_result(url, event):<br />&nbsp;&nbsp;&nbsp; if url == "/shorten":<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return shorten(event)<br />&nbsp;&nbsp;&nbsp; if url.startswith("/r/"):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return redirect(event)<br />&nbsp;&nbsp;&nbsp; return response(404, {}, False, 'Данного пути не существует')<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; url = event.get('url')<br />&nbsp;&nbsp;&nbsp; if url:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # из API-gateway url может прийти со знаком вопроса на конце<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if url[-1] == '?':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url = url[:-1]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return get_result(url, event)<br />&nbsp;&nbsp;&nbsp; return response(404, {}, False, 'Эту функцию следует вызывать при помощи api-gateway') <br />Создайте файл requirements.txt:<br />pipreqs $PWD --force <br />Находясь в директории с исходными файлами, упакуйте все нужные файлы в zip-архив:<br />zip src.zip index.py requirements.txt <br />&nbsp;&nbsp;&nbsp; В переменные окружения функции необходимо добавить:<br />&nbsp;&nbsp;&nbsp; endpoint &mdash; нужно указать протокол grpcs:// и добавить значение Эндпоинт из секции YDB эндпоинт, обычно получается grpcs://ydb.serverless.yandexcloud.net:2135.<br />&nbsp;&nbsp;&nbsp; database &mdash; это значение поля База данных из секции YDB эндпоинт (начинается с /ru-central1/....).<br />&nbsp;&nbsp;&nbsp; USE_METADATA_CREDENTIALS &mdash; выставите значение переменной в 1.<br />&nbsp;&nbsp;&nbsp; Создадим нашу функцию for-serverless-shortener. При этом сразу зададим все необходимые переменные, сервисный аккаунт и сделаем ее публичной:<br />yc serverless function create \<br />&nbsp; --name for-serverless-shortener \<br />&nbsp; --description "function for serverless-shortener"<br />yc serverless function version create \<br />&nbsp; --function-name for-serverless-shortener \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python37 \<br />&nbsp; --entrypoint=index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --environment USE_METADATA_CREDENTIALS=1 \<br />&nbsp; --environment endpoint=grpcs://ydb.serverless.yandexcloud.net:2135 \<br />&nbsp; --environment database=$YDB_DATABASE \<br />&nbsp; --source-path src.zip<br />yc serverless function allow-unauthenticated-invoke for-serverless-shortener <br />Шаг 5. Конфигурирование Yandex API Gateway<br />&nbsp;&nbsp;&nbsp; Создадим спецификацию for-serverless-shortener.yml со следующим содержанием:<br />openapi: 3.0.0<br />info:<br />&nbsp; title: for-serverless-shortener<br />&nbsp; version: 1.0.0<br />paths:<br />&nbsp; /:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: object_storage<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bucket:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;bucket_name&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- имя бакета<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;html_file&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- имя html-файла<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; presigned_redirect: false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account:&nbsp;&nbsp;&nbsp; &lt;service_account_id&gt; # &lt;-- идентификатор сервисного аккаунта<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: static<br />&nbsp; /shorten:<br />&nbsp;&nbsp;&nbsp; post:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud_functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id:&nbsp; &lt;function_id&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- идентификатор функции<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: shorten<br />&nbsp; /r/{id}:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud_functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id:&nbsp; &lt;function_id&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- идентификатор функции<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: redirect<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parameters:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - description: id of the url<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; explode: false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in: path<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; required: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; style: simple <br />Не забудьте подставить в спецификацию актуальные для вас значения переменных.<br />&nbsp;&nbsp;&nbsp; Используем спецификацию для инициализации:<br />yc serverless api-gateway create \<br />&nbsp; --name for-serverless-shortener \<br />&nbsp; --spec=for-serverless-shortener.yml \<br />&nbsp; --description "for serverless shortener" <br />В результате успешного создания API-шлюза получим значение параметра domain:<br />yc serverless api-gateway list<br />yc serverless api-gateway get --name for-serverless-shortener <br />&nbsp;&nbsp;&nbsp; Чтобы проверить работоспособность API-шлюза и созданного приложения целиком, скопируйте служебный домен (вида https://&lt;идентификатор API Gateway&gt;.apigw.yandexcloud.net/) и вставьте адрес в браузер.<br />Добавляйте адреса сайтов в форму, они будут сохранятся в базу данных. А вам будет доступна ссылка, за которой будет скрываться оригинальный адрес. Ваше приложение полностью работоспособно. Теперь вы умеете использовать serverless-стеком технологий Yandex Cloud.<br />Итак, вы создали приложение с использованием Cloud Functions, API Gateway, Object Storage и Yandex Database. Конечно, вы можете развивать его и дальше, расширяя функциональность.<br /><strong>Decision:</strong><br />$ export SERVICE_ACCOUNT_SHORTENER_ID=$(yc iam service-account create --name serverless-shortener \<br />&nbsp; --description "service account for serverless" \<br />&nbsp; --format json | jq -r .)<br />$ yc iam service-account list<br />$ echo "export SERVICE_ACCOUNT_SHORTENER_ID=&lt;идентификатор сервисного аккаунта&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $SERVICE_ACCOUNT_SHORTENER_ID<br />$ echo "export FOLDER_ID=$(yc config get folder-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $FOLDER_ID<br />$ echo "export OAUTH_TOKEN=$(yc config get token)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $OAUTH_TOKEN<br />$ echo "export CLOUD_ID=$(yc config get cloud-id)" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $CLOUD_ID<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --role editor<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --role ydb.admin<br />$ yc resource-manager folder add-access-binding $FOLDER_ID \<br />&nbsp; --subject serviceAccount:$SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --role storage.viewer<br />$ vim index.html<br />$ cat index.html<br />&lt;!DOCTYPE html&gt;<br />&lt;html lang="en"&gt;<br />&lt;head&gt;<br />&nbsp;&nbsp;&nbsp; &lt;meta charset="UTF-8"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;Сокращатель URL&lt;/title&gt;<br />&nbsp;&nbsp;&nbsp; &lt;!-- предостережет от лишнего GET запроса на адрес /favicon.ico --&gt;<br />&nbsp;&nbsp;&nbsp; &lt;link rel="icon" href="data:;base64,iVBORw0KGgo="&gt;<br />&lt;/head&gt;<br />&lt;body&gt;<br />&lt;h1&gt;Добро пожаловать&lt;/h1&gt;<br />&lt;form action="javascript:shorten()"&gt;<br />&nbsp;&nbsp;&nbsp; &lt;label for="url"&gt;Введите ссылку:&lt;/label&gt;&lt;br&gt;<br />&nbsp;&nbsp;&nbsp; &lt;input id="url" name="url" type="text"&gt;&lt;br&gt;<br />&nbsp;&nbsp;&nbsp; &lt;input type="submit" value="Сократить"&gt;<br />&lt;/form&gt;<br />&lt;p id="shortened"&gt;&lt;/p&gt;<br />&lt;/body&gt;<br />&lt;script&gt;<br />&nbsp;&nbsp;&nbsp; function shorten() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const link = document.getElementById("url").value<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fetch("/shorten", {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; method: 'POST',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; headers: {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'Content-Type': 'application/json'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; body: link<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .then(response =&gt; response.json())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .then(data =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; const url = data.url<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.getElementById("shortened").innerHTML = `&lt;a href=${url}&gt;${url}&lt;/a&gt;`<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .catch(error =&gt; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; document.getElementById("shortened").innerHTML = `&lt;p&gt;Произошла ошибка ${error}, попробуйте еще раз&lt;/p&gt;`<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; })<br />&nbsp;&nbsp;&nbsp; }<br />&lt;/script&gt;<br />&lt;/html&gt;<br />$ yc ydb database create for-serverless-shortener \<br />&nbsp; --serverless \<br />&nbsp; --folder-id $FOLDER_ID<br />$ yc ydb database list<br />$ yc ydb database get --name for-serverless-shortener<br />$ echo "export YDB_ENDPOINT=&lt;YDB_ENDPOINT&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $YDB_ENDPOINT<br />$ echo "export YDB_DATABASE=&lt;YDB_DATABASE&gt;" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $YDB_DATABASE<br />$ curl https://storage.yandexcloud.net/yandexcloud-ydb/install.sh | bash<br />$ yc iam key create \<br />--service-account-name serverless-shortener \<br />--output serverless-shortener.sa<br />$ echo "export SA_KEY_FILE=$PWD/serverless-shortener.sa" &gt;&gt; ~/.bashrc &amp;&amp; . ~/.bashrc<br />$ echo $SA_KEY_FILE<br />$ ydb \<br />&nbsp; --endpoint $YDB_ENDPOINT \<br />&nbsp; --database $YDB_DATABASE \<br />&nbsp; --sa-key-file $SA_KEY_FILE \<br />&nbsp; discovery whoami \<br />&nbsp; --groups<br />$ vim links.yql<br />$ cat links.yql<br />CREATE TABLE links<br />(<br />&nbsp;&nbsp;&nbsp; id Utf8,<br />&nbsp;&nbsp;&nbsp; link Utf8,<br />&nbsp;&nbsp;&nbsp; PRIMARY KEY (id)<br />);<br />COMMIT;<br />$ ydb \<br />&nbsp; --endpoint $YDB_ENDPOINT \<br />&nbsp; --database $YDB_DATABASE \<br />&nbsp; --sa-key-file $SA_KEY_FILE \<br />&nbsp; scripting yql --file links.yql<br />$ ydb \<br />&nbsp; --endpoint $YDB_ENDPOINT \<br />&nbsp; --database $YDB_DATABASE \<br />&nbsp; --sa-key-file $SA_KEY_FILE \<br />&nbsp; scheme describe links<br />$ vim index1.py<br />$ cat index1.py<br />import ydb<br />import urllib.parse<br />import hashlib<br />import base64<br />import json<br />import os<br />def decode(event, body):<br />&nbsp;&nbsp;&nbsp; # тело запроса может быть закодировано<br />&nbsp;&nbsp;&nbsp; is_base64_encoded = event.get('isBase64Encoded')<br />&nbsp;&nbsp;&nbsp; if is_base64_encoded:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; body = str(base64.b64decode(body), 'utf-8')<br />&nbsp;&nbsp;&nbsp; return body<br />def response(statusCode, headers, isBase64Encoded, body):<br />&nbsp;&nbsp;&nbsp; return {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'statusCode': statusCode,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'headers': headers,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'isBase64Encoded': isBase64Encoded,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'body': body,<br />&nbsp;&nbsp;&nbsp; }<br />def get_config():<br />&nbsp;&nbsp;&nbsp; endpoint = os.getenv("endpoint")<br />&nbsp;&nbsp;&nbsp; database = os.getenv("database")<br />&nbsp;&nbsp;&nbsp; if endpoint is None or database is None:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raise AssertionError("Нужно указать обе переменные окружения")<br />&nbsp;&nbsp;&nbsp; credentials = ydb.construct_credentials_from_environ()<br />&nbsp;&nbsp;&nbsp; return ydb.DriverConfig(endpoint, database, credentials=credentials)<br />def execute(config, query, params):<br />&nbsp;&nbsp;&nbsp; with ydb.Driver(config) as driver:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; driver.wait(timeout=5)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; except TimeoutError:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Connect failed to YDB")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print("Last reported errors by discovery:")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(driver.discovery_debug_details())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return None<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; session = driver.table_client.session().create()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; prepared_query = session.prepare(query)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return session.transaction(ydb.SerializableReadWrite()).execute(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; prepared_query,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; params,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit_tx=True<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; )<br />def insert_link(id, link):<br />&nbsp;&nbsp;&nbsp; config = get_config()<br />&nbsp;&nbsp;&nbsp; query = """<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DECLARE $id AS Utf8;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DECLARE $link AS Utf8;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UPSERT INTO links (id, link) VALUES ($id, $link);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; params = {'$id': id, '$link': link}<br />&nbsp;&nbsp;&nbsp; execute(config, query, params)<br />def find_link(id):<br />&nbsp;&nbsp;&nbsp; print(id)<br />&nbsp;&nbsp;&nbsp; config = get_config()<br />&nbsp;&nbsp;&nbsp; query = """<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DECLARE $id AS Utf8;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECT link FROM links where id=$id;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; """<br />&nbsp;&nbsp;&nbsp; params = {'$id': id}<br />&nbsp;&nbsp;&nbsp; result_set = execute(config, query, params)<br />&nbsp;&nbsp;&nbsp; if not result_set or not result_set[0].rows:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return None<br />&nbsp;&nbsp;&nbsp; return result_set[0].rows[0].link<br />def shorten(event):<br />&nbsp;&nbsp;&nbsp; body = event.get('body')<br />&nbsp;&nbsp;&nbsp; if body:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; body = decode(event, body)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; original_host = event.get('headers').get('Origin')<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; link_id = hashlib.sha256(body.encode('utf8')).hexdigest()[:6]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # в ссылке могут быть закодированные символы, например, %. это помешает работе api-gateway при редиректе,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # поэтому следует избавиться от них вызовом urllib.parse.unquote<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert_link(link_id, urllib.parse.unquote(body))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response(200, {'Content-Type': 'application/json'}, False, json.dumps({'url': f'{original_host}/r/{link_id}'}))<br />&nbsp;&nbsp;&nbsp; return response(400, {}, False, 'В теле запроса отсутствует параметр url')<br />def redirect(event):<br />&nbsp;&nbsp;&nbsp; link_id = event.get('pathParams').get('id')<br />&nbsp;&nbsp;&nbsp; redirect_to = find_link(link_id)<br />&nbsp;&nbsp;&nbsp; if redirect_to:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return response(302, {'Location': redirect_to}, False, '')<br />&nbsp;&nbsp;&nbsp; return response(404, {}, False, 'Данной ссылки не существует')<br /># эти проверки нужны, поскольку функция у нас одна<br /># в идеале сделать по функции на каждый путь в api-gw<br />def get_result(url, event):<br />&nbsp;&nbsp;&nbsp; if url == "/shorten":<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return shorten(event)<br />&nbsp;&nbsp;&nbsp; if url.startswith("/r/"):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return redirect(event)<br />&nbsp;&nbsp;&nbsp; return response(404, {}, False, 'Данного пути не существует')<br />def handler(event, context):<br />&nbsp;&nbsp;&nbsp; url = event.get('url')<br />&nbsp;&nbsp;&nbsp; if url:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # из API-gateway url может прийти со знаком вопроса на конце<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if url[-1] == '?':<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; url = url[:-1]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return get_result(url, event)<br />&nbsp;&nbsp;&nbsp; return response(404, {}, False, 'Эту функцию следует вызывать при помощи api-gateway')<br />$ vim requirements.txt <br />$ cat requirements.txt <br />...<br />ydb==2.13.3<br />$ zip src.zip index1.py requirements.txt<br />$ yc serverless function create \<br />&nbsp; --name for-serverless-shortener \<br />&nbsp; --description "function for serverless-shortener"<br />$ yc serverless function version create \<br />&nbsp; --function-name for-serverless-shortener \<br />&nbsp; --memory=256m \<br />&nbsp; --execution-timeout=5s \<br />&nbsp; --runtime=python39 \<br />&nbsp; --entrypoint=index.handler \<br />&nbsp; --service-account-id $SERVICE_ACCOUNT_SHORTENER_ID \<br />&nbsp; --environment USE_METADATA_CREDENTIALS=1 \<br />&nbsp; --environment endpoint=grpcs://ydb.serverless.yandexcloud.net:2135 \<br />&nbsp; --environment database=$YDB_DATABASE \<br />&nbsp; --source-path src.zip<br />$ yc serverless function allow-unauthenticated-invoke for-serverless-shortener<br />$ vim for-serverless-shortener.yml<br />$ cat for-serverless-shortener.yml<br />openapi: 3.0.0<br />info:<br />&nbsp; title: for-serverless-shortener<br />&nbsp; version: 1.0.0<br />paths:<br />&nbsp; /:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: object_storage<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bucket:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;bucket_name&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- имя бакета<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;html_file&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- имя html-файла<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; presigned_redirect: false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; service_account:&nbsp;&nbsp;&nbsp; &lt;service_account_id&gt; # &lt;-- идентификатор сервисного аккаунта<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: static<br />&nbsp; /shorten:<br />&nbsp;&nbsp;&nbsp; post:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud_functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id:&nbsp; &lt;function_id&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- идентификатор функции<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: shorten<br />&nbsp; /r/{id}:<br />&nbsp;&nbsp;&nbsp; get:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; x-yc-apigateway-integration:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: cloud_functions<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; function_id:&nbsp; &lt;function_id&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # &lt;-- идентификатор функции<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; operationId: redirect<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parameters:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - description: id of the url<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; explode: false<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in: path<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; name: id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; required: true<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; schema:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: string<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; style: simple<br />$ yc serverless api-gateway create \<br />&nbsp; --name for-serverless-shortener \<br />&nbsp; --spec=for-serverless-shortener.yml \<br />&nbsp; --description "for serverless shortener"<br />$ yc serverless api-gateway list<br />$ yc serverless api-gateway get --name for-serverless-shortener</p>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Безопасность в Yandex Cloud</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />В целях безопасности облачных ресурсов реализовал права на управление сервисным аккаунтом, организовал защищённый канал настроив IPSec VPN-туннель между двумя VPN-шлюзами в ВМ с помощью демона strongSwan, реализовал для домена втоматический выпуск сертификата с помощью Certificate Manager<br /><strong>Task:</strong><br />Права доступа и роли для сервисного аккаунта.<br />В этом уроке вы научитесь работать с сервисными аккаунтами и назначать для них роли и права доступа к объектам. <br />В качестве объекта будет выступать созданный в сервисе KMS ключ шифрования. <br />Предположим, что перед вами стоит задача использовать сервисный аккаунт для ротации ключей.<br />Чтобы решить эту задачу, понадобится выполнить следующие шаги:<br />- Создать сервисный аккаунт.<br />- Получить права на управление этим сервисным аккаунтом.<br />- Создать статические ключи доступа и привязать их к сервисному аккаунту, чтобы он мог пройти авторизацию в сервисе KMS.<br />- Создать в сервисе KMS ключ шифрования и назначить сервисному аккаунту роль kms.admin для управления этим ключом.<br />- И, наконец, ротировать ключ, то есть создать его новую версию с такими же параметрами, из-под сервисного аккаунта.<br />- Нужно заметить, что через консоль управления сервисному аккаунту можно назначить роль только на каталог, в котором он был создан. Роли на все остальные ресурсы назначаются с помощью CLI или API. Поэтому для выполнения этой практической работы вам понадобится вспомнить, как пользоваться утилитой yc, чему вы уже научились в курсе &laquo;DevOps и автоматизация&raquo;.<br /><strong>Decision:</strong><br />ШАГ 1<br />Для начала создадим сервисный аккаунт. В консоли управления войдите в каталог облака, в котором вы будете выполнять эту практическую работу, и перейдите на вкладку Сервисные аккаунты. Нажмите кнопку Создать сервисный аккаунт.<br />В открывшемся окне задайте для нового сервисного аккаунта имя и, при желании, добавьте описание. Здесь аккаунту также можно добавить роли на каталог, в котором он создаётся.<br />Оставьте поле с ролями пустым и нажмите Создать.<br />ШАГ 2<br />Настройте для вашего аккаунта на Яндексе доступ на авторизацию под созданным сервисным аккаунтом.<br />Для начала убедитесь, что вы авторизованы в аккаунте с ролью admin. Чтобы это проверить, выполните команду<br />yc iam role list <br />Вы увидите список ролей вашего аккаунта. Примерно такой (роль admin должна в нем присутствовать):<br />Узнайте идентификатор своего аккаунта. Он понадобится, чтобы добавить вашему аккаунту роль editor на созданный сервисный аккаунт (сервисный аккаунт тоже является ресурсом, и для работы с ним нужна соответствующая роль). Воспользуйтесь для этого командой:<br />yc iam user-account get &lt;имя_вашего_аккаунта&gt; <br />Кроме того, нужно узнать идентификатор созданного сервисного аккаунта. Это можно сделать в разделе Сервисные аккаунты консоли управления. Выбрав нужный аккаунт в списке, вы перейдёте на страницу с детальной информацией о нем.<br />Теперь предоставьте вашему пользовательскому аккаунту права на управление созданным сервисным аккаунтом. Для этого нужно выполнить команду<br />yc iam service-account add-access-binding &lt;ID_сервисного_аккаунта&gt; \<br />--role editor --subject userAccount:&lt;ID_пользовательского_аккаунта&gt; <br />ШАГ 3<br />Настройте аутентификацию под сервисным аккаунтом с вашей машины.<br />Сначала нужно создать статические ключи доступа и сохранить их в json-файле (например key.json).<br />Воспользуйтесь для этого командой<br />yc --folder-name &lt;имя_каталога&gt; iam key create \<br />--service-account-name &lt;имя_сервисного_аккаунта&gt; --output key.json <br />После выполнения команды вы получите идентификатор созданной ключевой пары. Используя статические ключи доступа, можно получить IAM-токен для авторизации в сервисах.<br />Теперь нужно создать профиль, от имени которого будут выполняться операции из-под сервисного аккаунта. Для этого придумайте имя этого профиля (например yc-lab23-profile) и выполните команду:<br />yc config profile create &lt;имя_профиля&gt; <br />Привяжите к этому профилю ранее созданный статический ключ доступа с помощью команды:<br />yc config set service-account-key key.json <br />Чтобы убедиться, что всё сделано правильно, выведите информацию об авторизации и ключах доступа<br />yc config list <br />Вы должны получить примерно такой результат:<br />ШАГ 4<br />Теперь нужно создать ключ шифрования, ротацией которого вы будете управлять с помощью сервисного аккаунта. Для этого перейдите в дашборд каталога в консоли управления, нажмите кнопку Создать ресурс и выберите Ключ шифрования.<br />В открывшемся окне задайте для ключа имя и нажмите кнопку Создать. Новый ключ появится в списке в открывшемся разделе Ключи.<br />Чтобы назначить сервисному аккаунту роль для какого-либо ресурса, нужно знать идентификатор этого ресурса. Нажмите строку с созданным ключом, чтобы перейти на страницу детальной информации о нём, и скопируйте ID ключа.<br />Перейдем к назначению сервисному аккаунту роли kms.admin для управления созданным ключом шифрования. Перед этим нужно сначала вернуться в профиль вашего аккаунта.<br />yc config profile activate &lt;имя_профиля&gt; <br />Выполните команду:<br />yc --folder-name &lt;имя_каталога&gt; kms symmetric-key \<br />add-access-binding &lt;ID_ключа_шифрования&gt; --role kms.admin \<br />--subject serviceAccount:&lt;ID_сервисного_аккаунта&gt; <br />Теперь с помощью сервисного аккаунта вы можете управлять этим ключом шифрования.<br />ШАГ 5<br />В CLI переключитесь обратно в профиль сервисного аккаунта:<br />yc config profile activate &lt;имя_профиля_сервисного_аккаунта&gt; <br />Ротируйте ключ шифрования:<br />yc kms symmetric-key rotate &lt;ID_ключа&gt; <br />После выполнения команды перейдите на страницу детальной информации о ключе и откройте вкладку Операции.<br />Вы увидите, что операция по ротации ключа выполнена под вашим сервисным аккаунтом. Значит, всё получилось и задача решена!<br /><strong>Decision:</strong><br />$ yc iam service-account create --name &lt;имя_сервисного_аккаунта&gt;<br />$ yc iam service-account create --name security-labs \<br />--description "Service account for Security course labs"<br />$ yc iam role list<br />$ yc iam user-account get &lt;ваш_логин&gt;<br />$ yc iam service-account list<br />$ yc iam service-account get &lt;имя_сервисного_аккаунта&gt;<br />$ yc iam service-account add-access-binding &lt;id_сервисного_аккаунта&gt; \<br />--role editor \<br />--subject userAccount:&lt;id_пользовательского_аккаунта&gt;<br />$ vim key.json<br />$ cat key.json<br />{<br />&nbsp; "id": "YOUR-ID1",<br />&nbsp; "service_account_id": "YOUR-ID2",<br />&nbsp; "created_at": "2023-12-09T01:19:35.625144946Z",<br />&nbsp; "key_algorithm": "RSA_2048",<br />&nbsp; "public_key": "-----BEGIN PUBLIC KEY-----\nYOUR-KEY1\n-----END PUBLIC KEY-----\n",<br />&nbsp; "private_key": "PLEASE DO NOT REMOVE THIS LINE! Yandex.Cloud SA Key ID &lt;YOUR-ID1&gt;\n-----BEGIN PRIVATE KEY-----\nYOUR-KEY2\n-----END PRIVATE KEY-----\n"<br />}<br />$ yc iam key create \<br />--service-account-name &lt;имя_сервисного_аккаунта&gt; \<br />--output key.json<br />$ yc config profile create &lt;имя_профиля_сервисного_аккаунта&gt;<br />$ yc config set service-account-key key.json<br />$ yc config set folder-id &lt;идентификатор_рабочего_каталога&gt;<br />$ yc config list<br />$ yc config profile list<br />$ yc config profile activate &lt;имя_основного_профиля&gt;<br />$ yc kms symmetric-key add-access-binding \<br />--id &lt;id_ключа_шифрования&gt; \<br />--role kms.admin \<br />--subject serviceAccount:&lt;id_сервисного_аккаунта&gt;<br />$ yc config profile activate &lt;имя_профиля_сервисного_аккаунта&gt;<br />$ yc kms symmetric-key rotate --id &lt;id_ключа_шифрования&gt;<br /><strong>Task:</strong><br />Организация защищённого канала. <br />Защита данных, передаваемых между вашей локальной инфраструктурой и облаком, &mdash; важный элемент информационной безопасности. А удалённая работа, которая получила распространение в период пандемии коронавируса и сейчас закрепилась в практиках многих компаний, сделала эту задачу ещё более актуальной.<br />Чтобы защитить передаваемую информацию, используют VPN (Virtual Private Network) &mdash; технологию, позволяющую развернуть защищённое сетевое соединение &laquo;поверх&raquo; незащищённой сети (чаще всего это интернет). VPN-соединение представляет собой канал передачи данных между двумя узлами. Этот канал обычно называют VPN-туннелем. Если за одним из узлов находится целая сеть, то его называют VPN-шлюзом.<br />Механизм работы VPN:<br />- Перед созданием туннеля узлы идентифицируют друг друга, чтобы удостовериться, что шифрованные данные будут отправлены на нужный узел.<br />- На обоих узлах нужно заранее определить, какие протоколы будут использоваться для шифрования и обеспечения целостности данных.<br />- Узлы сверяют настройки, чтобы договориться об используемых алгоритмах. Если настройки разные, туннель не создаётся.<br />- Если сверка прошла успешно, то создаётся ключ, который используется для симметричного шифрования.<br />Этот механизм регламентируют несколько стандартов. Один из самых популярных &mdash; IPSec (Internet Protocol Security).<br />На этом уроке вы научитесь настраивать IPSec VPN-туннель между двумя VPN-шлюзами с помощью демона strongSwan. Один шлюз вы настроите на виртуальной машине в Yandex Cloud, второй &mdash; на своей локальной машине или виртуальной машине в другой облачной сети.<br /><strong>Decision:</strong><br />Шаг 1. Создание ресурсов<br />Для практической работы вам понадобится сеть и подсеть в Yandex Cloud, а также созданная в этой подсети тестовая ВМ без публичного IP-адреса. Создайте эти ресурсы, если у вас их нет.<br />Теперь создадим IPSec-инстанс &mdash; ВМ, которая будет служить шлюзом для IPSec-туннеля. Чтобы это сделать:<br />Откройте ваш каталог, нажмите кнопку Создать ресурс и выберите пункт Виртуальная машина.<br />В поле Имя задайте имя ВМ, например ipsec-instance.<br />Выберите зону доступности, где находится подсеть, к которой будет подключён IPSec-инстанс, и тестовая ВМ.<br />В разделе Выбор образа/загрузочного диска перейдите в блок Cloud Marketplace и выберите образ IPSec-инстанс.<br />В блоке Сетевые настройки выберите нужную сеть, подсеть и назначьте ВМ публичный IP-адрес из списка или автоматически.<br />Важно использовать только статические публичные IP-адреса из списка или сделать IP-адрес ВМ статическим после её создания. Динамический IP-адрес может измениться после перезагрузки ВМ, и туннель перестанет работать.<br />В блоке Доступ укажите логин и SSH-ключ для доступа к ВМ.<br />Нажмите кнопку Создать ВМ.<br />Виртуальная машина готова.<br />Шаг 2. Настраиваем IPSec<br />Теперь настроим шлюз с публичным IP-адресом, который будет устанавливать IPSec-соединение с удалённым шлюзом (вашей локальной машиной или ВМ в другой облачной сети).<br />Вы можете создать в своём каталоге ещё одну облачную сеть с подсетью, создать в ней IPSec-инстанс из образа и использовать его в качестве удалённого шлюза. Либо можно использовать в качестве шлюза машину в вашей локальной сети. Вам понадобится публичный IP-адрес удалённого шлюза и CIDR подсети.<br />Допустим, публичный IP-адрес вашего шлюза &mdash; 130.193.32.25, а за ним находится подсеть c префиксом подсети CIDR 10.128.0.0/24. Шлюз будет устанавливать IPSec-соединение с удалённым шлюзом с IP-адресом, например, 1.1.1.1, за которым находится подсеть с префиксом подсети CIDR 192.168.0.0/24.<br />Подключитесь к ВМ IPSec-инстанс по SSH:<br />ssh &lt;имя пользователя&gt;@130.193.32.25 <br />Откройте конфигурацию IPSec:<br />sudo nano /etc/ipsec.conf <br />В разделе config setup файла конфигурации задайте следующие параметры:<br />config setup<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; charondebug="all"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uniqueids=yes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strictcrlpolicy=no <br />Добавьте новый раздел с описанием тестового соединения, например conn cloud-to-hq.<br />Задайте параметры тестового соединения:<br />leftid &mdash; публичный IP-адрес IPSec-инстанса.<br />leftsubnet &mdash; CIDR подсети, к которой подключён IPSec-инстанс.<br />right &mdash; публичный IP-адрес шлюза на другом конце VPN-туннеля.<br />rightsubnet &mdash; CIDR подсети, к которой подключён VPN-шлюз на другом конце VPN-туннеля.<br />Параметры ike и esp &mdash; это алгоритмы шифрования, которые поддерживаются на удалённом шлюзе. Перечень поддерживаемых алгоритмов можно посмотреть на сайте strongSwan: IKEv1 и IKEv2.<br />Укажите остальные настройки, консультируясь с документацией strongSwan и учитывая настройки удалённого шлюза.<br />У вас должна получиться примерно такая конфигурация:<br />conn cloud-to-hq<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start <br />Сохраните изменения и закройте файл.<br />Откройте файл /etc/ipsec.secrets и укажите в нём пароль для установки соединения:<br />130.193.32.25 1.1.1.1 : PSK "&lt;пароль&gt;" <br />Перезапустите strongSwan:<br />sudo systemctl restart strongswan-starter <br />Шаг 3. Настраиваем статическую маршрутизацию<br />Теперь нужно настроить маршрутизацию между IPSec-инстансом и тестовой ВМ без публичного IP-адреса. Для этого создадим таблицу маршрутизации и добавим в неё статические маршруты.<br />Откройте сервис Virtual Private Cloud в каталоге, где требуется создать статический маршрут.<br />Выберите раздел Таблицы маршрутизации в панели слева и нажмите кнопку Создать таблицу маршрутизации.<br />Задайте имя таблицы маршрутизации, выберите сеть, в которой требуется её создать, и нажмите кнопку Добавить маршрут.<br />В открывшемся окне введите префикс подсети назначения на удалённой стороне, в примере это 192.168.0.0/24.<br />В поле Next hop укажите внутренний IP-адрес IPSec-шлюза и нажмите кнопку Добавить.<br />Нажмите кнопку Создать таблицу маршрутизации.<br />Чтобы использовать статические маршруты, нужно привязать таблицу маршрутизации к подсети. Для этого в разделе Подсети, в строке нужной подсети, нажмите кнопку &hellip; и в открывшемся меню выберите пункт Привязать таблицу маршрутизации.<br />В открывшемся окне выберите созданную таблицу и нажмите кнопку Привязать. Созданный маршрут можно применять и к другим подсетям этой сети.<br />Шаг 4. Настраиваем IPSec на другом шлюзе<br />Для работы VPN-туннеля нужно настроить второй шлюз.<br />Настройте strongSwan аналогично первому IPSec-шлюзу, но с зеркальными настройками IP-адресов и подсетей в файле /etc/ipsec.conf. Должна получиться такая конфигурация:<br />conn hq-to-cloud<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start <br />Укажите пароль для соединения в файле /etc/ipsec.secrets, указав IP-адреса шлюзов в обратном порядке:<br />1.1.1.1 130.193.32.25 : PSK "&lt;пароль&gt;" <br />Перезапустите strongSwan:<br />sudo systemctl restart strongswan-starter <br />Шаг 5. Проверяем, что всё работает<br />Чтобы убедиться, что туннель между шлюзами установлен, выполните на любом из шлюзов команду:<br />sudo ipsec status <br />Если всё в порядке, то у вас должно появиться примерно такое сообщение:<br />Security Associations (1 up, 0 connecting):<br />hq-to-cloud[3]: ESTABLISHED 29 minutes ago, 10.128.0.26[130.193.33.12]...192.168.0.23[1.1.1.1]<br />hq-to-cloud{3}:&nbsp; INSTALLED, TUNNEL, reqid 3, ESP in UDP SPIs: c7fa371d_i ce8b91ad_o<br />hq-to-cloud{3}:&nbsp;&nbsp; 10.128.0.0/24 === 192.168.0.0/24 <br />Статус ESTABLISHED означает, что туннель между шлюзами создан.<br />Сведения об установке и работе соединения находятся в логах strongSwan. Просмотреть логи можно с помощью команды:<br />sudo journalctl -u strongswan-starter <br />Проверить статус демона strongSwan можно командой:<br />systemctl status strongswan-starter <br />Осталось проверить связность соединения. Для этого создайте ещё одну тестовую виртуальную машину за вторым шлюзом, а затем пропингуйте одну тестовую машину с другой.<br /><strong>Decision:</strong><br />$ ssh &lt;имя пользователя&gt;@130.193.32.25<br />$ sudo vim /etc/ipsec.conf<br />$ sudo cat /etc/ipsec.conf<br />...<br />config setup<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; charondebug="all"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uniqueids=yes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strictcrlpolicy=no<br />...<br />conn cloud-to-hq<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start<br />$ sudo vim /etc/ipsec.secrets<br />$ sudo cat /etc/ipsec.secrets<br />130.193.32.25 1.1.1.1 : PSK "&lt;пароль&gt;"<br />$ sudo systemctl restart strongswan-starter<br />$ exit <br />$ ssh &lt;имя пользователя&gt;@130.193.32.26<br />$ sudo vim /etc/ipsec.conf<br />$ sudo cat /etc/ipsec.conf<br />...<br />config setup<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; charondebug="all"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uniqueids=yes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strictcrlpolicy=no<br />...<br />conn hq-to-cloud<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; authby=secret<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; left=%defaultroute<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftid=1.1.1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; leftsubnet=192.168.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; right=130.193.32.25<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rightsubnet=10.128.0.0/24<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ike=aes256-sha2_256-modp1024!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esp=aes256-sha2_256!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keyingtries=0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ikelifetime=1h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lifetime=8h<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpddelay=30<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdtimeout=120<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dpdaction=restart<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; auto=start<br />$ sudo vim /etc/ipsec.secrets<br />$ sudo cat /etc/ipsec.secrets<br />1.1.1.1 130.193.32.25 : PSK "&lt;пароль&gt;"<br />$ sudo systemctl restart strongswan-starter<br />$ ssh &lt;имя пользователя&gt;@130.193.32.25<br />$ sudo ipsec status <br />$ sudo journalctl -u strongswan-starter<br />$ systemctl status strongswan-starter<br /><strong>Task:</strong><br />Выпуск сертификата для сайта.<br />В этой практической работе мы зарегистрируем домен, привяжем его к бакету в объектном хранилище и настроим для этого домена автоматический выпуск сертификата с помощью Certificate Manager.<br /><strong>Decision:</strong><br />Шаг 1<br />Если у вас нет своего домена, зарегистрируйте временный домен, например, на сайте freenom.com:<br />Проверьте на сайте доступность имени, которое вы придумали для своего домена.<br />Введите имя вместе с доменом верхнего уровня, например testpracticum2022.ml, иначе при попытке зарезервировать домен сервис будет сообщать, что домен занят.<br />Если это имя доступно, добавьте домен в корзину и укажите свой email для подтверждения.<br />Проверьте почту и подтвердите регистрацию домена.<br />Обновите страницу с заказом.<br />После подтверждения регистрации домена зайдите в объектное хранилище (Object Storage) и создайте новый публичный бакет. Его название должно совпадать с полным названием домена.<br />Переключите доступ на чтение объектов в Публичный. Загрузите в бакет файлы статического сайта (вы можете воспользоваться файлами из практической работы курса &laquo;Хранение и анализ данных&raquo;.<br />Выберите на панели управления раздел Веб-сайт, переключите бакет в режим Хостинг и нажмите Сохранить.<br />Шаг 2<br />Настроить защищённый доступ к бакету можно двумя способами: загрузить сертификат прямо в бакет или с помощью Certificate Manager. Воспользуемся вторым способом.<br />В консоли управления перейдите в сервис Certificate Manager. Для выпуска сертификата с помощью этого сервиса подтвердите владение доменом: в разделе Сертификаты нажмите кнопку Добавить сертификат и выберите Сертификат Let&rsquo;s Encrypt.<br />В открывшемся окне задайте имя создаваемого сертификата и заполните поле с именем вашего домена. Нажмите кнопку Создать.<br />Сервис автоматически направит запрос на создание сертификата, а домен перейдёт в статус проверки.<br />Для выпуска сертификата необходимо подтвердить статус владения доменом. Откройте страницу с деталями запроса на сертификат:<br />На этой странице для нас важны два поля: имя DNS-записи и её значение. Если вы создавали домен на freenom.com, то перейдите в личный кабинет на этом сайте, выберите раздел Services &rarr; My Domains и нажмите кнопку Manage Domains:<br />Выберите Manage Freenom DNS:<br />В открывшемся редакторе добавьте TXT-запись для подтверждения владения доменом. В качестве названия записи задайте _acme-challenge без полного названия домена. В качестве значения TXT-записи &mdash; значение со страницы проверки прав на домен в консоли управления Yandex Cloud.<br />Аналогично внесите значение CNAME-записи со страницы проверки прав на домен в консоли управления Yandex Cloud.<br />Добавьте также запись CNAME для привязки поддомена WWW к вашему бакету:<br />В поле Target укажите полное имя бакета, включая .website.yandexcloud.net. Сохраните сделанные изменения.<br />Если вы используете собственный домен, задайте параметры DNS в настройках вашего DNS-сервера. Для применения настроек DNS потребуется некоторое время &mdash; обычно до 15 минут.<br />После окончания проверки домена Certificate Manager автоматически выпустит сертификат.<br />Шаг 3<br />Теперь настроим доступ к сайту, то есть к созданному бакету, по протоколу HTTPS с помощью сертификата. Для этого перейдите в раздел HTTPS и нажмите кнопку Настроить.<br />В поле Источник выберите Certificate Manager, в поле Сертификат &mdash; ранее выпущенный сертификат. Нажмите кнопку Сохранить.<br />Теперь ваш сайт доступен по протоколу HTTPS. Чтобы проверить это, откройте его в браузере. В адресной строке браузера должен отображаться значок защищённого соединения.<br /><strong>Task:</strong><br />Создание и ротация ключей шифрования<br />На прошлом уроке вы познакомились с возможностями сервиса управления ключами шифрования KMS. В этой практической работе вы научитесь создавать ключи шифрования и управлять ими, а также использовать эти ключи для шифрования и расшифрования данных.<br /><strong>Decision:</strong><br />Шаг 1<br />Перейдите в панель управления Yandex Cloud, нажмите кнопку Создать ресурс и выберите из выпадающего списка пункт Ключ шифрования.<br />Задайте для создаваемого ключа имя (например yc-lab-key1), заполните поле Описание (это необязательно) и выберите алгоритм шифрования. Предположим, что ключ нужно ротировать каждый день. Для этого в поле Период ротации, дни выберите вариант Своё значение и введите число 1 в поле справа.<br />Нажмите кнопку Создать. Когда операция создания ключа завершится, новый ключ появится в списке.<br />Нажав на строку с ключом, вы перейдёте на страницу детальной информации. На ней приведены все параметры ключа, а также список его версий. Обратите внимание, что ID (идентификатор) ключа и ID конкретной версии ключа отличаются. Важно их не путать.<br />Шаг 2<br />Давайте используем созданный ключ для шифрования и расшифрования данных. Создайте у себя на диске файл (например, текстовый файл с именем plain.txt). Добавьте в него любой текст и сохраните содержимое. Напомним, что размер файла не должен превышать 32 килобайта.<br />Запустите утилиту командной строки (bash или cmd) и перейдите в каталог с файлом plain.txt. Зашифруйте этот файл с помощью утилиты yc, а результат операции шифрования выведите в файл encrypted.txt. Для этого выполните команду:<br />yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted.txt <br />После выполнения команды будет создан файл encrypted.txt, который содержит зашифрованный текст. Утилита yc также выведет информацию о том, каким ключом и какой его версией файл был зашифрован.<br />Шаг 3<br />Теперь расшифруйте этот файл, а результат операции выведите в файл decrypted.txt. Для этого выполните команду:<br />yc kms symmetric-crypto decrypt --id &lt;ID ключа&gt; --ciphertext-file encrypted.txt --plaintext-file decrypted.txt <br />В результате выполнения команды будет создан файл decrypted.txt с идентичным исходному файлу (plain.txt) содержимым.<br />Если расшифровать файл не удалось, утилита выдаст сообщение об ошибке.<br />Шаг 4<br />Создайте новую версию ключа. Для этого перейдите на страницу детальной информации о ключе и нажмите кнопку Ротировать. Новая версия ключа появится в списке версий и станет основной (Primary). Обратите внимание, что идентификаторы версий отличаются друг от друга.<br />Шаг 5<br />Запланируйте удаление первой версии ключа. Для этого в списке версий нажмите на значок &hellip; в строке с этой версией, а затем выберите пункт Запланировать удаление.<br />В появившемся окне установите время, по истечении которого ключ будет удалён, и нажмите Запланировать. Версия ключа не может быть удалена моментально, минимальный период времени для её удаления составляет один день.<br />После этого в списке версий удаляемый ключ будет помечен как запланированный на удаление (Scheduled For Destruction). Теперь этой версией ключа невозможно расшифровать файлы, которые были зашифрованы с её помощью.<br />Провести ротацию ключа можно и из командной строки. Для этого используется команда:<br />yc kms symmetric-key rotate &lt;ID ключа&gt; <br />Шаг 6<br />Зашифруйте исходный файл plain.txt с помощью новой версии ключа. Результат запишите в файл encrypted_with_new_key.txt.<br />yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted_with_new_key.txt <br />Теперь у вас есть два файла:<br />- encrypted.txt, зашифрованный версией ключа, которая помечена на удаление;<br />- encrypted_with_new_version.txt, зашифрованный новой версией ключа.<br />Попробуйте расшифровать данные из обоих файлов. Вы увидите, что расшифровать первый файл не получилось, а файл, который зашифрован второй версией ключа, расшифрован.<br />Запланированное удаление первой версии ключа можно отменить. Это позволит расшифровать данные из первого файла.<br />В строке версии ключа, которая запланирована на удаление, нажмите значок &hellip;, а затем кнопку кнопку Отменить удаление. Эта версия снова получит статус активной. Проверьте, что она работает, расшифровав файл encrypted.txt.<br /><strong>Decision:</strong><br />$ vim plain.txt<br />$ cat plain.txt<br />test text<br />$ yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted.txt<br />$ yc kms symmetric-crypto encrypt --id abjkh5a8k2uao3f8qi8k --plaintext-file plain.txt --ciphertext-file encrypted.txt<br />$ cat encrypted.txt <br />abj2vjcrv89d83cef26in#���k��|�V�X�<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ����:�F���*Y��l�(���у��֜�l�S<br />$ yc kms symmetric-crypto decrypt --id &lt;ID ключа&gt; --ciphertext-file encrypted.txt --plaintext-file decrypted.txt<br />$ cat decrypted.txt <br />test text<br />$ yc kms symmetric-key rotate &lt;ID ключа&gt;<br />$ yc kms symmetric-crypto encrypt --id &lt;ID ключа&gt; --plaintext-file plain.txt --ciphertext-file encrypted_with_new_key.txt<br />$ cat encrypted_with_new_key.txt<br />abjofv85g302tc8mjhqq��n�nߊz6�5�A�<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; �)ڀi�R0����o��s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; �^<br />�m�C zci�b�'</p>
                    </div>
                </div> 
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Прогнозирование затрат и оптимизация расходов в Yandex Cloud</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для оптимизации своих расходов в Yandex Cloud настроил дашборды в DataLens и использовал их.<br /><strong>Task:</strong><br />Калькулятор расходов<br />Любая стройка начинается со сметы. Облачная архитектура не исключение &mdash; прежде чем разворачивать систему, нужно просчитать её стоимость.<br />Чтобы сделать это в Yandex Cloud, откройте калькулятор тарифов.<br /><strong>Decision:</strong><br />Задание 1. Работа с калькулятором<br />Давайте для начала посчитаем, во сколько рублей в месяц обойдётся система со следующими параметрами:<br />Compute Cloud: Ubuntu 20.04 LTS, Intel Broadwell, 4 vCPU 100%, 16 ГБ RAM, SSD 100 ГБ, без публичного IP-адреса.<br />Managed Service for PostgreSQL: Intel Cascade Lake, standard, s2.micro, network-ssd, 200 ГБ, два хоста, публичный IP-адрес.<br />Техподдержка: тариф &laquo;Бизнес&raquo; при потреблении 50 тыс. ₽ в месяц.<br />Сервисы Yandex.Cloud, стоимость которых можно рассчитать, указаны на верхней панели калькулятора:<br />Выберите Compute Cloud и задайте параметры виртуальной машины. Должно получиться вот так:<br />Как видите, справа указана стоимость сервиса с детализацией. Если выбрать ещё один сервис на панели вверху &mdash; его стоимость добавится в общий лист, а внизу отобразится общая сумма за все сервисы.<br />Давайте это проверим. Выберите PostgreSQL и укажите нужную конфигурацию: один кластер Intel Cascade Lake, standard, s2.micro, network-ssd, 200 ГБ, два хоста, публичный IP-адрес.<br />Остался последний сервис &mdash; техническая поддержка.<br />Плата за тарифы &laquo;Стандарт&raquo; и &laquo;Бизнес&raquo; зависит от количества потребляемых ресурсов. Тариф &laquo;Премиум&raquo; может быть дополнен различными услугами и рассчитывается индивидуально.<br />Узнаем стоимость тарифа &laquo;Бизнес&raquo; при потреблении ресурсов на 50 тыс. ₽ в месяц:<br />Теперь вы знаете, сколько стоит система из трёх сервисов, и можете запустить её &mdash; или поэкспериментировать с конфигурациями, чтобы добиться приемлемой стоимости.<br />Задание 2. Расчёт вручную<br />А теперь задача со звёздочкой. В калькулятор тарифов пока добавлены не все сервисы Yandex Cloud. Стоимость некоторых придётся рассчитывать вручную. Потренируемся это делать.<br />Узнаем, например, сколько стоит сервис Monitoring. Прокрутите страницу калькулятора вниз и в блоке Инфраструктура и сеть выберите Monitoring.<br />Да, вы попадёте в документацию, но такова жизнь. Здесь указаны цены ресурсов. Со временем они могут меняться, поэтому для решения задачи ниже берите цены за август 2022 года:<br /><strong>Task:</strong><br />рассчитать стоимость месячного использования сервиса при записи 35 метрик с частотой два значения в минуту.<br />Подсказка: используйте раздел &laquo;Пример расчёта стоимости&raquo; как шпаргалку.<br /><strong>Decision:</strong><br />-16,93 ₽<br />-21,17 ₽<br />+29,64 ₽<br />-36,02 ₽<br /><strong>Task:</strong><br />Поиск самой затратной виртуальной машины<br />В боевых проектах вам часто придётся искать самую большую статью расходов, а потом придумывать, что с ней делать. Сейчас вы научитесь маркировать ВМ метками, чтобы понять, какая из них обходится дороже всего. Такими же метками можно размечать ресурсы и других сервисов Yandex Cloud.<br /><strong>Decision:</strong><br />Перед началом этого урока создайте четыре виртуальные машины &mdash; с 5, 20, 50 и 100% vCPU &mdash; и сделайте небольшой перерыв. Нужно как минимум 15 минут, чтобы вы увидели их потребление на дашбордах.<br />Если у вас ещё нет интерфейса командной строки Yandex Cloud Воспользуйтесь инструкцией, чтобы установить и инициализировать интерфейс командной строки (CLI) Yandex Cloud.<br />Универсальный шаблон команды добавления метки выглядит следующим образом:<br />&nbsp;yc &lt;имя сервиса&gt; &lt;тип ресурса&gt; add-labels &lt;имя или идентификатор ресурса&gt; --labels &lt;имя метки&gt;=&lt;значение метки&gt;<br />Давайте уточним его для нашей задачи. Имя сервиса &mdash; compute, тип ресурса &mdash; instance. Идентификатор ресурса вы найдёте в консоли на странице обзора ВМ:<br />Имя метки и значение метки задайте на свой вкус: можно использовать латиницу, цифры, дефисы и подчёркивания (не больше 63 символов).<br />Если вы сделали всё правильно, то увидите результат выполнения команды:<br />Повторите те же действия для трёх оставшихся ВМ.<br />Когда закончите с метками, сделайте паузу. Системе понадобится несколько минут, чтобы отобразить данные размеченных машин в Yandex DataLens.<br />В DataLens откройте дашборд Yandex Cloud Billing Dashboard и перейдите на вкладку Labels. Найти самую дорогую ВМ будет несложно:<br />Устанавливайте метки на те ресурсы, которые требуют пристального внимания, и тогда вам будет легче за ними следить.<br />Однако самостоятельно следить за потреблением в режиме нон-стоп просто невозможно. Чтобы всегда оставаться в курсе потребления и не уйти в минус при его резком всплеске, нужен автоматический помощник.<br /><strong>Decision:</strong><br />$ yc &lt;имя сервиса&gt; &lt;тип ресурса&gt; add-labels &lt;имя или идентификатор ресурса&gt; --labels &lt;имя метки&gt;=&lt;значение метки&gt;</p>
                    </div>
                </div> 
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Резкое переполнение базы в Firebird</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Резкое переполнение базы в Firebird<br />Ошибка после ввода пароля в ПИ СДП у всех пользователей - "Не отвечает программа"<br />&nbsp;&nbsp; ВНЕШНЯЯБАЗА2.exe не работает<br />На одном из объектов автоматизации второй раз за месяц происходит процесс переполнения внешней базы документооборота C:\ПУТЬКБАЗЕ\ВНЕШНЯЯБАЗА1.GDB. База данных увеличивается в размерах с 1.8 Гб до 115Гб за три дня. После проведения инженером филиала процедуры Бэкап/Рестор внешняя база возвращается к прежнему размеру. Данная проблема наблюдается второй раз за месяц с периодичностью в две недели.<br /><strong>Task:</strong><br />Отключить службы Firebird, Сделать backup/restore базы ВНЕШНЯЯБАЗА1.GDB, запустив скрипты <br />1. backup.bat <br />2. restore.bat<br />после чего сохранится файл ВНЕШНЯЯБАЗА1.GDB в КУДАСОХРАНЯТЬИЗМЕНЕНИЯ. Файл заменить на файл в сервере, который занимал 120 гб. Посмотреть лог файлы:<br />1. retranslator.log<br />2. retranslator_2022-01-11_15-23-40-694.log<br />3. retranslator_2022-01-24_16-36-09-627.log<br />4. retranslator_2022-01-24_16-36-16-806.log<br /><strong>Decision:</strong><br />$ cat backup.bat<br />@ echo on<br />SET ISC_USER=ИМЯПОЛЬЗОВАТЕЛЯБАЗЫ<br />SET ISC_PASSWORD=ПАРОЛЬКБАЗЕ<br />SET dbpath=localhost:C:\ПУТЬКБАЗЕ\ВНЕШНЯЯБАЗА1.GDB<br />SET fbpath=C:\ПУТЬFIREBIRD\Firebird_1_5\bin\<br />SET bbpath=C:\КУДАСОХРАНЯТЬИЗМЕНЕНИЯ\<br />"%fbpath%gfix" -shut -force 5 "%dbpath%"<br />"%fbpath%gbak" -b -v -g -y "%bbpath%%date%.log" "%dbpath%" "%bbpath%ВНЕШНЯЯБАЗА1_%date%.gbk"<br />@ pause<br />$ cat restore.bat<br />@ echo on<br />SET ISC_USER=ИМЯПОЛЬЗОВАТЕЛЯБАЗЫ<br />SET ISC_PASSWORD=ПАРОЛЬКБАЗЕ<br />SET fbpath=C:\ПУТЬFIREBIRD\Firebird_1_5\bin\<br />SET bbpath=localhost:C:\КУДАСОХРАНЯТЬИЗМЕНЕНИЯ\<br />"%fbpath%gbak.exe" -c -v -r -y "c:\КУДАСОХРАНЯТЬИЗМЕНЕНИЯ\%date%_fix.log" "c:\КУДАСОХРАНЯТЬИЗМЕНЕНИЯ\ВНЕШНЯЯБАЗА1_backup.gbk" "%bbpath%ВНЕШНЯЯБАЗА1_fix.GDB" <br />@ pause<br />$ cat retranslator.log<br />...<br />INF|09.12.2022 16:27:36 Сообщения в очереди "viv.client.КОДОА.1" отсутствуют<br />INF|09.12.2022 16:32:39 Отправка запроса id="ИДЕНТИФИКАТОРПРОЦЕССА1", type_id=ИДЕНТИФИКАТОРТИП ...<br />ERR|09.12.2022 16:33:37 Out of memory.<br />&nbsp;&nbsp;&nbsp; E.ClassName=EOutOfMemory<br />&nbsp;&nbsp;&nbsp; Sender.ClassName=TWorkThread<br />...<br />INF|11.12.2022 22:28:27 Отправка запроса id="ИДЕНТИФИКАТОРПРОЦЕССА2", type_id=ИДЕНТИФИКАТОРТИП ...<br />ERR|11.12.2022 22:28:53 При отправке запроса id="ИДЕНТИФИКАТОРПРОЦЕССА2" произошла неустранимая ошибка чтения из БД, запрос отклонён. Текст ошибки:<br />&nbsp;&nbsp;&nbsp; Unsuccessful execution caused by a system error that precludes<br />&nbsp;&nbsp;&nbsp; successful execution of subsequent statements.<br />&nbsp;&nbsp;&nbsp; I/O error for file "C:\ПУТЬКБАЗЕ\ВНЕШНЯЯБАЗА1.GDB".<br />&nbsp;&nbsp;&nbsp; Error while trying to write to file.<br />&nbsp;&nbsp;&nbsp; Недостаточно места на диске.<br />...<br /><strong>Decision:</strong><br />при обработке одного запроса id="ИДЕНТИФИКАТОРПРОЦЕССА1", type_id=ИДЕНТИФИКАТОРТИП происходит нехватка памяти, что далее приводит к сбою функционирования. Вероятно в запросе большое вложение. Для дальнейшего анализа смотрим БД ВНЕШНЯЯБАЗА2.gdb, в которой покажет технические ошибки состояния базы ВНЕШНЯЯБАЗА2.gdb.<br />Для их устранения также сделать бэкап/ресторе БД ВНЕШНЯЯБАЗА2.gdb. Далее понаблюдать за ситуацией с размером БД ВНЕШНЯЯБАЗА2.GDB, чтобы он весил не больше 19 Гб.</p>
                    </div>
                </div> 
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Банковское хранилище данных с функцией обнаружения мошенничества</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты дипломного проекта по теме "Банковское хранилище данных с функцией обнаружения мошенничества" при работе с транзакционными банковскими данными с помощью Python и SQL реализовал собственное хранилище данных - DWH, процесс сбора, очистки, трансформации и хранения данных, систему автоматического поиска мошеннических операций (AntiFraud-система)<br /><strong>Task:</strong><br />Docker установка<br /><strong>Decision:</strong><br />$ sudo apt update<br />$ sudo apt install apt-transport-https ca-certificates curl software-properties-common<br />$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg<br />$ echo"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"| sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null<br />$ sudo apt update<br />$ apt-cache policy docker-ce<br />$ sudo apt install docker-ce<br />$ systemctl status docker<br />$ sudo docker run hello-world<br />$ sudo usermod -aG docker tuser<br />$ docker run hello-world<br />$ curl -SL https://github.com/docker/compose/releases/download/v2.6.0/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose<br />$ chmod +x ~/.docker/cli-plugins/docker-compose<br />$ docker compose version<br /><strong>Task:</strong><br />Create Postgres Docker Image<br /><strong>Decision:</strong><br />$ mkdir docks<br />$ mkdir docks/postgres<br />$ touch docks/postgres/Dockerfile<br />$ vim docks/postgres/Dockerfile<br />$ cat docks/postgres/Dockerfile<br />FROM postgres:latest<br />ENV POSTGRES_USER YOUR-USERNAME<br />ENV POSTGRES_PASSWORD YOUR-PASSWORD<br />ENV POSTGRES_DB YOUR-DB<br />EXPOSE 5432 <br />$ cd docks/postgres/<br />$ docker build -t YOUR-DB/postgres .<br />$ docker run -d --name postg -p 5432:5432 YOUR-DB/postgres<br />FULLYOUR-ID1<br />$ sudo netstat -tulpn | grep 5432<br />$ docker logs -f postg<br />$ docker ps<br />$ docker ps -a<br />CONTAINER ID&nbsp;&nbsp; IMAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; COMMAND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CREATED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PORTS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAMES<br />YOUR-ID1&nbsp;&nbsp; YOUR-DB/postgres&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "docker-entrypoint.s&hellip;"&nbsp;&nbsp; 10 hours ago&nbsp;&nbsp; Exited (255) 5 minutes ago&nbsp;&nbsp; 0.0.0.0:5432-&gt;5432/tcp, :::5432-&gt;5432/tcp&nbsp;&nbsp; postg<br />$ docker start postg<br /><strong>Task:</strong><br />Pgadmin Postgres Docker container<br /><strong>Decision:</strong><br />$ google-chrome https://www.pgadmin.org/download/ &amp;<br />$ curl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg<br />$ sudo sh -c 'echo "deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" &gt; /etc/apt/sources.list.d/pgadmin4.list &amp;&amp; apt update'<br />$ sudo apt install pgadmin4<br />$ sudo /usr/pgadmin4/bin/setup-web.sh<br />$ docker ps -a<br />CONTAINER ID&nbsp;&nbsp; IMAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; COMMAND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CREATED&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; STATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PORTS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NAMES<br />YOUR-ID&nbsp;&nbsp; YOUR-DB/postgres&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "docker-entrypoint.s&hellip;"&nbsp;&nbsp; 45 hours ago&nbsp;&nbsp; Exited (255) 37 seconds ago&nbsp;&nbsp; 0.0.0.0:5432-&gt;5432/tcp, :::5432-&gt;5432/tcp&nbsp;&nbsp; postg<br />$ docker start postg<br />$ google-chrome http://YOUR-IP/pgadmin4 &amp;<br /><strong>Task:</strong><br />Stop, remove postgres container<br /><strong>Decision:</strong><br />$ docker stop postg<br />$ docker rm postg<br />$ docker push YOUR-DB/postgres<br /><strong>Task:</strong><br />Разработать ETL процесс, получающий ежедневную выгрузку данных (предоставляется за 3 дня), загружающий ее в хранилище данных и ежедневно строящий отчет.<br />Ежедневно некие информационные системы выгружают три следующих файла:<br />1. Список транзакций за текущий день. Формат &ndash; CSV.<br />2. Список терминалов полным срезом. Формат &ndash; XLSX.<br />3. Список паспортов, включенных в &laquo;черный список&raquo; - с накоплением с начала месяца. Формат &ndash; XLSX.<br />Сведения о картах, счетах и клиентах хранятся в СУБД PostgreSQL. Во вложении реквизиты для подключения. <br />Вам предоставляется выгрузка за последние три дня, ее надо обработать. В качестве хранилища выступает ваша учебная база (edu). Данные должны быть загружены в хранилище со следующей структурой (имена сущностей указаны по существу, без особенностей правил нейминга, указанных далее).<br />Типы данных в полях можно изменять на однородные если для этого есть необходимость. Имена полей менять нельзя. Ко всем таблицам SCD1 должны<br />быть добавлены технические поля create_dt, update_dt; ко всем таблицам SCD2 должны быть добавлены технические поля effective_from, effective_to, deleted_flg.<br />По результатам загрузки ежедневно необходимо строить витрину отчетности по мошенническим операциям. Витрина строится накоплением, каждый новый отчет укладывается в эту же таблицу с новым report_dt.<br />В витрине должны содержаться следующие поля:<br />1. event_dt - Время наступления события. Если событие наступило по результату нескольких действий &ndash; указывается время действия, по которому установлен факт мошенничества.<br />2. passport - Номер паспорта клиента, совершившего мошенническую операцию.<br />3. fio - ФИО клиента, совершившего мошенническую операцию.<br />4. phone - Номер телефона клиента, совершившего мошенническую операцию.<br />5. event_type - Описание типа мошенничества.<br />6. report_dt - Время построения отчета.<br />Признаки мошеннических операций:<br />1. Совершение операции при просроченном или заблокированном паспорте.<br />2. Совершение операции при недействующем договоре.<br />3. Совершение операций в разных городах в течение одного часа.<br />4. Попытка подбора суммы. В течение 20 минут проходит более 3х операций соследующим шаблоном &ndash; каждая последующая меньше предыдущей, при этом отклонены все кроме последней. Последняя операция (успешная) в такой цепочке считается мошеннической.<br />При именовании таблиц необходимо придерживаться следующих правил (для автоматизации проверки):<br />1. YOUR-USERNAME.&lt;CODE&gt;_STG_&lt;TABLE_NAME&gt; - Таблицы для размещения стейджинговых таблиц (первоначальная загрузка), промежуточное выделение инкремента, если требуется. Временные таблицы, если такие потребуются в расчете, можно также складывать с таким именованием. Имя таблиц можете выбирать произвольное, но смысловое.<br />2. YOUR-USERNAME.&lt;CODE&gt;_DWH_FACT_&lt;TABLE_NAME&gt; - Таблицы фактов, загруженных в хранилище. В качестве фактов выступают сами транзакции и &laquo;черный список&raquo; паспортов. Имя таблиц &ndash; как в ER диаграмме.<br />3. YOUR-USERNAME.&lt;CODE&gt;_DWH_DIM_&lt;TABLE_NAME&gt; - Таблицы измерений, хранящиеся в формате SCD1. Имя таблиц &ndash; как в ER диаграмме.<br />4. YOUR-USERNAME.&lt;CODE&gt;_DWH_DIM_&lt;TABLE_NAME&gt;_HIST - Таблицы измерений, хранящиеся в SCD2 формате (только для тех, кто выполняет усложненное задание). Имя таблиц &ndash; как в ER диаграмме.<br />5. YOUR-USERNAME.&lt;CODE&gt;_REP_FRAUD - Таблица с отчетом.<br />6. YOUR-USERNAME.&lt;CODE&gt;_META_&lt;TABLE_NAME&gt; - Таблицы для хранения метаданных. Имя таблиц можете выбирать произвольное, но<br />смысловое.<br />7. &lt;CODE&gt; - 4 буквы вашего персонального кода.<br />Выгружаемые файлы именуются согласно следующему шаблону:<br />1. transactions_DDMMYYYY.txt<br />2. passport_blacklist_DDMMYYYY.xlsx<br />3. terminals_DDMMYYYY.xlsx<br />Предполагается что в один день приходит по одному такому файлу. После загрузки соответствующего файла он должен быть переименован в файл с расширением .backup чтобы при следующем запуске файл не искался и перемещен в каталог archive:<br />1. transactions_DDMMYYYY.txt.backup<br />2. passport_blacklist_DDMMYYYY.xlsx.back<br />3. upterminals_DDMMYYYY.xlsx.backup<br />Желающие могут придумать, обосновать и реализовать более технологичные и учитывающие сбои способы обработки (за это будет повышен балл).<br />В classroom выкладывается zip-архив, содержащий следующие файлы и каталоги:<br />1. main.py - Файл, обязательный. Основной процесс обработки.<br />2. файлы с данными - Файл, обязательный. Те файлы, которые вы получили в качестве задания. Просто скопируйте все 9 файлов.<br />3. main.ddl - Файл, обязательный. Файл с SQL кодом для создания всех необходимых объектов в базе edu.<br />4. main.cron - Файл, обязательный. Файл для постановки вашего процесса на расписание, в формате crontab<br />5. archive - Каталог, обязательный. Пустой, сюда должны перемещаться отработанные файлы<br />6. sql_scripts - Каталог, необязательный. Если вы включаете в main.py какие-то SQL скрипты, вынесенные в отдельные файлы &ndash; помещайте их сюда.<br />7. py_scripts - Каталог, необязательный. Если вы включаете в main.py какие-то python скрипты, вынесенные в отдельные файлы &ndash; помещайте их сюда.<br /><strong>Decision:</strong><br />$ mkdir archive<br />$ touch main.py<br />$ chmod +x main.py<br />$ touch main.ddl<br />$ touch main.cron<br />$ cat snippet_pg.py<br />import psycopg2<br />import pandas as pd<br /># Создание подключения к PostgreSQL<br />conn = psycopg2.connect (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;database = "YOUR-DB",<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;host =&nbsp;&nbsp;&nbsp;&nbsp; "YOUR-IP",<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;user =&nbsp;&nbsp;&nbsp;&nbsp; "YOUR-USERNAME",<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;password = "YOUR-PASSWORD",<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;port =&nbsp;&nbsp;&nbsp;&nbsp; "5432"<br />&nbsp;&nbsp; &nbsp;)<br /># Отключение автокоммита<br />conn.autocommit = False<br /># Создание курсора<br />cursor = conn.cursor()<br />####################################################<br /># Выполнение SQL кода в базе данных без возврата результата<br />cursor.execute( "INSERT INTO YOUR-USERNAME.testtable( id, val ) VALUES ( 1, 'ABC' )" )<br />conn.commit()<br /># Выполнение SQL кода в базе данных с возвратом результата<br />cursor.execute( "SELECT * FROM YOUR-USERNAME.testtable" )<br />records = cursor.fetchall()<br />for row in records:<br />&nbsp;&nbsp; &nbsp;print( row )<br />####################################################<br /># Формирование DataFrame<br />names = [ x[0] for x in cursor.description ]<br />df = pd.DataFrame( records, columns = names )<br /># Запись в файл<br />df.to_excel( 'pandas_out.xlsx', sheet_name='sheet1', header=True, index=False )<br />####################################################<br /># Чтение из файла<br />df = pd.read_excel( 'pandas.xlsx', sheet_name='sheet1', header=0, index_col=None )<br /># Запись DataFrame в таблицу базы данных<br />cursor.executemany( "INSERT INTO YOUR-USERNAME.testtable( id, val ) VALUES( %s, %s )", df.values.tolist() )<br /># Закрываем соединение<br />cursor.close()<br />conn.close()<br />$ /SCD1_incremental_full_script.sql <br />----------------------------------------------------------------------------<br />-- Подготока данных<br /><br />create table YOUR-USERNAME.XXXX_source( <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;id integer,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;val varchar(50),<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;update_dt timestamp(0)<br />);<br />insert into YOUR-USERNAME.XXXX_source ( id, val, update_dt ) values ( 1, 'A', now() );<br />insert into YOUR-USERNAME.XXXX_source ( id, val, update_dt ) values ( 2, 'B', now() );<br />insert into YOUR-USERNAME.XXXX_source ( id, val, update_dt ) values ( 3, 'C', now() );<br />update YOUR-USERNAME.XXXX_source set val = 'X', update_dt = now() where id = 3;<br />delete from YOUR-USERNAME.XXXX_source where id = 3;<br />create table YOUR-USERNAME.XXXX_stg( <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;id integer,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;val varchar(50),<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;update_dt timestamp(0)<br />);<br />create table YOUR-USERNAME.XXXX_target (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;id integer,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;val varchar(50),<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;create_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;update_dt timestamp(0)<br />);<br />create table YOUR-USERNAME.XXXX_meta(<br />&nbsp;&nbsp; &nbsp;schema_name varchar(30),<br />&nbsp;&nbsp; &nbsp;table_name varchar(30),<br />&nbsp;&nbsp; &nbsp;max_update_dt timestamp(0)<br />);<br />insert into YOUR-USERNAME.XXXX_meta( schema_name, table_name, max_update_dt )<br />values( 'YOUR-USERNAME','XXXX_SOURCE', to_timestamp('1900-01-01','YYYY-MM-DD') );<br />create table YOUR-USERNAME.XXXX_stg_del( <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;id integer<br />);<br />----------------------------------------------------------------------------<br />-- Инкрементальная загрузка<br />-- 1. Очистка стейджинговых таблиц<br />delete from YOUR-USERNAME.XXXX_stg;<br />delete from YOUR-USERNAME.XXXX_stg_del;<br />-- 2. Захват данных из источника (измененных с момента последней загрузки) в стейджинг<br />insert into YOUR-USERNAME.XXXX_stg( id, val, update_dt )<br />select id, val, update_dt from YOUR-USERNAME.XXXX_source<br />where update_dt &gt; ( select max_update_dt from YOUR-USERNAME.XXXX_meta where schema_name='YOUR-USERNAME' and table_name='XXXX_SOURCE' );<br />-- 3. Захват в стейджинг ключей из источника полным срезом для вычисления удалений.<br />insert into YOUR-USERNAME.XXXX_stg_del( id )<br />select id from YOUR-USERNAME.XXXX_source;<br />-- 4. Загрузка в приемник "вставок" на источнике (формат SCD1).<br />insert into YOUR-USERNAME.XXXX_target( id, val, create_dt, update_dt )<br />select <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;stg.id, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;stg.val, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;stg.update_dt, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;null <br />from YOUR-USERNAME.XXXX_stg stg<br />left join YOUR-USERNAME.XXXX_target trg<br />on stg.id = trg.id<br />where trg.id is null;<br />-- 5. Обновление в приемнике "обновлений" на источнике (формат SCD1).<br />update YOUR-USERNAME.XXXX_target<br />set <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;val = tmp.val,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;update_dt = tmp.update_dt<br />from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;stg.id, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;stg.val, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;stg.update_dt, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;null <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME.XXXX_stg stg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;inner join YOUR-USERNAME.XXXX_target trg on stg.id = trg.id<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where stg.val &lt;&gt; trg.val <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;or ( stg.val is null and trg.val is not null ) or ( stg.val is not null and trg.val is null )<br />) tmp<br />where XXXX_target.id = tmp.id; <br />-- 6. Удаление в приемнике удаленных в источнике записей (формат SCD1).<br />delete from YOUR-USERNAME.XXXX_target<br />where id in (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trg.id<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME.XXXX_target trg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME.XXXX_stg_del stg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on stg.id = trg.id<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where stg.id is null<br />);<br />-- 7. Обновление метаданных.<br />update YOUR-USERNAME.XXXX_meta<br />set max_update_dt = coalesce( (select max( update_dt ) from YOUR-USERNAME.XXXX_stg ), ( select max_update_dt from YOUR-USERNAME.XXXX_meta where schema_name='YOUR-USERNAME' and table_name='XXXX_SOURCE' ) )<br />where schema_name='YOUR-USERNAME' and table_name = 'XXXX_SOURCE';<br />-- 8. Фиксация транзакции.<br />commit;<br />SCD1_incremental_full_script.sql<br />SCD1_incremental_full_script.sql. На экране<br />$ wget https://drive.google.com/file/d/13WSK0C1Z36hhsopebgEv2bGLAoxEsLUp/view?usp=drive_web&amp;authuser=0<br />$ unzip data.zip<br /><strong>Task:</strong><br />Создадите таблицы в базе<br /><strong>Decision:</strong><br />$ vim main.ddl<br />$ cat main.ddl<br />#!/usr/bin/python3<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_stg_transactions(<br />&nbsp;&nbsp; &nbsp;trans_id varchar(15),<br />&nbsp;&nbsp; &nbsp;trans_date timestamp(0),<br />&nbsp;&nbsp; &nbsp;--amt decimal(10,2),<br />&nbsp;&nbsp; &nbsp;amt numeric(10,2),&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;card_num varchar(20),<br />&nbsp;&nbsp; &nbsp;oper_type varchar(10),<br />&nbsp;&nbsp; &nbsp;oper_result varchar(10),<br />&nbsp;&nbsp; &nbsp;terminal varchar(10),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />create table YOUR-USERNAME.XXXX_dwh_fact_transactions(<br />&nbsp;&nbsp; &nbsp;trans_id varchar(15),<br />&nbsp;&nbsp; &nbsp;trans_date timestamp(0),<br />&nbsp;&nbsp; &nbsp;--amt numeric(10,2),<br />&nbsp;&nbsp; &nbsp;amt decimal(10,2),<br />&nbsp;&nbsp; &nbsp;card_num varchar(20),<br />&nbsp;&nbsp; &nbsp;oper_type varchar(10),<br />&nbsp;&nbsp; &nbsp;oper_result varchar(10),<br />&nbsp;&nbsp; &nbsp;terminal varchar(10),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_stg_terminals(<br />&nbsp;&nbsp; &nbsp;terminal_id varchar(10),<br />&nbsp;&nbsp; &nbsp;terminal_type varchar(10),<br />&nbsp;&nbsp; &nbsp;terminal_city varchar(30),<br />&nbsp;&nbsp; &nbsp;terminal_address varchar(70),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />create table YOUR-USERNAME.XXXX_dwh_dim_terminals(<br />&nbsp;&nbsp; &nbsp;terminal_id varchar(10),<br />&nbsp;&nbsp; &nbsp;terminal_type varchar(10),<br />&nbsp;&nbsp; &nbsp;terminal_city varchar(30),<br />&nbsp;&nbsp; &nbsp;terminal_address varchar(70),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_from timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_to timestamp(0),<br />&nbsp;&nbsp; &nbsp;deleted_flg char(1));<br />create table YOUR-USERNAME.XXXX_stg_del_terminals(<br />&nbsp;&nbsp; &nbsp;terminal_id varchar(10));<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_stg_blacklist(<br />&nbsp;&nbsp; &nbsp;passport_num varchar(15),<br />&nbsp;&nbsp; &nbsp;--entry_dt date<br />&nbsp;&nbsp; &nbsp;entry_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />create table YOUR-USERNAME.XXXX_dwh_fact_passport_blacklist(<br />&nbsp;&nbsp; &nbsp;passport_num varchar(30),<br />&nbsp;&nbsp; &nbsp;--entry_dt date<br />&nbsp;&nbsp; &nbsp;--date timestamp(0)<br />&nbsp;&nbsp; &nbsp;entry_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_stg_cards(<br />&nbsp;&nbsp; &nbsp;card_num varchar(20),<br />&nbsp;&nbsp; &nbsp;account_num varchar(20),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />create table YOUR-USERNAME.XXXX_dwh_dim_cards(<br />&nbsp;&nbsp; &nbsp;card_num varchar(20),<br />&nbsp;&nbsp; &nbsp;account_num varchar(20),<br />&nbsp;&nbsp; &nbsp;--create_dt date,<br />&nbsp;&nbsp; &nbsp;--update_dt date<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_from timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_to timestamp(0),<br />&nbsp;&nbsp; &nbsp;deleted_flg char(1));<br />create table YOUR-USERNAME.XXXX_stg_del_cards(<br />&nbsp;&nbsp; &nbsp;card_num varchar(20));<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_stg_accounts(<br />&nbsp;&nbsp; &nbsp;account_num varchar(20),<br />&nbsp;&nbsp; &nbsp;--valid_to date,<br />&nbsp;&nbsp; &nbsp;valid_to timestamp(0), <br />&nbsp;&nbsp; &nbsp;client varchar(10),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />create table YOUR-USERNAME.XXXX_dwh_dim_accounts(<br />&nbsp;&nbsp; &nbsp;account_num varchar(20),<br />&nbsp;&nbsp; &nbsp;--valid_to date,<br />&nbsp;&nbsp; &nbsp;valid_to timestamp(0), <br />&nbsp;&nbsp; &nbsp;client varchar(10),<br />&nbsp;&nbsp; &nbsp;--create_dt date,<br />&nbsp;&nbsp; &nbsp;--update_dt date<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_from timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_to timestamp(0),<br />&nbsp;&nbsp; &nbsp;deleted_flg char(1)); <br />create table YOUR-USERNAME.XXXX_stg_del_accounts(<br />&nbsp;&nbsp; &nbsp;account_num varchar(20));<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_stg_clients(<br />&nbsp;&nbsp; &nbsp;client_id varchar(10),<br />&nbsp;&nbsp; &nbsp;last_name varchar(20),<br />&nbsp;&nbsp; &nbsp;first_name varchar(20),<br />&nbsp;&nbsp; &nbsp;patronymic varchar(20),<br />&nbsp;&nbsp; &nbsp;--date_of_birth date,<br />&nbsp;&nbsp; &nbsp;date_of_birth timestamp(0), <br />&nbsp;&nbsp; &nbsp;passport_num varchar(15),<br />&nbsp;&nbsp; &nbsp;--passport_valid_to date,<br />&nbsp;&nbsp; &nbsp;passport_valid_to timestamp(0),<br />&nbsp;&nbsp; &nbsp;phone varchar(16),<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0));<br />create table YOUR-USERNAME.XXXX_dwh_dim_clients(<br />&nbsp;&nbsp; &nbsp;client_id varchar(10),<br />&nbsp;&nbsp; &nbsp;last_name varchar(20),<br />&nbsp;&nbsp; &nbsp;first_name varchar(20),<br />&nbsp;&nbsp; &nbsp;patronymic varchar(20),<br />&nbsp;&nbsp; &nbsp;--date_of_birth date,<br />&nbsp;&nbsp; &nbsp;date_of_birth timestamp(0),<br />&nbsp;&nbsp; &nbsp;passport_num varchar(15),<br />&nbsp;&nbsp; &nbsp;--passport_valid_to date,<br />&nbsp;&nbsp; &nbsp;passport_valid_to timestamp(0),<br />&nbsp;&nbsp; &nbsp;phone varchar(16),<br />&nbsp;&nbsp; &nbsp;--create_dt date,<br />&nbsp;&nbsp; &nbsp;--update_dt date<br />&nbsp;&nbsp; &nbsp;create_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;update_dt timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_from timestamp(0),<br />&nbsp;&nbsp; &nbsp;effective_to timestamp(0),<br />&nbsp;&nbsp; &nbsp;deleted_flg char(1));<br />create table YOUR-USERNAME.XXXX_stg_del_clients(<br />&nbsp;&nbsp; &nbsp;client_id varchar(10));<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_rep_fraud(<br />&nbsp;&nbsp; &nbsp;event_dt timestamp(0), <br />&nbsp;&nbsp; &nbsp;passport varchar(20), <br />&nbsp;&nbsp; &nbsp;fio varchar(50),<br />&nbsp;&nbsp; &nbsp;phone varchar(16), <br />&nbsp;&nbsp; &nbsp;event_type varchar(120), <br />&nbsp;&nbsp; &nbsp;--report_dt date<br />&nbsp;&nbsp; &nbsp;report_dt timestamp(0));<br />----------------------------------<br />create table YOUR-USERNAME.XXXX_meta(<br />&nbsp;&nbsp; &nbsp;schema_name varchar(30),<br />&nbsp;&nbsp; &nbsp;table_name varchar(30),<br />&nbsp;&nbsp; &nbsp;max_update_dt timestamp(0));<br />----------------------------------<br /><strong>Task:</strong><br />Алгоритм для файла main.py: Подключитесь к двум базам, Очистите весь стейджинг. Загрузите файлы transactions_01032021.txt, terminals_01032021.xlsx, passport_blacklist_01032021.xlsx в стейджинг. Загрузите таблицы clients, accounts, cards в стейджинг. Используйте следующий подход: Выполните запрос к базе 1, Сохраните полученный результат в DataFrame, Загрузите DataFrame в базу 2. Загрузите данные из стейджинга в целевую таблицу xxxx_dwh_dim_terminals, xxxx_dwh_dim_cards, xxxx_dwh_dim_accounts, xxxx_dwh_dim_clients. Загрузите данные из стейджинга в целевую таблицу xxxx_dwh_fact_passport_blacklist, xxxx_dwh_fact_transactions.. Фактовые таблицы данные перекладываются &laquo;простым инсертом&raquo;, то есть необходимо выполнить один INSERT INTO ... SELECT .... Напишите скрипт, соединяющий нужные таблицы для поиска операций, совершенных при недействующем договоре. Отладьте ваш скрипт для одной даты PgAdmin, он должен выдавать результат. Результат выполнения скрипта загружайте в таблицу xxxx_rep_fraud. Незабывайте сформировать поле report_dt. Зафиксируйте изменения. Отключитесь от баз. Переименуйте обработанные файлы и перенесите их в другой каталог. отладить его работоспособность навсех трех днях загрузки.<br /><strong>Decision:</strong><br />$ vim main.py<br />$ cat main.py<br />#!/usr/bin/python3<br />import pandas as pd<br />import psycopg2<br />import os<br />###################Подключение к базам<br />#conn_YOUR-DB1 = psycopg2.connect(database = "YOUR-DB",host = "YOUR-IP",user = "YOUR-USERNAME",password = "YOUR-PASSWORD",port = "5432")<br />conn_YOUR-DB1 = psycopg2.connect(database = "YOUR-DB1",host = "YOUR-HOST",user = "YOUR-USERNAME1",password = "YOUR-PASSWORD1",port = "5432")<br />conn_YOUR-DB2 = psycopg2.connect(database = "bank",host = "YOUR-HOST",user = "YOUR-USERNAME2",password = "YOUR-PASSWORD2",port = "5432")<br />conn_YOUR-DB1.autocommit = False<br />conn_YOUR-DB2.autocommit = False<br />cursor_YOUR-DB1 = conn_YOUR-DB1.cursor()<br />cursor_YOUR-DB2 = conn_YOUR-DB2.cursor()<br />######################################<br />###################Очистка стейджинговых таблиц<br />cursor_YOUR-DB1.execute("""DELETE FROM YOUR-USERNAME1.XXXX_stg_transactions;""")<br />###################Загрузка данных в стейджинг<br />#df = pd.read_csv(f'/home/YOUR-USERNAME1/XXXX/project/data/transactions_01032021.txt', sep=';', decimal=',', header=0, index_col=None)<br />dirpath = "/home/YOUR-USERNAME1/XXXX/project"<br />project_files = os.listdir(dirpath)<br />for transactions in project_files:<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if transactions.endswith('.txt'):<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;df = pd.read_csv(transactions, sep=";")<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datenow_w_txt = transactions.rsplit('_')[1]<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datenow_str = datenow_w_txt.split('.')[0]<br />df['amount'] = df['amount'].map(lambda z: z.strip().replace(',', '.')).astype('float')<br />df['create_dt'] = datenow_str<br />df['update_dt'] = datenow_str<br />###################<br />cursor_YOUR-DB1.executemany("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_stg_transactions(trans_id, trans_date, amt, card_num, oper_type, oper_result, terminal , create_dt, update_dt) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;VALUES(%s, %s , %s , %s , %s , %s , %s, to_timestamp(%s,'DDMMYYYY'), to_timestamp(%s,'DDMMYYYY'))<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""", df.values.tolist())<br />###################Загрузка данных в целевые таблицы фактов<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_dwh_fact_transactions (trans_id,trans_date,card_num,oper_type,amt,oper_result,terminal,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT stg.trans_id,stg.trans_date,stg.card_num,stg.oper_type,stg.amt,stg.oper_result,stg.terminal,stg.create_dt,stg.update_dt <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FROM YOUR-USERNAME1.XXXX_stg_transactions as stg;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################<br />######################################<br />###################Очистка стейджинговых таблиц<br />cursor_YOUR-DB1.execute("""DELETE FROM YOUR-USERNAME1.XXXX_stg_terminals;""")<br />###################Загрузка данных в стейджинг<br />#df = pd.read_excel(f'/home/YOUR-USERNAME1/XXXX/project/data/terminals_01032021.xlsx', sheet_name='terminals', header=0, index_col=None)<br />for terminals in project_files:<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if terminals.startswith('terminals'):<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;df = pd.read_excel(terminals, sheet_name='terminals', header=0, index_col=None )<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datenow_w_txt = terminals.rsplit('_')[1]<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datenow_str = datenow_w_txt.split('.')[0]<br />df['create_dt'] = datenow_str<br />df['update_dt'] = datenow_str<br />#df.insert(4, 'update_dt','2021-03-01')<br />###################<br />cursor_YOUR-DB1.executemany("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_stg_terminals(terminal_id,terminal_type,terminal_city,terminal_address,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;VALUES(%s,%s,%s,%s,to_timestamp(%s,'DDMMYYYY'),to_timestamp(%s,'DDMMYYYY'));<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""", df.values.tolist())<br />###################Загрузка данных в целевые таблицы измерений<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_dwh_dim_terminals (terminal_id,terminal_type,terminal_city,terminal_address,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT stg.terminal_id, stg.terminal_type, stg.terminal_city, stg.terminal_address, stg.update_dt,to_timestamp('9999-12-31', 'YYYY-MM-DD') <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_terminals as stg &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_terminals as trg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on stg.terminal_id = trg.terminal_id <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where trg.terminal_id is null;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################<br />######################################<br />###################Очистка стейджинговых таблиц<br />cursor_YOUR-DB1.execute("""DELETE FROM YOUR-USERNAME1.XXXX_stg_blacklist;""")<br />###################Загрузка данных в стейджинг<br />#df = pd.read_excel(f'/home/YOUR-USERNAME1/XXXX/project/data/passport_blacklist_01032021.xlsx', sheet_name='blacklist', header=0, index_col=None)<br />for blacklist in project_files:<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if blacklist.startswith('passport_blacklist'):<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;df = pd.read_excel(blacklist, sheet_name='blacklist', header=0, index_col=None )<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datenow_w_ext = blacklist.rsplit('blacklist_')[1]<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;datenow_str = datenow_w_ext.split('.')[0]<br />df['create_dt'] = datenow_str<br />df['update_dt'] = datenow_str<br />###################<br />cursor_YOUR-DB1.executemany("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_stg_blacklist(entry_dt,passport_num,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;VALUES(%s, %s,to_timestamp(%s,'DDMMYYYY'),to_timestamp(%s,'DDMMYYYY'));<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""", df.values.tolist())<br />###################Загрузка данных в целевые таблицы фактов<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_dwh_fact_passport_blacklist <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT stg.passport_num,stg.entry_dt,stg.create_dt,stg.update_dt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_blacklist as stg <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_fact_passport_blacklist as trg <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on stg.passport_num = trg.passport_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where trg.passport_num is null;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />######################################<br />###################Очистка стейджинговых таблиц<br />cursor_YOUR-DB1.execute("""DELETE FROM YOUR-USERNAME1.XXXX_stg_cards;""")<br />###################Загрузка данных в стейджинг<br />cursor_YOUR-DB2.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;--SELECT regexp_replace(card_num, '\s+$', '') as card_num,account,create_dt,update_dt <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT card_num,account,create_dt,update_dt <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FROM info.cards<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />records = cursor_YOUR-DB2.fetchall()<br />#for row in records:<br />#&nbsp;&nbsp;&nbsp; print(row)<br />names = [ x[0] for x in cursor_YOUR-DB2.description ]<br />df = pd.DataFrame( records, columns = names )<br />cursor_YOUR-DB1.executemany("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_stg_cards(card_num,account_num,create_dt,update_dt) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;VALUES(%s,%s,%s,%s)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""", df.values.tolist())<br />###################Загрузка данных в целевые таблицы измерений<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_dwh_dim_cards (card_num,account_num,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT stg.card_num, stg.account_num, stg.create_dt, to_timestamp('9999-12-31', 'YYYY-MM-DD')<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_cards as stg <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_cards as trg <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on stg.card_num = trg.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where trg.card_num is null;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################<br />######################################<br />###################Очистка стейджинговых таблиц<br />cursor_YOUR-DB1.execute("""DELETE FROM YOUR-USERNAME1.XXXX_stg_accounts;""")<br />###################Загрузка данных в стейджинг<br />cursor_YOUR-DB2.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT account,valid_to,client,create_dt,update_dt <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FROM info.accounts<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />records = cursor_YOUR-DB2.fetchall()<br />#for row in records:<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(row)<br />names = [ x[0] for x in cursor_YOUR-DB2.description ]<br />df = pd.DataFrame( records, columns = names )<br />cursor_YOUR-DB1.executemany("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_stg_accounts(account_num,valid_to,client,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;VALUES( %s, %s, %s, %s, %s)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""", df.values.tolist())<br />###################Загрузка данных в целевые таблицы измерений<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_dwh_dim_accounts(account_num,valid_to,client,create_dt,update_dt) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT stg.account_num,stg.valid_to,stg.client,stg.create_dt,to_timestamp('9999-12-31', 'YYYY-MM-DD')<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_accounts as stg <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_accounts as trg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on stg.account_num = trg.account_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where trg.account_num is null;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################<br />######################################<br />###################Очистка стейджинговых таблиц<br />cursor_YOUR-DB1.execute("""DELETE FROM YOUR-USERNAME1.XXXX_stg_clients;""")<br />###################Загрузка данных в стейджинг<br />cursor_YOUR-DB2.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT client_id,last_name,first_name,patronymic,date_of_birth,passport_num,passport_valid_to,phone,create_dt,update_dt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FROM info.clients; <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />records = cursor_YOUR-DB2.fetchall()<br />#for row in records:<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print(row)<br />names = [ x[0] for x in cursor_YOUR-DB2.description ]<br />df = pd.DataFrame(records, columns = names) <br />cursor_YOUR-DB1.executemany(""" <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_stg_clients(client_id,last_name,first_name,patronymic,date_of_birth,passport_num,passport_valid_to,phone,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;VALUES(%s,%s,%s,%s,%s,%s,%s,%s,%s,%s);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""", df.values.tolist()) <br />###################Загрузка данных в целевые таблицы измерений<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_dwh_dim_clients(client_id,last_name,first_name,patronymic,date_of_birth,passport_num,passport_valid_to,phone,create_dt,update_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SELECT stg.client_id,stg.last_name,stg.first_name,stg.patronymic,stg.date_of_birth,stg.passport_num,stg.passport_valid_to,stg.phone,stg.create_dt,now()<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_clients as stg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_clients as trg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on stg.client_id = trg.client_id <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where trg.client_id is null;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################<br />######################################<br />###################Выявление мошеннических операций и построение отчёта<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_rep_fraud <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;min(t2.trans_date) as trans_date, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;tgddcl.passport_num as passport_num, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;(tgddcl.last_name || ' ' || tgddcl.first_name || ' ' || tgddcl.patronymic ) as fio, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;tgddcl.phone as phone, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'1' as event_type,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;now() as report_dt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select *<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;with current_dt as ( <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_transactions) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select&nbsp; tgdft.*, tgddca.account_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_dwh_fact_transactions as tgdft <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_cards as tgddca<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on trim(tgdft.card_num) = trim(tgddca.card_num ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where tgdft.oper_result = 'SUCCESS' <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and tgdft.trans_date in (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from current_dt)) as t <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_accounts as gdda <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t.account_num = gdda.account_num ) as t2 <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_clients as tgddcl <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t2.client = tgddcl.client_id <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where (tgddcl.passport_valid_to &lt; t2.trans_date <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;or tgddcl.passport_num in (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select passport_num<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_dwh_fact_passport_blacklist)) &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;group by tgddcl.passport_num, (tgddcl.last_name || ' ' || tgddcl.first_name || ' ' || tgddcl.patronymic ), tgddcl.phone;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################Совершение операции при недействующем договоре.<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_rep_fraud<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;t2.trans_date as trans_date, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;gddcl.passport_num as passport_num, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;(gddcl.last_name || ' ' || gddcl.first_name || ' ' || gddcl.patronymic ) as fio, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;gddcl.phone as phone, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'2' as event_type,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;now() as report_dt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select min(t.trans_date) trans_date, t.account_num, gdda.client<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;with current_dt as ( <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_transactions) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select gdft.trans_date, gdft.card_num, gddca.account_num<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_dwh_fact_transactions as gdft <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_cards as gddca<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on trim(gdft.card_num) = trim(gddca.card_num ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where gdft.oper_result = 'SUCCESS'<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and gdft.trans_date in (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from current_dt)) as t <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_accounts as gdda <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t.account_num = gdda.account_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where t.trans_date &gt; gdda.valid_to<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;group by t.account_num, gdda.client ) as t2 <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_clients as gddcl <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t2.client = gddcl.client_id;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################Совершение операций в разных городах в течение одного часа<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_rep_fraud<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;t3.trans_date,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;t3.passport_num,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;(t3.last_name || ' ' || t3.first_name || ' ' || t3.patronymic ) as fio,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;t3.phone ,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'3' as event_type,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;now() as report_dt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date, trg2.*<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select * from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select * from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;with lds as&nbsp; (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;trans_date,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;terminal_city,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;card_num,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(terminal_city) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdftr.card_num<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdftr.trans_date) as lag_c,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(trans_date) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by card_num<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdftr.trans_date) as lag_t,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lead(terminal_city) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdftr.card_num<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdftr.trans_date) as lead_c ,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lead(trans_date) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by card_num<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdftr.trans_date) as lead_t<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_dwh_fact_transactions as gdftr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_terminals as gddt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on gdftr.terminal = gddt.terminal_id<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where gdftr.oper_result = 'SUCCESS'),<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;current_dt as (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_transactions )<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;min(trans_date) as trans_date,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;card_num<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from lds<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where lag_c &lt;&gt; terminal_city<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and (trans_date-lag_t) &lt; '01:00:00'<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and trans_date&nbsp; in (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from current_dt)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;group by card_num) as trg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_cards as trg3<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on trim(trg.card_num) = trim(trg3.card_num )) as t<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_accounts as trg4<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t.account_num = trg4.account_num ) as t2<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_clients as trg2<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t2.client = trg2.client_id ) as t3;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />###################Попытка подбора суммы<br />cursor_YOUR-DB1.execute("""<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;INSERT INTO YOUR-USERNAME1.XXXX_rep_fraud <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;t3.trans_date, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;t3.passport_num , <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;(t3.last_name || ' ' || t3.first_name || ' ' || t3.patronymic ) as fio, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;t3.phone , <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;'4' as event_type,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;now() as report_dt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;trans_date, <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;gddcl.*<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from&nbsp; (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select * from (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select * from(<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;with rj as (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;*,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(amt) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdft.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdft.trans_date) as lag_a,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(amt,2) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdft.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdft.trans_date) as lag_a2,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(amt,3) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdft.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdft.trans_date) as lag_a3,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(oper_result) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdft.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdft.trans_date) as lag_r,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(oper_result,2) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdft.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdft.trans_date) as lag_r2,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(oper_result,3) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdft.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdft.trans_date) as lag_r3,<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lag(trans_date,3) over (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;partition by gdft.card_num <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;order by gdft.trans_date) as min_t<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_dwh_fact_transactions gdft),<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;current_dt as ( <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from YOUR-USERNAME1.XXXX_stg_transactions )<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select * <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from rj<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;where oper_result = 'SUCCESS' <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and lag_r = 'REJECT' <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and lag_a &gt; amt <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and lag_r2 = 'REJECT' <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and lag_a2 &gt; lag_a<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and lag_r3 = 'REJECT' <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and lag_a3 &gt; lag_a2<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and (trans_date - min_t) &lt;= '00:20:00'<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;and trans_date&nbsp; in (<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;select trans_date <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;from current_dt)) as trg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_cards as gddca<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on trim(trg.card_num) = trim(gddca.card_num )) as t <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_accounts as gdda <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t.account_num = gdda.account_num ) as t2 <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;left join YOUR-USERNAME1.XXXX_dwh_dim_clients as gddcl <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;on t2.client = gddcl.client_id ) as t3;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;""")<br />######################################<br />conn_YOUR-DB2.commit()<br />conn_YOUR-DB1.commit()<br />######################################Запись файлов в архив<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/terminals_01032021.xlsx', '/home/YOUR-USERNAME1/XXXX/project/archive/terminals_01032021.xlsx.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/transactions_01032021.txt', '/home/YOUR-USERNAME1/XXXX/project/archive/transactions_01032021.txt.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/passport_blacklist_01032021.xlsx', '/home/YOUR-USERNAME1/XXXX/project/archive/passport_blacklist_01032021.xlsx.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/terminals_02032021.xlsx', '/home/YOUR-USERNAME1/XXXX/project/archive/terminals_02032021.xlsx.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/transactions_02032021.txt', '/home/YOUR-USERNAME1/XXXX/project/archive/transactions_02032021.txt.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/passport_blacklist_02032021.xlsx', '/home/YOUR-USERNAME1/XXXX/project/archive/passport_blacklist_02032021.xlsx.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/terminals_03032021.xlsx', '/home/YOUR-USERNAME1/XXXX/project/archive/terminals_03032021.xlsx.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/transactions_03032021.txt', '/home/YOUR-USERNAME1/XXXX/project/archive/transactions_03032021.txt.backup')<br />os.rename('/home/YOUR-USERNAME1/XXXX/project/passport_blacklist_03032021.xlsx', '/home/YOUR-USERNAME1/XXXX/project/archive/passport_blacklist_03032021.xlsx.backup')<br />######################################<br />cursor_YOUR-DB2.close();<br />cursor_YOUR-DB1.close();<br />$ sudo apt install python3.10-venv<br />$ python3.10 -m venv venv<br />$ source venv/bin/activate<br />$ pip install pandas<br />$ python3 main.py<br />$ ls archive/<br />passport_blacklist_01032021.xlsx.backup&nbsp; terminals_01032021.xlsx.backup&nbsp; transactions_01032021.txt.backup<br />$ sudo psql -U YOUR-USERNAME<br />YOUR-USERNAME=# select * from YOUR-USERNAME.XXXX_rep_fraud;<br /><strong>Task:</strong><br />Заполните файл main.cron расписанием и командой исполнения вашего скрипта. Расписание установите так, как считаете нужным чтобы ваши данные заполнились корректно.<br /><strong>Decision:</strong><br />$ vim main.cron <br />$ cat main.cron <br />0 0 * * * /home/david/project/main.py<br /><strong>Decision:</strong><br />По следующим признакам получилось выявить мошеннические транзакции: выполнение операции с просроченным или заблокированным паспортом, выполнение операции с недействительным контрактом, выполнение операций в разных городах в течение одного часа<br /><strong>Source:</strong><br />https://dzen.ru/a/Ypr65Wh4jmLimA3o<br />https://www.youtube.com/watch?v=Je3Y8up0Qbs&amp;list=LL&amp;index=5&amp;t=98s<br />https://losst.pro/kak-posmotret-otkrytye-porty-v-linux?ysclid=lpe5qjsv9o445640330<br />https://www.pgadmin.org/download/pgadmin-4-apt/<br />https://losst.pro/spisok-kontejnerov-docker</p>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Разработка скриптов на Bash и Python для автоматизации работы</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Разработал скрипты на языках Bash и Python для автоматизации работы в компьютерных классах и аудиториях<br /><strong>Task:</strong><br />В компьютерном классе по 20 компьютеров и в каждом надо было установить Microsoft Office. Для этого я написал скрипты инсталлятор и конфигуратор, которые позволяют мне выбрать дистрибутив, в котором я установливаю, саму программу для установки и настройки (не только офис)<br /><strong>Decision:</strong><br />$ vim Linux-Installer.sh<br />$ cat Linux-Installer.sh<br />#!/bin/bash<br />checkcmd(){<br />if [ $? -eq 0 ]; then<br />&nbsp;&nbsp; &nbsp;echo ! The command was executed successfully<br />else<br />&nbsp;&nbsp; &nbsp;echo ! The command was executed with an error<br />fi<br />} <br />#echo YOUR-PASSWORD | sudo -S sudo dnf update<br />#checkcmd<br /># https://stackoverflow.com/questions/226703/how-do-i-prompt-for-yes-no-cancel-input-in-a-linux-shell-script<br />while true; do<br />&nbsp;&nbsp; &nbsp;read -p "Do you want to install the program? (y/n) " yn<br />&nbsp;&nbsp; &nbsp;case $yn in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[Yy]* ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Select the distribution where you want to install the program (Centos 9 - 1 / Ubuntu 22.04 - 2 / Redos 7.3 - 3): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read choicedistr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;case "$choicedistr" in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1|Centos) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Select a program (Test - 0 / Sublime Text - 1 / Postgresql - 2 / PgAdmin - 3 / Git - 4 / Kvm - 5 / nfts-3g - 6 / libreoffice - 7): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read choiceprogr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;case "$choiceprogr" in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# https://www.sublimetext.com/docs/linux_repositories.html#dnf<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo rpm -v --import https://download.sublimetext.com/sublimehq-rpm-pub.gpg<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf config-manager --add-repo https://download.sublimetext.com/rpm/stable/x86_64/sublime-text.repo<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -y install sublime-text<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;2)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# https://www.postgresql.org/download/linux/redhat/<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-x86_64/pgdg-redhat-repo-latest.noarch.rpm<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -qy module disable postgresql<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf install -y postgresql15-server<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo /usr/pgsql-15/bin/postgresql-15-setup initdb<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo systemctl enable postgresql-15<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo systemctl start postgresql-15<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;3)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# https://www.pgadmin.org/download/pgadmin-4-rpm/<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo rpm -i https://ftp.postgresql.org/pub/pgadmin/pgadmin4/yum/pgadmin4-redhat-repo-2-1.noarch.rpm<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum install -y pgadmin4<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum install -y pgadmin4-desktop<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum install -y pgadmin4-web<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sudo /usr/pgadmin4/bin/setup-web.sh<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum upgrade -y pgadmin4<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;4)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# https://unixcop.com/how-to-install-git-on-centos-9-stream-fedora/<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -y install git<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;git --version<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;5)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# https://technixleo.com/install-kvm-on-centos-alma-rhel-9/<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;egrep -c '(vmx|svm)' /proc/cpuinfo<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf install -y qemu-kvm qemu-img libvirt virt-install libvirt-client virt-manager<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lsmod | grep kvm<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo systemctl enable --now libvirtd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sudo virt-host-validate&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;6)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;# https://itisgood.ru/2019/03/26/kak-smontirovat-disk-ntfs-na-centos-rhel-scientific-linux/<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum -y install epel-release<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum -y install ntfs-3g<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;7)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -y install libreoffice<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;esac<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;2|u|U|Ubuntu) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo apt -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo apt -y upgrade<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Select a program (Test - 0 / Net-Tools - 1 / Ssh - 2): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read choiceprogr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;case "$choiceprogr" in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo apt-get -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo apt-get install net-tools<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;2)#https://help.reg.ru/support/servery-vps/oblachnyye-servery/rabota-s-serverom/kak-ustanovit-i-nastroit-ssh<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo apt-get install ssh<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo apt-get install openssh-server<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;systemctl status ssh<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;esac<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;exit 0<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;3|r|R|Redos)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Select a program (Test - 0 / Office - 1 / Playonlinux - 2): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read choiceprogr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;case "$choiceprogr" in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;wine /LINKS/MS\ Office\ 2007-10-13/Office_Professional_Plus_2007_W32_Russia/SETUP.EXE<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;2)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo touch /etc/yum.repos.d/playonlinux.repo<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo echo '[playonlinux]<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;name=PlayOnLinux Official repository<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;baseurl=http://rpm.playonlinux.com/fedora/yum/base<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;enable=1<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;gpgcheck=0<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;gpgkey=http://rpm.playonlinux.com/public.gpg' &gt; /etc/yum.repos.d/playonlinux.repo<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cat /etc/yum.repos.d/playonlinux.repo<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo yum -y install playonlinux nc jq<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo reboot&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;esac<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;*) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo "Nothing was entered."<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;esac&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[Nn]* ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;exit<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;* ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo "Please answer yes or no."<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;esac<br />done<br />exit 0<br />$ ./Linux-Installer.sh<br />Do you want to install the program? (y/n) y<br />Select the distribution where you want to install the program (Centos 9 - 1 / Ubuntu 22.04 - 2 / Redos 7.3 - 3): 1<br />Select a program (Test - 0 / Sublime Text - 1 / Postgresql - 2 / PgAdmin - 3 / Git - 4 / Kvm - 5 / nfts-3g - 6 / libreoffice - 7): 0<br />Do you want to install the program? (y/n) y<br />Select the distribution where you want to install the program (Centos 9 - 1 / Ubuntu 22.04 - 2 / Redos 7.3 - 3): 2<br />Select a program (Test - 0 / Net-Tools - 1 / Ssh - 2): 0<br />$ vim Linux-Config.sh<br />$ cat Linux-Config.sh<br />#!/bin/bash <br />checkcmd(){<br />if [ $? -eq 0 ]; then<br />&nbsp;&nbsp; &nbsp;echo ! The command was executed successfully<br />else<br />&nbsp;&nbsp; &nbsp;echo ! The command was executed with an error<br />fi<br />}<br /># https://stackoverflow.com/questions/226703/how-do-i-prompt-for-yes-no-cancel-input-in-a-linux-shell-script<br />while true; do<br />&nbsp;&nbsp; &nbsp;read -p "Do you want to configure the program? (y/n) " yn<br />&nbsp;&nbsp; &nbsp;case $yn in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[Yy]* ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Select the distribution where you want to configure the program (Redhat - 1 / Debian - 2): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read choicedistr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;case "$choicedistr" in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1|r|R|Redhat) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Select a program (Test - 0 / Disabling Lamp - 1 / Starting Lamp - 2 / Add users in postgressql - 3 / Moving linux folders to another disk - 4): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read choiceprogr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;case "$choiceprogr" in<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo dnf -y update<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo service apache2 stop<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo service mysql stop<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;2)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo service apache2 start<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo service mysql start<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;3) #https://www.dmosk.ru/miniinstruktions.php?mini=postgresql-users&amp;ysclid=lig0a2xuou515754413#create<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Please come up with a new user: "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read userdb<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Please come up with a new password: "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read passwdb<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#echo YOUR-PASSWORD | sudo -S <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cd /tmp<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sudo -u postgres -H -- psql -d template1 -c "CREATE USER $userdb WITH PASSWORD '$passwdb';"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#psql -U postgres -d template1 -c "CREATE USER tuser0 WITH PASSWORD 'Tpsswd';"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Please come up with a new base: "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read namedb<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sudo -u postgres -H -- psql -d template1 -c "CREATE database $namedb;"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sudo -u postgres -H -- psql -d template1 -c "GRANT ALL PRIVILEGES ON DATABASE "$namedb" to $userdb;"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sudo -u postgres -H -- psql -d template1 -c "\c $namedb;"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sudo -u postgres -H -- psql -d template1 -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "$userdb";"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;4) #http://sysengineering.ru/notes/peremeschenie-papok-linux-na-drugoy-disk?ysclid=lisfix46x1712981898<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lsblk<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "USB device for moving the base (hint above): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read mntusb<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo fdisk $mntusb<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lsblk<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "USB device for moving the base (hint above): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read mntusb1<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Enter the file system type: "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read mntfs<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo mkfs -t $mntfs $mntusb1<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo mount $mntusb1 /mnt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;shopt -s dotglob<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Which directory do you need to move: "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read movedir<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo rsync -aulvXpogtr $movedir/* /mnt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ls -Zd $movedir<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ls -Zd /mnt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Change the security settings of a new folder (hint above): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read mntset<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo chcon -t $mntset /mnt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ls -Zd /mnt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo umount /mnt<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo blkid<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo -n "Enter the UUID of the disk (hint above): "<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read mntuid<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo sh -c "echo 'UUID=$mntuid&nbsp;&nbsp; $movedir&nbsp; $mntfs&nbsp; defaults,noatime,nofail 0 2' &gt;&gt; /etc/fstab"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo cat /etc/fstab | grep $mntfs<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo mv $movedir $movedir.back<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo mkdir $movedir<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo YOUR-PASSWORD | sudo -S sudo mount -av<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;checkcmd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ls $movedir<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;lsblk&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;esac<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;2|d|D|Debian) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo "deb"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;exit 0<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;*) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo "Nothing was entered."<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;esac&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;[Nn]* ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;exit<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;* ) <br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;echo "Please answer yes or no."<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;;;<br />&nbsp;&nbsp; &nbsp;esac<br />done<br />exit 0<br />$ ./Linux-Config.sh<br />Do you want to configure the program? (y/n) y<br />Select the distribution where you want to configure the program (Redhat - 1 / Debian - 2): 1<br />Select a program (Test - 0 / Disabling Lamp - 1 / Starting Lamp - 2 / Add users in postgressql - 3 / Moving linux folders to another disk - 4): 0<br />Do you want to configure the program? (y/n) n<br /><strong>Task:</strong><br />Столкнулся с такой проблемой, что маленький неттоп флешки не читает, он не был добавлен в домен и антивирус на нем не стоял. Убедимся на другой машине, в моем случае ноутбуке, что флешка спокойно видит на нем файлы.&nbsp;&nbsp; &nbsp;То есть это чистая флешка, не зараженная, и попробуем ее вставить в тот проблемный неттоп. Тут мы увидим, что во флешке другая информация будет. Как будто в самой флешке отображается сама флешка, и если ее открыть (что делать не стоит) тот там и будут наши файлы. на самом деле они будут зашифрованны и флешка заражена. Надо это исправлять. В тот момент у нас не было в неттопе никакого антивируса, поэтому я установил бесплатный антивирус Касперский FREE с официального сайта. И вот, он выдал в момент запуска после установки рекомендации по устранении проблм в компьютере. - Жмем устранить и перезагрузимся - В следующем запуске антивирус покажет информацию об устранении проблем, и можем сразу вставить флешку в неттопе. Тут мы увидим, что антвирус удалил какой-то файл (это и есть вирус) Открываем саму флешку после удаления вируса, а там пустой файл, хотя система показывает, что флешка заполнена. Он содержит зашифрованные файлы. Давайте попробуем их восстановить. Есть скрипт, который возвращает данные. Вставьте этот файл на флешку - запустите его - увидите файл и папку с файлами, которые ему удалось восстановить - Все готово, и неттоп мы подлечили, и данные со флешки восстановили, и антивирус бесплатный установили, и главное что этот бюджетный вариант с восстановлением вполне корректно работает.<br /><strong>Decision:</strong><br />$ vim Windows-FlashDriveRecovery.bat<br />$ cat Windows-FlashDriveRecovery.bat<br />dir /AS /B &gt; list.txt <br />FOR /F "eol=# tokens=1* delims=:" %%i in (list.txt) do ( <br />attrib -s -h -r "%%i" <br />) <br />pause<br /><strong>Task:</strong><br />Разработать программу "Менеджер паролей", в которой можно вносить данные в файле.<br /><strong>Decision:</strong><br />$ cat Py-PasswordStorage.py<br />'''<br />links&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | email&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | login | password &nbsp;&nbsp;&nbsp; &nbsp;- Keys<br />http://fds | fgd@fgd.ru | admin | fgdfgdf &nbsp;&nbsp; &nbsp;- Values<br />'''<br />repeat="y"<br />while repeat == "y":<br />&nbsp;&nbsp; &nbsp;keys=['links', 'mails', 'logins', 'passwords']<br />&nbsp;&nbsp; &nbsp;print(keys)&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;#print(keys[1])<br />&nbsp;&nbsp; &nbsp;values=[]<br />&nbsp;&nbsp; &nbsp;#print(values)<br />&nbsp;&nbsp; &nbsp;link, email, login, password= input("Enter the link: "), input("Enter email: "), input("Enter login: "), input("Enter password: ")<br />&nbsp;&nbsp; &nbsp;values.append(link)<br />&nbsp;&nbsp; &nbsp;values.append(email)<br />&nbsp;&nbsp; &nbsp;values.append(login)<br />&nbsp;&nbsp; &nbsp;values.append(password)<br />&nbsp;&nbsp; &nbsp;print(values)<br />&nbsp;&nbsp; &nbsp;#print(values[2])<br />&nbsp;&nbsp; &nbsp;row={}<br />&nbsp;&nbsp; &nbsp;for i in range(len(keys)):<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#print(keys[i])<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#row[keys[i]] = None<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;row[keys[i]] = values[i]<br />&nbsp;&nbsp; &nbsp;print(row)<br />&nbsp;&nbsp; &nbsp;createfile = input("Create new file? (y/n): ")<br />&nbsp;&nbsp; &nbsp;if createfile == "y":<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;namefile = input("Name the file where the passwords will be stored: ")<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;with open(namefile,'w') as file:<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#file.write(str(row))<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for key, value in row.items():<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;#print("Key: " + key)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;keyRow="|&nbsp;&nbsp; &nbsp;"+str(key)+"&nbsp;&nbsp; &nbsp;|"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.write(keyRow)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.write("\n")<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for key, value in row.items():<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;valueRow="|&nbsp;&nbsp; &nbsp;"+str(value)+"&nbsp;&nbsp; &nbsp;|"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.write(valueRow)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.close()<br />&nbsp;&nbsp; &nbsp;elif createfile == "n":<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;namefile = input("Write the name of the file in which you want to make changes: ")<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;with open(namefile,'a') as file:<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.write("\n")<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for key, value in row.items():<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;valueRow="|&nbsp;&nbsp; &nbsp;"+str(value)+"&nbsp;&nbsp; &nbsp;|"<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.write(valueRow)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.write("\n")<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;file.close()<br />&nbsp;&nbsp; &nbsp;repeat = input("Do you want to continue? (y/n): ")<br />&nbsp;&nbsp; &nbsp;if repeat == "n":<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;break<br />&nbsp;&nbsp; &nbsp;while (repeat!="y" and repeat!="n"):<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;repeat = input("Please enter the correct answer (y/n): ")<br />$ python Py-PasswordStorage.py<br />['links', 'mails', 'logins', 'passwords']<br />Enter the link: 1<br />Enter email: 2<br />Enter login: 3<br />Enter password: 4<br />['1', '2', '3', '4']<br />{'links': '1', 'mails': '2', 'logins': '3', 'passwords': '4'}<br />Create new file? (y/n): y<br />Name the file where the passwords will be stored: testfile<br />Do you want to continue? (y/n): 1213wa<br />Please enter the correct answer (y/n): y<br />['links', 'mails', 'logins', 'passwords']<br />Enter the link: 11<br />Enter email: 22<br />Enter login: 33<br />Enter password: 4444444<br />['11', '22', '33', '4444444']<br />{'links': '11', 'mails': '22', 'logins': '33', 'passwords': '4444444'}<br />Create new file? (y/n): n<br />Write the name of the file in which you want to make changes: testfile<br />Do you want to continue? (y/n): n<br />$ cat testfile<br />| links || mails || logins || passwords |<br />| 1 || 2 || 3 || 4 |<br />| 11 || 22 || 33 || 4444444 |</p>
                    </div>
                </div>                
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Инвентаризация компьютерной техники в здании</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Развернул виртуальный сервер в Altlinux и разработал в нем базу "Инвентаризация компьютерной техники в здании". Это позволило мне быстро предоставлять отчеты об оборудовании в здании<br /><strong>Task:</strong><br />Установить виртуальный сервер AltLinux в Hyper-V<br /><strong>Decision:</strong><br />PS C:\Windows\system32&gt; $ram=1*1024*1024*1024<br />PS C:\Windows\system32&gt; $ram<br />1073741824<br />PS C:\Windows\system32&gt; $hdd=10*1024*1024*1024<br />PS C:\Windows\system32&gt; $hdd<br />10737418240<br />PS C:\Windows\system32&gt; NEW-VM -Name Alt -MemoryStartupBytes $ram -NewVHDPath 'C:\Data\VM\Alt\Alt.vhdx'-NewVHD<br />SizeBytes $hdd -Path 'C:\Data\VM\Alt'<br />PS C:\Windows\system32&gt; Start-VM -name Alt<br />PS C:\Windows\system32&gt; Get-VM<br />Name State&nbsp;&nbsp; CPUUsage(%) MemoryAssigned(M) Uptime&nbsp;&nbsp; Status<br />---- -----&nbsp;&nbsp; ----------- ----------------- ------&nbsp;&nbsp; ------<br />Alt&nbsp; Off&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br /><strong>Task:</strong><br />Set up an ActiveDirectory/Login<br /><strong>Decision:</strong><br />$ ssh -X tuser@thost1<br />$ su -<br /># apt-get install task-auth-ad-sssd<br /># net time set -S thost.ru<br /># system-auth write ad thost.ru thost1 thost 'tuser' 'tpassword'<br />Using short domain name -- thost<br />Joined 'thost1' to dns domain 'thost.ru'<br />Successfully registered hostname with DNS<br />failed to call wbcGetDisplayName: WBC_ERR_WINBIND_NOT_AVAILABLE<br />Could not lookup sid S-1-5-21-965402400-3010625364-1855727791-513<br />failed to call wbcGetDisplayName: WBC_ERR_WINBIND_NOT_AVAILABLE<br />Could not lookup sid S-1-5-21-965402400-3010625364-1855727791-512<br /># wbinfo -t<br />checking the trust secret for domain thost via RPC calls succeeded<br /># acc<br />2 keyboards found<br />qt.qpa.xcb: could not connect to display<br />qt.qpa.plugin: Could not load the Qt platfothost plugin "xcb" in "" even though it was found.<br />This applthostation failed to start because no Qt platfothost plugin could be initialized. Reinstalling the applthostation may fix this problem.<br />Available platfothost plugins are: eglfs, linuxfb, minimal, minimalegl, offscreen, vnc, xcb.<br /># exit<br />$ exit<br />$ ssh -X tuser@thost1<br />$ su -<br /># acc<br />2 keyboards found<br />QStandardPaths: XDG_RUNTIME_DIR not set, defaulting to '/tmp/.private/root/runtime-root'<br />libpng warning: thostCP: known incorrect sRGB profile<br />libpng warning: thostCP: known incorrect sRGB profile<br />libpng warning: thostCP: known incorrect sRGB profile<br />libpng warning: thostCP: known incorrect sRGB profile<br />libpng warning: thostCP: known incorrect sRGB profile<br />WARNING: (alterator lookout evaluation): imported module (alterator presentation events) overrides core binding `when'<br />libpng warning: thostCP: known incorrect sRGB profile<br />libpng warning: thostCP: known incorrect sRGB profile<br />libpng warning: thostCP: known incorrect sRGB profile<br />libpng warning: thostCP: known incorrect sRGB profile<br /># vim /etc/net/ifaces/eth0/resolv.conf<br /># cat /etc/net/ifaces/eth0/resolv.conf<br />nameserver IpAddr1<br /># hostnamectl set-hostname thost1.thost.ru<br /># cat /etc/resolv.conf<br /># Generated by resolvconf<br /># Do not edit manually, use<br /># /etc/net/ifaces/&lt;interface&gt;/resolv.conf instead.<br />search thost.ru<br />nameserver 127.0.0.1<br /># vim /etc/resolv.conf<br /># cat /etc/resolvconf.conf<br /># Configuration for resolvconf(8)<br /># See resolvconf.conf(5) for details<br />resolv_conf_head='# Do not edit manually, use\n# /etc/net/ifaces/&lt;interface&gt;/resolv.conf instead.'<br />resolv_conf=/etc/resolv.conf<br /># These interfaces will always be processed first.<br />interface_order='lo lo[0-9]* lo.*'<br /># These interfaces will be processed next, unless they have a metrthost.<br />dynamthost_order='tap[0-9]* tun[0-9]* vpn vpn[0-9]* wg[0-9]* ppp[0-9]* ippp[0-9]*'<br />#Configuration files for named subscriber.<br />named_zones=/var/lib/bind/etc/resolvconf-zones.conf<br />named_options=/var/lib/bind/etc/resolvconf-options.conf<br />#Configuration files for dnsmasq subscriber.<br />dnsmasq_conf=/etc/dnsmasq.conf.d/60-resolvconf<br />dnsmasq_resolv=/etc/resolv.conf.dnsmasq<br />name_servers=127.0.0.1<br /># vim /etc/resolvconf.conf<br /># cat /etc/resolvconf.conf<br /># Configuration for resolvconf(8)<br /># See resolvconf.conf(5) for details<br />resolv_conf_head='# Do not edit manually, use\n# /etc/net/ifaces/&lt;interface&gt;/resolv.conf instead.'<br />resolv_conf=/etc/resolv.conf<br /># These interfaces will always be processed first.<br />#interface_order='lo lo[0-9]* lo.*'<br />interface_order='lo lo[0-9]* lo.* eth0'<br />search_domains=thost.ru<br /># These interfaces will be processed next, unless they have a metrthost.<br />dynamthost_order='tap[0-9]* tun[0-9]* vpn vpn[0-9]* wg[0-9]* ppp[0-9]* ippp[0-9]*'<br />#Configuration files for named subscriber.<br />named_zones=/var/lib/bind/etc/resolvconf-zones.conf<br />named_options=/var/lib/bind/etc/resolvconf-options.conf<br />#Configuration files for dnsmasq subscriber.<br />dnsmasq_conf=/etc/dnsmasq.conf.d/60-resolvconf<br />dnsmasq_resolv=/etc/resolv.conf.dnsmasq<br />#name_servers=127.0.0.1<br /># resolvconf -u<br /># cat /etc/resolv.conf<br /># Generated by resolvconf<br /># Do not edit manually, use<br /># /etc/net/ifaces/&lt;interface&gt;/resolv.conf instead.<br />search thost.ru<br />nameserver IpAddr1<br />...<br />nameserver 8.8.8.8<br /># hostname<br />thost1.thost.ru<br /># dig _kerberos._udp.thost.ru SRV | grep ^_kerberos<br />_kerberos._udp.thost.ru. 600 IN SRV 0 100 88 M-1.thost.ru.<br />...<br />_kerberos._udp.thost.ru. 600 IN SRV 0 100 88 T-1.thost.ru.<br /># dig _kerberos._tcp.thost.ru SRV | grep ^_kerberos<br />_kerberos._tcp.thost.ru. 600 IN SRV 0 100 88 M-c.thost.ru.<br />...<br />_kerberos._tcp.thost.ru. 600 IN SRV 0 100 88 T-1.thost.ru.<br /># cat /etc/krb5.conf | grep default_realm<br />default_realm = thost.ru<br /># default_realm = EXAMPLE.COM<br /># cat /etc/krb5.conf | grep dns_lookup_realm<br />dns_lookup_realm = false<br /># cat /etc/krb5.conf | grep dns_lookup_kdc<br />dns_lookup_kdc = true<br /># exit<br />$ ssh -X tuser@thost1<br /># kinit tuser<br /># klist<br />Tthostket cache: KEYRING:persistent:0:krb_ccache_CCjHpN1<br />Default principal: a-r@thost.ru<br />Valid starting&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Expires&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Servthoste principal<br />10.08.2022 12:30:34&nbsp; 10.08.2022 22:30:34&nbsp; krbtgt/thost.ru@thost.ru<br />&nbsp;&nbsp; &nbsp;renew until 17.08.2022 12:30:32<br /># apt-get install samba-client<br /># cat /etc/samba/smb.conf | grep realm<br />&nbsp;&nbsp; &nbsp;realm = thost.ru<br /># cat /etc/samba/smb.conf | grep workgroup<br />&nbsp;&nbsp; &nbsp;workgroup = thost<br /># cat /etc/samba/smb.conf | grep netbios<br />&nbsp;&nbsp; &nbsp;netbios name = thost1<br /># cat /etc/samba/smb.conf | grep security<br />&nbsp;&nbsp; &nbsp;security = ads<br /># cat /etc/samba/smb.conf | grep method<br />&nbsp;&nbsp; &nbsp;kerberos method = system keytab<br /># cat /etc/samba/smb.conf | grep idmap<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;idmap config * : range = 200000-2000200000<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;idmap config * : backend = sss<br /># vim /etc/samba/smb.conf<br /># cat /etc/samba/smb.conf | grep idmap<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;idmap config * : range = 200000-2000200000<br />;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; idmap config * : backend = sss<br />&nbsp;&nbsp; &nbsp;idmap config * : backend = tdb<br /># testpathost<br />Load smb config files from /etc/samba/smb.conf<br />Loaded servthostes file OK.<br />Weak crypto is allowed<br />Server role: ROLE_DOMAIN_MEMBER<br />Press enter to see a dump of your servthoste definitions<br /># Global parameters<br />[global]<br />&nbsp;&nbsp; &nbsp;kerberos method = system keytab<br />&nbsp;&nbsp; &nbsp;machine password timeout = 0<br />&nbsp;&nbsp; &nbsp;realm = thost.ru<br />&nbsp;&nbsp; &nbsp;security = ADS<br />&nbsp;&nbsp; &nbsp;template homedir = /home/thost.ru/%U<br />&nbsp;&nbsp; &nbsp;template shell = /bin/bash<br />&nbsp;&nbsp; &nbsp;winbind use default domain = Yes<br />&nbsp;&nbsp; &nbsp;workgroup = thost<br />&nbsp;&nbsp; &nbsp;idmap config * : range = 200000-2000200000<br />&nbsp;&nbsp; &nbsp;idmap config * : backend = tdb<br />[share]<br />&nbsp;&nbsp; &nbsp;comment = Commonplace<br />&nbsp;&nbsp; &nbsp;path = /srv/share<br />&nbsp;&nbsp; &nbsp;read only = No<br />[homes]<br />&nbsp;&nbsp; &nbsp;browseable = No<br />&nbsp;&nbsp; &nbsp;comment = Home Directory for '%u'<br />&nbsp;&nbsp; &nbsp;read only = No<br /># net ads join -U tuser<br />Enter tuser's password:<br />Using short domain name -- thost<br />Joined 'thost1' to dns domain 'thost.ru'<br />No DNS domain configured for thost1. Unable to perfothost DNS Update.<br />DNS update failed: NT_STATUS_INVALID_PARAMETER<br /># cat /etc/hosts<br />127.0.0.1&nbsp;&nbsp; localhost.localdomain localhost<br /># vim /etc/hosts<br /># cat /etc/hosts<br />127.0.0.1&nbsp;&nbsp; localhost.localdomain localhost<br />127.0.0.1&nbsp;&nbsp; thost1.thost.ru thost1<br /># net ads join -U tuser<br />Enter tuser's password:<br />Using short domain name -- thost<br />Joined 'thost1' to dns domain 'thost.ru'<br />kerberos_kinit_password thost1$@thost.ru failed: Preauthentthostation failed<br />DNS update failed: kinit failed: Preauthentthostation failed<br /># vim /etc/hosts<br /># cat /etc/hosts<br />127.0.0.1&nbsp;&nbsp; thost1.thost.ru thost1<br /># net ads join -U tuser<br />Enter tuser's password:<br />Using short domain name -- thost<br />Joined 'thost1' to dns domain 'thost.ru'<br /># klist -k -e<br />Keytab name: FILE:/etc/krb5.keytab<br />KVNO Principal<br />---- --------------------------------------------------------------------------<br />9 host/thost1.thost.ru@thost.ru (aes256-cts-hmac-sha1-96)<br />9 host/thost1@thost.ru (aes256-cts-hmac-sha1-96)<br />9 host/thost1.thost.ru@thost.ru (aes128-cts-hmac-sha1-96)<br />9 host/thost1@thost.ru (aes128-cts-hmac-sha1-96)<br />9 host/thost1.thost.ru@thost.ru (DEPRECATED:arcfour-hmac)<br />9 host/thost1@thost.ru (DEPRECATED:arcfour-hmac)<br />9 thost1$@thost.ru (aes256-cts-hmac-sha1-96)<br />9 thost1$@thost.ru (aes128-cts-hmac-sha1-96)<br />9 thost1$@thost.ru (DEPRECATED:arcfour-hmac)<br />8 host/thost1.thost.ru@thost.ru (aes256-cts-hmac-sha1-96)<br />8 host/thost1@thost.ru (aes256-cts-hmac-sha1-96)<br />8 host/thost1.thost.ru@thost.ru (aes128-cts-hmac-sha1-96)<br />8 host/thost1@thost.ru (aes128-cts-hmac-sha1-96)<br />8 host/thost1.thost.ru@thost.ru (DEPRECATED:arcfour-hmac)<br />8 host/thost1@thost.ru (DEPRECATED:arcfour-hmac)<br />8 thost1$@thost.ru (aes256-cts-hmac-sha1-96)<br />8 thost1$@thost.ru (aes128-cts-hmac-sha1-96)<br />8 thost1$@thost.ru (DEPRECATED:arcfour-hmac)<br /># apt-get install sssd-ad<br /># cat /etc/sssd/sssd.conf<br />[sssd]<br />config_file_version = 2<br />servthostes = nss, pam<br /># Managed by system facility command:<br />## control sssd-drop-privileges unprivileged|privileged|default<br />user = _sssd<br /># SSSD will not start if you do not configure any domains.<br />domains = thost.ru<br />[nss]<br />[pam]<br />[domain/thost.ru]<br />id_provider = ad<br />auth_provider = ad<br />chpass_provider = ad<br />access_provider = ad<br />default_shell = /bin/bash<br />fallback_homedir = /home/%d/%u<br />debug_level = 0<br />; cache_credentials = false<br />ad_gpo_ignore_unreadable = true<br />ad_gpo_access_control = pethostissive<br />ad_update_samba_machine_account_password = true<br /># vim /etc/sssd/sssd.conf<br /># cat /etc/sssd/sssd.conf<br />[sssd]<br />config_file_version = 2<br />servthostes = nss, pam<br /># Managed by system facility command:<br />## control sssd-drop-privileges unprivileged|privileged|default<br />#user = _sssd<br />user=root<br /># SSSD will not start if you do not configure any domains.<br />domains = thost.ru<br />[nss]<br />[pam]<br />[domain/thost.ru]<br />id_provider = ad<br />auth_provider = ad<br />chpass_provider = ad<br />access_provider = ad<br />;ldap_id_mapping = False<br />default_shell = /bin/bash<br />fallback_homedir = /home/%d/%u<br />debug_level = 0<br />;use_fully_qualified_names = True<br />; cache_credentials = True<br />ad_gpo_ignore_unreadable = true<br />ad_gpo_access_control = pethostissive<br />ad_update_samba_machine_account_password = true<br /># grep sss /etc/nsswitch.conf<br />passwd: files sss<br />shadow: tcb files sss<br />group: files [SUCCESS=merge] sss role<br /># control system-auth sss<br /># servthoste sssd status<br />active<br /># servthoste sssd start<br /># getent passwd tuser<br />tuser:*:1-9:1-3:в-н:/home/thost.ru/tuser:/bin/bash<br /># id tuser<br />uid=1-9(tuser) gid=1-3(пользователи домена) группы=1-3(пользователи домена),1-8(администраторы dhcp),1-0(I-s),11-0(пользователи филиалы),1-1(tusert_users),1-9(i-n)<br /># net ads info<br />LDAP server: IpAddr2<br />LDAP server name: MOW-1.thost.ru<br />Realm: thost.ru<br />Bind Path: dc=thost,dc=RU<br />LDAP port: 389<br />Server time: Ср, 10 авг 2022 13:08:06 +08<br />KDC server: IpAddr2<br />Server time offset: 0<br />Last machine account password change: Ср, 10 авг 2022 12:50:51 +08<br /># net ads testjoin<br />Join is OK<br /># cat /etc/lightdm/lightdm.conf | grep greeter-hide-<br /># greeter-hide-users = True to hide the user list<br />#greeter-hide-users=false<br />greeter-hide-users = true<br /># cat /etc/lightdm/lightdm-gtk-greeter.conf | grep show-language<br />show-language-selector = false<br /># cat /etc/lightdm/lightdm-gtk-greeter.conf | grep show-indthostators<br /># vim /etc/lightdm/lightdm-gtk-greeter.conf<br /># cat /etc/lightdm/lightdm-gtk-greeter.conf | grep show-indthostators<br />show-indthostators=~a11y;~power;~session;~language<br /># vim /etc/lightdm/lightdm-gtk-greeter.conf<br /># cat /etc/lightdm/lightdm-gtk-greeter.conf | grep enter-<br />enter-username = true<br /># reboot<br />$ ssh -X tuser@thost1<br /><strong>Decision:</strong><br />$ su -<br /># apt-get install libnss-role<br /># groupadd -r localadmins<br />groupadd: группа &laquo;localadmins&raquo; уже существует<br /># groupadd -r remote<br />groupadd: группа &laquo;remote&raquo; уже существует<br /># control sshd-allow-groups enabled<br /># sed -i 's/AllowGroups.*/AllowGroups = remote/' /etc/openssh/sshd_config<br /># roleadd users cdwriter cdrom audio proc radio camera floppy xgrp scanner uucp fuse<br /># roleadd localadmins wheel remote vboxusers<br /># roleadd 'Domain Users' users<br />Error 156: No such group<br /># roleadd 'Пользователи домена' users<br /># roleadd 'Администраторы домена' localadmins<br /># rolelst<br />users:cdwriter,cdrom,audio,proc,radio,camera,floppy,xgrp,scanner,uucp,fuse,video,vboxusers,vboxadd<br />localadmins:wheel,remote,vboxusers,vboxadd<br />пользователи домена:users<br />администраторы домена:localadmins<br />powerusers:remote,vboxadd,vboxusers<br />vboxadd:vboxsf<br /># id tuser<br />uid=1-9(tuser) gid=1-3(пользователи домена) группы=1-3(пользователи домена),11-0(пользователи филиалы),1-9(i-n),1-0(I-s),1-1(tusert_users),1-8(администраторы dhcp),100(users),80(cdwriter),22(cdrom),81(audio),19(proc),83(radio),440(camera),71(floppy),466(xgrp),467(scanner),14(uucp),483(fuse),488(video),481(vboxusers),455(vboxadd),454(vboxsf)<br /># roleadd 'I-s' localadmins<br /># roleadd 'I-s' wheel<br /># rolelst<br />users:cdwriter,cdrom,audio,proc,radio,camera,floppy,xgrp,scanner,uucp,fuse,video,vboxusers,vboxadd<br />localadmins:wheel,remote,vboxusers,vboxadd<br />пользователи домена:users<br />администраторы домена:localadmins<br />I-s:localadmins<br />powerusers:remote,vboxadd,vboxusers<br />vboxadd:vboxsf<br /># exit<br />$ exit<br />$ ssh -X tuser@thost1<br />$ su -<br /># id tuser<br />uid=1-9(tuser) gid=1-3(пользователи домена) группы=1-3(пользователи домена),11-0(пользователи филиалы),1-9(i-n),1-0(I-s),1-1(tusert_users),1-8(администраторы dhcp),100(users),80(cdwriter),22(cdrom),81(audio),19(proc),83(radio),440(camera),71(floppy),466(xgrp),467(scanner),14(uucp),483(fuse),488(video),481(vboxusers),455(vboxadd),454(vboxsf),101(localadmins),10(wheel),110(remote)<br /><strong>Task:</strong><br />Добавить сетевые папки<br /><strong>Decision:</strong><br /># apt-get install autofs<br /># vim /etc/auto.master<br /># cat /etc/auto.master<br /># Fothostat of this file:<br /># mountpoint map options<br /># For details of the fothostat look at autofs(8).<br />/mnt/auto&nbsp;&nbsp; /etc/auto.tab&nbsp;&nbsp; -t 5<br />/mnt/net&nbsp;&nbsp;&nbsp; /etc/auto.avahi -t 120<br />/mnt/.tdirectory&nbsp; /etc/auto.samba --ghost<br /># vim /etc/auto.samba<br /># cat /etc/auto.samba<br />s&nbsp;&nbsp;&nbsp; -fstype=cifs,multiuser,cruid=$USER,sec=krb5,domain=thost.ru,vers=1.0 ://thost/tdirectory1<br />o&nbsp;&nbsp;&nbsp; -fstype=cifs,multiuser,cruid=$USER,sec=krb5,domain=thost.ru,vers=1.0 ://thost/tdirectory2<br /># systemctl enable autofs<br /># systemctl start autofs<br /># ls -la /mnt/.tdirectory/<br />drwxr-xr-x 4 root root&nbsp;&nbsp;&nbsp; 0 авг 11 14:09 .<br />drwxr-xr-x 5 root root 4096 авг 11 14:09 ..<br />d????????? ? ?&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ? o<br />d????????? ? ?&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ? s<br /><strong>Task:</strong><br />Creating a Network Bridge interface<br /><strong>Decision:</strong><br /># mkdir /etc/net/ifaces/tethernet1<br /># cp /etc/net/ifaces/tethernet/* /etc/net/ifaces/tethernet1<br /># rm -f /etc/net/ifaces/tethernet/{i,r}*<br /># ls /etc/net/ifaces/tethernet1/<br />ipv4address&nbsp; options&nbsp; resolv.conf<br /># cat /etc/net/ifaces/tethernet1/options<br />BOOTPROTO=dhcp<br />TYPE=eth<br />NM_CONTROLLED=yes<br />DISABLED=yes<br />CONFIG_WIRELESS=no<br />SYSTEMD_BOOTPROTO=dhcp4<br />CONFIG_IPV4=yes<br />SYSTEMD_CONTROLLED=no<br /># vim /etc/net/ifaces/tethernet1/options<br /># ls /etc/net/ifaces/<br />default&nbsp; tethernet&nbsp; lo&nbsp; unknown&nbsp; tethernet1<br /># vim /etc/net/ifaces/tethernet1/options<br /># vim /etc/net/ifaces/tethernet1/options<br /># cat /etc/net/ifaces/tethernet1/options<br />BOOTPROTO=static<br />CONFIG_WIRELESS=no<br />CONFIG_IPV4=yes<br />HOST='tethernet'<br />ONBOOT=yes<br />TYPE=bri<br /># ls /etc/net/ifaces/tethernet/<br />ipv4address&nbsp; options&nbsp; resolv.conf<br /># service network restart<br /><strong>Task:</strong><br />Настройка сервера Postgresql+Pgadmin<br /><strong>Decision:</strong><br /># apt-get update<br /># apt-get install postgresql12-server<br /># /etc/init.d/postgresql initdb<br /># systemctl start postgresql<br /># systemctl enable postgresql<br /># pg_isready<br /><strong>Decision:</strong><br /># psql -U postgres<br />postgres=# CREATE USER tbuser WITH PASSWORD 'tbpassword';<br />postgres=# CREATE DATABASE tbbase;<br />postgres=# GRANT ALL PRIVILEGES ON DATABASE tbbase to tbuser;<br />postgres=# psql -U postgres -c "\l+"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Список баз данных<br />&nbsp;&nbsp;&nbsp;&nbsp; Имя&nbsp;&nbsp;&nbsp;&nbsp; | Владелец | Кодировка | LC_COLLATE&nbsp; |&nbsp; LC_CTYPE&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp; Права доступа&nbsp;&nbsp;&nbsp;&nbsp; | Размер&nbsp; | Табл. пространство |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Опис<br />ание&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />-------------+----------+-----------+-------------+-------------+-----------------------+---------+--------------------+----------------------<br />----------------------<br />&nbsp;tbbase | postgres | UTF8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | ru_RU.UTF-8 | ru_RU.UTF-8 | =Tc/postgres&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +| 8041 kB | pg_default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | postgres=CTc/postgres+|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | tbuser=CTc/postgres&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />&nbsp;postgres&nbsp;&nbsp;&nbsp; | postgres | UTF8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | ru_RU.UTF-8 | ru_RU.UTF-8 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 8185 kB | pg_default&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | default administrativ<br />e connection database<br />...<br />postgres=# \c tbbase<br />tbbase=# GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "tbuser";<br />tbbase=# ALTER DATABASE tbbase OWNER TO tbuser;<br />tbbase=# \q<br /><strong>Task:</strong><br />Сделаем так, чтобы с клиентской машины Redos мы могли подключаться к серверу AltLinux удаленно<br /><strong>Decision:</strong><br /># su - postgres -c "psql -c 'SHOW config_file;'"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; config_file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />-------------------------------------<br />&nbsp;/var/lib/pgsql/data/postgresql.conf<br />(1 строка)<br /># echo "listen_addresses = 'IpAddr3, IpAddr2, thost1'" &gt;&gt; /var/lib/pgsql/data/postgresql.conf<br /># cat /var/lib/pgsql/data/pg_hba.conf<br />...<br /># "local" is for Unix domain socket connections only<br />local&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trust<br /># IPv4 local connections:<br />host&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1/32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trust<br />...<br /># vim /var/lib/pgsql/data/pg_hba.conf<br /># cat /var/lib/pgsql/data/pg_hba.conf | grep '10.38.'<br /># "local" is for Unix domain socket connections only<br />local&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trust<br /># IPv4 local connections:<br />host&nbsp;&nbsp;&nbsp; tbbase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tbuser&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IpAddr2/21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5<br />host&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1/32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trust<br /># systemctl restart postgresql<br /># systemctl status postgresql<br />$ psql -d tbbase -U tbuser -h thost1<br /><strong>Task:</strong><br />Для работы с базой в графическом интерфейсе установим Pgadmin<br /><strong>Decision:</strong><br /># apt-get install pgadmin3<br /># pgadmin3 &amp;<br />&nbsp;&nbsp; &nbsp;add server - name - tbuser - host - thost1- password - tbpassword - ok<br /># dnf install postgresql-server<br /># postgresql-setup initdb<br /># systemctl enable postgresql<br /># systemctl start postgresql<br /># pg_isready<br />$ psql -d tbbase -U tbuser -h thost1<br />tbbase=&gt; \du<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Список ролей<br />&nbsp;Имя роли |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Атрибуты&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Член ролей<br />----------+-------------------------------------------------------------------------+------------<br />&nbsp;tbuser&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | {}<br />&nbsp;postgres | Суперпользователь, Создаёт роли, Создаёт БД, Репликация, Пропускать RLS | {}<br /><strong>Decision:</strong><br />$ sudo dnf install pgadmin4 pgadmin4-qt<br />$ pgadmin4-qt &amp;<br />&nbsp;&nbsp; &nbsp;root's password - add server - name - tbuser - host - thost1- password - tbpassword - ok<br /><strong>Task:</strong><br />Создать таблицы. В первой таблице отметим в каких зданиях находятся кабинеты.<br /><strong>Decision:</strong><br />CREATE TABLE offices (<br />&nbsp; id SERIAL PRIMARY KEY,<br />&nbsp; office VARCHAR,<br />&nbsp; building VARCHAR<br />);<br />INSERT INTO offices (office, building)<br />VALUES ('1', 'Улица1'),<br />('2', 'Улица1'),<br />('3', 'Улица1'),<br />('4', 'Улица2'),<br />('5', 'Улица2'),<br />('6', 'Улица2'),<br />('7', 'Улица2'),<br />('8', 'Улица2'),<br />('9', 'Улица2');<br />SELECT * FROM offices;<br />+====+========+===============+<br />| id | office | building&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+====+========+===============+<br />| 1&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp; | Улица1&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 2&nbsp; | 2&nbsp;&nbsp;&nbsp;&nbsp; | Улица1&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 3&nbsp; | 3&nbsp;&nbsp;&nbsp;&nbsp; | Улица1&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 4&nbsp; | 4&nbsp;&nbsp;&nbsp; | Улица2&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 5&nbsp; | 5&nbsp;&nbsp;&nbsp; | Улица2&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 6&nbsp; | 6&nbsp;&nbsp;&nbsp; | Улица2&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 7&nbsp; | 7&nbsp;&nbsp;&nbsp; | Улица2&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 8&nbsp; | 8&nbsp;&nbsp;&nbsp; | Улица2&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br />| 9&nbsp; | 9&nbsp;&nbsp;&nbsp; | Улица2&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;|<br />+----+--------+---------------+<br /><strong>Task:</strong><br />Вторая таблица отвечает за названия оборудований<br /><strong>Decision:</strong><br />CREATE TABLE devices (<br />&nbsp; id SERIAL PRIMARY KEY,<br />&nbsp; device VARCHAR,<br />&nbsp; title VARCHAR<br />);<br />INSERT INTO devices (device, title)<br />VALUES ('Atc', 'Panasonic kx-tda100ru'),<br />('Bидеокамера белая', NULL),<br />('Интерактиная доска с короткофокусным проектором', 'Promethean activeboard i78 mount dlp'),<br />('Колонки', 'Sven sps-605'),<br />('Компьютер', 'Nuc'),<br />('Программно-аапаратный комплекс', 'Vipnet coordinator hw 1000'),<br />('Сетевой фильтр', 'Sven platinum'),<br />('Маршрутизатор', 'Mtuserrottuser'),<br />('Сетевой фильтр', 'Makel с заземлением mpg 137'),<br />('Роутер', 'Mtuserrottuser browder rb9516'),<br />('Dvd-плеер', 'Pioner dv-310-k'),<br />('Акустическая система', 'Electrovoice'),<br />('Коммутатор', 'Kramer'),<br />('Масштабатор видео и графики', 'Kramer'),<br />('Микрофон делегата настольный', NULL),<br />('Микрофонная стойка', 'Qutuser lok a300'),<br />('Мультимедийный проектор', 'Epson eb-965h'),<br />('Пульт микшерский', 'Soundcraft epm8'),<br />('Система вентилляции и кондиционирования', NULL),<br />('Эран моторизированный', 'Projecta compact electrol'),<br />('Ноутбук', 'Acer aspire as5560g-4333g32mn'),<br />('Bидеокамера серая', NULL),<br />('Микрофон', 'Shure sh58'),<br />('Акустическая система', 'Mackie sr1530z'),<br />('Сетевой фильтр', 'Sven optima'),<br />('Сетевой фильтр', 'Surge protector'),<br />('Мультимедийный проектор', 'Optima ex612'),<br />('Экран настенный', 'Screenmedia economy-p'),<br />('Колонки', 'Logitech s120'),<br />('Компьютер', 'Nuc mini pc kit'),<br />('Сетевой фильтр', 'Pc pet'),<br />('Интерактиная доска', '80'),<br />('Короткофокусный проектор', 'Benq'),<br />('Колонки', 'Microlab solo 1'),<br />('Акустическая система', 'Eurosound eg-26w 2*6'),<br />('Микшерный пульт', 'Eurosound compact-802'),<br />('Планшет графический', 'Wacom pl-1600'),<br />('Телевизор плазменный', 'Lg 50pa6500'),<br />('Усилитель мощности', 'Eurosound xz-400'),<br />('8 port video splitter', NULL);<br />SELECT * FROM devices;<br />+====+=================================================+======================================+<br />| id | device&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+====+=================================================+======================================+<br />| 1&nbsp; | Atc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Panasonic kx-tda100ru&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 2&nbsp; | Bидеокамера белая&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 3&nbsp; | Интерактиная доска с короткофокусным проектором | Promethean activeboard i78 mount dlp |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 4&nbsp; | Колонки&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Sven sps-605&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 5&nbsp; | Компьютер&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Nuc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 6&nbsp; | Программно-аапаратный комплекс&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Vipnet coordinator hw 1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 7&nbsp; | Сетевой фильтр&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Sven platinum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 8&nbsp; | Маршрутизатор&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Mtuserrottuser&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 9&nbsp; | Сетевой фильтр&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Makel с заземлением mpg 137&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 10 | Роутер&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Mtuserrottuser browder rb9516&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 11 | Dvd-плеер&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Pioner dv-310-k&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 12 | Акустическая система&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Electrovoice&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 13 | Коммутатор&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Kramer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 14 | Масштабатор видео и графики&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Kramer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 15 | Микрофон делегата настольный&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 16 | Микрофонная стойка&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Qutuser lok a300&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 17 | Мультимедийный проектор&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Epson eb-965h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 18 | Пульт микшерский&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Soundcraft epm8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 19 | Система вентилляции и кондиционирования&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 20 | Эран моторизированный&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Projecta compact electrol&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 21 | Ноутбук&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Acer aspire as5560g-4333g32mn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 22 | Bидеокамера серая&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 23 | Микрофон&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Shure sh58&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 24 | Акустическая система&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Mackie sr1530z&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 25 | Сетевой фильтр&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Sven optima&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 26 | Сетевой фильтр&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Surge protector&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 27 | Мультимедийный проектор&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Optima ex612&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 28 | Экран настенный&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Screenmedia economy-p&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 29 | Колонки&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Logitech s120&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 30 | Компьютер&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Nuc mini pc kit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 31 | Сетевой фильтр&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Pc pet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 32 | Интерактиная доска&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 33 | Короткофокусный проектор&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Benq&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 34 | Колонки&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Microlab solo 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 35 | Акустическая система&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Eurosound eg-26w 2*6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 36 | Микшерный пульт&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Eurosound compact-802&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 37 | Планшет графический&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Wacom pl-1600&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 38 | Телевизор плазменный&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Lg 50pa6500&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 39 | Усилитель мощности&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Eurosound xz-400&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br />| 40 | 8 port video splitter&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+----+-------------------------------------------------+--------------------------------------+<br /><strong>Task:</strong><br />Третья таблица отвечает за инвентарные номера оборудований, кабинетов и даты изменения<br /><strong>Decision:</strong><br />CREATE TABLE inventories (<br />&nbsp; id SERIAL PRIMARY KEY,<br />&nbsp; inventory VARCHAR,<br />&nbsp; device_id INT REFERENCES devices(id),<br />&nbsp; office_id INT REFERENCES offices(id),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp; quantity INT,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp; date TIMESTAMP<br />);<br />INSERT INTO inventories (inventory, device_id, office_id, quantity, date)<br />VALUES ('457', '1', '1', '1', '2017-12-12 12:12:12'),<br />(NULL, '2', '1', '1', '2017-12-12 12:12:12'),<br />...<br />('750', '30', '6', '1', '2021-09-12 12:12:12'),<br />('707', '17', '6', '1', '2020-05-12 12:12:12'),<br />('008', '4', '6', '1', '2020-09-12 12:12:12'),<br />('010', '34', '9', '1', '2017-12-12 12:12:12'),<br />('650', '5', '9', '1', '2017-12-12 12:12:12'),<br />('556', '33', '9', '1', '2017-12-12 12:12:12'),<br />('426', '32', '9', '1', '2017-12-12 12:12:12');<br />SELECT * FROM inventories;<br />+====+=============+===========+===========+==========+=====================+<br />| id | inventory&nbsp;&nbsp; | device_id | office_id | quantity | date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+====+=============+===========+===========+==========+=====================+<br />| 1&nbsp; | 457&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 2&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />...<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 62 | 750&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2021-09-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 63 | 707&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2020-05-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 64 | 008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2020-09-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 65 | 010&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 34&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 66 | 650&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 67 | 556&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 33&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 68 | 426&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br /><strong>Task:</strong><br />Мне нужно вывести информацию, где в первом столбце будет инвентарные номера, во втором столбце, устройство и его название, а в третьем столбце вывести кабинеты, где находятся те самые оборудования<br /><strong>Decision:</strong><br />SELECT inventory, device, title, office<br />FROM inventories<br />INNER JOIN devices<br />ON inventories.device_id = devices.id<br />INNER JOIN offices<br />ON inventories.office_id = offices.id<br />WHERE office_id='6';<br />+=============+=========================+=================+========+<br />| inventory&nbsp;&nbsp; | device&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | office |<br />+=============+=========================+=================+========+<br />| 008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Колонки&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Sven sps-605&nbsp;&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+-------------------------+-----------------+--------+<br />| 707&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Мультимедийный проектор | Epson eb-965h&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+-------------------------+-----------------+--------+<br />| 750&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Компьютер&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Nuc mini pc kit | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+-------------------------+-----------------+--------+<br /><strong>Task:</strong><br />Заметил ошибку в таблице, есть лишнее оборудование в кабинете. его на самом деле нету в кабинете и значит не должно быть в таблице.<br /><strong>Decision:</strong><br />DELETE FROM inventories<br />WHERE id='64';<br />SELECT inventory, device, title, office<br />FROM inventories<br />INNER JOIN devices<br />ON inventories.device_id = devices.id<br />INNER JOIN offices<br />ON inventories.office_id = offices.id<br />WHERE office_id='6';<br />+===========+=========================+=================+========+<br />| inventory | device&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | office |<br />+===========+=========================+=================+========+<br />| 707&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Мультимедийный проектор | Epson eb-965h&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-----------+-------------------------+-----------------+--------+<br />| 750&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Компьютер&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Nuc mini pc kit | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-----------+-------------------------+-----------------+--------+<br />SELECT * FROM inventories;<br />+====+=============+===========+===========+==========+=====================+<br />| id | inventory&nbsp;&nbsp; | device_id | office_id | quantity | date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+====+=============+===========+===========+==========+=====================+<br />| 1&nbsp; | 457&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 2&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />...<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 62 | 750&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2021-09-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 63 | 707&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2020-05-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 65 | 010&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 34&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 66 | 650&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 67 | 556&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 33&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 68 | 426&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br /><strong>Task:</strong><br />Появилось новое обрудование, и нужно его внести в таблицу.<br /><strong>Decision:</strong><br />INSERT INTO inventories (inventory, device_id, office_id, quantity, date)<br />VALUES ('testinv1', '39', '1', '1', '2017-12-12 12:12:12');<br />SELECT * FROM inventories;<br />+====+=============+===========+===========+==========+=====================+<br />| id | inventory&nbsp;&nbsp; | device_id | office_id | quantity | date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+====+=============+===========+===========+==========+=====================+<br />| 1&nbsp; | 457&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 2&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />...<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 68 | 426&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 69 | testinv1&nbsp;&nbsp;&nbsp; | 39&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br /><strong>Task:</strong><br />в предыдущей задаче не верные данные внес в таблицу, нужно подкорректировать.<br /><strong>Decision:</strong><br />UPDATE inventories<br />SET inventory='testinv2', office_id='9'<br />WHERE id='69';<br />SELECT * FROM inventories;<br />+====+=============+===========+===========+==========+=====================+<br />| id | inventory&nbsp;&nbsp; | device_id | office_id | quantity | date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+====+=============+===========+===========+==========+=====================+<br />| 1&nbsp; | 457&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 2&nbsp; | (null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />...<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 68 | 426&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />| 69 | testinv2&nbsp;&nbsp;&nbsp; | 39&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2017-12-12 12:12:12 |<br />+----+-------------+-----------+-----------+----------+---------------------+<br />SELECT inventory, device, title, office<br />FROM inventories<br />INNER JOIN devices<br />ON inventories.device_id = devices.id<br />INNER JOIN offices<br />ON inventories.office_id = offices.id<br />WHERE office_id='9';<br />+=============+==========================+==================+========+<br />| inventory&nbsp;&nbsp; | device&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | title&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | office |<br />+=============+==========================+==================+========+<br />| 650&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Компьютер&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Nuc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+--------------------------+------------------+--------+<br />| 426&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Интерактиная доска&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+--------------------------+------------------+--------+<br />| 556&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Короткофокусный проектор | Benq&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+--------------------------+------------------+--------+<br />| 010&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Колонки&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Microlab solo 1&nbsp; | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+--------------------------+------------------+--------+<br />| testinv2&nbsp;&nbsp;&nbsp; | Усилитель мощности&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Eurosound xz-400 | 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+-------------+--------------------------+------------------+--------+<br /><strong>Source:</strong></p>
                        <ul>
                        <li><a href="https://www.altlinux.org/ActiveDirectory/Login#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2">https://www.altlinux.org/ActiveDirectory/Login#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2</a></li>
                        <li><a href="https://www.altlinux.org/SSSD/AD">https://www.altlinux.org/SSSD/AD</a></li>
                        <li><a href="https://www.altlinux.org/%D0%A1%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B9_%D0%BC%D0%BE%D1%81%D1%82">https://www.altlinux.org/%D0%A1%D0%B5%D1%82%D0%B5%D0%B2%D0%BE%D0%B9_%D0%BC%D0%BE%D1%81%D1%82</a></li>
                        <li><a href="https://www.altlinux.org/PostgreSQL#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B8_%D0%BD%D0%B0%D1%87%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9_%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA">https://www.altlinux.org/PostgreSQL#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0_%D0%B8_%D0%BD%D0%B0%D1%87%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9_%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA</a></li>
                        <li><a href="https://www.tecmint.com/install-postgresql-and-pgadmin-in-ubuntu/">https://www.tecmint.com/install-postgresql-and-pgadmin-in-ubuntu/</a></li>
                        <li><a href="https://o7planning.org/11353/install-pgadmin-on-ubuntu">https://o7planning.org/11353/install-pgadmin-on-ubuntu</a></li>
                        <li><a href="https://redos.red-soft.ru/base/server-configuring/dbms/install-postgresql/?sphrase_id=53348">https://redos.red-soft.ru/base/server-configuring/dbms/install-postgresql/?sphrase_id=53348</a></li>
                        <li><a href="https://redos.red-soft.ru/base/server-configuring/dbms/pgadmin4/">https://redos.red-soft.ru/base/server-configuring/dbms/pgadmin4/</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Установка и настройка Linux в рамках импортозамещения</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для импортозамещения с Windows на Redos, развернул виртуальную тестовую машину Redos в Hyber-v, протестировал машину на работоспобность с программами в организации, развернул Pxe сервер для развертывания Redos с загрузкой в Uefi по сети. Это сэкономило время на внедрение системы Redos в компьютерных классах<br /><strong>Task:</strong><br />Установить Hyper-V в Windows Server 2012 c помощью Shell<br /><strong>Decision:</strong><br />PS C:\Windows\system32&gt; Get-Module -ListAvailable<br />Каталог: C:\Windows\system32\WindowsPowerShell\v1.0\Modules<br />ModuleType Version&nbsp;&nbsp;&nbsp; Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ExportedCo<br />---------- -------&nbsp;&nbsp;&nbsp; ----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ----------<br />...<br />Binary&nbsp;&nbsp;&nbsp;&nbsp; 1.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Hyper-V&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {Add-VMDvd<br />...<br />PS C:\Windows\system32&gt; Import-Module -Name Hyper-V<br /><strong>Task:</strong><br />Развернуть виртуальную тестовую машину Redos в Hyber-v с помощью Powershell<br /><strong>Decision:</strong><br />PS C:\Windows\system32&gt; Get-VM<br />Name State CPUUsage(%) MemoryAssigned(M) Uptime&nbsp;&nbsp; Status<br />---- ----- ----------- ----------------- ------&nbsp;&nbsp; ------<br />Alt&nbsp; Off&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br />PS C:\Windows\system32&gt; $ram=1*1024*1024*1024<br />PS C:\Windows\system32&gt; $ram<br />1073741824<br />PS C:\Windows\system32&gt; $hdd=10*1024*1024*1024<br />PS C:\Windows\system32&gt; $hdd<br />10737418240<br />PS C:\Windows\system32&gt; NEW-VM -Name Redos -MemoryStartupBytes $ram -NewVHDPath 'C:\Data\VM\Redos\Redos.vhdx'-NewVHD<br />SizeBytes $hdd -Path 'C:\Data\VM\Redos'<br />Name State CPUUsage(%) MemoryAssigned(M) Uptime&nbsp;&nbsp; Status<br />---- ----- ----------- ----------------- ------&nbsp;&nbsp; ------<br />Redos Off&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br />PS C:\Windows\system32&gt; Get-VM<br />Name State CPUUsage(%) MemoryAssigned(M) Uptime&nbsp;&nbsp; Status<br />---- ----- ----------- ----------------- ------&nbsp;&nbsp; ------<br />Alt&nbsp; Off&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br />Redos Off&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br />PS C:\Windows\system32&gt; Start-VM -name Redos<br />PS C:\Windows\system32&gt; Get-VM<br />Name State&nbsp;&nbsp; CPUUsage(%) MemoryAssigned(M) Uptime&nbsp;&nbsp; Status<br />---- -----&nbsp;&nbsp; ----------- ----------------- ------&nbsp;&nbsp; ------<br />Alt&nbsp; Off&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br />Redos Running 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1024&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:16 Работает нормально<br />PS C:\Windows\system32&gt; Stop-VM Redos<br />Подтверждение<br />Hyper-V не удается завершить работу виртуальной машины Redos, так как служба интеграции по завершению работы недоступна.<br />&nbsp;Во избежание потенциальной потери данных вы можете приостановить виртуальную машину или сохранить ее состояние. Другим<br />&nbsp;вариантом является отключение виртуальной машины, но при этом возможна потеря данных.<br />[Y] Да - Y&nbsp; [N] Нет - N&nbsp; [S] Приостановить - S&nbsp; [?] Справка (значением по умолчанию является "Y"): y<br />PS C:\Windows\system32&gt; Get-VM<br />Name State CPUUsage(%) MemoryAssigned(M) Uptime&nbsp;&nbsp; Status<br />---- ----- ----------- ----------------- ------&nbsp;&nbsp; ------<br />Alt&nbsp; Off&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br />Redos Off&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00:00:00 Работает нормально<br /><strong>Task:</strong><br />Установить и настроить дистрибутив Redos в виртуальной машине<br /><strong>Decision:</strong><br />выбираем Install - выбрать размер разделов - поменяем систему разметки LVM на Standart Portition - нажимаем на click here to create them autmaticaly - установщик автоматически разделит диск - уменьшить размер корневого раздела / и раздел /home - Меняю у них размеры - Done - интернет настроить в Network &amp; Host Name - Ethernet переключаем тумблер - Done - software Slection - minmal install- Done - запуск<br /><strong>Task:</strong><br /># dnf -y install kernel-devel-$(uname -r)<br />&nbsp;&nbsp;&nbsp; Last metadata expiration check: 0:52:33 ago on Thu 14 May 2020 03:36:35 AM EDT.<br />&nbsp;&nbsp;&nbsp; No match for argument: kernel-devel-4.18.0-147.el8.x86_64<br />&nbsp;&nbsp;&nbsp; Error: Unable to find a match: kernel-devel-4.18.0-147.el8.x86_64<br /><strong>Decision:</strong><br /># dnf -y install kernel-devel<br /><strong>Task:</strong> &nbsp;<br />Ввод компьютера в домен Windows и изменение имени хоста<br /><strong>Decision:</strong><br /># yum install join-to-domain<br /># join-to-domain.sh<br /># reboot<br /># hostname<br />&nbsp;&nbsp;&nbsp; thost1.tdomain.ru<br /># hostname thost2.tdomain.ru<br /># hostname<br />&nbsp;&nbsp;&nbsp; thost2.tdomain.ru<br /># vim /etc/hostname<br /># cat /etc/hostname<br />&nbsp;&nbsp;&nbsp; thost2.tdomain.ru<br /># vim /etc/hosts<br /># cat /etc/hosts<br />&nbsp;&nbsp;&nbsp; 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4<br />&nbsp;&nbsp;&nbsp; ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6<br />&nbsp;&nbsp;&nbsp; 127.0.0.1 thost2.tdomain.ru thost2<br /><strong>Task:</strong><br />Установка Консультант Плюс и подключение сетевых директорий с использованием automount и механизма Kerberos<br /><strong>Decision:</strong><br />$ yum install wine winetricks<br /># winetricks riched30 winhttp<br />Wine -&gt; Wine Configuration -&gt; Графика -&gt; уберите галочку в пункте "Разрешить менеджеру окон декорировать окна". -&gt; Для запуска &laquo;Консультант Плюс&raquo; на рабочей станции подключите сетевой диск с &laquo;Консультантом&raquo; -&gt; Сделать это можно с помощью подключения сетевых директорий с использованием automount и механизма Kerberos<br />$ smbclient -L thost -k<br />Sharename Type Comment<br />--------- ---- -------<br />Consultant Disk<br />ConsultantR Disk<br />...<br />S Disk<br />Reconnecting with SMB1 for workgroup listing.<br />Server Comment<br />-------- -------<br />Wg M<br />--------- -------<br /># yum install cifs-utils autofs<br />$ klist<br />Ticket cache: FILE:/tmp/krb5cc_1<br />Default principal: tuser@tdomain.RU<br />Valid starting Expires service principal<br />31.08.2020 09:51:47 31.08.2020 19:51:47 krbtgt/tdomain.RU@tdomain.RU<br />renew until 31.08.2020 19:51:47<br /># vim /etc/auto.master<br /># cat /etc/auto.master<br />...<br />/mnt/.thost&nbsp;&nbsp;&nbsp; /etc/auto.samba&nbsp;&nbsp;&nbsp; --ghost<br /># vim /etc/auto.samba<br /># cat /etc/auto.samba<br />Consultant&nbsp;&nbsp;&nbsp; -fstype=cifs,multiuser,cruid=tuser,sec=krb5,domain=tdomain.RU,vers=2.1&nbsp;&nbsp;&nbsp;&nbsp; ://thost/Consultant<br />Students&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -fstype=cifs,multiuser,cruid=tuser,sec=krb5,domain=tdomain.RU,vers=2.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ://thost/Students<br />Для подключения скрытых сетевых каталогов необходимо экранировать символ $<br />Consultant&nbsp;&nbsp;&nbsp; -fstype=cifs,multiuser,cruid=tuser,sec=krb5,domain=tdomain.RU,vers=2.1&nbsp;&nbsp;&nbsp;&nbsp; ://thost/Consultant\$<br />В файле /etc/krb5.conf нужно закомментировать строку (если она ещё не закомментирована)<br />#cat /etc/krb5.conf<br />...<br />default_ccache_name = KEYRING:persistent:%{uid}<br />...<br />#vim/etc/krb5.conf<br />#cat /etc/krb5.conf<br />...<br />default_ccache_name = FILE:/tmp/krb5cc_%{uid}<br />...<br /># systemctl start autofs.service<br /># systemctl enable autofs --now<br />Created symlink from /etc/systemd/system/multi-user.target.wants/autofs.service to /usr/lib/systemd/system/autofs.service.<br /># ls /mnt/.thost/Consultant/<br />... cons.exe ...<br />$ winecfg<br /># wine /mnt/.thost/Сonsultant/cons.exe /linux /yes<br /><strong>Task:</strong><br />Создать ярлык Консультант +<br /><strong>Decision:</strong><br /># vim /home/tuser@thost.ru/Рабочий\ стол/Consultant.desktop<br /># cat /home/tuser@thost.ru/Рабочий\ стол/Consultant.desktop<br />[Desktop Entry]<br />Name=ConsultantPlus<br />Exec=wine /mnt/.thost/Сonsultant/cons.exe<br />Type=Application<br />StartupNotify=true<br />Comment=ConsultantPlus<br />icon=43D4_Cons.0<br />StartupWMClass=c.exe<br /><strong>Task:</strong><br />В случае замедленной работы можно добавить ключ /sprocess=0 При нормальной работе, не добавляйте этот ключ. Ключ /yes необходим для подавления сообщения об ошибке [WNetGetUniversalName ...] : NO_NETWORK<br /><strong>Decision:</strong><br /># ln -s /mnt/.thost/S /home/tuser@thost.ru/Рабочий\ стол/S<br /><strong>Task:</strong><br />Создание ярлыка для сетевой директории<br /><strong>Decision:</strong><br /># ln -s /mnt/.thost/S /home/tuser@thost.ru/Рабочий\ стол/S<br /><strong>Task:</strong><br />После добавления сетевых папок через Kerberos на следующий месяц, все етевые папки на ПК перестали работать. Для решения проблемы нужно обновлять билеты через kdestroy и kinit:<br /><strong>Decision:</strong><br />$ smbclient -L thost -k<br />gse_get_client_auth_token: gss_init_sec_context failed with [ Miscellaneous failure (see text): encryption type 0 not supported](2529639062)<br />gensec_spnego_client_negTokenInit_step: gse_krb5: creating NEG_TOKEN_INIT for cifs/tusertsrvdoc failed (next[(null)]): NT_STATUS_LOGON_FAILURE<br />session setup failed: NT_STATUS_LOGON_FAILURE<br />$ klist<br />Ticket cache: FILE:/tmp/krb5cc_17<br />Default principal: tuser@tdomain.RU<br />Valid starting Expires Service principal<br />01.01.1970 08:00:00 01.01.1970 08:00:00 krbtgt/tdomain.RU@tdomain.RU<br />$ date<br />Вт окт 6 14:46:12 +08 2020<br />$ kdestroy<br />$ kinit<br />$ klist<br />Ticket cache: FILE:/tmp/krb5cc_17<br />Default principal: tuser@tdomain.RU<br />Valid starting Expires Service principal<br />06.10.2020 14:46:51 07.10.2020 00:46:51 krbtgt/tdomain.RU@tdomain.RU<br />renew until 13.10.2020 14:46:29<br /><strong>Decision:</strong><br />Проблема решена, но билет кеширования, нужно было обновлять постоянно. Поэтому, на мой взгляд, проще подключать сетевые папки через automount без Kerberos.<br /><strong>Task:</strong><br />Oграничение доступа к USB накопителям<br /><strong>Decision:</strong><br /># vim /etc/udev/rules.d/99-usb.rules<br /># cat /etc/udev/rules.d/99-usb.rules<br />ENV{ID_USB_DRIVER}=="usb-storage",ENV{UDISKS_IGNORE}="1"<br /># udevadm control --reload-rules<br /><strong>Task:</strong><br />Запрет создания ярлыков и файлов на рабочем столе<br /><strong>Decision:</strong><br />Проверить, поддерживает ли ваша файловая система ACL можно командой (вместо /dev/sda1 указать нужное имя дискового раздела):<br /># tune2fs -l /dev/sda1 | grep "Default mount options:"<br />Default mount options: user_xattr acl<br /># vim /home/tuser@thost.ru/.config/user-dirs.dirs<br /># cat /home/tuser@thost.ru/.config/user-dirs.dirs<br /># This file is written by xdg-user-dirs-update<br /># If you want to change or add directories, just edit the line you're<br /># interested in. All local changes will be retained on the next run<br /># Format is XDG_xxx_DIR="$HOME/yyy", where yyy is a shell-escaped<br /># homedir-relative path, or XDG_xxx_DIR="/yyy", where /yyy is an<br /># absolute path. No other format is supported.<br />#<br />XDG_DESKTOP_DIR="$HOME/Рабочий стол"<br />XDG_DOWNLOAD_DIR="$HOME/Загрузки"<br />XDG_TEMPLATES_DIR="$HOME/Шаблоны"<br />XDG_PUBLICSHARE_DIR="$HOME/Общедоступные"<br />XDG_DOCUMENTS_DIR="$HOME/Документы"<br />XDG_MUSIC_DIR="$HOME/Музыка"<br />XDG_PICTURES_DIR="$HOME/Изображения"<br />XDG_VIDEOS_DIR="$HOME/Видео"<br /># ls -la /home/tuser@thost.ru/.config<br />...<br />-rw-------. 1 tuser &iuml;&icirc;&euml;&uuml;&ccedil;&icirc;&acirc;&agrave;&ograve;&aring;&euml;&egrave; &auml;&icirc;&igrave;&aring;&iacute;&agrave; 714 &agrave;&acirc;&atilde; 31 09:52 user-dirs.dirs<br />-rw-r--r--. 1 tuser &iuml;&icirc;&euml;&uuml;&ccedil;&icirc;&acirc;&agrave;&ograve;&aring;&euml;&egrave; &auml;&icirc;&igrave;&aring;&iacute;&agrave; 5 &agrave;&acirc;&atilde; 31 09:52 user-dirs.locale<br /># chown root:root /home/tuser@thost.ru/.config/user-dirs.dirs<br /># ls -la /home/tuser@thost.ru/.config<br />...<br />-rw-------. 1 root root 714 &agrave;&acirc;&atilde; 31 09:52 user-dirs.dirs<br />-rw-r--r--. 1 tuser &iuml;&icirc;&euml;&uuml;&ccedil;&icirc;&acirc;&agrave;&ograve;&aring;&euml;&egrave; &auml;&icirc;&igrave;&aring;&iacute;&agrave; 5 &agrave;&acirc;&atilde; 31 09:52 user-dirs.locale<br /># ls -la<br />...<br />drwxr-xr-x. 2 tuser &iuml;&icirc;&euml;&uuml;&ccedil;&icirc;&acirc;&agrave;&ograve;&aring;&euml;&egrave; &auml;&icirc;&igrave;&aring;&iacute;&agrave; 4096 &agrave;&acirc;&atilde; 31 09:52 'Рабочий стол'<br />...<br /># chown -R root:root /home/tuser@thost.ru/Рабочий\ стол/<br /># ls -la<br />...<br />drwxr-xr-x. 2 root root 4096 &agrave;&acirc;&atilde; 31 09:52 'Рабочий стол'<br />drwxr-xr-x. 2 tuser &iuml;&icirc;&euml;&uuml;&ccedil;&icirc;&acirc;&agrave;&ograve;&aring;&euml;&egrave; &auml;&icirc;&igrave;&aring;&iacute;&agrave; 4096 &agrave;&acirc;&atilde; 31 09:52 &Oslash;&agrave;&aacute;&euml;&icirc;&iacute;&ucirc;<br /><strong>Task:</strong><br />Как скрыть пользователей от экрана входа<br /><strong>Decision:</strong><br /># cat /var/lib/AccountsService/users/user<br />[User]<br />Language=<br />XSession=<br />SystemAccount=false<br /># vim /var/lib/AccountsService/users/user<br /># cat /var/lib/AccountsService/users/user<br />[User]<br />Language=<br />XSession=gnome<br />SystemAccount=true<br /><strong>Task:</strong><br />Добавление пользователя из доменной сети<br /><strong>Decision:</strong><br />[root@thost user]# vim /var/lib/AccountsService/users/tuser<br />[root@thost user]# cat /var/lib/AccountsService/users/tuser<br />[User]<br />Language=<br />XSession=<br />Icon=/home/tuser@thost.ru/.face<br />SystemAccount=false<br /><strong>Task:</strong><br />отключить сетевые принтеры<br /><strong>Decision:</strong><br /># vim /etc/avahi/avahi-daemon.conf<br />cat /etc/avahi/avahi-daemon.conf<br /># This file is part of avahi.<br />...<br />enable-dbus=no<br />...<br /># reboot<br /><strong>Task:</strong><br />Установка Gimp<br /><strong>Decision:</strong><br />yum provides gimp<br />Загружены модули: fastestmirror, langpacks<br />Loading mirror speeds from cached hostfile<br />2:gimp-2.8.22-2.el7.thost86 : GNU Image Manipulation Program<br />Источник: base<br />2:gimp-2.8.22-2.el7.x86_64 : GNU Image Manipulation Program<br />Источник: base<br /># yum list | grep gimp<br />gimp.thost86 2:2.8.22-2.el7 base<br /># yum -y install gimp<br /><strong>Task:</strong><br />Запись дисков Linux в терминале<br /><strong>Decision:</strong><br /># ls<br />13 'MyTestX Tests'<br /># pwd<br />/home/is@tdomain.RU/Documents<br /># mkisofs -o first.iso /home/is@tdomain.RU/Documents/13<br /># ls<br />13 first.iso 'MyTestX Tests'<br /># mkisofs -l -o first.iso /home/is@tdomain.RU/Documents/13<br /># ls<br />13 first.iso 'MyTestX Tests'<br /># mkisofs -D -l -o first.iso /home/is@tdomain.RU/Documents/13<br /># mkisofs -J -l -o first.iso /home/is@tdomain.RU/Documents/13<br />Warning: creating filesystem with Joliet extensions but without Rock Ridge<br />extensions. It is highly recommended to add Rock Ridge.<br />...<br />Joliet tree sort failed. The -joliet-long switch may help you.<br /># -joliet-long<br /># mkisofs -J -joliet-long -l -o first.iso /home/is@tdomain.RU/Documents/13<br />Warning: creating filesystem with Joliet extensions but without Rock Ridge<br />extensions. It is highly recommended to add Rock Ridge.<br />...<br />99.90% done, estimate finish Fri Jan 15 11:29:00 2021<br />Total translation table size: 0<br />Total rockridge attributes bytes: 0<br />Total directory bytes: 0<br />Path table size(bytes): 10<br />Max brk space used 0<br />545548 extents written (1065 MB# lsblk -d -o +MODEL<br />NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT MODEL<br />sda 8:0 0 111,8G 0 disk KINGSTON SA400S3<br />sr0 11:0 1 2K 0 rom CDDVDW SN-208BB<br />Если вы собираетесь записать образ на диск ubuntu DVD-RW/CD-RW необходимо сначала его очистить:<br />cdrecord -dev=/dev/sr0 -v blank=fast<br /># cd Documents/<br /># ls<br />13 first.iso 'MyTestX Tests'<br />Здесь и ниже /dev/sr0 - адрес файла вашего привода:<br /># cdrecord -dev=/dev/sr0 -speed=16 -eject -v first.iso<br />first.iso - это файл образа, 16 - скорость записи, а опция -eject - заставляет извлечь диск из привода после записи. Можно указывать скорость 4, 8 и 16. Желательно выбирать минимальную скорость, так диск запишется более качественно.<br /><strong>Task:</strong><br />Установка клиента 1С<br /><strong>Decision:</strong><br /># yum -y install webkitgtk3<br /># ls<br />1C_Enterprise83-client-8.3.14-17.x86_64.rpm<br />1C_Enterprise83-common-8.3.14-17.x86_64.rpm<br />1C_Enterprise83-server-8.3.14-17.x86_64.rpm<br /># yum -y install 1C_Enterprise83-*<br /><strong>Task:</strong><br />Установка аналога paint<br /><strong>Decision:</strong><br /># yum list | grep paint<br />kolourpaint.thost86 17.12.1-2.el7 base<br />kolourpaint.x86_64 17.12.1-2.el7 base<br />kolourpaint-libs.thost86 17.12.1-2.el7 base<br />kolourpaint-libs.x86_64 17.12.1-2.el7 base<br /># yum -y install kolourpaint<br /><strong>Task:</strong><br />Настройка оповещения и автоматического обновления пакетов в РЕД ОС с помощью yum-cron<br /><strong>Decision:</strong><br /># yum -y install yum-cron<br /># vim /etc/yum/yum-cron.conf<br /># cat /etc/yum/yum-cron.conf<br />[commands]<br /># What kind of update to use:<br /># default = yum upgrade<br /># security = yum --security upgrade<br /># security-severity:Critical = yum --sec-severity=Critical upgrade<br /># minimal = yum --bugfix update-minimal<br /># minimal-security = yum --security update-minimal<br /># minimal-security-severity:Critical = --sec-severity=Critical update-minimal<br />update_cmd = default<br /># Whether a message should be emitted when updates are available,<br /># were downloaded, or applied.<br />update_messages = yes<br /># Whether updates should be downloaded when they are available.<br />download_updates = yes<br /># Whether updates should be applied when they are available. Note<br /># that download_updates must also be yes for the update to be applied.<br />apply_updates = no<br /># Maximum amout of time to randomly sleep, in minutes. The program<br /># will sleep for a random amount of time between 0 and random_sleep<br /># minutes before running. This is useful for e.g. staggering the<br /># times that multiple systems will access update servers. If<br /># random_sleep is 0 or negative, the program will run immediately.<br /># 6*60 = 360<br />random_sleep = 360<br />...<br /># vim /etc/yum/yum-cron.conf<br /># cat /etc/yum/yum-cron.conf<br />[commands]<br /># What kind of update to use:<br /># default = yum upgrade<br /># security = yum --security upgrade<br /># security-severity:Critical = yum --sec-severity=Critical upgrade<br /># minimal = yum --bugfix update-minimal<br /># minimal-security = yum --security update-minimal<br /># minimal-security-severity:Critical = --sec-severity=Critical update-minimal<br />update_cmd = default<br /># Whether a message should be emitted when updates are available,<br /># were downloaded, or applied.<br />update_messages = yes<br /># Whether updates should be downloaded when they are available.<br />download_updates = yes<br /># Whether updates should be applied when they are available. Note<br /># that download_updates must also be yes for the update to be applied.<br />apply_updates = yes<br /># Maximum amout of time to randomly sleep, in minutes. The program<br /># will sleep for a random amount of time between 0 and random_sleep<br /># minutes before running. This is useful for e.g. staggering the<br /># times that multiple systems will access update servers. If<br /># random_sleep is 0 or negative, the program will run immediately.<br /># 6*60 = 360<br />random_sleep = 360<br />...<br /># systemctl enable yum-cron --now<br /><strong>Task:</strong> &nbsp;<br />Если не требуется обновлять определенные пакеты (как вручную, так и автоматически), то добавляем их в исключение. Например, kernel и php.<br /><strong>Decision:</strong><br />#nano /etc/yum.conf<br />exclude=kernel, php<br /><strong>Task:</strong> &nbsp;<br />Если не требуется обновлять пакеты ТОЛЬКО в автоматическом режиме, тогда в /etc/yum/yum-cron.conf , в раздел [base], добавляем следующую строку:<br />Decision<br /># nano /etc/yum/yum-cron.conf<br />exclude=kernel* php*<br /><strong>Task:</strong><br />Установка Anydesk<br /><strong>Decision:</strong><br /># tee /etc/yum.repos.d/AnyDesk-RHEL.repo &lt;&lt;EOF<br />&gt; [anydesk]<br />&gt; name=AnyDesk RHEL - stable<br />&gt; baseurl=http://rpm.anydesk.com/rhel/\$basearch/<br />&gt; gpgcheck=1<br />&gt; repo_gpgcheck=1<br />&gt; gpgkey=https://keys.anydesk.com/repos/RPM-GPG-KEY<br />&gt; EOF<br /># dnf makecache<br /># dnf install -y redhat-lsb-core<br /># dnf install anydesk<br /># rpm -qi anydesk<br /># systemctl status anydesk.service<br /># exit<br />$ anydesk<br /><strong>Task:</strong><br />Создание загрузочных носителей<br /><strong>Decision:</strong><br /># fdisk -l<br />...<br />Диск /dev/sdb: 3,61 GiB, 3880452096 байт, 7579008 секторов<br />Disk model: Silicon-Power4G<br />Единицы: секторов по 1 * 512 = 512 байт<br />Размер сектора (логический/физический): 512 байт / 512 байт<br />Размер I/O (минимальный/оптимальный): 512 байт / 512 байт<br />Тип метки диска: gpt<br />Идентификатор диска: 2BAC44AA-F36D-461C-B12A-D251E7E9373F<br />Устр-во&nbsp;&nbsp;&nbsp; начало&nbsp;&nbsp; Конец Секторы Размер Тип<br />/dev/sdb1&nbsp;&nbsp;&nbsp; 2048 7578974 7576927&nbsp;&nbsp; 3,6G Microsoft basic data<br /># ls<br />Zorin-OS-16.1-Core-64-bit.iso<br /># dd if=Zorin-OS-16.1-Core-64-bit.iso of=/dev/sdb1 bs=8MB status=progress oflag=direct<br />3058237440 байт (3,1 GB, 2,8 GiB) скопирован, 659 s, 4,6 MB/s<br />382+1 записей получено<br />382+1 записей отправлено<br />3058237440 байт (3,1 GB, 2,8 GiB) скопирован, 659,39 s, 4,6 MB/s<br /><strong>Task:</strong><br />Развернуть Pxe сервер для развертывания Redos с загрузкой в Uefi по сети<br /><strong>Decision:</strong><br /># ifconfig<br />enp2s0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;&nbsp; mtu 1500<br />&nbsp;&nbsp;&nbsp; inet IpAddr1&nbsp; netmask Mask1&nbsp; broadcast IpAddr.255<br />&nbsp;&nbsp; &nbsp;...<br /># dnf install dhcp tftp-server syslinux httpd dnf-plugins-core -y<br /># mkdir /var/lib/tftpboot/pxelinux.cfg<br /># mkdir /var/lib/tftpboot/uefi<br /># mkdir -p /var/lib/tftpboot/images/REDOS<br /># cp /usr/share/syslinux/{chain.c32,mboot.c32,memdisk,menu.c32,pxelinux.0,ldlinux.c32,libutil.c32} /var/lib/tftpboot/<br /># chmod 777 /var/lib/tftpboot/pxelinux.0<br /># dnf download shim-x64 grub2-efi-x64 --downloaddir=/root/<br /># cd /root/<br /># rpm2cpio shim-x64-*.rpm | cpio -dimv<br /># rpm2cpio grub2-efi-x64-*.rpm | cpio -dimv<br /># cp ./boot/efi/EFI/BOOT/BOOTX64.EFI /var/lib/tftpboot/uefi<br /># cp ./boot/efi/EFI/redos/grubx64.efi /var/lib/tftpboot/uefi<br /># chmod 777 /var/lib/tftpboot/uefi/*.*<br /># mount -t iso9660 -o loop redos-MUROM-7.3.2-20211027.0-Everything-x86_64-DVD1.iso /mnt/<br /># cp -vR /mnt/* /var/lib/tftpboot/images/REDOS/<br /># umount /mnt/<br /># vim /etc/dhcp/dhcpd.conf<br /># cat /etc/dhcp/dhcpd.conf<br />non-authoritative;<br />allow bootp;<br />option space pxelinux;<br />option pxelinux.magic code 208 = string;<br />option pxelinux.configfile code 209 = text;<br />option pxelinux.pathprefix code 210 = text;<br />option pxelinux.reboottime code 211 = unsigned integer 32;<br />option architecture-type code 93 = unsigned integer 16;<br />subnet IpAddr.0 netmask Mask1 {<br />option routers IpAddr1;<br />range IpAddr.70 IpAddr.80;<br />class "pxeclients" {<br />match if substring (option vendor-class-identifier, 0, 9) = "PXEClient";<br />next-server IpAddr1;<br />if option architecture-type = 00:07 {<br />filename "uefi/grubx64.efi";<br />} <br />else {<br />filename "pxelinux.0";<br />}<br />}<br />} <br /># systemctl enable dhcpd --now<br /># vim /var/lib/tftpboot/pxelinux.cfg/default<br /># cat /var/lib/tftpboot/pxelinux.cfg/default<br />default menu.c32<br />PROMPT 0<br />TIMEOUT 150<br />MENU TITLE PXE Menu<br />LABEL REDOS 7.3<br />MENU LABEL REDOS 7.3<br />KERNEL images/REDOS/images/pxeboot/vmlinuz<br />APPEND initrd=images/REDOS/images/pxeboot/initrd.img ramdisk_size=128000 ip=dhcp inst.repo=http://IpAddr1/images/REDOS/ <br /># vim /var/lib/tftpboot/uefi/grub.cfg <br /># cat /var/lib/tftpboot/uefi/grub.cfg <br />function load_video { <br />insmod efi_gop &nbsp;<br />insmod efi_uga <br />insmod video_bochs <br />insmod video_cirrus <br />insmod all_video <br />} <br />load_video <br />set gfxpayload=keep <br />insmod gzio <br />menuentry 'REDOS 7.3' { <br />linux images/REDOS/images/pxeboot/vmlinuz ip=dhcp inst.repo=http://IpAddr1/images/REDOS/ <br />initrd images/REDOS/images/pxeboot/initrd.img <br />} <br /><strong>Task:</strong><br />Используем web-сервер для публикации файлов дистрибутива РЕД ОС в локальной сети.<br /><strong>Decision:</strong><br /># vim /etc/httpd/conf.d/pxeboot.conf <br /># cat /etc/httpd/conf.d/pxeboot.conf <br />Alias /images /var/lib/tftpboot/images <br />&lt;Directory /var/lib/tftpboot/images&gt; <br />Options Indexes FollowSymLinks <br />Require ip 127.0.0.1 IpAddr.0/24 <br />&lt;/Directory&gt;<br /># systemctl enable httpd --now<br /><strong>Task:</strong><br />Настройка и запуск службы tftp.<br /><strong>Decision:</strong><br /># vim /usr/lib/systemd/system/tftp.service<br /># cat /usr/lib/systemd/system/tftp.service<br />...<br />[Install]:<br />WantedBy=multi-user.target <br />Also=tftp.socket<br />...<br /># vim /usr/lib/systemd/system/tftp.socket<br /># cat /usr/lib/systemd/system/tftp.socket<br />...<br />[Unit] <br />Description=Tftp Server Activation Socket <br />[Socket] <br />ListenDatagram=0.0.0.0:69 <br />[Install] <br />WantedBy=sockets.target <br />...<br /># systemctl daemon-reload<br /># systemctl enable tftp --now<br /># ausearch -c 'httpd' --raw | audit2allow -M my-httpd<br /># semodule -i my-httpd.pp<br /><strong>Task:</strong><br />Автоматизация развертывания (kickstart)<br />Создать файл кикстарта, Записать файл на локальный или удаленный носитель, Создать загрузочный диск, с которого будет запускаться установка, Предоставить доступ к установочной структуре, Начать процесс установки.<br /><strong>Decision:</strong><br /># dnf install pykickstart -y<br /># cp /root/anaconda-ks.cfg /var/lib/tftpboot<br /># mv /var/lib/tftpboot/anaconda-ks.cfg /var/lib/tftpboot/ks.cfg<br /># vim /var/lib/tftpboot/pxelinux.cfg/default<br /># cat /var/lib/tftpboot/pxelinux.cfg/default<br />...<br />APPEND initrd=images/REDOS/images/pxeboot/initrd.img ramdisk_size=128000 ip=dhcp method=http://IpAddr1/images/REDOS/ devfs=nomount inst.ks=http://IpAddr1/ks.cfg <br /># vim /var/lib/tftpboot/uefi/grub.cfg<br /># cat /var/lib/tftpboot/uefi/grub.cfg<br />... { <br />linux images/REDOS/images/pxeboot/vmlinuz ip=dhcp kernel vmlinuz inst.repo=http://IpAddr1/images/REDOS/ inst.ks=http://IpAddr1/ks.cfg <br />initrd images/REDOS/images/pxeboot/initrd.img<br />} <br /># vim /var/lib/tftpboot/ks.cfg<br /># cat /var/lib/tftpboot/ks.cfg<br /># Здесь указываем раскладку клавиатуры<br />keyboard --vckeymap=us --xlayouts='us','ru' --switch='grp:alt_shift_toggle'<br /># Системная локаль<br />lang ru_RU.UTF-8<br /># Информация о сетевом интерфейсе и имя машины<br />network&nbsp; --bootproto=dhcp --device=enp2s0 --noipv6 --activate<br />network&nbsp; --hostname=hostname1337<br /># Пароль Root представлен в виде хэш-суммы<br />rootpw --iscrypted $6$DUu0yyOYMRbGS8gL$9zHYPsxROGEZdDKG0wnf7h8SGnKOp3V272De6oGTVUsz2uBLmEeiR6T6cInRN5dyWcxNXh5fVluEUTQ/3rmzB0<br /># Настройка сервисов (в данном случае сервис по обновлению меток времени и дат)<br />services --enabled="chronyd"<br /># Настройка временной зоны<br />timezone Europe/Moscow --isUtc<br />#Настройка локального пользователя<br />user --groups=wheel --name=mekka --password=$6$83fyYZ7KMS7G9t6A$E5/99/ffOwjUOo8THr1ngqGDdKMimpTZf3IT9S/SI98BTV7dta7GksLYnQEZjtqqyZQrwibSRlvYccRqHB7m8/ --iscrypted --gecos="Mekka"<br /># Настройка xorg при загрузке<br />xconfig&nbsp; --startxonboot<br /># Указание загрузочного сектора и тип структуры<br />bootloader --location=mbr --boot-drive=sda<br /># Удаление всей информации с партиций для последующей установки<br />clearpart --none --initlabel<br /># Здесь указана вся разметка диска<br />part /boot --fstype="xfs" --onpart=sda2<br />part biosboot --fstype="biosboot" --noformat --onpart=sda4<br />part pv.31 --fstype="lvmpv" --noformat --onpart=sda3<br />part /boot/efi --fstype="efi" --onpart=sda1 --fsoptions="umask=0077,shortname=winnt"<br />volgroup ro --noformat --useexisting<br />logvol swap&nbsp; --fstype="swap" --useexisting --name=swap --vgname=ro<br />logvol /home&nbsp; --fstype="xfs" --noformat --useexisting --name=home --vgname=ro<br />logvol /&nbsp; --fstype="ext4" --useexisting --name=root --vgname=ro<br />#дополнительные пакеты для установки<br />%packages<br />@^mate-desktop-environment<br />@backup-client<br />@base<br />@branding<br />@core<br />@desktop-debugging<br />@dial-up<br />@directory-client<br />@fonts<br />@guest-agents<br />@guest-desktop-agents<br />@input-methods<br />@internet-applications<br />@internet-browser<br />@java-platform<br />@mate-desktop<br />@multimedia<br />@network-file-system-client<br />@print-client<br />@x11<br />chrony<br />%end<br />#настройка аварийных дампов памяти в случае сбоев (оставить как есть)<br />%addon com_redhat_kdump --enable --reserve-mb='auto'<br />%end<br />#настройка анаконды (оставить как есть)<br />%anaconda<br />pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty<br />pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok<br />pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty<br />%end<br /><strong>Task:</strong><br />Настройка установки РЕД ОС по PXE через VNC вместо Kickstart<br /><strong>Decision:</strong><br /># vim /var/lib/tftpboot/pxelinux.cfg/default<br /># cat /var/lib/tftpboot/pxelinux.cfg/default<br />...<br />APPEND initrd=images/REDOS/images/pxeboot/initrd.img ramdisk_size=128000 ip=dhcp method=http://IpAddr1/images/REDOS/ devfs=nomount inst.vnc inst.vncpassword=tpassword<br /># vim /var/lib/tftpboot/uefi/grub.cfg<br /># cat /var/lib/tftpboot/uefi/grub.cfg<br />... { <br />linux images/REDOS/images/pxeboot/vmlinuz ip=dhcp kernel vmlinuz inst.repo=http://IpAddr1/images/REDOS/ inst.vnc inst.vncpassword=tpassword<br />initrd images/REDOS/images/pxeboot/initrd.img<br />}<br /><strong>Task:</strong><br />Ошибка после установки REDOS в Virtualbox<br />"Упс, что то пошло не так"<br /><strong>Decision:</strong><br /># su<br /># systemctl disable gdm<br /># systemctl enable sddm<br /># reboot</p><strong>Source:</strong></p>
                        <ul>
                        <li><a href="https://redos.red-soft.ru/base/other-soft/other-other/consultant/?sphrase_id=53349">https://redos.red-soft.ru/base/other-soft/other-other/consultant/?sphrase_id=53349</a></li>
                        <li><a href="https://wtuseri.astralinuthost.ru/pages/viewpage.action?pageId=61574227">https://wtuseri.astralinuthost.ru/pages/viewpage.action?pageId=61574227</a></li>
                        <li><a href="https://askubuntu.ru/questions/21203/kak-skry-t-pol-zovatelej-ot-e-krana-vxoda-v-gdm">https://askubuntu.ru/questions/21203/kak-skry-t-pol-zovatelej-ot-e-krana-vxoda-v-gdm</a></li>
                        <li><a href="https://computingforgeeks.com/how-to-install-gimp-on-centos-rhel-8-desktop/">https://computingforgeeks.com/how-to-install-gimp-on-centos-rhel-8-desktop/</a></li>
                        <li><a href="https://ru.wtuserihow.com/%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D1%82%D1%8C-ISO-%D1%84%D0%B0%D0%B9%D0%BB-%D0%B2-Linux">https://ru.wtuserihow.com/%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D1%82%D1%8C-ISO-%D1%84%D0%B0%D0%B9%D0%BB-%D0%B2-Linux</a></li>
                        <li><a href="https://losst.ru/zapis-diskov-v-ubuntu">https://losst.ru/zapis-diskov-v-ubuntu</a></li>
                        <li><a href="https://losst.ru/luchshie-analogi-paint-dlya-linux">https://losst.ru/luchshie-analogi-paint-dlya-linux</a></li>
                        <li><a href="https://computingforgeeks.com/how-to-install-anydesk-on-centos-rhel-8/">https://computingforgeeks.com/how-to-install-anydesk-on-centos-rhel-8/</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Разработка программ, которые анализируют, обрабатывают и сортируют код на сайте организации</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Разработал программы, которые анализируют, обрабатывают и сортируют код на сайте организации. Это позволило мне ускорить процесс корректировки тегов на сайте по запросу Россобрнадзор<br /><strong>Task:</strong><br />проверить все страницы на сайте, на отсутствие pdf файлов больше 15 Мб.<br /><strong>Decision:</strong><br />$ wget https://tsite.ru/sveden/document<br />--2018-11-01 20:12:20--&nbsp; https://tsite.ru/sveden/document<br />Распознаётся tsite.ru (tsite.ru)&hellip; IpAddr<br />Подключение к tsite.ru (tsite.ru)|IpAddr|:443... соединение установлено.<br />ОШИБКА: Нет доверия сертификату для &laquo;tsite.ru&raquo;.<br />ОШИБКА: Неизвестный издатель сертификата &laquo;tsite.ru&raquo;.<br />$ wget --no-check-certificate -r -l 1 -A pdf https://tsite.ru/sveden/document<br />$ vim bash-FileWeight.sh<br />$ chmod +x bash-FileWeight.sh<br />$ cat bash-FileWeight.sh<br />#!/bin/bash<br />echo -n "Enter a link to the site: "<br />read linksite<br />user=$(whoami)<br />echo -n "Come up with a name for the directory where the files will be written: "<br />read linkfiles<br />if [ -d /home/$user/$linkfiles ]; then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rm -rf /home/$user/$linkfiles<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "/home/$user/$filename delete"<br />else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mkdir /home/$user/$linkfiles<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cd /home/$user/$linkfiles<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo "/home/$user/$linkfiles create"<br />fi<br />wget --no-check-certificate -r -l 1 -A pdf $linksite<br />find /home/$user/$linkfiles -size +15M &gt; output<br />$ ./bash-FileWeight.sh<br />Enter a link to the site: https://tsite.ru/sveden/document<br />Come up with a name for the directory where the files will be written: tdir<br />/home/tUser/tdir create<br />...<br />$ cat /home/tUser/tdir/output<br />/home/tUser/tdir/tsite.ru/Media/irk/Документы института/2018/tDoc1.pdf<br />$ ls -l /home/tUser/tdir/tsite.ru/Media/irk/Документы\ института/2018/tDoc1.pdf <br />-rw-r--r--. 1 tUser tUser 20055320 июн 30&nbsp; 2018 '/home/tUser/tdir/tsite.ru/Media/irk/Документы института/2018/tDoc1.pdf'<br /><strong>Task:</strong><br />Отсортировать html-код страницы по атрибутам tr, td <br /><strong>Decision:</strong><br /><strong>Task:</strong><br />Поменять/добавить тег на странице с таблицей. В некоторых строках тег отсутствует<br /><strong>Decision:</strong><br /><strong>Source:</strong></p>
                        <ul>
                        <li><a href="https://stackoverflow.com/questions/4846007/check-if-directory-exists-and-delete-in-one-command-unix">https://stackoverflow.com/questions/4846007/check-if-directory-exists-and-delete-in-one-command-unix</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Утилита для сканирования безопасности сети Nmap</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты выпускной квалификационной работы по теме "Утилита для сканирования безопасности сети Nmap" проанализировал состояние виртуальных машин в Qemu-Kvm инструментом Nmap. Дополнительно для перехвата трафиков использовал Tcpdump. Для того чтобы обезопасить свои системы, настроил правила в Iptables и развернул антируткит, который по определенному раписанию выгружал отчет о состоянии системы. В курсовой работе своил навыки по следующим инструментам: Qemu-Kvm, Virtualbox, Linux, Ssh, Iptables, Nmap, Bash, Vsftpd, Telnet, Nginx, Squid, Tcpdump, Icmp, Tripwire, Rkhunter, Crontab<br /><strong>Task:</strong><br />У руководителя уже установлена тестовая система Centos в машине Qemu-Kvm. Наша первая задача скоипровать у него систему <br /><strong>Decision:</strong><br />$ sudo virsh list --all<br />&nbsp;ID&nbsp;&nbsp; Имя&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Состояние<br />-------------------------------<br />&nbsp;2&nbsp;&nbsp;&nbsp; Centos9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; работает<br />&nbsp;-&nbsp;&nbsp;&nbsp; Alt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; выключен<br />&nbsp;-&nbsp;&nbsp;&nbsp; Centos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; выключен<br />&nbsp;-&nbsp;&nbsp;&nbsp; Kali&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; выключен<br />&nbsp;-&nbsp;&nbsp;&nbsp; ubuntu22.04&nbsp;&nbsp; выключен<br />&nbsp;-&nbsp;&nbsp;&nbsp; Windows&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; выключен<br />$ sudo virsh shutdown Centos9<br />$ sudo virsh domblklist Centos9<br />&nbsp;Назначение&nbsp;&nbsp; Источник<br />---------------------------------------------------<br />&nbsp;vda&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /images/Centos9.img<br />&nbsp;sda&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -<br />$ rsync -avzP user@IpAddrCentos:/images/Centos9.img Centos/.<br />$ sudo virsh dumpxml Centos9 &gt; Centos9.xml<br />$ head Centos9.xml<br />&lt;domain type='kvm'&gt;<br />&nbsp; &lt;name&gt;Centos9&lt;/name&gt;<br />&nbsp; &lt;uuid&gt;8cdbcba9-a955-4ca1-b75e-ab3145255c8d&lt;/uuid&gt;<br />&nbsp; &lt;metadata&gt;<br />&nbsp;&nbsp;&nbsp; &lt;libosinfo:libosinfo xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0"&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;libosinfo:os id="http://centos.org/centos-stream/9"/&gt;<br />&nbsp;&nbsp;&nbsp; &lt;/libosinfo:libosinfo&gt;<br />&nbsp; &lt;/metadata&gt;<br />&nbsp; &lt;memory unit='KiB'&gt;2097152&lt;/memory&gt;<br />&nbsp; &lt;currentMemory unit='KiB'&gt;2097152&lt;/currentMemory&gt;<br />$ sudo head /etc/libvirt/qemu/Centos9.xml<br />&lt;!--<br />WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br />OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br />&nbsp; virsh edit Centos9<br />or other application using the libvirt API.<br />--&gt;<br />&lt;domain type='kvm'&gt;<br />&nbsp; &lt;name&gt;Centos9&lt;/name&gt;<br />&nbsp; &lt;uuid&gt;8cdbcba9-a955-4ca1-b75e-ab3145255c8d&lt;/uuid&gt;<br />$ sudo qemu-img info Centos9.img<br />image: Centos9.img<br />file format: qcow2<br />virtual size: 50 GiB (53687091200 bytes)<br />disk size: 50 GiB<br />cluster_size: 65536<br />Snapshot list:<br />ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TAG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VM SIZE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DATE&nbsp;&nbsp;&nbsp;&nbsp; VM CLOCK&nbsp;&nbsp;&nbsp;&nbsp; ICOUNT<br />1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; snapshot1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 B 2023-09-28 13:18:14 00:00:00.000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />Format specific information:<br />&nbsp;&nbsp;&nbsp; compat: 1.1<br />&nbsp;&nbsp;&nbsp; compression type: zlib<br />&nbsp;&nbsp;&nbsp; lazy refcounts: true<br />&nbsp;&nbsp;&nbsp; refcount bits: 16<br />&nbsp;&nbsp;&nbsp; corrupt: false<br />&nbsp;&nbsp;&nbsp; extended l2: false<br />Child node '/file':<br />&nbsp;&nbsp;&nbsp; filename: Centos9.img<br />&nbsp;&nbsp;&nbsp; protocol type: file<br />&nbsp;&nbsp;&nbsp; file length: 50 GiB (53695545344 bytes)<br />&nbsp;&nbsp;&nbsp; disk size: 50 GiB<br />$ sudo qemu-img convert Centos9.img tmp.bin -p<br />$ VBoxManage convertdd tmp.bin virtualbox.vdi<br />$ VBoxManage modifyvdi virtualbox.vdi compact<br /><strong>Task:</strong><br />Работа с iptables. <br />Проверяем наличие пакета iptables. <br />Убедимся, что iptables запускается при старте системы. <br />Выводим список текущих правил iptables.<br />проанализируем какие порты открыты в сервере Centos. <br />Для этого нужно подключиться с сервера ubuntu.<br /><strong>Decision:</strong><br />$ virsh start Centos9<br />$ virsh start ubuntu22.04<br />$ ssh -X user@IpAddrCentos<br />$ sudo su<br />[root@centos user]# yum install iptables-services<br />[root@centos user]# iptables --version<br />[root@centos user]# iptables -L -v<br />Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br />&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)<br />&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br />&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination <br />[root@centos user]# systemctl start iptables<br />[root@centos user]# systemctl enable iptables<br />[root@centos user]# service iptables status<br />$ ssh -X user@IpAddrUbuntu<br />user@ubuntu:~$ nmap IpAddrCentos<br />Starting Nmap 7.80 ( https://nmap.org ) at 2023-10-17 08:33 CDT<br />Nmap scan report for centos (IpAddrCentos)<br />Host is up (0.00089s latency).<br />Not shown: 999 filtered ports<br />PORT&nbsp;&nbsp; STATE SERVICE<br />22/tcp open&nbsp; ssh<br />MAC Address: MacAddrCentos (QEMU virtual NIC)<br />Nmap done: 1 IP address (1 host up) scanned in 5.30 seconds<br /><strong>Task:</strong><br />В сервере Centos Напишем набор правил iptables, в котором мы разрешаем все исходящие соединения и строго ограничиваем входящие. <br />Доступ будет возможен по портам TCP: 21, 22, 25, 53, 80, 143, 443, по портам UDP: 20, 21, 53, также мы пропускаем пакеты для уже установленных соединений.<br />С удаленной машины просканируем порты на нашем сервере.<br /><strong>Decision:</strong><br />[root@centos user]# vim firewall.sh<br />[root@centos user]# cat firewall.sh<br />#!/bin/bash<br />IPT="/sbin/iptables"<br /># Очищаем правила и удаляем цепочки.<br />$IPT -F<br />$IPT -X<br /># По умолчанию доступ запрещен.<br />$IPT -P INPUT DROP<br />$IPT -P FORWARD DROP<br />$IPT -P OUTPUT DROP<br /># Список разрешенных TCP и UDP портов.<br />TCP_PORTS="21,22,25,53,80,143,443"<br />UDP_PORTS="53,21,20"<br /># Разрешаем пакеты для интерфейса обратной петли.<br />$IPT -A INPUT -i lo -j ACCEPT<br />$IPT -A OUTPUT -o lo -j ACCEPT<br /># Разрешаем пакеты для установленных соединений.<br />$IPT -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT<br /># Разрешаем исходящие соединения.<br />$IPT -A OUTPUT -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT<br /># Разрешаем доступ к портам, описанным в переменных TCP_PORTS и UDP_PORTS.<br />$IPT -A INPUT -p tcp -m multiport --dport $TCP_PORTS -j ACCEPT<br />$IPT -A INPUT -p udp -m multiport --dport $UDP_PORTS -j ACCEPT<br /># Разрешаем исходящий ping.<br />$IPT -A INPUT -p icmp -m icmp --icmp-type echo-reply -j ACCEPT<br />[root@centos user]# chmod +x firewall.sh<br />[root@centos user]# ./firewall.sh<br />[root@centos user]# iptables -L -v<br />Chain INPUT (policy DROP 1986 packets, 87384 bytes)<br />&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; --&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; 79&nbsp; 5604 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; --&nbsp; any&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state RELATED,ESTABLISHED<br />&nbsp;&nbsp;&nbsp; 9&nbsp;&nbsp; 396 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; tcp&nbsp; --&nbsp; any&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; multiport dports ftp,ssh,smtp,domain,http,imap,https<br />&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; udp&nbsp; --&nbsp; any&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; multiport dports domain,ftp,ftp-data<br />&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; icmp --&nbsp; any&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; icmp echo-reply<br />Chain FORWARD (policy DROP 0 packets, 0 bytes)<br />&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />Chain OUTPUT (policy DROP 0 packets, 0 bytes)<br />&nbsp;pkts bytes target&nbsp;&nbsp;&nbsp;&nbsp; prot opt in&nbsp;&nbsp;&nbsp;&nbsp; out&nbsp;&nbsp;&nbsp;&nbsp; source&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; destination&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; --&nbsp; any&nbsp;&nbsp;&nbsp; lo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; 60&nbsp; 7920 ACCEPT&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp; --&nbsp; any&nbsp;&nbsp;&nbsp; any&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; state NEW,RELATED,ESTABLISHED<br />[root@centos user]# service iptables save<br />user@ubuntu:~$ nmap IpAddrCentos<br />Starting Nmap 7.80 ( https://nmap.org ) at 2023-10-17 08:37 CDT<br />Nmap scan report for centos (IpAddrCentos)<br />Host is up (0.00095s latency).<br />Not shown: 993 filtered ports<br />PORT&nbsp;&nbsp;&nbsp; STATE&nbsp; SERVICE<br />21/tcp&nbsp; closed ftp<br />22/tcp&nbsp; open&nbsp;&nbsp; ssh<br />25/tcp&nbsp; closed smtp<br />53/tcp&nbsp; closed domain<br />80/tcp&nbsp; closed http<br />143/tcp closed imap<br />443/tcp closed https<br />MAC Address: MacAddrCentos (QEMU virtual NIC)<br />Nmap done: 1 IP address (1 host up) scanned in 5.20 seconds<br /><strong>Task:</strong><br />Если сетевых интерфейсов два или более, то необходимо включить перенаправление трафика и перечитать конфигурационный файл<br /><strong>Decision:</strong><br />[root@centos user]# vim /etc/sysctl.conf<br />[root@centos user]# cat /etc/sysctl.conf<br />...<br />net.ipv4.ip_forward = 1<br />[root@centos user]# sysctl -p /etc/sysctl.conf<br />net.ipv4.ip_forward = 1<br /><strong>Task:</strong><br />Install and configure an FTP server. Securing the connection to the FTP server.<br /><strong>Decision:</strong><br />[root@centos user]# dnf update -y<br />[root@centos user]# dnf install vsftpd -y<br />[root@centos user]# systemctl enable vsftpd --now<br />[root@centos user]# systemctl status vsftpd<br />user@ubuntu:~$ nmap IpAddrCentos<br />Starting Nmap 7.80 ( https://nmap.org ) at 2023-10-18 07:41 CDT<br />Nmap scan report for IpAddrCentos<br />Host is up (0.0012s latency).<br />Not shown: 993 filtered ports<br />PORT&nbsp;&nbsp;&nbsp; STATE&nbsp; SERVICE<br />21/tcp&nbsp; open&nbsp;&nbsp; ftp<br />22/tcp&nbsp; open&nbsp;&nbsp; ssh<br />25/tcp&nbsp; closed smtp<br />53/tcp&nbsp; closed domain<br />80/tcp&nbsp; closed http<br />143/tcp closed imap<br />443/tcp closed https<br />MAC Address: MacAddrCentos (QEMU virtual NIC)<br />Nmap done: 1 IP address (1 host up) scanned in 5.80 seconds<br />[root@centos user]# useradd -m -d "/home/ftpuser" ftpuser<br />[root@centos user]# passwd ftpuser<br />[root@centos user]# mkdir -p /home/ftpuser/shared<br />[root@centos user]# chmod -R 750 /home/ftpuser/shared<br />[root@centos user]# chown ftpuser: /home/ftpuser/shared<br />[root@centos user]# vim /etc/vsftpd/user_list<br />[root@centos user]# cat /etc/vsftpd/user_list | grep ftp<br />ftpuser<br />[root@centos user]# vim /etc/vsftpd/vsftpd.conf<br />[root@centos user]# cat /etc/vsftpd/vsftpd.conf<br />...<br />anonymous_enable=NO<br />...<br />local_enable=YES<br />...<br />write_enable=YES<br />...<br />chroot_local_user=YES<br />...<br />allow_writeable_chroot=YES<br />pasv_min_port=31500<br />pasv_max_port=32500<br />userlist_file=/etc/vsftpd/user_list<br />userlist_deny=NO<br />[root@centos user]# systemctl restart vsftpd<br />[root@centos user]# openssl req -x509 -nodes -days 3650 \<br />-newkey rsa:2048 -keyout /etc/vsftpd.pem \<br />-out /etc/vsftpd/vsftpd.pem<br />[root@centos user]# vim /etc/vsftpd/vsftpd.conf<br />[root@centos user]# cat /etc/vsftpd/vsftpd.conf<br />...<br />#rsa_cert_file=/etc/vsftpd/vsftpd.pem<br />#rsa_private_key_file=/etc/vsftpd.pem<br />#ssl_enable=YES<br />[root@centos user]# systemctl restart vsftpd<br />[root@centos user]# cat /etc/sysconfig/iptables<br /># Generated by iptables-save v1.8.8 (nf_tables) on Sun Oct 22 12:10:33 2023<br />*mangle<br />:PREROUTING ACCEPT [45:3316]<br />:INPUT ACCEPT [45:3316]<br />:FORWARD ACCEPT [0:0]<br />:OUTPUT ACCEPT [34:5048]<br />:POSTROUTING ACCEPT [34:5048]<br />COMMIT<br /># Completed on Sun Oct 22 12:10:33 2023<br /># Generated by iptables-save v1.8.8 (nf_tables) on Sun Oct 22 12:10:33 2023<br />*raw<br />:PREROUTING ACCEPT [45:3316]<br />:OUTPUT ACCEPT [34:5048]<br />COMMIT<br /># Completed on Sun Oct 22 12:10:33 2023<br /># Generated by iptables-save v1.8.8 (nf_tables) on Sun Oct 22 12:10:33 2023<br />*filter<br />:INPUT DROP [0:0]<br />:FORWARD DROP [0:0]<br />:OUTPUT DROP [0:0]<br />-A INPUT -i lo -j ACCEPT<br />-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT<br />-A INPUT -p tcp -m multiport --dports 21,22,25,53,80,143,443 -j ACCEPT<br />-A INPUT -p udp -m multiport --dports 53,21,20 -j ACCEPT<br />-A INPUT -p icmp -m icmp --icmp-type 0 -j ACCEPT<br />-A OUTPUT -o lo -j ACCEPT<br />-A OUTPUT -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<br />COMMIT<br /># Completed on Sun Oct 22 12:10:33 2023<br /># Generated by iptables-save v1.8.8 (nf_tables) on Sun Oct 22 12:10:33 2023<br />*nat<br />:PREROUTING ACCEPT [0:0]<br />:INPUT ACCEPT [0:0]<br />:OUTPUT ACCEPT [0:0]<br />:POSTROUTING ACCEPT [0:0]<br />COMMIT<br /># Completed on Sun Oct 22 12:10:33 2023<br />[root@centos user]# iptables -t filter -A INPUT -p tcp --dport 20:21 -j ACCEPT<br />[root@centos user]# iptables -t filter -A INPUT -p tcp --dport 31500:32500 -j ACCEPT<br />[root@centos user]# service iptables save<br />[root@centos user]# systemctl restart iptables<br />user@ubuntu:~$ telnet IpAddrCentos 21<br />Trying IpAddrCentos...<br />Connected to IpAddrCentos.<br />Escape character is '^]'.<br />220 (vsFTPd 3.0.5)<br />USER ftpuser<br />331 Please specify the password.<br />PASS tpassword<br />230 Login successful.<br />PWD<br />257 "/" is the current directory<br />PASV<br />227 Entering Passive Mode (I,P,126,61).<br />user@ubuntu:~$ 126*256+61<br />32317<br />user@ubuntu:~$ telnet IpAddrCentos 32317<br />Trying IpAddrCentos...<br />Connected to IpAddrCentos.<br />Escape character is '^]'.<br />LIST<br />150 Here comes the directory listing.<br />226 Directory send OK.<br />drwxr-x---&nbsp;&nbsp;&nbsp; 2 1001&nbsp;&nbsp;&nbsp;&nbsp; 1001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6 Oct 21 03:06 shared<br />QUIT<br />221 Goodbye.<br /><strong>Task:</strong><br />Запрещаем доступ к фтп всем пользователям, кроме пользователя с MAC-адресом MacAddrUbuntu.<br /><strong>Decision:</strong><br />[root@centos user]# iptables -I INPUT -p tcp --dport 21 -m mac ! --mac-source MacAddrUbuntu -j REJECT<br />[root@centos user]# service iptables save<br />[root@centos user]# systemctl restart iptables<br />user@ubuntu:~$ ifconfig | grep MacAddrUbuntu<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ether MacAddrUbuntu&nbsp; txqueuelen 1000&nbsp; (Ethernet)<br />user@ubuntu:~$ ftp IpAddrCentos<br />Connected to IpAddrCentos.<br />220 (vsFTPd 3.0.5)<br />Name (IpAddrCentos:user): ftpuser<br />331 Please specify the password.<br />Password: <br />230 Login successful.<br />Remote system type is UNIX.<br />Using binary mode to transfer files.<br />ftp&gt; ls<br />229 Entering Extended Passive Mode (|||31695|)<br />150 Here comes the directory listing.<br />drwxr-x---&nbsp;&nbsp;&nbsp; 2 1001&nbsp;&nbsp;&nbsp;&nbsp; 1001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6 Oct 21 03:06 shared<br />226 Directory send OK.<br />ftp&gt; exit<br />221 Goodbye.<br />┌──(user㉿kali)-[~]<br />└─$ ftp IpAddrCentos<br />ftp: Can't connect to `IpAddrCentos:21': Connection refused<br />ftp: Can't connect to `IpAddrCentos:ftp'<br />ftp&gt; exit<br />┌──(user㉿kali)-[~]<br />└─$ telnet IpAddrCentos 21 <br />Trying IpAddrCentos...<br />telnet: Unable to connect to remote host: Connection refused<br /><strong>Task:</strong><br />Install Nginx<br /><strong>Decision:</strong><br />[root@centos user]# dnf update -y<br />[root@centos user]# dnf install nginx<br />[root@centos user]# systemctl start nginx<br />[root@centos user]# systemctl enable nginx<br />[root@centos user]# nginx -v<br />nginx version: nginx/1.22.1<br />[root@centos user]# firefox IpAddrCentos<br /><strong>Task:</strong><br />Configure Squid Proxy<br /><strong>Decision:</strong><br />┌──(root㉿kali)-[/home/user]<br />└─#&nbsp; apt update<br />┌──(root㉿kali)-[/home/user]<br />└─#&nbsp; apt install squid<br />┌──(root㉿kali)-[/home/user]<br />└─# systemctl start squid<br />┌──(root㉿kali)-[/home/user]<br />└─# systemctl enable squid<br />┌──(root㉿kali)-[/home/user]<br />└─# grep -Eiv '(^#|^$)' /etc/squid/squid.conf<br />acl localnet src 0.0.0.1-0.255.255.255&nbsp; # RFC 1122 "this" network (LAN)<br />acl localnet src 10.0.0.0/8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 1918 local private network (LAN)<br />acl localnet src 100.64.0.0/10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 6598 shared address space (CGN)<br />acl localnet src 169.254.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 3927 link-local (directly plugged) machines<br />acl localnet src 172.16.0.0/12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 1918 local private network (LAN)<br />acl localnet src 192.168.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 1918 local private network (LAN)<br />acl localnet src fc00::/7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 4193 local private network range<br />acl localnet src fe80::/10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 4291 link-local (directly plugged) machines<br />acl SSL_ports port 443<br />acl Safe_ports port 80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # http<br />acl Safe_ports port 21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # ftp<br />acl Safe_ports port 443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # https<br />acl Safe_ports port 70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # gopher<br />acl Safe_ports port 210&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # wais<br />acl Safe_ports port 1025-65535&nbsp; # unregistered ports<br />acl Safe_ports port 280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # http-mgmt<br />acl Safe_ports port 488&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # gss-http<br />acl Safe_ports port 591&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # filemaker<br />acl Safe_ports port 777&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # multiling http<br />http_access deny !Safe_ports<br />http_access deny CONNECT !SSL_ports<br />http_access allow localhost manager<br />http_access deny manager<br />http_access allow localhost<br />http_access deny to_localhost<br />http_access deny to_linklocal<br />include /etc/squid/conf.d/*.conf<br />http_access deny all<br />http_port 3128<br />coredump_dir /var/spool/squid<br />refresh_pattern ^ftp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1440&nbsp;&nbsp;&nbsp; 20%&nbsp;&nbsp;&nbsp;&nbsp; 10080<br />refresh_pattern -i (/cgi-bin/|\?) 0&nbsp;&nbsp;&nbsp;&nbsp; 0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />refresh_pattern .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 20%&nbsp;&nbsp;&nbsp;&nbsp; 4320<br />┌──(root㉿kali)-[/home/user]<br />└─# mv /etc/squid/squid.conf /etc/squid/squid.conf.bac<br />┌──(root㉿kali)-[/home/user]<br />└─# vim /etc/squid/squid.conf<br />┌──(root㉿kali)-[/home/user]<br />└─# cat /etc/squid/squid.conf&nbsp;&nbsp; &nbsp;<br />acl localnet src IpAddrKali<br />http_access allow localnet<br />http_port 3128<br />┌──(root㉿kali)-[/home/user]<br />└─# systemctl restart squid&nbsp; &nbsp;<br />┌──(root㉿kali)-[/home/user]<br />└─# cat /var/log/squid/access.log<br />1698153952.395&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 IpAddrKali NONE_NONE/400 3816 - / - HIER_NONE/- text/html<br />1698153953.958&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 7 IpAddrKali TCP_DENIED/403 4185 GET http://kali:3128/squid-internal-static/icons/SN.png - HIER_NONE/- text/html<br />...<br />1698154905.087&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 IpAddrKali TCP_MISS/400 3889 GET http://IpAddrKali:3128/ - HIER_DIRECT/IpAddrKali text/html<br />1698154906.698&nbsp;&nbsp;&nbsp; 149 IpAddrKali TCP_TUNNEL/200 39 CONNECT static.vk.com:443 - HIER_DIRECT/87.240.137.164 -<br />1698154906.796&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 IpAddrKali NONE_NONE/400 3838 - /favicon.ico - HIER_NONE/- text/html<br />1698154906.797&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 IpAddrKali TCP_MISS/400 3911 GET http://IpAddrKali:3128/favicon.ico - HIER_DIRECT/IpAddrKali text/html<br />┌──(root㉿kali)-[/home/user]<br />└─# apt install apache2-utils&nbsp; &nbsp;<br />┌──(root㉿kali)-[/home/user]<br />└─# htpasswd -c /etc/squid/passwd user<br />┌──(root㉿kali)-[/home/user]<br />└─# vim /etc/squid/squid.conf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />┌──(root㉿kali)-[/home/user]<br />└─# cat /etc/squid/squid.conf<br />#acl localnet src IpAddrKali<br />#http_access allow localnet<br />http_port 3128<br />via off<br />auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd<br />auth_param basic children 5<br />auth_param basic credentialsttl 2 hours<br />auth_param basic casesensitive on<br />auth_param basic realm Squid proxy for kali<br />acl auth_users proxy_auth REQUIRED<br />http_access allow auth_users<br />┌──(root㉿kali)-[/home/user]<br />└─# systemctl restart squid<br /><strong>Task:</strong><br />Configure Squid Proxy<br /><strong>Decision:</strong><br />[root@centos user]# dnf install squid<br />[root@centos user]# systemctl enable --now squid<br />[root@centos user]# grep -Eiv '(^#|^$)' /etc/squid/squid.conf<br />acl localnet src 0.0.0.1-0.255.255.255&nbsp; # RFC 1122 "this" network (LAN)<br />acl localnet src 10.0.0.0/8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 1918 local private network (LAN)<br />acl localnet src 100.64.0.0/10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 6598 shared address space (CGN)<br />acl localnet src 169.254.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 3927 link-local (directly plugged) machines<br />acl localnet src 172.16.0.0/12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 1918 local private network (LAN)<br />acl localnet src 192.168.0.0/16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 1918 local private network (LAN)<br />acl localnet src fc00::/7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 4193 local private network range<br />acl localnet src fe80::/10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # RFC 4291 link-local (directly plugged) machines<br />acl SSL_ports port 443<br />acl Safe_ports port 80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # http<br />acl Safe_ports port 21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # ftp<br />acl Safe_ports port 443&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # https<br />acl Safe_ports port 70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # gopher<br />acl Safe_ports port 210&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # wais<br />acl Safe_ports port 1025-65535&nbsp; # unregistered ports<br />acl Safe_ports port 280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # http-mgmt<br />acl Safe_ports port 488&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # gss-http<br />acl Safe_ports port 591&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # filemaker<br />acl Safe_ports port 777&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # multiling http<br />http_access deny !Safe_ports<br />http_access deny CONNECT !SSL_ports<br />http_access allow localhost manager<br />http_access deny manager<br />http_access allow localnet<br />http_access allow localhost<br />http_access deny all<br />http_port 3128<br />coredump_dir /var/spool/squid<br />refresh_pattern ^ftp:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1440&nbsp;&nbsp;&nbsp; 20%&nbsp;&nbsp;&nbsp;&nbsp; 10080<br />refresh_pattern ^gopher:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1440&nbsp;&nbsp;&nbsp; 0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1440<br />refresh_pattern -i (/cgi-bin/|\?) 0&nbsp;&nbsp;&nbsp;&nbsp; 0%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />refresh_pattern .&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 20%&nbsp;&nbsp;&nbsp;&nbsp; 4320<br />[root@centos user]# mv /etc/squid/squid.conf /etc/squid/squid.conf.bac<br />[root@centos user]# vim /etc/squid/squid.conf<br />[root@centos user]# cat /etc/squid/squid.conf<br />acl localnet src IpAddrCentos<br />acl localnet src IpAddr.0/32<br />acl Safe_ports port 80<br />acl Safe_ports port 443<br />cache_dir ufs /var/spool/squid 1000 16 256<br />http_access allow localnet<br />http_port 3128&nbsp; &nbsp;<br />[root@centos user]# systemctl restart squid<br />[root@centos user]# iptables -t filter -A INPUT -p tcp --dport 3128 -j ACCEPT<br />[root@centos user]# service iptables save<br />[root@centos user]# systemctl restart iptables.service<br />[root@centos user]# curl -O -L "https://www.redhat.com/index.html" -x "IpAddrCentos:<br />3128"<br />&nbsp; % Total&nbsp;&nbsp;&nbsp; % Received % Xferd&nbsp; Average Speed&nbsp;&nbsp; Time&nbsp;&nbsp;&nbsp; Time&nbsp;&nbsp;&nbsp;&nbsp; Time&nbsp; Current<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dload&nbsp; Upload&nbsp;&nbsp; Total&nbsp;&nbsp; Spent&nbsp;&nbsp;&nbsp; Left&nbsp; Speed<br />&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 --:--:-- --:--:-- --:--:--&nbsp;&nbsp;&nbsp;&nbsp; 0<br />100&nbsp; 156k&nbsp;&nbsp;&nbsp; 0&nbsp; 156k&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; 147k&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 --:--:--&nbsp; 0:00:01 --:--:--&nbsp; 795k<br />user@ubuntu:~$ sudo nmap IpAddrCentos<br />Starting Nmap 7.80 ( https://nmap.org ) at 2023-10-25 08:12 CDT<br />Nmap scan report for IpAddrCentos<br />Host is up (0.00086s latency).<br />Not shown: 991 filtered ports<br />PORT&nbsp;&nbsp;&nbsp;&nbsp; STATE&nbsp; SERVICE<br />20/tcp&nbsp;&nbsp; closed ftp-data<br />21/tcp&nbsp;&nbsp; open&nbsp;&nbsp; ftp<br />22/tcp&nbsp;&nbsp; open&nbsp;&nbsp; ssh<br />25/tcp&nbsp;&nbsp; closed smtp<br />53/tcp&nbsp;&nbsp; closed domain<br />80/tcp&nbsp;&nbsp; open&nbsp;&nbsp; http<br />143/tcp&nbsp; closed imap<br />443/tcp&nbsp; closed https<br />3128/tcp open&nbsp;&nbsp; squid-http<br />MAC Address: MacAddrCentos (QEMU virtual NIC)<br />Nmap done: 1 IP address (1 host up) scanned in 5.16 seconds<br />[root@centos user]# dnf install httpd-tools<br />[root@centos user]# touch /etc/squid/passwd<br />[root@centos user]# chown squid /etc/squid/passwd<br />[root@centos user]# htpasswd /etc/squid/passwd proxyuser<br />[root@centos user]# vim /etc/squid/squid.conf<br />[root@centos user]# cat /etc/squid/squid.conf<br />#acl localnet src IpAddrCentos<br />#acl localnet src IpAddr.0/32<br />#acl Safe_ports port 80<br />#acl Safe_ports port 443<br />#cache_dir ufs /var/spool/squid 1000 16 256<br />#http_access allow localnet<br />http_port 3128&nbsp; &nbsp;<br />auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwd<br />auth_param basic children 5<br />auth_param basic realm Squid Basic Authentication<br />auth_param basic credentialsttl 2 hours<br />acl auth_users proxy_auth REQUIRED<br />http_access allow auth_users<br />[root@centos user]# systemctl restart squid<br />[root@centos user]# curl -O -L "https://www.redhat.com/index.html" -x "proxyuser:tpassword@IpAddrCentos:3128"<br />&nbsp; % Total&nbsp;&nbsp;&nbsp; % Received % Xferd&nbsp; Average Speed&nbsp;&nbsp; Time&nbsp;&nbsp;&nbsp; Time&nbsp;&nbsp;&nbsp;&nbsp; Time&nbsp; Current<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dload&nbsp; Upload&nbsp;&nbsp; Total&nbsp;&nbsp; Spent&nbsp;&nbsp;&nbsp; Left&nbsp; Speed<br />&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 --:--:-- --:--:-- --:--:--&nbsp;&nbsp;&nbsp;&nbsp; 0<br />100&nbsp; 156k&nbsp;&nbsp;&nbsp; 0&nbsp; 156k&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; 124k&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 --:--:--&nbsp; 0:00:01 --:--:--&nbsp; 562k<br /><strong>Task:</strong><br />Перенаправление пакетов, идущих на 80-й порт, на стандартный порт прокси-сервера.<br /><strong>Decision:</strong><br />[root@centos user]# iptables -t nat -A PREROUTING -s IpAddr.0 -p tcp --dport 80 -j REDIRECT --to-port 3128<br />[root@centos user]# service iptables save<br />[root@centos user]# systemctl restart iptables.service<br /><strong>Task:</strong><br />Предоставляем доступ из Интернет к веб-серверу, который расположен в локальной сети (проброс порта). Вместо IpAddrUbuntu укажите IP-адрес вашего веб-сервера.<br /><strong>Decision:</strong><br />[root@centos user]# iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination IpAddrUbuntu:80<br />[root@centos user]# service iptables save<br />[root@centos user]# systemctl restart iptables.service<br />Tas<br />Включаем маскарадинг для доступа в Интернет пользователей локальной сети.<br /><strong>Decision:</strong><br />[root@centos user]# iptables -t nat -A POSTROUTING -o LanCard -s IpAddr.0/32 -j MASQUERADE<br />[root@centos user]# service iptables save<br />[root@centos user]# systemctl restart iptables.service<br /><strong>Task:</strong><br />сканирование сети<br /><strong>Decision:</strong><br />[root@centos user]# nmap -sL IpAddrCentos/24<br />Starting Nmap 7.92 ( https://nmap.org ) at 2023-10-29 11:25 +08<br />Nmap scan report for IpAddr.0<br />...<br />Nmap scan report for kali (IpAddrKali)<br />...<br />Nmap scan report for centos (IpAddr)<br />...<br />Nmap scan report for ubuntu (IpAddrUbuntu)<br />...<br />Nmap scan report for IpAddr.255<br />Nmap done: 256 IP addresses (0 hosts up) scanned in 28.06 seconds<br /><strong>Decision:</strong><br />Утилита обнаружила активные устройства в сети. Среди них показались ip-адреса, в котором были развернуты мои виртуальные машины<br /><strong>Task:</strong><br />Просканируем удаленный хост (агрессивный режим).<br /><strong>Decision:</strong><br />user@ubuntu:~$ sudo nmap -A -T4 IpAddrCentos<br />Starting Nmap 7.80 ( https://nmap.org ) at 2023-10-27 23:24 CDT<br />Nmap scan report for IpAddrCentos<br />Host is up (0.00084s latency).<br />Not shown: 992 filtered ports<br />PORT&nbsp;&nbsp;&nbsp;&nbsp; STATE&nbsp; SERVICE&nbsp;&nbsp;&nbsp; VERSION<br />20/tcp&nbsp;&nbsp; closed ftp-data<br />21/tcp&nbsp;&nbsp; open&nbsp;&nbsp; ftp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vsftpd 3.0.5<br />22/tcp&nbsp;&nbsp; open&nbsp;&nbsp; ssh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OpenSSH 8.7 (protocol 2.0)<br />25/tcp&nbsp;&nbsp; closed smtp<br />53/tcp&nbsp;&nbsp; closed domain<br />143/tcp&nbsp; closed imap<br />443/tcp&nbsp; closed https<br />3128/tcp open&nbsp;&nbsp; http-proxy Squid http proxy 5.5<br />|_http-server-header: squid/5.5<br />|_http-title: ERROR: The requested URL could not be retrieved<br />MAC Address: MacAddrCentos (QEMU virtual NIC)<br />Aggressive OS guesses: Linux 2.6.32 - 3.13 (94%), Linux 2.6.22 - 2.6.36 (92%), Linux 3.10 (92%), Linux 3.10 - 4.11 (92%), Linux 2.6.39 (92%), Linux 2.6.32 (91%), Linux 3.2 - 4.9 (91%), Linux 2.6.32 - 3.10 (91%), Linux 2.6.18 (90%), Linux 3.16 - 4.6 (90%)<br />No exact OS matches for host (test conditions non-ideal).<br />Network Distance: 1 hop<br />Service Info: OS: Unix<br />TRACEROUTE<br />HOP RTT&nbsp;&nbsp;&nbsp;&nbsp; ADDRESS<br />1&nbsp;&nbsp; 0.83 ms IpAddrCentos<br />OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br />Nmap done: 1 IP address (1 host up) scanned in 24.18 seconds<br /><strong>Task:</strong><br />узнать более подробную информацию о машине и запущенных на ней сервисах<br /><strong>Decision:</strong><br />[root@centos user]# nmap -sV IpAddrUbuntu<br />Starting Nmap 7.92 ( https://nmap.org ) at 2023-10-29 11:35 +08<br />Nmap scan report for ubuntu (IpAddrUbuntu)<br />Host is up (0.0010s latency).<br />Not shown: 997 filtered tcp ports (no-response)<br />PORT&nbsp;&nbsp;&nbsp; STATE&nbsp; SERVICE VERSION<br />22/tcp&nbsp; open&nbsp;&nbsp; ssh&nbsp;&nbsp;&nbsp;&nbsp; OpenSSH 8.9p1 Ubuntu 3ubuntu0.3 (Ubuntu Linux; protocol 2.0)<br />80/tcp&nbsp; open&nbsp;&nbsp; http&nbsp;&nbsp;&nbsp; Apache httpd 2.4.52 ((Ubuntu))<br />443/tcp closed https<br />MAC Address: MacAddrUbuntu (QEMU virtual NIC)<br />Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel<br />Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .<br />Nmap done: 1 IP address (1 host up) scanned in 12.27 seconds<br /><strong>Task:</strong><br />В виртуальной машине запущен веб-сервер, поэтому мы можем рассмотреть эту службу подробнее.<br /><strong>Decision:</strong><br />[root@centos user]# nmap -sC IpAddrUbuntu -p 80<br />Starting Nmap 7.92 ( https://nmap.org ) at 2023-10-29 11:45 +08<br />Nmap scan report for ubuntu (IpAddrUbuntu)<br />Host is up (0.00078s latency).<br />PORT&nbsp;&nbsp; STATE SERVICE<br />80/tcp open&nbsp; http<br />|_http-title: david138it<br />MAC Address: MacAddrUbuntu (QEMU virtual NIC)<br />Nmap done: 1 IP address (1 host up) scanned in 1.88 seconds<br /><strong>Task:</strong><br />Найти все скрипты, которые позволяют проверить порты более детально, для нашего веб-сервера. Затем попытаемся использовать один из них, для этого достаточно указать его с помощью опции &mdash;script. Но сначала вы можете посмотреть информацию о скрипте. <br /><strong>Decision:</strong><br />[root@centos user]# find /usr/share/nmap/scripts/ -name '*.nse' | grep http<br />/usr/share/nmap/scripts/http-brute.nse<br />...<br />/usr/share/nmap/scripts/riak-http-info.nse<br />[root@centos user]# nmap --script-help http-brute.nse<br />Starting Nmap 7.92 ( https://nmap.org ) at 2023-10-29 11:50 +08<br />http-brute<br />Categories: intrusive brute<br />https://nmap.org/nsedoc/scripts/http-brute.html<br />&nbsp; Performs brute force password auditing against http basic, digest and ntlm authentication.<br />&nbsp; This script uses the unpwdb and brute libraries to perform password<br />&nbsp; guessing. Any successful guesses are stored in the nmap registry, using<br />&nbsp; the creds library, for other scripts to use.<br />[root@centos user]# nmap --script http-brute.nse IpAddrWindServ84 -p 80<br />Starting Nmap 7.92 ( https://nmap.org ) at 2023-10-29 11:54 +08<br />Note: Host seems down. If it is really up, but blocking our ping probes, try -Pn<br />Nmap done: 1 IP address (0 hosts up) scanned in 3.61 seconds<br />[root@centos user]# nmap --script http-brute.nse IpAddrWindServ84 -p 80 -Pn<br />Starting Nmap 7.92 ( https://nmap.org ) at 2023-10-29 12:08 +08<br />Nmap scan report for IpAddrWindServ84<br />Host is up.<br />PORT&nbsp;&nbsp; STATE&nbsp;&nbsp;&nbsp; SERVICE<br />80/tcp filtered http<br />Nmap done: 1 IP address (1 host up) scanned in 2.61 seconds<br /><strong>Decision:</strong><br />В последней команде пытался узнать пароль веб-сервера. В некоторых случаях можно вытащить логин и пароль. Такое происходит, когда используются параметры входа по умолчанию.<br /><strong>Task:</strong><br />Сканируем диапазон портов<br /><strong>Decision:</strong><br />user@ubuntu:~$ sudo nmap -sT -p 21-80 IpAddrCentos<br />Starting Nmap 7.80 ( https://nmap.org ) at 2023-10-27 23:41 CDT<br />Nmap scan report for IpAddrCentos<br />Host is up (0.0030s latency).<br />Not shown: 56 filtered ports<br />PORT&nbsp;&nbsp; STATE&nbsp; SERVICE<br />21/tcp open&nbsp;&nbsp; ftp<br />22/tcp open&nbsp;&nbsp; ssh<br />25/tcp closed smtp<br />53/tcp closed domain<br />MAC Address: MacAddrCentos (QEMU virtual NIC)<br />Nmap done: 1 IP address (1 host up) scanned in 1.85 seconds<br /><strong>Task:</strong><br />Перехватываем весь трафик для MAC-адреса MacAddrUbuntu на сетевом интерфейсе LanCard.<br /><strong>Decision:</strong><br />user@ubuntu:~$ sudo tcpdump -n -i LanCard "ether host MacAddrCentos"<br />tcpdump: verbose output suppressed, use -v[v]... for full protocol decode<br />listening on LanCard, link-type EN10MB (Ethernet), snapshot length 262144 bytes<br />[root@centos user]# ssh user@IpAddrUbuntu<br />user@IpAddrUbuntu's password: <br />user@ubuntu:~$ sudo tcpdump -n -i LanCard "ether host MacAddrCentos"<br />...<br />00:11:09.121772 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [S], seq 3127527477, win 64240, options [mss 1460,sackOK,TS val 3107336019 ecr 0,nop,wscale 7], length 0<br />00:11:09.121894 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [S.], seq 2200785231, ack 3127527478, win 65160, options [mss 1460,sackOK,TS val 2462886528 ecr 3107336019,nop,wscale 7], length 0<br />00:11:09.122300 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 1, win 502, options [nop,nop,TS val 3107336020 ecr 2462886528], length 0<br />00:11:09.123009 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1:22, ack 1, win 502, options [nop,nop,TS val 3107336020 ecr 2462886528], length 21: SSH: SSH-2.0-OpenSSH_8.7<br />00:11:09.123086 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [.], ack 22, win 509, options [nop,nop,TS val 2462886529 ecr 3107336020], length 0<br />00:11:09.148795 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 1:42, ack 22, win 509, options [nop,nop,TS val 2462886555 ecr 3107336020], length 41: SSH: SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.3<br />00:11:09.149526 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 42, win 502, options [nop,nop,TS val 3107336047 ecr 2462886555], length 0<br />00:11:09.150579 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 22:1382, ack 42, win 502, options [nop,nop,TS val 3107336048 ecr 2462886555], length 1360<br />00:11:09.151887 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 42:1122, ack 1382, win 501, options [nop,nop,TS val 2462886558 ecr 3107336048], length 1080<br />00:11:09.157642 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1382:1430, ack 1122, win 501, options [nop,nop,TS val 3107336055 ecr 2462886558], length 48<br />00:11:09.171709 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 1122:1654, ack 1430, win 501, options [nop,nop,TS val 2462886578 ecr 3107336055], length 532<br />00:11:09.185522 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1430:1446, ack 1654, win 501, options [nop,nop,TS val 3107336083 ecr 2462886578], length 16<br />00:11:09.228923 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [.], ack 1446, win 501, options [nop,nop,TS val 2462886635 ecr 3107336083], length 0<br />00:11:09.229685 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1446:1498, ack 1654, win 501, options [nop,nop,TS val 3107336127 ecr 2462886635], length 52<br />00:11:09.229782 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [.], ack 1498, win 501, options [nop,nop,TS val 2462886636 ecr 3107336127], length 0<br />00:11:09.229995 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 1654:1706, ack 1498, win 501, options [nop,nop,TS val 2462886636 ecr 3107336127], length 52<br />00:11:09.230579 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1498:1566, ack 1706, win 501, options [nop,nop,TS val 3107336128 ecr 2462886636], length 68<br />00:11:09.238565 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 1706:1758, ack 1566, win 501, options [nop,nop,TS val 2462886644 ecr 3107336128], length 52<br />00:11:09.280247 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 1758, win 501, options [nop,nop,TS val 3107336177 ecr 2462886644], length 0<br />00:11:12.034402 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1566:1714, ack 1758, win 501, options [nop,nop,TS val 3107338932 ecr 2462886644], length 148<br />00:11:12.076713 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [.], ack 1714, win 501, options [nop,nop,TS val 2462889483 ecr 3107338932], length 0<br />00:11:12.274441 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 1758:1794, ack 1714, win 501, options [nop,nop,TS val 2462889680 ecr 3107338932], length 36<br />00:11:12.275003 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 1794, win 501, options [nop,nop,TS val 3107339172 ecr 2462889680], length 0<br />00:11:12.275445 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1714:1834, ack 1794, win 501, options [nop,nop,TS val 3107339173 ecr 2462889680], length 120<br />00:11:12.275497 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [.], ack 1834, win 501, options [nop,nop,TS val 2462889681 ecr 3107339173], length 0<br />00:11:12.447785 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 1794:2422, ack 1834, win 501, options [nop,nop,TS val 2462889854 ecr 3107339173], length 628<br />00:11:12.489012 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 2422, win 501, options [nop,nop,TS val 3107339386 ecr 2462889854], length 0<br />00:11:12.489092 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 2422:2474, ack 1834, win 501, options [nop,nop,TS val 2462889895 ecr 3107339386], length 52<br />00:11:12.489453 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 2474, win 501, options [nop,nop,TS val 3107339387 ecr 2462889895], length 0<br />00:11:12.489928 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [P.], seq 1834:2242, ack 2474, win 501, options [nop,nop,TS val 3107339387 ecr 2462889895], length 408<br />00:11:12.490014 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [.], ack 2242, win 501, options [nop,nop,TS val 2462889896 ecr 3107339387], length 0<br />00:11:12.493478 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 2474:2582, ack 2242, win 501, options [nop,nop,TS val 2462889899 ecr 3107339387], length 108<br />00:11:12.494668 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 2582:2906, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 324<br />00:11:12.494876 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 2906:2942, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 36<br />00:11:12.494942 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 2942:2978, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 36<br />00:11:12.494972 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 2978:3062, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 84<br />00:11:12.495040 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3062:3098, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 36<br />00:11:12.495108 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3098:3198, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 100<br />00:11:12.495173 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3198:3234, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 36<br />00:11:12.495242 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3234:3270, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 36<br />00:11:12.495311 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3270:3370, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339387], length 100<br />00:11:12.495324 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 3198, win 501, options [nop,nop,TS val 3107339393 ecr 2462889899], length 0<br />00:11:12.495436 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3370:3406, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339393], length 36<br />00:11:12.495512 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 3370, win 501, options [nop,nop,TS val 3107339393 ecr 2462889901], length 0<br />00:11:12.495525 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3406:3522, ack 2242, win 501, options [nop,nop,TS val 2462889901 ecr 3107339393], length 116<br />00:11:12.495620 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3522:3558, ack 2242, win 501, options [nop,nop,TS val 2462889902 ecr 3107339393], length 36<br />00:11:12.495693 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3558:3594, ack 2242, win 501, options [nop,nop,TS val 2462889902 ecr 3107339393], length 36<br />00:11:12.495753 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 3522, win 501, options [nop,nop,TS val 3107339393 ecr 2462889901], length 0<br />00:11:12.495765 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3594:3694, ack 2242, win 501, options [nop,nop,TS val 2462889902 ecr 3107339393], length 100<br />00:11:12.495844 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3694:3730, ack 2242, win 501, options [nop,nop,TS val 2462889902 ecr 3107339393], length 36<br />00:11:12.495907 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 3694, win 501, options [nop,nop,TS val 3107339393 ecr 2462889902], length 0<br />00:11:12.536934 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 3730, win 501, options [nop,nop,TS val 3107339434 ecr 2462889902], length 0<br />00:11:12.586762 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3730:3782, ack 2242, win 501, options [nop,nop,TS val 2462889993 ecr 3107339434], length 52<br />00:11:12.586838 IP IpAddrUbuntu.22 &gt; IpAddrCentos.58598: Flags [P.], seq 3782:3898, ack 2242, win 501, options [nop,nop,TS val 2462889993 ecr 3107339434], length 116<br />00:11:12.588205 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 3782, win 501, options [nop,nop,TS val 3107339485 ecr 2462889993], length 0<br />00:11:12.588207 IP IpAddrCentos.58598 &gt; IpAddrUbuntu.22: Flags [.], ack 3898, win 501, options [nop,nop,TS val 3107339486 ecr 2462889993], length 0<br /><strong>Task:</strong><br />Перехватываем только ICMP-пакеты<br /><strong>Decision:</strong><br />user@ubuntu:~$ sudo tcpdump -i LanCard -n -nn -ttt 'ip proto \icmp'<br />tcpdump: verbose output suppressed, use -v[v]... for full protocol decode<br />listening on LanCard, link-type EN10MB (Ethernet), snapshot length 262144 bytes<br />[root@centos user]# ping IpAddrUbuntu<br />PING IpAddrUbuntu (IpAddrUbuntu) 56(84) bytes of data.<br />64 bytes from IpAddrUbuntu: icmp_seq=1 ttl=64 time=0.692 ms<br />64 bytes from IpAddrUbuntu: icmp_seq=2 ttl=64 time=0.764 ms<br />64 bytes from IpAddrUbuntu: icmp_seq=3 ttl=64 time=0.868 ms<br />64 bytes from IpAddrUbuntu: icmp_seq=4 ttl=64 time=1.01 ms<br />64 bytes from IpAddrUbuntu: icmp_seq=5 ttl=64 time=1.13 ms<br />^C<br />--- IpAddrUbuntu ping statistics ---<br />5 packets transmitted, 5 received, 0% packet loss, time 4006ms<br />rtt min/avg/max/mdev = 0.692/0.892/1.130/0.159 ms<br />user@ubuntu:~$ sudo tcpdump -i LanCard -n -nn -ttt 'ip proto \icmp'<br />...<br />&nbsp;00:00:00.000000 IP IpAddrCentos &gt; IpAddrUbuntu: ICMP echo request, id 4, seq 1, length 64<br />&nbsp;00:00:00.000171 IP IpAddrUbuntu &gt; IpAddrCentos: ICMP echo reply, id 4, seq 1, length 64<br />&nbsp;00:00:01.001145 IP IpAddrCentos &gt; IpAddrUbuntu: ICMP echo request, id 4, seq 2, length 64<br />&nbsp;00:00:00.000077 IP IpAddrUbuntu &gt; IpAddrCentos: ICMP echo reply, id 4, seq 2, length 64<br />&nbsp;00:00:01.001365 IP IpAddrCentos &gt; IpAddrUbuntu: ICMP echo request, id 4, seq 3, length 64<br />&nbsp;00:00:00.000077 IP IpAddrUbuntu &gt; IpAddrCentos: ICMP echo reply, id 4, seq 3, length 64<br />&nbsp;00:00:01.001375 IP IpAddrCentos &gt; IpAddrUbuntu: ICMP echo request, id 4, seq 4, length 64<br />&nbsp;00:00:00.000077 IP IpAddrUbuntu &gt; IpAddrCentos: ICMP echo reply, id 4, seq 4, length 64<br />&nbsp;00:00:01.001573 IP IpAddrCentos &gt; IpAddrUbuntu: ICMP echo request, id 4, seq 5, length 64<br />&nbsp;00:00:00.000125 IP IpAddrUbuntu &gt; IpAddrCentos: ICMP echo reply, id 4, seq 5, length 64<br /><strong>Task:</strong><br />Перехватываем DNS-трафик между сервером и каким-нибудь узлом в сети.<br /><strong>Decision:</strong><br />$ sudo virsh start Windows12<br />[root@centos user]# nmap IpAddrWindServ<br />Starting Nmap 7.92 ( https://nmap.org ) at 2023-10-28 13:24 +08<br />Nmap scan report for RT-GM2-9 (IpAddrWindServ)<br />Host is up (0.0017s latency).<br />Not shown: 901 filtered tcp ports (no-response), 96 closed tcp ports (reset)<br />PORT&nbsp;&nbsp;&nbsp; STATE SERVICE<br />53/tcp&nbsp; open&nbsp; domain<br />80/tcp&nbsp; open&nbsp; http<br />443/tcp open&nbsp; https<br />Nmap done: 1 IP address (1 host up) scanned in 3.64 seconds<br />[root@centos user]# tcpdump -i LanCard -n -nn -ttt 'host IpAddrWindServ and port 53'<br /><strong>Task:</strong><br />Перехватываем входящий трафик на порт 80. сохраняем статистику в файл my.log для первых 500 пакетов. Будет создан бинарный файл my.log, который можно отпарсить с помощью команды<br /><strong>Decision:</strong><br />[root@centos user]# firefox IpAddrUbuntu<br />[root@centos user]# tcpdump -v -i LanCard dst port 80<br />dropped privs to tcpdump<br />tcpdump: listening on LanCard, link-type EN10MB (Ethernet), snapshot length 262144 bytes<br />14:07:24.835633 IP (tos 0x0, ttl 64, id 15549, offset 0, flags [DF], proto TCP (6), length 60)<br />&nbsp;&nbsp;&nbsp; centos.45022 &gt; ubuntu.http: Flags [S], cksum 0x76d1 (incorrect -&gt; 0x9a90), seq 1076682845, win 64240, options [mss 1460,sackOK,TS val 3110711737 ecr 0,nop,wscale 7], length 0<br />14:07:24.836511 IP (tos 0x0, ttl 64, id 15550, offset 0, flags [DF], proto TCP (6), length 52)<br />&nbsp;&nbsp;&nbsp; centos.45022 &gt; ubuntu.http: Flags [.], cksum 0x76c9 (incorrect -&gt; 0x51b3), ack 2952605173, win 502, options [nop,nop,TS val 3110711738 ecr 3247231251], length 0<br />14:07:24.836838 IP (tos 0x0, ttl 64, id 15551, offset 0, flags [DF], proto TCP (6), length 412)<br />&nbsp;&nbsp;&nbsp; centos.45022 &gt; ubuntu.http: Flags [P.], cksum 0x7831 (incorrect -&gt; 0xb0a2), seq 0:360, ack 1, win 502, options [nop,nop,TS val 3110711739 ecr 3247231251], length 360: HTTP, length: 360<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GET / HTTP/1.1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Host: IpAddrUbuntu<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Accept-Encoding: gzip, deflate<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Connection: keep-alive<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Upgrade-Insecure-Requests: 1<br />14:07:24.844920 IP (tos 0x0, ttl 64, id 15552, offset 0, flags [DF], proto TCP (6), length 52)<br />&nbsp;&nbsp;&nbsp; centos.45022 &gt; ubuntu.http: Flags [.], cksum 0x76c9 (incorrect -&gt; 0x4285), ack 3522, win 489, options [nop,nop,TS val 3110711747 ecr 3247231260], length 0<br />14:07:29.846014 IP (tos 0x0, ttl 64, id 15553, offset 0, flags [DF], proto TCP (6), length 52)<br />&nbsp;&nbsp;&nbsp; centos.45022 &gt; ubuntu.http: Flags [F.], cksum 0x76c9 (incorrect -&gt; 0x2eef), seq 360, ack 3522, win 501, options [nop,nop,TS val 3110716748 ecr 3247231260], length 0<br />14:07:29.846795 IP (tos 0x0, ttl 64, id 15554, offset 0, flags [DF], proto TCP (6), length 52)<br />&nbsp;&nbsp;&nbsp; centos.45022 &gt; ubuntu.http: Flags [.], cksum 0x76c9 (incorrect -&gt; 0x1b63), ack 3523, win 501, options [nop,nop,TS val 3110716749 ecr 3247236262], length 0<br />[root@centos user]# tcpdump -v -n -w my.log dst port 80 -c 500<br />dropped privs to tcpdump<br />tcpdump: listening on LanCard, link-type EN10MB (Ethernet), snapshot length 262144 bytes<br />[root@centos user]# ls my.log<br />my.log<br />[root@centos user]# tcpdump -nr my.log | awk '{print $3}' | grep -oE '[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,}' | sort | uniq -c | sort -rn<br />reading from file my.log, link-type EN10MB (Ethernet), snapshot length 262144<br />dropped privs to tcpdump<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6 IpAddrCentos<br /><strong>Decision:</strong><br />Чем больше подключений для одного IP-адреса, тем больше вероятность, что это какая-то нехорошая деятельность.<br /><strong>Task:</strong><br />IP-адреса, которые вызывают подозрение, можно заблокировать в iptables с помощью команды, указанной ниже.<br /><strong>Decision:</strong><br />[root@centos user]# iptables -A INPUT -s IpAddrUbuntu -j DROP<br />[root@centos user]# service iptables save<br />[root@centos user]# systemctl restart iptables.service<br /><strong>Task:</strong><br />Системы обнаружения вторжения (Intrusion Detection System, IDS). Установка и настройка tripwire.<br /><strong>Decision:</strong><br />[root@centos user]# dnf -y install epel-releasey<br />[root@centos user]# dnf -y install tripwire<br />[root@centos user]# tripwire-setup-keyfiles<br />[root@centos user]# tripwire --init<br />...<br />### Warning: File system error.<br />### Filename: /proc/pci<br />### Нет такого файла или каталога<br />### Continuing...<br />...<br />[root@centos user]# cat /etc/tripwire/twpol.txt<br />...<br />&nbsp;&nbsp;&nbsp;&nbsp; /proc/pci&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; $(Device) ;<br />...<br />[root@centos user]# vim /etc/tripwire/twpol.txt<br />[root@centos user]# cat /etc/tripwire/twpol.txt<br />...<br />&nbsp;&nbsp;&nbsp;&nbsp; #/proc/pci&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt; $(Device) ;<br />...<br />[root@centos user]# tripwire --update-policy --secure-mode low /etc/tripwire/twpol.txt<br />[root@centos user]# tripwire --check &mdash;interactive<br /><strong>Task:</strong><br />Создаем конфигурацию, Создаем базу данных, Проверим на работоспособность<br /><strong>Decision:</strong><br />[root@centos user]# ls /etc/tripwire/<br />centos-local.key&nbsp; site.key&nbsp; tw.cfg&nbsp; twcfg.txt&nbsp; tw.pol&nbsp; tw.pol.bak&nbsp; twpol.txt<br />[root@centos user]# twadmin -m F -c /etc/tripwire/tw.cfg -S /etc/tripwire/site.key /etc/tripwire/twcfg.txt<br />[root@centos user]# vim /etc/tripwire/twpolmake.pl<br />[root@centos user]# cat /etc/tripwire/twpolmake.pl<br />#!/usr/bin/perl<br /># Tripwire Policy File customize tool<br /># ----------------------------------------------------------------<br /># Copyright (C) 2003 Hiroaki Izumi<br /># This program is free software; you can redistribute it and/or<br /># modify it under the terms of the GNU General Public License<br /># as published by the Free Software Foundation; either version 2<br /># of the License, or (at your option) any later version.<br /># This program is distributed in the hope that it will be useful,<br /># but WITHOUT ANY WARRANTY; without even the implied warranty of<br /># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&nbsp; See the<br /># GNU General Public License for more details.<br /># You should have received a copy of the GNU General Public License<br /># along with this program; if not, write to the Free Software<br /># Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA&nbsp; 02111-1307, USA.<br /># ----------------------------------------------------------------<br /># Usage:<br />#&nbsp;&nbsp;&nbsp;&nbsp; perl twpolmake.pl {Pol file}<br /># ----------------------------------------------------------------<br />#<br />$POLFILE=$ARGV[0];<br />open(POL,"$POLFILE") or die "open error: $POLFILE" ;<br />my($myhost,$thost) ;<br />my($sharp,$tpath,$cond) ;<br />my($INRULE) = 0 ;<br />while (&lt;POL&gt;) {<br />&nbsp;&nbsp;&nbsp; chomp;<br />&nbsp;&nbsp;&nbsp; if (($thost) = /^HOSTNAME\s*=\s*(.*)\s*;/) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $myhost = `hostname` ; chomp($myhost) ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($thost ne $myhost) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $_="HOSTNAME=\"$myhost\";" ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; elsif ( /^{/ ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $INRULE=1 ;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; elsif ( /^}/ ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $INRULE=0 ;<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; elsif ($INRULE == 1 and ($sharp,$tpath,$cond) = /^(\s*\#?\s*)(\/\S+)\b(\s+-&gt;\s+.+)$/) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ret = ($sharp =~ s/\#//g) ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ($tpath eq '/sbin/e2fsadm' ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $cond =~ s/;\s+(tune2fs.*)$/; \#$1/ ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (! -s $tpath) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $_ = "$sharp#$tpath$cond" if ($ret == 0) ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $_ = "$sharp$tpath$cond" ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp; print "$_\n" ;<br />}<br />close(POL) ;<br />[root@centos user]# perl /etc/tripwire/twpolmake.pl /etc/tripwire/twpol.txt &gt; /etc/tripwire/twpol.txt.new <br />[root@centos user]# twadmin -m P -c /etc/tripwire/tw.cfg -p /etc/tripwire/tw.pol -S /etc/tripwire/site.key /etc/tripwire/twpol.txt.new<br />[root@centos user]# tripwire -m i -s -c /etc/tripwire/tw.cfg<br />[root@centos user]# tripwire -m c -s -c /etc/tripwire/tw.cfg<br />Open Source Tripwire(R) 2.4.3.7 Integrity Check Report<br />Report generated by:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; root<br />Report created on:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Вс 29 окт 2023 14:26:04<br />Database last updated on:&nbsp;&nbsp;&nbsp;&nbsp; Never<br />...<br />===============================================================================<br />Object Summary: <br />===============================================================================<br />-------------------------------------------------------------------------------<br /># Section: Unix File System<br />-------------------------------------------------------------------------------<br />No violations.<br />===============================================================================<br />Error Report: <br />===============================================================================<br />...<br />[root@centos user]# ll /var/lib/tripwire/report<br />итого 28<br />-rw-r--r--. 1 root root&nbsp; 350 окт 29 13:55 centos-20231029-135511.twr<br />-rw-r--r--. 1 root root&nbsp; 350 окт 29 13:57 centos-20231029-135712.twr<br />-rw-r--r--. 1 root root&nbsp; 350 окт 29 14:00 centos-20231029-140029.twr<br />-rw-r--r--. 1 root root&nbsp; 350 окт 29 14:08 centos-20231029-140853.twr<br />-rw-r--r--. 1 root root&nbsp; 350 окт 29 14:09 centos-20231029-140919.twr<br />-rw-r--r--. 1 root root 6446 окт 29 14:27 centos-20231029-142604.twr<br />[root@centos user]# touch /var/lib/tripwire/tfile3.txt<br />[root@centos user]# tripwire -m c -s -c /etc/tripwire/tw.cfg<br />Open Source Tripwire(R) 2.4.3.7 Integrity Check Report<br />...<br />-------------------------------------------------------------------------------<br />Rule Name: Tripwire Data Files (/var/lib/tripwire)<br />Severity Level: 100<br />-------------------------------------------------------------------------------<br />Added:<br />"/var/lib/tripwire/tfile3.txt"<br />===============================================================================<br />Error Report: <br />===============================================================================<br />...<br /><strong>Decision:</strong><br />Мы создали файл /var/lib/tripwire/tfile3.txt и утилита tripwire показала нам, что мы создали один файл.<br /><strong>Task:</strong><br />Поиск руткитов. Установка RkHunter, обновление БД вирусов, Создадим образ нашей ОС, для того, чтобы RootKit Hunter мог сравнивать текущее состояние команд в системе с созданной базой, сканируем систему<br /><strong>Decision:</strong><br />[root@centos user]# dnf install rkhunter -y<br />[root@centos user]# rkhunter --update<br />[root@centos user]# cat /etc/rkhunter.conf<br />[root@centos user]# rkhunter --propupd<br />[root@centos user]# rkhunter --check<br />[root@centos user]# cat /var/log/rkhunter/rkhunter.log<br /><strong>Task:</strong><br />добавить выполнение сканирования krootkit в планировщик под пользователем<br /><strong>Decision:</strong><br />[user@centos ~]$ crontab -e<br />[user@centos ~]$ crontab -l<br />0 14 * * *&nbsp;&nbsp;&nbsp; /usr/bin/rkhunter --update; /usr/bin/rkhunter -c --createlogfile --cronjob<br /><strong>Task:</strong><br />Сбор информации до и после взлома<br />сравнить образ раздела или файла перед взломом с образом из взломанной системы.<br /><strong>Decision:</strong><br />[root@centos user]# dd if=/bin/ls of=ls.dd | md5sum ls.dd &gt; sum.txt<br />274+1 записей получено<br />274+1 записей отправлено<br />140760 байт (141 kB, 137 KiB) скопирован, 0,00362538 s, 38,8 MB/s<br />[root@centos user]# cat sum.txt<br />0ad8006df0caff12335f45fdf6c7c0f7&nbsp; ls.dd<br />[root@centos user]# file /bin/ls<br />/bin/ls: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=bdfe7bf382f12e8361d590aa148cb3e591f83d30, for GNU/Linux 3.2.0, stripped<br />[root@centos user]# stat /bin/ls<br />&nbsp; Файл: /bin/ls<br />&nbsp; Размер: 140760&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Блоков: 280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Блок В/В: 4096&nbsp;&nbsp; обычный файл<br />Устройство: fd00h/64768d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Инода: 33894006&nbsp;&nbsp;&nbsp; Ссылки: 1<br />Доступ: (0755/-rwxr-xr-x)&nbsp; Uid: (&nbsp;&nbsp;&nbsp; 0/&nbsp;&nbsp;&nbsp; root)&nbsp;&nbsp; Gid: (&nbsp;&nbsp;&nbsp; 0/&nbsp;&nbsp;&nbsp; root)<br />Контекст: system_u:object_r:bin_t:s0<br />Доступ:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2023-10-29 10:10:37.199000000 +0800<br />Модифицирован: 2023-01-06 19:42:38.000000000 +0800<br />Изменён:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2023-09-28 12:38:12.337575533 +0800<br />Создан:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2023-09-28 12:38:12.333575533 +0800<br /><strong>Task:</strong><br />создать список контрольных сумм для популярных файлов, которые обычно могут изменяться при взломе системы<br /><strong>Decision:</strong><br />[root@centos user]# md5sum /bin/ls &gt;&gt; sums.txt<br />[root@centos user]# cat sums.txt<br />07c62424e4c26afc0d7e393bab60546c&nbsp; /bin/ls<br /><strong>Source:</strong></p>
                        <ul>
                        <li><a href="https://serverspace.ru/support/help/utilita-rsync-dlya-sinkhronizatsii-fajlov/">https://serverspace.ru/support/help/utilita-rsync-dlya-sinkhronizatsii-fajlov/</a></li>
                        <li><a href="https://elatov.github.io/2013/06/migrate-from-libvirt-kvm-to-virtualbox/">https://elatov.github.io/2013/06/migrate-from-libvirt-kvm-to-virtualbox/</a></li>
                        <li><a href="https://www.opennet.ru/tips/1870_qemu_virtualbox_disk.shtml">https://www.opennet.ru/tips/1870_qemu_virtualbox_disk.shtml</a></li>
                        <li><a href="https://blog.sedicomm.com/2016/12/16/iptables-ustanovka-i-nastrojka/?ysclid=ln3wplng53988958006#1">https://blog.sedicomm.com/2016/12/16/iptables-ustanovka-i-nastrojka/?ysclid=ln3wplng53988958006#1</a></li>
                        <li><a href="https://www.youtube.com/playlist?list=PLtSGboPf3g50Aejrp6KjQsqqjxvAO4aKw">https://www.youtube.com/playlist?list=PLtSGboPf3g50Aejrp6KjQsqqjxvAO4aKw</a></li>
                        <li><a href="https://unixcop.com/how-to-install-and-configure-an-ftp-server-on-centos-9-stream/">https://unixcop.com/how-to-install-and-configure-an-ftp-server-on-centos-9-stream/</a></li>
                        <li><a href="https://losst.pro/kak-otkryt-port-iptables?ysclid=lnvrpgxwj8175390861">https://losst.pro/kak-otkryt-port-iptables?ysclid=lnvrpgxwj8175390861</a></li>
                        <li><a href="https://techviewleo.com/configure-vsftpd-ftp-server-on-ubuntu-linux/">https://techviewleo.com/configure-vsftpd-ftp-server-on-ubuntu-linux/</a></li>
                        <li><a href="https://tokmakov.msk.ru/blog/item/477">https://tokmakov.msk.ru/blog/item/477</a></li>
                        <li><a href="https://stackoverflow.com/questions/38523250/vsftpd-login-is-not-successful">https://stackoverflow.com/questions/38523250/vsftpd-login-is-not-successful</a></li>
                        <li><a href="https://linux-notes.org/fil-tratsiya-mac-ispol-zuya-iptables-v-linux/?ysclid=lo0z3u2sro842609893">https://linux-notes.org/fil-tratsiya-mac-ispol-zuya-iptables-v-linux/?ysclid=lo0z3u2sro842609893</a></li>
                        <li><a href="https://ru.linux-console.net/?p=1297&amp;ysclid=lo0tx5owhk496498608">https://ru.linux-console.net/?p=1297&amp;ysclid=lo0tx5owhk496498608</a></li>
                        <li><a href="https://devcoops.com/install-nginx-on-centos-9-stream/">https://devcoops.com/install-nginx-on-centos-9-stream/</a></li>
                        <li><a href="https://itsecforu.ru/2022/01/14/%F0%9F%90%89-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-http-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-kali-linux/?ysclid=lo4exvw84m943299837">https://itsecforu.ru/2022/01/14/%F0%9F%90%89-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-http-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-kali-linux/?ysclid=lo4exvw84m943299837</a></li>
                        <li><a href="https://hackware.ru/?p=15739">https://hackware.ru/?p=15739</a></li>
                        <li><a href="https://support.mozilla.org/ru/kb/parametry-soedineniya-v-firefox">https://support.mozilla.org/ru/kb/parametry-soedineniya-v-firefox</a></li>
                        <li><a href="https://techviewleo.com/configure-squid-proxy-on-centos-almalinux-rhel/">https://techviewleo.com/configure-squid-proxy-on-centos-almalinux-rhel/</a></li>
                        <li><a href="https://uzverss.livejournal.com/109496.html?ysclid=lo9hqkxw2s612202120">https://uzverss.livejournal.com/109496.html?ysclid=lo9hqkxw2s612202120</a></li>
                        <li><a href="https://habr.com/ru/companies/alexhost/articles/531170/">https://habr.com/ru/companies/alexhost/articles/531170/</a></li>
                        <li><a href="https://linux-notes.org/ustanovka-i-nastrojka-tripwire-v-centos-redhat-fedora/?ysclid=loazeq8vjc96566460">https://linux-notes.org/ustanovka-i-nastrojka-tripwire-v-centos-redhat-fedora/?ysclid=loazeq8vjc96566460</a></li>
                        <li><a href="https://linux-notes.org/poisk-rutkitov-v-debian-ubuntu-linux-mint-i-red-hat-centos-fedora/?ysclid=lob3rn9gk6547904603">https://linux-notes.org/poisk-rutkitov-v-debian-ubuntu-linux-mint-i-red-hat-centos-fedora/?ysclid=lob3rn9gk6547904603</a></li>
                        <li><a href="https://winitpro.ru/index.php/2020/04/21/planirovshhik-zadach-cron-v-linux/">https://winitpro.ru/index.php/2020/04/21/planirovshhik-zadach-cron-v-linux/</a></li>
                        <li><a href="https://drive.google.com/drive/folders/1SUpqELdGy0O2zEDbmfnx35zViexy5xZL">https://drive.google.com/drive/folders/1SUpqELdGy0O2zEDbmfnx35zViexy5xZL</a></li>
                        <li><a href="https://losst.ru/kak-polzovatsya-nmap-dlya-skanirovaniya-seti">https://losst.ru/kak-polzovatsya-nmap-dlya-skanirovaniya-seti</a></li>
                        <li><a href="https://www.server-world.info/en/note?os=CentOS_7&amp;p=tripwire">https://www.server-world.info/en/note?os=CentOS_7&amp;p=tripwire</a></li>
                        <li><a href="https://www.lisenet.com/2017/configure-tripwire-on-centos-7/">https://www.lisenet.com/2017/configure-tripwire-on-centos-7/</a></li>
                        <li><a href="https://habr.com/sandbox/29825/">https://habr.com/sandbox/29825/</a></li>
                        <li><a href="https://kamaok.org.ua/?p=813">https://kamaok.org.ua/?p=813</a></li>
                        <li><a href="https://habr.com/company/first/blog/243487/">https://habr.com/company/first/blog/243487/</a></li>
                        <li><a href="https://habr.com/sandbox/29825/">https://habr.com/sandbox/29825/</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Организация локальной сети</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты лабораторных работ по дисциплине Локально-вычислительные сети в виртуальной машине Ubuntu настроил программу для проектирования сетей Packet Tracer, спроектрировал лабораторные работы по темам "Использование DHCP-протокола через маршрутизатор и через сервер", "Wi-Fi - беспроводная передача данных", а также по теме "Локальная сеть" развернул виртуальные машины в Virtualbox две операционные системы Windows 10 и Windows Server 2012 для настройки локальной сети. В Windows Server установил DHCP и DNS сервера и добавил в домен клиентского компьютера Windows 10.<br /><strong>Task:</strong><br />Packet Tracer Install Ubuntu 20.04<br /><strong>Decision:</strong><br />$ sudo virsh start ubuntu22.04<br />$ ssh -X user@IpAddrUbuntu<br />$ google-chrome https://www.google.ru/search?q=cisco+account+create&amp;newwindow=1&amp;source=hp&amp;ei=Z8eqYdOSEcTIrgSIwIeQDQ&amp;iflsig=ALs-wAMAAAAAYarVd9Qob1A5NSTfBETDiQsuP3G5I7gv&amp;ved=0ahUKEwiT4p6Jgsn0AhVEpIsKHQjgAdIQ4dUDCAY&amp;uact=5&amp;oq=cisco+account+create&amp;gs_lcp=Cgdnd3Mtd2l6EAMyBQgAEIAEMgUIABCABDIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjIGCAAQFhAeMgYIABAWEB5QAFgAYPgEaABwAHgAgAGBAYgBgQGSAQMwLjGYAQCgAQKgAQE&amp;sclient=gws-wiz &amp;<br />$ google-chrome https://id.cisco.com/signin/register &amp;<br />$ google-chrome https://temp-mail.org/ &amp;<br />xanaveb196@simdpi.com - https://id.cisco.com/signin/register - mail: xanaveb196@simdpi.com - https://temp-mail.org/ - <br />Активировать Аккаунт - https://id.cisco.com/signin/register - xanaveb196@simdpi.com<br />$ google-chrome https://www.google.ru/search?q=netacad+introduction+to+packet+tracer&amp;newwindow=1&amp;ei=Ks-qYZugA5a_rgTF_beoDw&amp;oq=netacad+into+to+pa&amp;gs_lcp=Cgdnd3Mtd2l6EAMYAjIGCAAQFhAeMgYIABAWEB4yBggAEBYQHjoHCAAQRxCwAzoNCC4QxwEQ0QMQsAMQQzoHCAAQsAMQQzoFCAAQgAQ6BQghEKABOgUIABDNAkoFCDwSATJKBAhBGABKBAhGGABQ96cZWMXDGWC44RloAnACeACAAZwBiAHGCpIBBDAuMTCYAQCgAQHIAQrAAQE&amp;sclient=gws-wiz &amp;<br />$ google-chrome https://www.netacad.com/portal/resources/packet-tracer &amp;<br />$ wget https://www.netacad.com/portal/resources/file/71b29477-0abb-4a52-97eb-cc23d5771574<br />$ ls<br />CiscoPacketTracer_821_Ubuntu_64bit.deb<br />$ sudo dpkg -i CiscoPacketTracer_821_Ubuntu_64bit.deb<br />...<br />dpkg: error processing package packettracer (--install):<br />&nbsp;dependency problems - leaving unconfigured<br />...<br />Errors were encountered while processing:<br />&nbsp;packettracer<br />$ sudo apt install -f<br />$ sudo dpkg -i CiscoPacketTracer_821_Ubuntu_64bit.deb<br />$ packettracer &amp;<br /><strong>Task:</strong><br />The simplest network<br />Для организации простейшей сети потребуется Два компьютера и Патч-корд. В случае отсутствия патч-корда<br />необходимы: Кусок витой пары, Два коннектора RJ45.<br /><strong>Decision:</strong><br />end devices - PC0 - PC1 - connections - copper cross-cover - PC0 - Desktop - ip configuration - ipv4 - 192.168.1.1 - subnet mask - 255.255.255.0 - PC1 - Desktop - ip configuration - ipv4 - 192.168.1.2 - subnet mask - 255.255.255.0 - PC0 - Desktop - Command Prompt<br />C:\&gt;ping 192.168.1.2<br />&nbsp;&nbsp;&nbsp; Pinging 192.168.1.2 with 32 bytes of data:<br />&nbsp;&nbsp;&nbsp; Reply from 192.168.1.2: bytes=32 time&lt;1ms TTL=128<br />&nbsp;&nbsp;&nbsp; Reply from 192.168.1.2: bytes=32 time&lt;1ms TTL=128<br />&nbsp;&nbsp;&nbsp; Reply from 192.168.1.2: bytes=32 time&lt;1ms TTL=128<br />&nbsp;&nbsp;&nbsp; Reply from 192.168.1.2: bytes=32 time&lt;1ms TTL=128<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.1.2:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 0ms, Maximum = 0ms, Average = 0ms<br /><strong>Task:</strong><br />Используем DHCP-протокол через маршрутизатор: We have one switch and router and several computers, Create a DHCP pool (some kind of ip address space), Exclude certain ip addresses, Настроить компьютеры (Убедимся, что ip адреса автоматически добавляются), Проверить связь, See which computers and which ip addresses were issued, Настроим порты, задать VLAN 2,3 на порты fa0/1,2,3,4, The vlan needs to be pushed to the router, Configure the router's sub-interface for 2,3,4 vlans, Configure the DHCP Server. The Dhcp server is located in a separate segment and a broadcast request from computers 3,4,5,6 in the search for a Dhcp server, the router will not pass. Since the computers are in different segments. It is necessary to forward computer requests to the Dhcp server<br /><strong>Decision:</strong><br />Switch -2960 - PC0 - PC1 - PC2 - Router0 - 1841 - Copper Straight-Through - Router0 - CLI<br />Router&gt;en<br />Router#conf t<br />&nbsp;&nbsp;&nbsp; Enter configuration commands, one per line.&nbsp; End with CNTL/Z.<br />Router(config)#int fa0/0<br />Router(config-if)#no sh<br />Router(config-if)#no shutdown<br />Router(config-if)#<br />&nbsp;&nbsp;&nbsp; %LINK-5-CHANGED: Interface FastEthernet0/0, changed state to up<br />&nbsp;&nbsp;&nbsp; %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/0, changed state to up<br />Router(config-if)#ip add<br />Router(config-if)#ip address 192.168.1.1 255.255.255.0<br />Router(config-if)#exit<br />Router(config)#ip dhcp pool DHCP<br />Router(dhcp-config)#network 192.168.1.0 255.255.255.0<br />Router(dhcp-config)#defa<br />Router(dhcp-config)#default-router 192.168.1.1<br />Router(dhcp-config)#dns-server 8.8.8.8<br />Router(dhcp-config)#exit<br />Router(config)#ip dhcp&nbsp; excluded-address 192.168.1.100<br />Router(config)#ip dhcp&nbsp; excluded-address 192.168.1.1<br />Router(config)#exit<br />Router#wr mem<br />PC0,1,2 - Desktop - ip configuration - +DHCP - PC0 - Desktop - command prompt<br />C:\&gt;ping 192.168.1.1<br />...<br />Ping statistics for 192.168.1.1:<br />&nbsp;&nbsp; &nbsp;Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp; &nbsp;Minimum = 0ms, Maximum = 11ms, Average = 2ms<br />C:\&gt;ping 192.168.1.3<br />...<br />Ping statistics for 192.168.1.3:<br />&nbsp;&nbsp; &nbsp;Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp; &nbsp;Minimum = 0ms, Maximum = 1ms, Average = 0ms<br />C:\&gt;ping 192.168.1.4<br />...<br />Ping statistics for 192.168.1.4:<br />&nbsp;&nbsp; &nbsp;Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp; &nbsp;Minimum = 0ms, Maximum = 0ms, Average = 0ms<br />Router0 - CLI<br />Router#show ip dhcp binding<br />IP address&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Client-ID/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Lease expiration&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Hardware address<br />192.168.1.2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0090.21EC.999A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Automatic<br />192.168.1.3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0060.3E23.49DD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Automatic<br />192.168.1.4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0010.1109.2ACD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Automatic<br /><strong>Task:</strong><br />Используем DHCP-протокол через сервер: We have 3 different network segments (Vlan2,3,4) and a dedicated dhcp server, Segmenting our network, Create a VLAN, <br /><strong>Decision:</strong><br />Switch - 2960 - PC3,4,5 - Router1 - 1841 - Sever0 - Copper Straight-Through - switch1 - cli<br />Switch&gt;en<br />Switch#conf t<br />Switch(config)#vlan 2<br />Switch(config-vlan)#name VLAN2<br />Switch(config-vlan)#exit<br />Switch(config)#vlan 3<br />Switch(config-vlan)#name VLAN3<br />Switch(config-vlan)#exit<br />Switch(config)#vlan 4<br />Switch(config-vlan)#name DHCP<br />Switch(config-vlan)#exit<br />Switch(config)#int range fa<br />Switch(config)#int range fastEthernet 0/1-2<br />Switch(config-if-range)#swi<br />Switch(config-if-range)#switchport mode<br />Switch(config-if-range)#switchport mode acc<br />Switch(config-if-range)#switchport mode access<br />Switch(config-if-range)#swi<br />Switch(config-if-range)#switchport acc<br />Switch(config-if-range)#switchport access vla<br />Switch(config-if-range)#switchport access vlan 2<br />Switch(config-if-range)#exit<br />Switch(config)#int range fastEthernet 0/3-4<br />Switch(config-if-range)#switchport mode access<br />Switch(config-if-range)#switchport access vlan 3<br />Switch(config-if-range)#exit<br />Switch(config)#int range fastEthernet 0/5<br />Switch(config-if-range)#switchport mode access<br />Switch(config-if-range)#switchport access vlan 4<br />Switch(config-if-range)#exit<br />Switch(config)#int fa<br />Switch(config)#int fastEthernet 0/6<br />Switch(config-if)#switchport mode trunk<br />Switch(config-if)#swi<br />Switch(config-if)#switchport tr<br />Switch(config-if)#switchport trunk all<br />Switch(config-if)#switchport trunk allowed vla<br />Switch(config-if)#switchport trunk allowed vlan 2,3,4<br />Switch(config-if)#exit<br />Switch(config)#end<br />Switch#wr mem<br />Switch#show run<br />&nbsp;&nbsp;&nbsp; Building configuration...<br />&nbsp;&nbsp;&nbsp; Current configuration : 1388 bytes<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; version 15.0<br />&nbsp;&nbsp;&nbsp; no service timestamps log datetime msec<br />&nbsp;&nbsp;&nbsp; no service timestamps debug datetime msec<br />&nbsp;&nbsp;&nbsp; no service password-encryption<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; hostname Switch<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; spanning-tree mode pvst<br />&nbsp;&nbsp;&nbsp; spanning-tree extend system-id<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 2<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 2<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/3<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 3<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/4<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 3<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/5<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 4<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/6<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport trunk allowed vlan 2-4<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode trunk<br />router1 - cli<br />Router&gt;en<br />Router#conf t<br />Router(config)#int g<br />Router(config)#int gigabitEthernet 0/0.2<br />Router(config-subif)#enc<br />Router(config-subif)#encapsulation do<br />Router(config-subif)#encapsulation dot1Q 2<br />Router(config-subif)#ip<br />Router(config-subif)#ip add<br />Router(config-subif)#ip address 192.168.2.1 255.255.255.0<br />Router(config-subif)#no sh<br />Router(config-subif)#no shutdown<br />Router(config-subif)#exit<br />Router(config)#int gigabitEthernet 0/0<br />Router(config-if)#no shutdown<br />Router(config-if)#<br />&nbsp;&nbsp;&nbsp; %LINK-5-CHANGED: Interface GigabitEthernet0/0, changed state to up<br />&nbsp;&nbsp;&nbsp; %LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/0, changed state to up<br />&nbsp;&nbsp;&nbsp; %LINK-5-CHANGED: Interface GigabitEthernet0/0.2, changed state to up<br />&nbsp;&nbsp;&nbsp; %LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/0.2, changed state to up<br />Router(config-if)#exit<br />Router(config)#int gigabitEthernet 0/0.3<br />Router(config-subif)#<br />&nbsp;&nbsp;&nbsp; %LINK-5-CHANGED: Interface GigabitEthernet0/0.3, changed state to up<br />&nbsp;&nbsp;&nbsp; %LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/0.3, changed state to up<br />Router(config-subif)#encapsulation dot1Q 3<br />Router(config-subif)#ip address 192.168.3.1 255.255.255.0<br />Router(config-subif)#no shutdown<br />Router(config-subif)#exit<br />Router(config)#int gigabitEthernet 0/0.4<br />Router(config-subif)#<br />&nbsp;&nbsp;&nbsp; %LINK-5-CHANGED: Interface GigabitEthernet0/0.4, changed state to up<br />&nbsp;&nbsp;&nbsp; %LINEPROTO-5-UPDOWN: Line protocol on Interface GigabitEthernet0/0.4, changed state to up<br />Router(config-subif)#encapsulation dot1Q 4<br />Router(config-subif)#ip address 192.168.4.1 255.255.255.0<br />Router(config-subif)#no shutdown<br />Router(config-subif)#end<br />Router#<br />Router#wr mem<br />Router#show run<br />&nbsp;&nbsp;&nbsp; Building configuration...<br />&nbsp;&nbsp;&nbsp; Current configuration : 882 bytes<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; version 15.1<br />&nbsp;&nbsp;&nbsp; no service timestamps log datetime msec<br />&nbsp;&nbsp;&nbsp; no service timestamps debug datetime msec<br />&nbsp;&nbsp;&nbsp; no service password-encryption<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; hostname Router<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; ip cef<br />&nbsp;&nbsp;&nbsp; no ipv6 cef<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; license udi pid CISCO2901/K9 sn FTX1524I7AI-<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; spanning-tree mode pvst<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface GigabitEthernet0/0<br />&nbsp;&nbsp;&nbsp;&nbsp; no ip address<br />&nbsp;&nbsp;&nbsp;&nbsp; duplex auto<br />&nbsp;&nbsp;&nbsp;&nbsp; speed auto<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface GigabitEthernet0/0.2<br />&nbsp;&nbsp;&nbsp;&nbsp; encapsulation dot1Q 2<br />&nbsp;&nbsp;&nbsp;&nbsp; ip address 192.168.2.1 255.255.255.0<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface GigabitEthernet0/0.3<br />&nbsp;&nbsp;&nbsp;&nbsp; encapsulation dot1Q 3<br />&nbsp;&nbsp;&nbsp;&nbsp; ip address 192.168.3.1 255.255.255.0<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface GigabitEthernet0/0.4<br />&nbsp;&nbsp;&nbsp;&nbsp; encapsulation dot1Q 4<br />&nbsp;&nbsp;&nbsp;&nbsp; ip address 192.168.4.1 255.255.255.0<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface GigabitEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp; no ip address<br />&nbsp;&nbsp;&nbsp;&nbsp; duplex auto<br />&nbsp;&nbsp;&nbsp;&nbsp; speed auto<br />&nbsp;&nbsp;&nbsp;&nbsp; shutdown<br />&nbsp;&nbsp;&nbsp; !<br />server0 - dekstop - ip configuration - ip address 192.168.4.2 - subnet mask 255.255.255.0 - default gateway 192.168.4.1 - command prompt<br />C:\&gt;ping 192.168.4.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.4.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 0ms, Maximum = 6ms, Average = 1ms<br />&nbsp;&nbsp;&nbsp; services - dhcp - убеждаемся, что видим один дефолтный server pool - pool name DCHP-VLAN2 - start ip address 192.168.2.0 - default gateway 192.168.2.1 - dns server - 8.8.8.8 - service +On - Add - тоже самое для 3тьего vlan<br />Router1 - ClI<br />Router&gt;en<br />Router#conf t<br />Router(config)#int g<br />Router(config)#int gigabitEthernet 0/0.2<br />Router(config-subif)#ip hel<br />Router(config-subif)#ip help<br />Router(config-subif)#ip helper-address 192.168.4.2<br />Router(config-subif)#exit<br />Router(config)#int gigabitEthernet 0/0.3<br />Router(config-subif)#ip helper-address 192.168.4.2<br />Router(config-subif)#end<br />Router#wr mem<br />PC3,4,5,6 - desktop - ip configuration - +dhcp - Убеждаемтся в том, что dhcp автоматически раздал адреса - PC6 - command prompt<br />C:\&gt;ping 192.168.3.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.3.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 0ms, Maximum = 2ms, Average = 1ms<br />C:\&gt;ping 192.168.2.2<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.2.2:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 3, Lost = 1 (25% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 0ms, Maximum = 1ms, Average = 0ms<br /><strong>Task:</strong><br />Wifi: setting up a Wi fi router, Add a custom device laptop, add another stationary computer. assume that the organization already has some kind of network. we need to deploy wi-fi to our organization. we have a guest room of the organization. make sure that the wi-fi network is in a separate segment. On the port that connects to our router1 router, you need to add this vlan4 to trunkport. We need to create a sub interface on our router. Set the possibility to distribute addresses. Add some kind of wireless device, that is, let's assume that a client of the organization came to us and he has a laptop that wants to connect to wifi. Что получить ноутбуку ip адрес wifi нужно определить точку доступа к vlan.<br />Необходимо донастроить nat.&nbsp;&nbsp; &nbsp;<br /><strong>Decision:</strong><br />Router0-CLI<br />Router&gt;en<br />Router#conf t<br />Router(config)#int fa<br />Router(config)#int fastEthernet 0/0<br />Router(config-if)#ip add<br />Router(config-if)#ip address 210.210.0.1 255.255.255.252<br />Router(config-if)#no sh<br />Router(config-if)#no shutdown<br />Router(config-if)#<br />&nbsp;&nbsp;&nbsp; %LINK-5-CHANGED: Interface FastEthernet0/0, changed state to up<br />&nbsp;&nbsp;&nbsp; %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet0/0, changed state to up<br />Router(config-if)#end<br />Router#wr mem<br />Wireless router 0 - gui - static ip - ip address: 210.210.0.2 - subnet mask: 255.255.255.252 - gateway: 210.210.0.1 - save setting - wireless - network name ssid: netskills-home - save setting - wireless security - wpa2 personal - passphase: ciscocisco - save setting<br />lalptop0 - выключаем - убираем (перетаскиваем) подключенный сетевой модуль - заместо него wrc300n - включаем ноутбук - desktop - pc wireless - connect - refresh - netskills-home - connect - pre-shared key - ciscocisco - command promprt<br />C:\&gt;ipconfig<br />&nbsp;&nbsp;&nbsp; Bluetooth Connection:(default port)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Connection-specific DNS Suffix..:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Link-local IPv6 Address.........: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv6 Address....................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv4 Address....................: 0.0.0.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Subnet Mask.....................: 0.0.0.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Default Gateway.................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0<br />&nbsp;&nbsp;&nbsp; Wireless0 Connection:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Connection-specific DNS Suffix..:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Link-local IPv6 Address.........: FE80::202:4AFF:FE66:D186<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv6 Address....................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv4 Address....................: 192.168.0.100<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Subnet Mask.....................: 255.255.255.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Default Gateway.................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.0.1<br />C:\&gt;ping 192.168.0.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.0.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 23ms, Maximum = 122ms, Average = 56ms<br />C:\&gt;ping 210.210.0.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 210.210.0.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 3, Lost = 1 (25% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 17ms, Maximum = 32ms, Average = 26ms<br />pc0 - ip conf - dbhcp - command prompt<br />C:\&gt;ping 192.168.0.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.0.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 0ms, Maximum = 1ms, Average = 0ms<br />C:\&gt;ping 210.210.0.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 210.210.0.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 0ms, Maximum = 1ms, Average = 0ms<br />C:\&gt;ping 192.168.0.100<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.0.100:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 11ms, Maximum = 158ms, Average = 62ms<br />Switch0 - CLI<br />Switch&gt;en<br />Switch#show run<br />&nbsp;&nbsp;&nbsp; Building configuration...<br />&nbsp;&nbsp;&nbsp; Current configuration : 1436 bytes<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; version 12.2<br />&nbsp;&nbsp;&nbsp; no service timestamps log datetime msec<br />&nbsp;&nbsp;&nbsp; no service timestamps debug datetime msec<br />&nbsp;&nbsp;&nbsp; no service password-encryption<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; hostname Switch<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; spanning-tree mode pvst<br />&nbsp;&nbsp;&nbsp; spanning-tree extend system-id<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp; description ToRouter<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport trunk allowed vlan 2-4<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode trunk<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp; description Users<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 2<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/3<br />&nbsp;&nbsp;&nbsp;&nbsp; description Users<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 2<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/4<br />&nbsp;&nbsp;&nbsp;&nbsp; description srv<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 3<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/5<br />&nbsp;&nbsp;&nbsp;&nbsp; description WiFi-AP<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 4<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/6<br />&nbsp;&nbsp;&nbsp; !<br /><br />&nbsp;&nbsp;&nbsp; router1-cli<br />Switch&gt;en<br />Switch#show run<br />&nbsp;&nbsp;&nbsp; Building configuration...<br />&nbsp;&nbsp;&nbsp; Current configuration : 1436 bytes<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; version 12.2<br />&nbsp;&nbsp;&nbsp; no service timestamps log datetime msec<br />&nbsp;&nbsp;&nbsp; no service timestamps debug datetime msec<br />&nbsp;&nbsp;&nbsp; no service password-encryption<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; hostname Switch<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; spanning-tree mode pvst<br />&nbsp;&nbsp;&nbsp; spanning-tree extend system-id<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp; description ToRouter<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport trunk allowed vlan 2-4<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode trunk<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp; description Users<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 2<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/3<br />&nbsp;&nbsp;&nbsp;&nbsp; description Users<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 2<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/4<br />&nbsp;&nbsp;&nbsp;&nbsp; description srv<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 3<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/5<br />&nbsp;&nbsp;&nbsp;&nbsp; description WiFi-AP<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport access vlan 4<br />&nbsp;&nbsp;&nbsp;&nbsp; switchport mode access<br />&nbsp;&nbsp;&nbsp; !<br />&nbsp;&nbsp;&nbsp; interface FastEthernet0/6<br />&nbsp;&nbsp;&nbsp; !<br />access point0 - config - port1 - ssid: netskill - wpa2-psk - pass phrase: ciscocisco<br />switch-cli<br />#en<br /># conf t<br /># vlan 4<br /># name wifi<br /># end<br />#show run<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; switchport trunk allowed vlan 2-4<br />router1 - cli<br />#en<br /># conf t<br /># int fa0/1.4<br /># encapsulation dot1Q 4<br /># ip address 192.168.4.1 255.255.255.0<br /># no shutdown<br /># end<br /># conf t<br /># ip dhcp pool Wifi-pool<br /># network 192.168.4.0 255.255.255.0<br /># default-router 192.168.4.1<br /># exit<br /># ip dhcp excluded-address 192.168.4.1<br /># end<br /># wr mem<br />Laptop1 - выключаем - убираем (перетаскиваем) подключенный сетевой модуль - заместо него wrc300n - включаем ноутбук - desktop - pc wireless - connect - refresh - netskills - save setting - wireless security - wpa2 personal - passphase: ciscocisco - save setting - command prompt<br />switch0-cli<br />#en<br /># conf t<br /># switchport mode access<br /># switchport access vlan 4<br /># description WiFi-AP<br /># end<br /># wr mem<br />Router1-cli<br /># en<br /># conf t<br /># ip access-list standart FOR-NAT<br /># permit 192.168.4.0&nbsp; 0.0.0.255<br /># exit<br /># int fa0/1.4<br /># ip nat inside<br /># end<br /># wr mem<br />lalptop1 - ip configuration - dhcp - ok - command prompt<br />C:\&gt;ipconfig<br />&nbsp;&nbsp;&nbsp; Bluetooth Connection:(default port)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Connection-specific DNS Suffix..:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Link-local IPv6 Address.........: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv6 Address....................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv4 Address....................: 0.0.0.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Subnet Mask.....................: 0.0.0.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Default Gateway.................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0.0.0<br />&nbsp;&nbsp;&nbsp; Wireless0 Connection:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Connection-specific DNS Suffix..:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Link-local IPv6 Address.........: FE80::203:E4FF:FE34:D1E7<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv6 Address....................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IPv4 Address....................: 192.168.4.2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Subnet Mask.....................: 255.255.255.0<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Default Gateway.................: ::<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 192.168.4.1<br />C:\&gt;ping 192.168.4.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.4.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 48ms, Maximum = 171ms, Average = 96ms<br />C:\&gt;ping 192.168.2.3<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 192.168.2.3:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 3, Lost = 1 (25% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 27ms, Maximum = 60ms, Average = 39ms<br />C:\&gt;ping 210.210.0.1<br />&nbsp;&nbsp;&nbsp; ...<br />&nbsp;&nbsp;&nbsp; Ping statistics for 210.210.0.1:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),<br />&nbsp;&nbsp;&nbsp; Approximate round trip times in milli-seconds:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minimum = 38ms, Maximum = 69ms, Average = 52ms<br /><strong>Task:</strong><br />Install VirtualBox<br /><strong>Decision:</strong><br />$ sudo dnf config-manager --add-repo=https://download.virtualbox.org/virtualbox/rpm/el/virtualbox.repo<br />$ sudo rpm --import https://www.virtualbox.org/download/oracle_vbox.asc<br />$ sudo dnf install https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm<br />$ sudo dnf install binutils kernel-devel kernel-headers libgomp make patch gcc glibc-headers glibc-devel dkm<br />$ sudo dnf search virtualbox<br />$ sudo dnf install VirtualBox-7.0<br />$ sudo usermod -aG vboxusers $USER<br />$ newgrp vboxusers<br />$ wget https://download.virtualbox.org/virtualbox/7.0.10/Oracle_VM_VirtualBox_Extension_Pack-7.0.10-158379.vbox-extpack<br />$ sudo VBoxManage extpack install Oracle_VM_VirtualBox_Extension_Pack-7.0.10-158379.vbox-extpack<br /><strong>Task:</strong><br />Использовать Virtualbox<br /><strong>Decision:</strong><br />$ VBoxManage list ostypes<br />...<br />ID:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Windows2012_64<br />Description: Windows 2012 (64-bit)<br />Family ID:&nbsp;&nbsp; Windows<br />Family Desc: Microsoft Windows<br />64 bit:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; true<br />...<br />$ VBoxManage createvm --name "Windows2012" --ostype "Windows2012_64" --register --basefolder /vboximages/<br />$ vboxmanage modifyvm Windows2012 --memory 2048 --vram 128<br />$ vboxmanage modifyvm Windows2012 --nic1 bridged<br />$ vboxmanage createhd --filename /vboximages/Windows2012/Windows2012_DISK.vdi --size 75000 --format VDI <br />$ vboxmanage storagectl Windows2012 --name "SATA Controller" --add sata --controller IntelAhci<br />$ vboxmanage storageattach Windows2012 --storagectl "SATA Controller" --port 0 --device 0 --type hdd --medium /vboximages/Windows2012/Windows2012_DISK.vdi<br />$ vboxmanage storagectl Windows2012 --name "IDE Controller" --add ide --controller PIIX4<br />$ vboxmanage storageattach Windows2012 --storagectl "IDE Controller" --port 1 --device 0 --type dvddrive --medium /iso/Server2012.iso<br />$ vboxmanage modifyvm Windows2012 --boot1 dvd --boot2 disk --boot3 none --boot4 none<br />$ vboxmanage modifyvm Windows2012 --vrde on<br />$ vboxmanage modifyvm Windows2012 --vrdemulticon on --vrdeport 10001<br />$ vboxmanage modifyvm Windows2012 --graphicscontroller vboxsvga<br />$ vboxmanage sharedfolder add Windows2012 --name "Загрузки" --hostpath /Загрузки/ --automount<br />$ vboxmanage startvm --type gui Windows2012 &amp;<br /><strong>Task:</strong><br />Установить DHCP и DNS сервера, добавить в домен клиентского компьютера, и проверить их работоспособность. Делать это все мы будем в виртуальной машине KVM с установленными операционными системами Windows Server 2019 и Windows 10. В KVM когда настраиваем сеть операционных систем, нужно подключить внутреннюю сеть и в неразборчивом режиме разрешить все. После чего для настройки сервера запускаем Windows Server 2019<br /><strong>Decision:</strong><br />Диспетчер серверов - Локальная сеть - ipv4 - уберем галочку ipv6 - нажмем на ipv4 - настроить - прописать адреса: <br />ip-адрес 192.168.0.1<br />маска подсети 255.255.255.0<br />Основной шлюз 192.168.0.1<br />Предпочитаемый Днс-сервер 8.8.8.8<br />Диспетчер серверов - Локальная сеть - имя компьютера - изменить (например, Server) - перезагрузиться<br />Диспетчер серверов - Локальная сеть - управление - добавить роли и компоненты - тип установки - установка ролей и компонентов - выбор сервера - видим наш сервер (Server) и выбираем его - роли сервера ставим флажок на DNS-сервер и доменные службы Active Directory - компоненты - Windows Powershell - подтверждаем - ставим галочку на автоматический перезапуск - устанавливаем - Диспетчер серверов - Локальная сеть - видим восклицательный знак - повысить роли и компоненты - в конфигурации развертывания добавить новый лес - даем имя корневого раздела (на моем примере - server.local) - придумываем пароль, имя домена - устанавливаем<br />Диспетчер серверов - Локальная сеть - Средства - DNS - в зоне обратного просмотра правой кнопкой мыши создаем новую зону - добавляем идентификатор сети 192.168.0. <br />Сеть и интернет - центр управления сетями - дополнительные параметры - +включить сетевые обнаружения - +включить общий доступ к файлам и принтерам - вернемся обратно и снова зайдем в дополнительные парметры, увидиим что сохранения не изменинились. Для этого нужно зайти в диспетчер задач - службы - находим Публикация ресурсов обнаружения функции, Обнаружение SSDP - тип запуска у всех Автоматически - запускаем - Сеть и интернет - центр управления сетями - дополнительные параметры - оставляем флажки на "включить сетевые обнаружения" и "включить общий доступ к файлам и принтерам"<br />Диспетчер серверов - Локальная сеть - Управление - добавить роли и компоненты - тип установки - установка ролей и компонентов - роли сервера - добавим флажок на DHCP-сервер - подтверждаем - ставим галочку на автоматический перезапуск - устанавливаем - по восклицательному знаку в разделе Локальная сеть - настраиваем DHCP - имя пользователя - добавляем то самое имя учетной записи, с которой мы все это настраиваем (в моем случае - Администратор) - фиксируем <br />Диспетчер серверов - Локальная сеть - средства - DHCP - IPv4 правой кнопкой мыши создаем область - пишем имя области (в моем случае - Server) - добавляем диапозон айпи адресов и маску:<br />Начальный IP адрес 192.168.0.10<br />Конечный IP адрес 192.168.0.20<br />Длина 24<br />маска подсети 255.255.255.0<br />срок действия аренды я выбрал 7 дней - добавляем айпи адрес маршрутизатора 192.168.0.1. В DHCP - IPv4 - область 192.168.0.0 - пул ардесов - должна появиться инфа по DHCP<br />панельуправлени - система безопасности - брандмауер - включение и отключение брандмауера<br />$ sudo virsh start Windows<br />$ virt-viewer --connect qemu:///system --wait Windows<br />свойства компьютера - изменить настройки,изменить - ставим флажок на добавление домена - вводим в домен (в моем случае это server.local) - вводим данные сервера (имя и пароль учетки сервера) - После перезагрузки можем спокойно работать в домене.<br /><strong>Task:</strong><br />Перенос виртуальной машины VirtualBox в KVM<br /><strong>Decision:</strong><br />$ vboxmanage list hdds<br />UUID:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 90d93e42-c567-4ff4-8ab8-5a21971604dc<br />Parent UUID:&nbsp;&nbsp;&nbsp; base<br />State:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; created<br />Type:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; normal (base)<br />Location:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /vboximages/Windows2012/Windows2012_DISK.vdi<br />Storage format: VDI<br />Capacity:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 75000 MBytes<br />Encryption:&nbsp;&nbsp;&nbsp;&nbsp; disabled<br />$ VBoxManage clonehd /vboximages/Windows2012/Snapshots/\{41cf81da-b2f5-4dfe-9afb-e5c0d5f0d301\}.vdi /vboximages/Windows2012/Windows12static.vdi --format VDI --variant Fixed<br />$ sudo qemu-img convert -f vdi /vboximages/Windows2012/Windows12static.vdi -O qcow2 /images/Windows12.qcow2<br />$ sudo virt-install --osinfo list<br />...<br />win2k12r2<br />...<br />$ sudo virt-install \<br />--name Windows12 \<br />--ram 2048 \<br />--vcpus=2 \<br />--import \<br />--disk path=/images/Windows12.qcow2,format=qcow2 \<br />--vnc \<br />--noautoconsole \<br />--os-variant win2k12r2 \<br />--accelerate \<br />--network bridge=br0<br />$ virt-viewer --connect qemu:///system --wait Windows12<br /><strong>Decision:</strong><br />Вернемся к серверу - меню пуск - администрирование - DHCP-сервер - IPv4 - область - арендованные адреса видим наш клиентский компьютер<br />$ sudo virsh shutdown Windows<br />$ vboxmanage controlvm Windows12 poweroff soft<br /><strong>Source:</strong></p>
                        <ul>
                        <li><a href="https://www.youtube.com/watch?v=04VpVYO7F78">https://www.youtube.com/watch?v=04VpVYO7F78</a></li>
                        <li><a href="https://www.youtube.com/watch?v=kg5CalaPOLA">https://www.youtube.com/watch?v=kg5CalaPOLA</a></li>
                        <li><a href="https://www.youtube.com/playlist?list=PLcDkQ2Au8aVNYsqGsxRQxYyQijILa94T9">https://www.youtube.com/playlist?list=PLcDkQ2Au8aVNYsqGsxRQxYyQijILa94T9</a></li>
                        <li><a href="https://www.linuxhowto.net/how-to-install-virtualbox-on-rhel-9-step-by-step/?ysclid=ln2gkjl488389400056">https://www.linuxhowto.net/how-to-install-virtualbox-on-rhel-9-step-by-step/?ysclid=ln2gkjl488389400056</a></li>
                        <li><a href="https://www.dmosk.ru/miniinstruktions.php?mini=virtualbox-install">https://www.dmosk.ru/miniinstruktions.php?mini=virtualbox-install</a></li>
                        <li><a href="https://devminz.github.io/posts/devops/virtualbox-cli-vm-bridged-networking/">https://devminz.github.io/posts/devops/virtualbox-cli-vm-bridged-networking/</a></li>
                        <li><a href="https://urn.su/dvps/virtualbox/vboxmanage/?ysclid=ln6wyljfpr336059458">https://urn.su/dvps/virtualbox/vboxmanage/?ysclid=ln6wyljfpr336059458</a></li>
                        <li><a href="https://urn.su/dvps/virtualbox/vboxmanage/man/?ysclid=ln6xc4orjl822339529">https://urn.su/dvps/virtualbox/vboxmanage/man/?ysclid=ln6xc4orjl822339529</a></li>
                        <li><a href="https://askubuntu.com/questions/161759/how-to-access-a-shared-folder-in-virtualbox">https://askubuntu.com/questions/161759/how-to-access-a-shared-folder-in-virtualbox</a></li>
                        <li><a href="https://superuser.com/questions/116946/how-do-i-press-ctrlaltdelete-in-virtualbox">https://superuser.com/questions/116946/how-do-i-press-ctrlaltdelete-in-virtualbox</a></li>
                        <li><a href="https://www.youtube.com/playlist?list=PL90TRL5CLgV68UQJZIWU_aoQhQGSXZJiS">https://www.youtube.com/playlist?list=PL90TRL5CLgV68UQJZIWU_aoQhQGSXZJiS</a></li>
                        <li><a href="https://obu4alka.ru/perenos-virtualnoj-mashiny-virtualbox-v-kvm.html">https://obu4alka.ru/perenos-virtualnoj-mashiny-virtualbox-v-kvm.html</a></li>
                        <li><a href="https://doc.s-terra.ru/rh_output/4.2/Virt_gate/output/mergedProjects/KVM/%D0%98%D0%BC%D0%BF%D0%BE%D1%80%D1%82_%D0%B2_KVM.htm">https://doc.s-terra.ru/rh_output/4.2/Virt_gate/output/mergedProjects/KVM/%D0%98%D0%BC%D0%BF%D0%BE%D1%80%D1%82_%D0%B2_KVM.htm</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Использование данных с одночастотных приемников спутниковых радионавигационных систем для коррекции модели ионосферы</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для защиты диссертации по теме "Использование данных с одночастотных приемников спутниковых радионавигационных систем для коррекции модели ионосферы" освоил технологию приёма получения данных с одночастотных приемников спутниковых радионавигационных систем, получил данные, разработал программу на C++, которая обрабатывает и сортирует данные двух координат из файла по столбцам, рисует график, чтобы увидеть желаемый результат в точности определения координат спутников, рассмотрел способы уменьшения ошибок измерения псевдодальности и показал, что из-за нестабильности аппаратуры потребителя информация о состоянии ионосферы может быть получена в каждый момент времени по разностям ПД двух навигационных спутников <br /><strong>Task:</strong><br />Установка виртуальной машины Windows в Qemu-Kvm<br /><strong>Decision:</strong><br /># virt-install \<br />--name Windows \<br />--ram 2048 \<br />--disk path=/var/lib/libvirt/images/Windows.img,size=75 \<br />--vcpus 2 \<br />--os-variant Windows \<br />--network bridge=br0 \<br />--graphics none \<br />--console pty,target_type=serial \<br />--location /var/lib/libvirt/iso/Windows.iso \<br />--extra-args 'console=ttyS0,115200n8'<br />$ sudo virsh list --all<br />&nbsp;ID&nbsp;&nbsp; Имя&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Состояние<br />-------------------------------<br />...<br />&nbsp;-&nbsp;&nbsp;&nbsp; Windows&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; выключен<br />$ sudo virsh start Windows<br /><strong>Task:</strong><br />Настройка удаленного доступа к виртуальной машине для передачи файлов<br /><strong>Decision:</strong><br />Панель управления - Система - Настройка удаленного доступа - +разрешить подключения удаленного помощника к этому компьютеру - +разрешить удаленные подключения к этому компьютеру - -Разрешить подключение только с компьютеров, ...<br />$ sudo dnf install rdesktop<br />$ rdesktop IP -u tuser -p tpassword -g 1400x900<br />PS C:\Windows\system32&gt; Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0<br />PS C:\Windows\system32&gt; Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0<br />PS C:\Windows\system32&gt; Get-WindowsCapability -Online | Where-Object Name -like 'OpenSSH*'<br />Name&nbsp; : OpenSSH.Client~~~~0.0.1.0<br />State : Installed<br />Name&nbsp; : OpenSSH.Server~~~~0.0.1.0<br />State : Installed<br />PS C:\Windows\system32&gt; Start-Service sshd<br />PS C:\Windows\system32&gt; Set-Service -Name sshd -StartupType 'Automatic'<br />PS C:\Windows\System32\OpenSSH&gt; notepad.exe C:\ProgramData\ssh\sshd_config<br />tuser@KVM-TWINDOWS C:\Users\tuser&gt;type C:\ProgramData\ssh\sshd_config<br />...<br />PasswordAuthentication yes<br />...<br /># override default of no subsystems<br />Subsystem&nbsp;&nbsp; &nbsp;sftp&nbsp;&nbsp; &nbsp;sftp-server.exe<br />...<br />Match User tuser<br />&nbsp;&nbsp; &nbsp;ChrootDirectory C:\Users\tuser\Documents<br />#&nbsp;&nbsp; &nbsp;ForceCommand internal-sftp<br />&nbsp;&nbsp; &nbsp;X11Forwarding yes<br />...<br />PS C:\Windows\System32\OpenSSH&gt; Restart-Service sshd<br />$ ssh tuser@IP<br />tuser@KVM-TWINDOWS C:\Users\tuser&gt;powershell<br />PS C:\Users\tuser&gt; Start-Process powershell -Verb runAs<br />PS C:\Users\tuser&gt; exit<br />$ ls<br />DataProcessingInCpp&nbsp; Drivers&nbsp; ReceivingDataFromSatellite<br />$ sftp tuser@IP<br />sftp&gt; put -r ReceivingDataFromSatellite<br />sftp&gt; put -r DataProcessingInCpp<br />sftp&gt; ls<br />DataProcessingInCpp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />ReceivingDataFromSatellite <br />sftp&gt; exit<br />$ rdesktop IP -u tuser -p tpassword -g 1400x900 &amp;<br /><strong>Task:</strong><br />Получение данных с одночастотного приемника СРНС<br /><strong>Decision:</strong><br />Для проверки способа определения вариации ионосферной задержки 19 мая 2015 года провел обработку данных измерения навигационных сигналов от нескольких НС. Для измерений использовался 20 канальный&nbsp; одночастотный&nbsp; приемник BU-353 фирмы&nbsp; GlobalSat. Этот приемник предназначен для ГНСС GPS, работает на частоте L1 по C/A коду и имеет высокую чувствительность 159 дБм. Данные о псевдодальностях доступны только при использовании бинарного протокола, поэтому при наблюдениях применялась программа SirfTech версии 2.20 и данные записывались в RINEX файл. <br /><strong>Task:</strong><br />Установка Borland C++ Builder под Windows<br /><strong>Decision:</strong><br />$ ssh tuser@IP<br />tuser@KVM-TWINDOWS C:\Users\tuser&gt;powershell<br />PS C:\users\tuser\documents&gt; Mount-DiskImage -ImagePath "C:\users\tuser\documents\DataProcessingInCpp\Borland C++ Builder 6.0 Enterprise [cd1].iso"<br />zPS C:\users\tuser\documents&gt; Get-PSDrive -PSProvider FileSystem<br />Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Used (GB)&nbsp;&nbsp;&nbsp;&nbsp; Free (GB) Provider&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Root&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CurrentLocation <br />----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---------&nbsp;&nbsp;&nbsp;&nbsp; --------- --------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --------------- <br />C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 25,27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 49,16 FileSystem&nbsp;&nbsp;&nbsp; C:\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; users\tuser\documents <br />D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4,32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,00 FileSystem&nbsp;&nbsp;&nbsp; D:\<br />E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileSystem&nbsp;&nbsp;&nbsp; E:\<br />F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,61&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,00 FileSystem&nbsp;&nbsp;&nbsp; F:\<br />PS C:\users\tuser\documents&gt; ls F:\<br />&nbsp;&nbsp;&nbsp; Каталог: F:\<br />Mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LastWriteTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Length Name<br />----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ------ ----<br />d-----&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Install<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 29550 license.txt<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 54878 readme.rtf<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 33959 readme.txt<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 29550 license.txt<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 54878 readme.rtf<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 33959 readme.txt<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5337 remote.rtf<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1750 remote.txt<br />--r---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 01.02.2002&nbsp;&nbsp;&nbsp;&nbsp; 17:00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1750 install.exe<br />Запустим от администратора install.exe - выбираем С++ Builder 6 - нужно ввести сгенерированный ключ программы, зайдя в папку Borland - запустить генератор ключей Borland KeyGen - копируем - вставляем серийный номер - ключ программы в установщик<br />PS C:\users\tuser\documents&gt; Dismount-DiskImage -ImagePath "C:\users\tuser\documents\DataProcessingInCpp\Borland C++ Builder 6.0 Enterprise [cd1].iso" <br />PS C:\users\tuser\documents&gt; Mount-DiskImage -ImagePath "C:\users\tuser\documents\DataProcessingInCpp\Borland C++ Builder 6.0 Enterprise [cd2].iso"<br />Ок - finish - NO (Ни в коем случае не перезагружаться)<br />PS C:\users\tuser\documents&gt; Dismount-DiskImage -ImagePath "C:\users\tuser\documents\DataProcessingInCpp\Borland C++ Builder 6.0 Enterprise [cd2].iso" <br />C:\Programms file (x86)\Bornald\Builder\Bin\ - свойства совместимости bcb.exe - +всегда выполнять от администратора это программу - Запускаем bcb.exe - +регистрируем ее с помощью генератора ключей Borland KeyGe - копировать - вставить - перезагрузиться<br /><strong>Task:</strong><br />Мы хотим чтобы наша программа с графическим интерфейсом с нами поздоровалась в Bornald Builder<br /><strong>Decision:</strong><br />//---------------------------------------------------------------------------<br />#include &lt;vcl.h&gt;<br />#pragma hdrstop<br />#include "Unit1.h"<br />//---------------------------------------------------------------------------<br />#pragma package(smart_init)<br />#pragma resource "*.dfm"<br />TForm1 *Form1;<br />//---------------------------------------------------------------------------<br />__fastcall TForm1::TForm1(TComponent* Owner)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : TForm(Owner)<br />{<br />}<br />//---------------------------------------------------------------------------<br />void __fastcall TForm1::Button1Click(TObject *Sender)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShowMessage("Hello world!");<br />}<br />//---------------------------------------------------------------------------<br /><strong>Task:</strong><br />Для дальнейшей обработки и сортировки данных мною была написана программа на языке С++, которая считывает rinex файлы в текстовом формате и сортирует псевдодальности по каждому НС, что упрощает дальнейшую обработку.<br /><strong>Task:</strong><br />Попробуем в файле irkj1380.txt вывести всю информацию до END OF HEADER в out.txt.<br /><strong>Decision:</strong><br />&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OBSERVATION DATA&nbsp;&nbsp;&nbsp; M (MIXED)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RINEX VERSION / TYPE<br />CCRINEXO V2.4.1 LH&nbsp; imvp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 19-MAY-15 06:30&nbsp;&nbsp;&nbsp;&nbsp; PGM / RUN BY / DATE<br />no comments&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; COMMENT<br />JPS2RIN 1.40 LNX&nbsp;&nbsp;&nbsp; IMVP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18-MAY-15 01:08&nbsp;&nbsp;&nbsp;&nbsp; COMMENT<br />BUILD MAY 14 2009 (C) TOPCON POSITIONING SYSTEMS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; COMMENT<br />IRKJ40190000.JPS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; COMMENT<br />SE TPS 00000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; COMMENT<br />IRKJ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MARKER NAME<br />12313M002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MARKER NUMBER<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS NIIFTRI, IRKUTSK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; OBSERVER / AGENCY<br />00517&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JPS LEGACY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2.6.0 OCT,24,2007&nbsp;&nbsp; REC # / TYPE / VERS<br />RA0225&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; JPSREGANT_SD_E1 NONE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ANT # / TYPE<br />&nbsp; -968328.4915&nbsp; 3794423.9665&nbsp; 5018165.4637&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; APPROX POSITION XYZ<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.1280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0.0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ANTENNA: DELTA H/E/N<br />&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WAVELENGTH FACT L1/2<br />&nbsp;&nbsp;&nbsp;&nbsp; 7&nbsp;&nbsp;&nbsp; C1&nbsp;&nbsp;&nbsp; P1&nbsp;&nbsp;&nbsp; P2&nbsp;&nbsp;&nbsp; L1&nbsp;&nbsp;&nbsp; L2&nbsp;&nbsp;&nbsp; D1&nbsp;&nbsp;&nbsp; D2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # / TYPES OF OBSERV<br />&nbsp;&nbsp;&nbsp; 30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INTERVAL<br />&nbsp; 2015&nbsp;&nbsp;&nbsp;&nbsp; 5&nbsp;&nbsp;&nbsp; 18&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; 0.000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GPS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TIME OF FIRST OBS<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; END OF HEADER<br /><strong>Task:</strong><br />Вывести следующую строку после END OF HEADER<br /><strong>Decision:</strong><br />15&nbsp; 5 18&nbsp; 0&nbsp; 0&nbsp; 0.0000000&nbsp; 1 19G01G04G11G12G14G18G22G24G25G31G32R05<br /><strong>Task:</strong><br />Выведем количество спутников и названия спутников в строке<br /><strong>Decision:</strong><br />19<br />G01G04G11G12G14G18G22G24G25G31G32R05<br /><strong>Task:</strong><br />нужно сделать так, что бы строка G01G04G11G12G14G18G22G24G25G31G32R05 читалась буквам, то есть создаем динамический массив с указателем.<br /><strong>Decision:</strong><br />19<br />G01G04G11G12G14G18G22G24G25G31G32R05<br />G<br />G<br />G<br />G<br />G<br />G<br />G<br />G<br />G<br />G<br />G<br />R<br /><strong>Task:</strong><br />Вывести вторую строку.<br /><strong>Decision:</strong><br />19<br />G01G04G11G12G14G18G22G24G25G31G32R05<br />R06R07R09R15R16R22R23<br /><strong>Task:</strong><br />Вывести буквы спутников в столбец.<br /><strong>Decision:</strong><br />19<br />G01G04G11G12G14G18G22G24G25G31G32R05<br />R<br />R<br />R<br />R<br />R<br />R<br />R<br /><strong>Task:</strong><br />вывести по буквам и по цифрам. если увидим пробел, тогда операция не должна выполняться.<br /><strong>Decision:</strong><br />19<br />G01G04G11G12G14G18G22G24G25G31G32R05<br />R<br />0<br />6<br />R<br />0<br />7<br />R<br />0<br />9<br />R<br />1<br />5<br />R<br />1<br />6<br />R<br />2<br />2<br />R<br />2<br />3<br /><strong>Task:</strong><br />вывести все спутники в столбец.<br /><strong>Decision:</strong><br />19<br />G01<br />G04<br />G11<br />G12<br />G14<br />G18<br />G22<br />G24<br />G25<br />G31<br />G32<br />R05<br />R06<br />R07<br />R09<br />R15<br />R16<br />R22<br />R23<br /><strong>Task:</strong><br />Нужно вывести псевдодальности для одной/первой эпохи (время - 0:0).<br /><strong>Decision:</strong><br />19<br />G01 G04 G11 G12 G14 G18 G22 G24 G25 G31 G32 R05 R06 R07 R09 R15 R16 R22 R23 2.40771e+07<br />2.28061e+07<br />2.4023e+07<br />2.23889e+07<br />2.06979e+07<br />2.17159e+07<br />2.04115e+07<br />2.22393e+07<br />2.35478e+07<br />2.41313e+07<br />2.3745e+07<br />2.20981e+07<br />1.91242e+07<br />2.1007e+07<br />2.22533e+07<br />2.12016e+07<br />1.94745e+07<br />2.35659e+07<br />2.28647e+07<br /><strong>Task:</strong><br />мы вывели все псевдодальности для каждого спутника, но только для первой эпохи (время - 0:0). Чтобы посчитать для каждой эпохи, давайте переделаем программу, используя векторы. Сначала попробуем также считать и вывести названия спутников для первой эпохи.<br /><strong>Decision:</strong><br />19<br />G01<br />G04<br />G11<br />G12<br />G14<br />G18<br />G22<br />G24<br />G25<br />G31<br />G32<br />R05<br />R06<br />R07<br />R09<br />R15<br />R16<br />R22<br /><strong>Task:</strong><br />вывести псевдодальности для каждого спутника.<br /><strong>Decision:</strong><br />19<br />G01 G04 G11 G12 G14 G18 G22 G24 G25 G31 G32 R05 R06 R07 R09 R15 R16 R22 R23<br />24077128.1194 22806124.8054 24022983.9984 22388929.9144 20697892.8884 21715906.8854 20411541.2704 22239301.1624 23547808.7034 24131268.6434 23745039.8404 22098086.832 19124242.27 21007031.526 22253250.468 21201583.22 19474489.084 23565923.703 22864670.122 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0<br /><strong>Task:</strong><br />Попробуем и для первой и для второй эпохи (время: 0:00 - 0:30) проделать такие операции. Выводится название спутника, и расстояние (дальность) спутника. первая строка - для первой эпохи, вторая строка - для второй эпохи<br /><strong>Decision:</strong><br />19<br />19<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G31&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R23<br />24077128.1194 22806124.8054 24022983.9984 22388929.9144 20697892.8884 21715906.8854 20411541.2704 22239301.1624 23547808.7034 24131268.6434 23745039.8404&nbsp; 22098086.832&nbsp;&nbsp; 19124242.27&nbsp; 21007031.526&nbsp; 22253250.468&nbsp;&nbsp; 21201583.22&nbsp; 19474489.084&nbsp; 23565923.703&nbsp; 22864670.122&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />24065818.3394 22804492.2684 24023768.7094 22378483.9394 20691105.4344 21730480.5744 20415751.1104 22255260.6984 23528148.4594 24109572.7604 23726475.0794&nbsp; 22118176.666&nbsp; 19126075.998&nbsp; 20989472.459&nbsp; 22228716.936&nbsp; 21220136.852&nbsp; 19466441.002&nbsp;&nbsp; 23584399.66&nbsp; 22865445.005&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br /><strong>Task:</strong><br />наведем теперь порядок в коде, чтобы все переменные были наверху, во вторых, чтобы постоянно вручную не считывать дальность для каждого спутника и для каждой эпохи, давайте изменим программу. Создадим цикл. 4 - 4 эпохи (время 0:00-1:30).<br /><strong>Decision:</strong><br />19<br />19<br />19<br />19<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G31&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; G32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; R23<br />24077128.1194 22806124.8054 24022983.9984 22388929.9144 20697892.8884 21715906.8854 20411541.2704 22239301.1624 23547808.7034 24131268.6434 23745039.8404&nbsp; 22098086.832&nbsp;&nbsp; 19124242.27&nbsp; 21007031.526&nbsp; 22253250.468&nbsp;&nbsp; 21201583.22&nbsp; 19474489.084&nbsp; 23565923.703&nbsp; 22864670.122&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />24065818.3394 22804492.2684 24023768.7094 22378483.9394 20691105.4344 21730480.5744 20415751.1104 22255260.6984 23528148.4594 24109572.7604 23726475.0794&nbsp; 22118176.666&nbsp; 19126075.998&nbsp; 20989472.459&nbsp; 22228716.936&nbsp; 21220136.852&nbsp; 19466441.002&nbsp;&nbsp; 23584399.66&nbsp; 22865445.005&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />24054604.4524 22802978.2284 24024661.7794 22368141.6094 20684380.5444 21745121.8054 20420058.9764 22271281.9174 23508530.9834 24087901.1804 23707941.2624 118341978.858 102070810.568 112264586.751 118569402.732&nbsp;&nbsp; 21238782.99 103944062.756 125994130.633 122319666.917&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br />24043483.7924 22801583.0244 24025665.3284 22357904.6154 20677717.7854 21759831.8404 20424464.4854 22287364.6624 23488954.4584 24066257.0444 23689442.3374 118449919.114 102081788.249 112171158.621 118438955.294&nbsp; 21257519.389 103902612.851 126093535.929 122325408.502&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br /><strong>Task:</strong><br />Попробуем вывести для всех эпох данные спутников. Просто регулируем цикл.<br />мы отсортировали данные псевдодальности к каждому спутник для всех эпох. нули в столбцах означают, что в спутниках отсутсвуют нужные данные. единственное, в нижнем скриншоте увидим, что появилиись какие-то нули и у них не обозначены спутники. Дело в том, что в программе мы указали размерность вектора массива 100 и в каждом файле принимаемого с приемника в нашем случае irkj1380.txt, количество эпох может быть разное. Поэтому тут нужно регулировать в нашем случае цифру 100. Я, например, посталю значение здесь 55. Уже покрасивее будет выглядеть наша таблица.<br />Но давайте выведем на экран данные для двух спутников<br /><strong>Decision:</strong><br />G01 G04 G11 G12 и т.д.<br />24077128.119 22806124.805<br />24065818.339 22804492.268<br />24054604.452 22802978.228<br />24043483.792 22801583.024<br />24032459.125 22800306.861<br />24021529.084 22799148.829<br />24010696.527 22798110.763<br />23999959.98 22797191.503<br />23989317.858 22796390.025<br />23978776.092 22795708.426<br />23968330.915 22795144.69<br />23957983.22 22794700.309<br />23947732.989 22794375.481<br />23937583.568 22794167.697<br />23927530.52 22794080.594<br />23917578.625 22794109.516<br />23907725.007 22794258.689<br />23897972.386 22794526.148<br />23888318.516 22794910.502<br />23878766.415 22795414.62<br />... ...<br /><strong>Task:</strong><br />вывести данные именно для одного спутника, например первого. Для этого закомментируем ненужные строки.<br /><strong>Decision:</strong><br />24077128.119<br />24065818.339<br />24054604.452<br />24043483.792<br />24032459.125<br />24021529.084<br />24010696.527<br />23999959.98<br />23989317.858<br />23978776.092<br />23968330.915<br />23957983.22<br />23947732.989<br />...<br /><strong>Task:</strong><br />Попробуем просто сделать это все на графическом интерфейсе, вывести данные двух спутников, плюс еще нарисовать графики этих данных для двух спутников.<br />Теперь нужно обработать и сортировать данные с геометрической дальностью для спутников. Файл называется igr18451.txt. Вот как выглядят данные, которые нужно отсортировать. Тут уже одна эпоха равняется 15 минутам.<br />То что я выделил, это координаты спутника X,Y,Z. Именно их и нужно отсортировать. PG01 - название первого спутника. Попробуем вывести данные именно для него.<br /><strong>Decision:</strong><br />PG04 16571.755106 7091.147720 19268.134634<br />PG04 17081.817393 9222.831883 17918.904800<br />PG04 17633.922784 11162.951350 16256.328779<br />PG04 18194.986791 12883.319207 14310.615388<br />PG04 18728.745598 14363.489413 12116.696076<br />PG04 19197.262350 15591.290270 9713.525830<br />PG04 19562.489921 16563.032391 7143.333216<br />PG04 19787.827341 17283.391677 4450.837454<br />PG04 19839.609715 17764.980464 1682.449322<br />PG04 19688.476298 18027.631365 -1114.528992<br />PG04 19310.568086 18097.427949 -3892.691773<br />PG04 18688.514262 18005.524210 -6605.294077<br />PG04 17812.175758 17786.800613 -9206.983073<br />PG04 16679.123638 17478.408399 -11654.488894<br />PG04 15294.839581 17118.255856 -13907.269035<br />PG04 13672.635233 16743.490595 -15928.101701<br />PG04 11833.296299 16389.030589 -17683.624513<br />PG04 9804.465824 16086.194088 -19144.815686<br />PG04 7619.789018 15861.474593 -20287.415200<br />...<br /><strong>Task:</strong><br />Это мы вывели координаты X,Y,Z и название спутника. Но мне теперь нужно вывести данные только Х для первого спутника.<br /><strong>Decision:</strong><br />14736.411108<br />15414.203154<br />16201.304785<br />17074.555745<br />18004.439905<br />18956.228081<br />19891.328698<br />20768.792721<br />21546.914135<br />...<br /><strong>Task:</strong><br />Аналогично выводяся только для Y и Z выводим данные. Просто нужно поменять в коде x на y или z.<br />Давайте попробуем поситать данные псевдодальности полученные с моего приемника, название файла называется sirfrin1.txt. Вот как выглядит файл:<br />Здесь мы уже видим только две данные для спутников. первые, это дальность, которую как раз и нужно отсортировать по каждом НС, а вторые это, видимо, какие-то сигналы спутника, которые нас не особо не интересуют. И эпоха здесь начинается не с нуля, как мы видим, а с 41 минуты 23 секунды. Это тоже нужно учитывать, когда нужно будет сравнивать эти данные с ГД.<br /><strong>Decision:</strong><br />Мы задачу выполнили (отсортировать данные ГД и ПД по каждом навигационному спутнику), остается только обработать эти данные по формулам и посторить по ним графики через Эксель.<br /><strong>Source:</strong></p>
                        <ul>
                        <li><a href="https://forum.calculate-linux.org/t/windows-qemu-kvm-libvirt/9357">https://forum.calculate-linux.org/t/windows-qemu-kvm-libvirt/9357</a></li>
                        <li><a href="https://blog.sedicomm.com/2019/07/21/rdesktop-klient-rdp-dlya-podklyucheniya-rabochego-stola-windows-iz-linux/">https://blog.sedicomm.com/2019/07/21/rdesktop-klient-rdp-dlya-podklyucheniya-rabochego-stola-windows-iz-linux/</a></li>
                        <li><a href="https://learn.microsoft.com/ru-ru/windows-server/administration/openssh/openssh_install_firstuse">https://learn.microsoft.com/ru-ru/windows-server/administration/openssh/openssh_install_firstuse</a></li>
                        <li><a href="https://learn.microsoft.com/ru-ru/powershell/scripting/learn/remoting/ssh-remoting-in-powershell-core?view=powershell-7.3">https://learn.microsoft.com/ru-ru/powershell/scripting/learn/remoting/ssh-remoting-in-powershell-core?view=powershell-7.3</a></li>
                        <li><a href="https://learn.microsoft.com/en-us/powershell/module/storage/dismount-diskimage?view=windowsserver2022-ps">https://learn.microsoft.com/en-us/powershell/module/storage/dismount-diskimage?view=windowsserver2022-ps</a></li>
                        <li><a href="https://superuser.com/questions/499264/how-can-i-mount-an-iso-via-powershell-programmatically">https://superuser.com/questions/499264/how-can-i-mount-an-iso-via-powershell-programmatically</a></li>
                        <li><a href="https://winitpro.ru/index.php/2016/03/31/sftp-ssh-ftp-na-windows-server-2012-r2/">https://winitpro.ru/index.php/2016/03/31/sftp-ssh-ftp-na-windows-server-2012-r2/</a></li>
                        <li><a href="https://mhelp.pro/ru/kak-zapustit-powershell-ot-imeni-administratora/?ysclid=lmzwqntxfi559273426">https://mhelp.pro/ru/kak-zapustit-powershell-ot-imeni-administratora/?ysclid=lmzwqntxfi559273426</a></li>
                        <li><a href="https://remontka.pro/text-files-cmd-powershell/?ysclid=lmzy2p5172409325479">https://remontka.pro/text-files-cmd-powershell/?ysclid=lmzy2p5172409325479</a></li>
                        <li><a href="https://www.digitalocean.com/community/tutorials/sftp-ru">https://www.digitalocean.com/community/tutorials/sftp-ru</a></li>
                        <li><a href="http://ftp.glonass-iac.ru/guide/navfaq.php">http://ftp.glonass-iac.ru/guide/navfaq.php</a></li>
                        <li><a href="https://ru.wtuseripedia.org/wtuseri/%D0%A1%D0%BF%D1%83%D1%82%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D0%BD%D0%B0%D0%B2%D0%B8%D0%B3%D0%B0%D1%86%D0%B8%D0%B8">https://ru.wtuseripedia.org/wtuseri/%D0%A1%D0%BF%D1%83%D1%82%D0%BD%D0%B8%D0%BA%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D0%BD%D0%B0%D0%B2%D0%B8%D0%B3%D0%B0%D1%86%D0%B8%D0%B8</a></li>
                        <li>Харисов В.Н. Глобальная спутниковая радионавигационная система ГЛОНАСС</li>
                        <li>Грудинская Г.П. Распространение радиоволн</li>
                        <li><a href="http://begin.clan.su/news/speciftusera_provedenija_psevdodalnomernykh_i_fazov/2013-09-18-135">http://begin.clan.su/news/speciftusera_provedenija_psevdodalnomernykh_i_fazov/2013-09-18-135</a></li>
                        <li><a href="http://rrv.iszf.irk.ru/sites/default/files/conf2014/articles/tom2/17-20.pdf">http://rrv.iszf.irk.ru/sites/default/files/conf2014/articles/tom2/17-20.pdf</a></li>
                        <li><a href="http://www.u-blox.com">http://www.u-blox.com</a></li>
                        <li>Дэвис К. Радиоволны в ионосфере</li>
                        <li><a href="https://www.youtube.com/watch?v=bDvVosvyVp0&amp;list=LL&amp;index=315">https://www.youtube.com/watch?v=bDvVosvyVp0&amp;list=LL&amp;index=315</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card__content" id="">
                    <h2 class="card_hidden" onclick="card__hidden(this)">Разработка сайта</h2>
                    <div style="display:none; text-align: left;" style=&{head};>
                        <p><strong>Task:</strong><br />Для разработки своего <a href="https://ct77328.tmweb.ru/">сайта</a>, куда публиковал <a href="https://ct77328.tmweb.ru/progress.html">все решенные мной интересные задачи</a>, сверстал простой сайт, развернул в Qemu-kvm виртуальную машину с операционной системой Ubuntu, в котором установил и настроил веб-сервер Lamp с своей базой данных на Mysql, опубликовал сайт в сервис Timeweb и в нем зарегистрировал домен;<br /><strong>Decision:</strong><br />$ wget https://ubuntu.com/download/desktop/thank-you?version=22.04.3&amp;architecture=amd64<br />$ sudo dnf install https://kojihub.stream.centos.org/kojifiles/packages/libvirt-python/8.5.0/2.el9/x86_64/<br />$ sudo dnf install libguestfs-tools<br />$ sudo dnf install libvirt-python<br />$ sudo systemctl enable libvirtd<br />$ sudo systemctl start libvirtd<br />$ systemctl status libvirtd<br />$ lsmod | grep kvm<br />$ sudo ls -l /var/lib/libvirt/images/<br />$ sudo ls -l /var/lib/libvirt/iso<br />$ rpm -qa | grep bridge-utils<br />$ sudo yum install bridge-utils<br />$ ip a<br />$ brctl show<br />$ systemctl enable --now libvirtd <br />$ nmcli connection add type bridge autoconnect yes con-name br0 ifname br0 <br />$ sudo su<br /># nmcli connection modify br0 ipv4.addresses 10.0.0.30/24 ipv4.method manual<br /># nmcli connection modify br0 ipv4.gateway 10.0.0.1 <br /># nmcli connection modify br0 ipv4.dns 10.0.0.10<br /># nmcli connection modify br0 ipv4.dns-search srv.world <br /># nmcli connection up enp0s21f0u1u4<br /># nmcli connection del enp0s21f0u1u4<br /># nmcli device<br /># nmcli connection add type bridge-slave autoconnect yes con-name enp0s21f0u1u4 ifname enp0s21f0u1u4 master br0<br /># nmcli device<br /># reboot<br /># ip addr <br /># virt-install \<br />--name ubuntu22.04 \<br />--ram 2048 \<br />--disk path=/var/lib/libvirt/images/ubuntu22.04.img,size=50 \<br />--vcpus 2 \<br />--os-variant Ubuntu \<br />--network bridge=br0 \<br />--graphics none \<br />--console pty,target_type=serial \<br />--location /var/lib/libvirt/iso/Ubuntu.iso \<br />--extra-args 'console=ttyS0,115200n8' <br />$ sudo virsh list --all<br />$ sudo virsh start ubuntu22.04<br />$ ssh -X tuser@IP<br /><strong>Decision:</strong><br />$ sudo apt update<br />$ sudo apt install apache2<br />$ sudo ufw app list<br />Available applications:<br />&nbsp; Apache<br />&nbsp; Apache Full<br />&nbsp; Apache Secure<br />&nbsp; CUPS<br />&nbsp; OpenSSH<br />$ sudo ufw enable<br />$ sudo ufw allow in "Apache"<br />$ sudo ufw allow in "OpenSSH"<br />$ sudo ufw status<br />Status: active<br />To&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Action&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; From<br />--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ----<br />Apache&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ALLOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />Apache Full&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ALLOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />OpenSSH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ALLOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Anywhere&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />Apache (v6)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ALLOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Anywhere (v6)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />Apache Full (v6)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ALLOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Anywhere (v6)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<br />OpenSSH (v6)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ALLOW&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Anywhere (v6) <br />$ firefox<br />update.go:85: cannot change mount namespace according to change mount (/var/lib/snapd/hostfs/usr/share/gimp/2.0/help /usr/share/gimp/2.0/help none bind,ro 0 0): cannot open directory "/var/lib": permission denied<br />update.go:85: cannot change mount namespace according to change mount (/var/lib/snapd/hostfs/usr/share/xubuntu-docs /usr/share/xubuntu-docs none bind,ro 0 0): cannot open directory "/var/lib": permission denied<br />X11 connection rejected because of wrong authentication.<br />X11 connection rejected because of wrong authentication.<br />X11 connection rejected because of wrong authentication.<br />X11 connection rejected because of wrong authentication.<br />X11 connection rejected because of wrong authentication.<br />X11 connection rejected because of wrong authentication.<br />Error: cannot open display: localhost:10.0<br /><strong>Decision:</strong><br />$ wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb<br />$ sudo dpkg -i --force-depends google-chrome-stable_current_amd64.deb<br />$ google-chrome http://127.0.0.1<br />Decision:<br />$ sudo apt install mysql-server<br />$ sudo mysql<br />mysql&gt; ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'tpassword';<br />mysql&gt; exit<br />$ sudo mysql_secure_installation<br />$ sudo mysql<br />ERROR 1045 (28000): Access denied for user 'root'@'localhost' (using password: NO)<br />$ sudo mysql -u root -p<br />mysql&gt; exit<br /><strong>Decision:</strong><br />$ sudo apt install php libapache2-mod-php php-mysql<br />$ php -v<br />$ cat /etc/php/8.1/apache2/php.ini | grep upload_max_filesize<br />upload_max_filesize = 2M<br />$ cat /etc/php/8.1/apache2/php.ini | grep post_max_size<br />post_max_size = 8M<br />$ cat /etc/php/8.1/apache2/php.ini | grep memory_limit<br />memory_limit = 128M<br />$ cat /etc/php/8.1/apache2/php.ini | grep max_execution_time<br />max_execution_time = 30<br />$ cat /etc/php/8.1/apache2/php.ini | grep max_input_vars<br />;max_input_vars = 1000<br />$ cat /etc/php/8.1/apache2/php.ini | grep max_input_time<br />; max_input_time<br />max_input_time = 60<br />$ sudo vim /etc/php/8.1/apache2/php.ini<br />$ cat /etc/php/8.1/apache2/php.ini | grep upload_max_filesize<br />upload_max_filesize = 32M<br />$ cat /etc/php/8.1/apache2/php.ini | grep post_max_size<br />post_max_size = 48M<br />$ cat /etc/php/8.1/apache2/php.ini | grep memory_limit<br />memory_limit = 256M<br />$ cat /etc/php/8.1/apache2/php.ini | grep max_execution_time<br />max_execution_time = 600<br />$ cat /etc/php/8.1/apache2/php.ini | grep max_input_vars<br />max_input_vars = 3000<br />$ cat /etc/php/8.1/apache2/php.ini | grep max_input_time<br />; max_input_time<br />max_input_time = 1000<br />$ sudo service apache2 restart<br /><strong>Decision:</strong><br />$ sudo mkdir /var/www/tdomain<br />$ sudo chown -R $USER:$USER /var/www/tdomain<br />$ sudo vim /etc/apache2/sites-available/tdomain.conf<br />$ cat /etc/apache2/sites-available/tdomain.conf<br />&lt;VirtualHost *:80&gt;<br />&nbsp;&nbsp;&nbsp; ServerName tdomain<br />&nbsp;&nbsp;&nbsp; ServerAlias www.tdomain <br />&nbsp;&nbsp;&nbsp; ServerAdmin webmaster@localhost<br />&nbsp;&nbsp;&nbsp; DocumentRoot /var/www/tdomain<br />&nbsp;&nbsp;&nbsp; ErrorLog ${APACHE_LOG_DIR}/error.log<br />&nbsp;&nbsp;&nbsp; CustomLog ${APACHE_LOG_DIR}/access.log combined<br />&lt;/VirtualHost&gt;<br />$ sudo a2ensite tdomain<br />$ sudo a2dissite 000-default<br />$ sudo apache2ctl configtest<br />$ sudo systemctl reload apache2<br />$ vim /var/www/tdomain/index.html<br />$ cat /var/www/tdomain/index.html<br />&lt;html&gt;<br />&nbsp; &lt;head&gt;<br />&nbsp;&nbsp;&nbsp; &lt;title&gt;tdomain website&lt;/title&gt;<br />&nbsp; &lt;/head&gt;<br />&nbsp; &lt;body&gt;<br />&nbsp;&nbsp;&nbsp; &lt;h1&gt;Hello World!&lt;/h1&gt;<br />&nbsp;&nbsp;&nbsp; &lt;p&gt;This is the landing page of &lt;strong&gt;tdomain&lt;/strong&gt;.&lt;/p&gt;<br />&nbsp; &lt;/body&gt;<br />&lt;/html&gt;<br />$ google-chrome http://127.0.0.1<br /><strong>Decision:</strong><br />$ cat /etc/apache2/mods-enabled/dir.conf<br />&lt;IfModule mod_dir.c&gt;<br />&nbsp;&nbsp;&nbsp; DirectoryIndex index.html index.cgi index.pl index.php index.xhtml index.htm<br />&lt;/IfModule&gt;<br /># vim: syntax=apache ts=4 sw=4 sts=4 sr noet<br />$ sudo vim /etc/apache2/mods-enabled/dir.conf<br />$ cat /etc/apache2/mods-enabled/dir.conf<br />&lt;IfModule mod_dir.c&gt;<br />&nbsp;&nbsp;&nbsp; DirectoryIndex index.php index.html index.cgi index.pl index.php index.xhtml index.htm<br />&lt;/IfModule&gt;<br /># vim: syntax=apache ts=4 sw=4 sts=4 sr noet<br />$ sudo systemctl reload apache2<br />$ vim /var/www/tdomain/info.php<br />$ cat /var/www/tdomain/info.php<br />&lt;?php<br />phpinfo();<br />$ google-chrome http://127.0.0.1/info.php<br />$ sudo rm /var/www/tdomain/info.php<br />$ sudo mysql -u root -p<br />mysql&gt; create database tbase;<br />mysql&gt; CREATE USER 'tuser'@'%' IDENTIFIED BY 'tpassword';<br />mysql&gt; GRANT ALL ON tbase.* TO 'tuser'@'%';<br />mysql&gt; exit<br />$ mysql -u tuser -p<br />mysql&gt; show databases;<br />+--------------------+<br />| Database&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+--------------------+<br />| information_schema |<br />| performance_schema |<br />| tbase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<br />+--------------------+<br />3 rows in set (0.07 sec)<br />mysql&gt; create table tbase.ttable1 <br />&nbsp;&nbsp;&nbsp; (ttable1_id INT PRIMARY KEY AUTO_INCREMENT,<br />&nbsp;&nbsp;&nbsp; content VARCHAR(255));<br />CREATE TABLE tbase.ttable1<br />&nbsp;&nbsp;&nbsp; (ttable1_id INT PRIMARY KEY AUTO_INCREMENT,<br />&nbsp;&nbsp;&nbsp; column1 VARCHAR(255), <br />&nbsp;&nbsp;&nbsp; column2 VARCHAR(255),<br />&nbsp;&nbsp;&nbsp; column3 VARCHAR(255),<br />&nbsp;&nbsp;&nbsp; column4 VARCHAR(255),<br />&nbsp;&nbsp;&nbsp; column5 Date,<br />&nbsp;&nbsp;&nbsp; column6 Date);<br />mysql&gt; INSERT INTO tbase.ttable1<br />&nbsp;&nbsp;&nbsp; (column1, column2)<br />VALUES <br />&nbsp;&nbsp;&nbsp; ("text1","text2"),<br />&nbsp;&nbsp;&nbsp; ("text3","text4"),<br />&nbsp;&nbsp;&nbsp; ("text5","text6"),<br />&nbsp;&nbsp;&nbsp; ("text7","text8");<br />mysql&gt; select * from tbase.ttable1;<br />+------------+---------+---------+---------+---------+---------+---------+<br />| ttable1_id | column1 | column2 | column3 | column4 | column5 | column6 |<br />+------------+---------+---------+---------+---------+---------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | text1&nbsp;&nbsp; | text2&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | text3&nbsp;&nbsp; | text4&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 | text5&nbsp;&nbsp; | text6&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 | text7&nbsp;&nbsp; | text8&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />+------------+---------+---------+---------+---------+---------+---------+<br />4 rows in set (0.00 sec)<br />mysql&gt; CREATE TABLE tbase.ttable2<br />&nbsp;&nbsp;&nbsp; (ttable2_id INT PRIMARY KEY AUTO_INCREMENT,<br />&nbsp;&nbsp;&nbsp; columnId INT,<br />&nbsp;&nbsp;&nbsp; column1 VARCHAR(500),<br />&nbsp;&nbsp;&nbsp; FOREIGN KEY (columnId) REFERENCES tbase.ttable1 (ttable1_id));<br />mysql&gt; INSERT INTO tbase.ttable2 <br />&nbsp;&nbsp;&nbsp; (columnId, column1)<br />VALUES <br />&nbsp;&nbsp;&nbsp; (1, "text9"),<br />&nbsp;&nbsp;&nbsp; (1, "text10"),<br />&nbsp;&nbsp;&nbsp; (2, "text11"),<br />&nbsp;&nbsp;&nbsp; (3, "text12"),<br />&nbsp;&nbsp;&nbsp; (4, "text13");<br />mysql&gt; select * from tbase.ttable2;<br />+------------+----------+---------+<br />| ttable2_id | columnId | column1 |<br />+------------+----------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | text9&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | text10&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | text11&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 | text12&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 | text13&nbsp; |<br />+------------+----------+---------+<br />5 rows in set (0.00 sec)<br />mysql&gt; select * from tbase.ttable2<br />&nbsp;&nbsp;&nbsp; inner join tbase.ttable1<br />&nbsp;&nbsp;&nbsp; on ttable1.ttable1_id = ttable2.columnId;<br />+------------+----------+---------+------------+---------+---------+---------+---------+---------+---------+<br />| ttable2_id | columnId | column1 | ttable1_id | column1 | column2 | column3 | column4 | column5 | column6 |<br />+------------+----------+---------+------------+---------+---------+---------+---------+---------+---------+<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | text9&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | text1&nbsp;&nbsp; | text2&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | text10&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 | text1&nbsp;&nbsp; | text2&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | text11&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2 | text3&nbsp;&nbsp; | text4&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 | text12&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 | text5&nbsp;&nbsp; | text6&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5 |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 | text13&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 | text7&nbsp;&nbsp; | text8&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; | NULL&nbsp;&nbsp;&nbsp; |<br />+------------+----------+---------+------------+---------+---------+---------+---------+---------+---------+<br />5 rows in set (0.00 sec)<br />mysql&gt; exit<br />$ vim /var/www/tdomain/index.php<br />$ cat /var/www/tdomain/index.php<br />&lt;?php<br />$user = "tuser";<br />$password = "tpassword";<br />$database = "tbase";<br />$table1 = "ttable1";<br />$table2 = "ttable2";<br />try {<br />&nbsp;&nbsp;&nbsp; $db = new PDO("mysql:host=localhost;dbname=$database", $user, $password);<br />&nbsp;&nbsp;&nbsp; $query = $db-&gt;query("<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select * from $database.$table2 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inner join $database.$table1 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; on $table1.experience_id=$table2.experienceId;<br />&nbsp;&nbsp;&nbsp; ");<br />&nbsp;&nbsp;&nbsp; foreach($query as $row) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo '<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;li&gt;&lt;strong&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' . $row['column1'] . '<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' . $row['column2'] . '<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; :&lt;/strong&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' . $row['column3'] . '<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' . $row['column4'] . '<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' . $row['column5'] . '<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' . $row['column6'] . '<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/li&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ';<br />&nbsp;&nbsp;&nbsp; }<br />} catch (PDOException $e) {<br />&nbsp;&nbsp;&nbsp; print "Error!: " . $e-&gt;getMessage() . "&lt;br/&gt;";<br />&nbsp;&nbsp;&nbsp; die();<br />}<br />$ google-chrome http://127.0.0.1/index.php<br /><strong>Decision:</strong><br />$ sudo apt update<br />$ sudo apt install phpmyadmin php-mbstring php-zip php-gd php-json php-curl<br />$ sudo apt install php8.1-fpm php8.1 libapache2-mod-php8.1 php8.1-common php8.1-mysql php8.1-xml php8.1-xmlrpc php8.1-imagick php8.1-cli php8.1-imap php8.1-opcache php8.1-soap php8.1-intl php8.1-bcmath unzip<br />...<br />granting access to database phpmyadmin for phpmyadmin@localhost: failed.<br />error encountered creating user:<br />mysql said: ERROR 1819 (HY000) at line 1: Your password does not satisfy the cur<br />rent policy requirements<br />dbconfig-common: phpmyadmin configure: aborted.<br />dbconfig-common: flushing administrative password<br />dpkg: error processing package phpmyadmin (--configure):<br />&nbsp;installed phpmyadmin package post-installation script subprocess returned error<br />&nbsp;exit status 1<br />Processing triggers for libapache2-mod-php8.1 (8.1.2-1ubuntu2.14) ...<br />...<br />Errors were encountered while processing:<br />&nbsp;phpmyadmin<br />E: Sub-process /usr/bin/dpkg returned an error code (1)<br />$ mysql -u root -p<br />mysql&gt; UNINSTALL COMPONENT "file://component_validate_password";<br />mysql&gt; exit<br />$ sudo apt install phpmyadmin<br />...<br />granting access to database phpmyadmin for phpmyadmin@localhost: success.<br />verifying access for phpmyadmin@localhost: success.<br />creating database phpmyadmin: success.<br />verifying database phpmyadmin exists: success.<br />populating database via sql...&nbsp; done.<br />dbconfig-common: flushing administrative password<br />$ mysql -u root -p<br />mysql&gt; INSTALL COMPONENT "file://component_validate_password";<br />mysql&gt; exit<br />$ sudo phpenmod mbstring<br />$ sudo systemctl restart apache2<br />$ mysql -u root -p<br />mysql&gt; SELECT user,authentication_string,plugin,host FROM mysql.user;<br />mysql&gt; exit<br />$ sudo cp /etc/phpmyadmin/apache.conf /etc/apache2/conf-available/phpmyadmin.conf<br />$ sudo a2enconf phpmyadmin.conf<br />$ systemctl reload apache2<br />$ google-chrome http://127.0.0.1/phpmyadmin &amp;<br /><strong>Decision:</strong><br />$ wget -qO - https://download.sublimetext.com/sublimehq-pub.gpg | sudo tee /etc/apt/trusted.gpg.d/sublimehq-pub.asc<br />$ sudo apt update<br />$ sudo apt-get install apt-transport-https<br />$ echo "deb https://download.sublimetext.com/ apt/stable/" | sudo tee /etc/apt/sources.list.d/sublime-text.list<br />$ sudo apt update<br />$ sudo apt install sublime-text<br /><strong>Decision:</strong><br />$ exit<br /># virsh shutdown ubuntu22.04<br /><strong>Source:</strong><br />https://winitpro.ru/index.php/2020/02/10/virsh-upravlenie-virtualnymi-mashinami-kvm/<br />https://winitpro.ru/index.php/2020/02/04/ustanovka-zapusk-kvm-v-linux-centos/<br />https://www.server-world.info/en/note?os=CentOS_Stream_9&amp;p=kvm&amp;f=1<br />https://www.server-world.info/en/note?os=CentOS_Stream_9&amp;p=initial_conf&amp;f=3<br />https://www.server-world.info/en/note?os=CentOS_Stream_9&amp;p=kvm&amp;f=2<br />https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-22-04<br />https://losst.pro/ustanovka-chrome-v-ubuntu-18-04?ysclid=lmdflkvc3v463974954<br />https://qna.habr.com/q/439469?ysclid=lmdgkb49q827401606<br />https://metanit.com/sql/mysql/2.5.php<br />https://metanit.com/sql/mysql/5.2.php<br />https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-phpmyadmin-on-ubuntu-20-04<br />https://serverspace.ru/support/help/osnovnye-komandy-ufw/<br />https://www.tutsmake.com/how-to-install-lamp-apache-mysql-php-in-ubuntu-22-04/<br />https://www.php.net/manual/ru/faq.html.php<br />https://www.8host.com/blog/kak-rabotayut-stroki-v-php/</p>
                    </div>
                </div>
            </div>
        </div>
    </section> 
    <!-- JS -->
    <script src="js/jquery.js"></script>
    <script src="js/main.js"></script>
</body>
</html>